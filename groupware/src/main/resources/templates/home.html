<!DOCTYPE html>
<html
xmlns:th="http://www.thymeleaf.org"
xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
layout:decorate="~{/include/layout}">
<th:block layout:fragment="content">
	<!-- FullCalendar ë¶€íŠ¸ìŠ¤íŠ¸ë©5 í…Œë§ˆ CSS ì¶”ê°€ -->
	<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/bootstrap5.min.css" rel="stylesheet">
			
	<!-- Preloader Start -->
	<div class="toast toast-onload align-items-center text-bg-primary border-0" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true" data-bs-delay="2000">
    	<div class="toast-body hstack align-items-start gap-6">
      	<i class="ti ti-alert-circle fs-6"></i>
      		<div>
        		<h5 class="text-white fs-3 mb-1">ë¬´ìì½” ê·¸ë£¹ì›¨ì–´</h5>
        		<h6 class="text-white fs-2 mb-0"><span th:text="|${#authentication.principal.member.memberName}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!|"></span></h6>
      		</div>
      		<button type="button" class="btn-close btn-close-white fs-2 m-0 ms-auto shadow-none" data-bs-dismiss="toast" aria-label="Close"></button>
    	</div>
  	</div>
  	<!-- Preloader End -->
	
	<!-- í˜ì´ì§€ ë ˆì´ì•„ì›ƒ -->
	<div class="container-fluid">
		<div class="row">
	    	<div class="col-lg-3">
	    	
	        	<div class="card shadow-none border">
	            	<div class="card-body">
	            	
						<div class="d-flex flex-column align-items-center">
							
						    <div class="text-center mb-3">
						        <th:block th:if="${latestMyProfile != null}">
						            <img th:src="@{|/uploads/${latestMyProfile.new_name}|}" width="120" height="120" style="margin-top:20px; margin-bottom:20px;" alt="profile-img" />
						        </th:block>
						        <th:block th:if="${latestMyProfile == null}">
						            <img th:src="@{/img/default_profile.png}" width="120" height="120" style="margin-top:20px; margin-bottom:20px;" alt="default-profile" />
						        </th:block>
						    </div>
							
						    <h5 class="fs-4 mb-1" th:text="${#authentication.principal.member.memberName}">ì‚¬ìš©ì ì´ë¦„</h5>
							
							<div class="mb-1 text-muted small">
							    <span th:text="'#' + ${#authentication.principal.member.memberNo}">ì‚¬ë²ˆ</span>
							</div>
							
						    <div class="text-center text-muted small">
						        <th:block th:if="${#authentication.principal.member.dept != null && #authentication.principal.member.pos != null}">
						            <span th:text="${#authentication.principal.member.dept.deptName+' (' + #authentication.principal.member.pos.posName + ')'}">ë¶€ì„œ(ì§ê¸‰)</span>
						        </th:block>
						        <th:block th:if="${#authentication.principal.member.dept == null && #authentication.principal.member.pos != null}">
						            <span th:text="${'ë¯¸ë°°ì • (' + #authentication.principal.member.pos.posName + ')'}">ë¶€ì„œ ë¯¸ë°°ì •(ì§ê¸‰)</span>
						        </th:block>
						        <th:block th:if="${#authentication.principal.member.dept != null && #authentication.principal.member.pos == null}">
						            <span th:text="${#authentication.principal.member.dept.deptName + ' (ì—†ìŒ)'}">ë¶€ì„œ(ì§ê¸‰ ë¯¸ë°°ì •)</span>
						        </th:block>
						        <th:block th:if="${#authentication.principal.member.dept == null && #authentication.principal.member.pos == null}">
						            <span>ë¯¸ë°°ì •(ì—†ìŒ)</span>
						        </th:block>
						    </div>
							
						</div>
				        
				        <hr class="my-3">
				
				        <div class="mt-3 small">
							<div class="d-flex justify-content-between mb-2">
								<input type="hidden" id="start_time_min" th:value="${workPolicy.startTimeMin}">
								<input type="hidden" id="start_time_max" th:value="${workPolicy.startTimeMax}">
								<!-- í‡´ê·¼ ê³„ì‚°ìš© í¬ë§·ëœ ì‹œê°„ (HH:mm:ss í˜•ì‹ìœ¼ë¡œ ê°•ì œ ì¶œë ¥) -->
								<input type="hidden" id="start_time_max_str" th:value="${#temporals.format(workPolicy.startTimeMax, 'HH:mm:ss')}">
								<span class="text-muted">ì¶œê·¼</span>
								<th:block th:if="${todayAttendance == null}">
									<div id="checkInWrap">
										<button class="btn btn-primary btn-sm" onclick="startTime();">ì¶œê·¼</button>
									</div>
								</th:block>
								<th:block th:if="${todayAttendance != null}">
									<div id="checkInWrap">
										<span class="fw-bold text-success" id="start_time"
											th:text="${todayAttendance.check_in}"></span>
									</div>
								</th:block>
							</div>
							<div class="d-flex justify-content-between mb-2">
								<span class="text-muted">í‡´ê·¼</span>
								<th:block th:if="${todayAttendance == null}">
									<div id="checkOutWrap">
										<button id="end_time_btn" class="btn btn-primary btn-sm"
									onclick="endTime();" th:disabled="${todayAttendance == null}">í‡´ê·¼</button>
									</div>
								</th:block>
								<th:block th:if="${todayAttendance != null and todayAttendance.check_out == null}">
									<div id="checkOutWrap">
										<button id="end_time_btn" class="btn btn-primary btn-sm"
									onclick="endTime();">í‡´ê·¼</button>
									</div>
								</th:block>
								<th:block th:if="${todayAttendance != null and todayAttendance.check_out != null}">
									<div id="checkOutWrap">
										<span class="fw-bold text-success" id="end_time"
											th:text="${todayAttendance.check_out}"></span>
									</div>
								</th:block>
							</div>
							<!-- ê·¼ë¬´ ìƒíƒœ â†’ ì¶œê·¼/í‡´ê·¼ ìƒíƒœë¡œ ë‚˜ëˆ” -->
							<div class="mt-2 border-top pt-2">
							  <!-- ì¶œê·¼ ìƒíƒœ -->
							  <div class="d-flex justify-content-between mb-1">
							    <span class="text-muted">ì¶œê·¼ ìƒíƒœ</span>
							    <th:block th:if="${todayAttendance == null}">
							      <span id="checkInStatus"
							        class="badge bg-secondary-subtle text-secondary fw-semibold px-2 py-1 rounded">-</span>
							    </th:block>
							    <th:block th:if="${todayAttendance != null}">
							      <span th:if="${todayAttendance.late_yn == 'N'}"
							        class="badge bg-success-subtle text-success fw-semibold px-2 py-1 rounded">ì •ìƒ ì¶œê·¼</span>
							      <span th:if="${todayAttendance.late_yn == 'Y'}"
							        class="badge bg-warning-subtle text-warning fw-semibold px-2 py-1 rounded">ì§€ê°</span>
							    </th:block>
							  </div>
							
							  <!-- í‡´ê·¼ ìƒíƒœ -->
							  <div class="d-flex justify-content-between mb-1">
							    <span class="text-muted">í‡´ê·¼ ìƒíƒœ</span>
							    <th:block th:if="${todayAttendance == null or todayAttendance.check_out == null}">
							      <span id="checkOutStatus"
							        class="badge bg-secondary-subtle text-secondary fw-semibold px-2 py-1 rounded">-</span>
							    </th:block>
							    <th:block th:if="${todayAttendance != null and todayAttendance.check_out != null}">
							      <span th:if="${todayAttendance.early_leave_yn == 'N'}"
							        class="badge bg-success-subtle text-success fw-semibold px-2 py-1 rounded">ì •ìƒ í‡´ê·¼</span>
							      <span th:if="${todayAttendance.early_leave_yn == 'Y'}"
							        class="badge bg-primary-subtle text-primary fw-semibold px-2 py-1 rounded">ì¡°í‡´</span>
							    </th:block>
							  </div>
							</div>
						</div>
						
				        <hr class="my-3">
				        
				        <div class="d-flex align-items-center mb-3" style="cursor: pointer;" onclick="location.href='/calendar'">
				            <i class="ti ti-calendar" style="font-size: 14px;"></i>
				            <span class="ms-3">ì¼ì •</span>
				        </div>
				        
	            		<div class="d-flex align-items-center mb-3" style="cursor: pointer;" onclick="location.href='/attendance/info'">
						    <i class="ti ti-clock" style="font-size: 14px;"></i>
						    <span class="ms-3">ê·¼ë¬´ ì´ë ¥</span>
						</div>
				        
	                	<div class="d-flex align-items-center mb-3" style="cursor: pointer;" onclick="location.href='/approval'">
				            <i class="ti ti-check" style="font-size: 14px;"></i>
				            <span class="ms-3">ê²°ì¬</span>
				        </div>
				        
				        <div class="d-flex align-items-center mb-3" style="cursor: pointer;" onclick="location.href='/shared'">
				            <i class="ti ti-file" style="font-size: 14px;"></i>
				            <span class="ms-3">ê³µìœ ë¬¸ì„œí•¨</span>
				        </div>
						
				        <div class="d-flex align-items-center mb-3" style="cursor: pointer;" onclick="location.href='/chat'">
				            <i class="ti ti-message-circle" style="font-size: 14px;"></i>
				            <span class="ms-3">ì±„íŒ…</span>
				        </div>
				
				        <div class="d-flex align-items-center mb-3" style="cursor: pointer;" onclick="location.href='/notice'">
				            <i class="ti ti-alert-circle" style="font-size: 14px;"></i>
				            <span class="ms-3">ê³µì§€ì‚¬í•­</span>
				        </div>
				
				        <div class="d-flex align-items-center" style="cursor: pointer;" onclick="location.href='/board/list'">
				            <i class="ti ti-clipboard-text" style="font-size: 14px;"></i>
				            <span class="ms-3">ê²Œì‹œíŒ</span>
				        </div>
	            	</div>
	  			</div>
				
			</div>
	        
	        <div class="col-lg-9">
			    <div class="row">
			        <!-- ì²« ë²ˆì§¸ ë°•ìŠ¤ (ê³µì§€ì‚¬í•­ ë° ììœ ê²Œì‹œíŒ) -->
			        <div class="col-md-8">
			            <div class="card shadow-none border">
			                <div class="card-body" style="height: 360px; max-height: 360px; overflow-y:auto;">
			                    <div class="hstack gap-6 mb-3">
			                        <a class="p-0 hstack justify-content-center round-32 btn btn-secondary rounded-circle" href="javascript:void(0)">
			                            <i class="ti ti-alert-circle"></i>
			                        </a>
			                        <a href="javascript:void(0)" class="text-dark link-primary">ê³µì§€ì‚¬í•­</a>
			                    </div>
		                        <div>
		                        	ê³µì§€ì‚¬í•­ th<br>
		                        	ìµœì‹  ê³µì§€ 1<br>
		                        	ìµœì‹  ê³µì§€ 2<br>
		                        	ìµœì‹  ê³µì§€ 3
		                        </div>
		                        <div class="hstack gap-6 mt-3 mb-3">
			                        <a class="p-0 hstack justify-content-center round-32 btn btn-secondary rounded-circle" href="javascript:void(0)">
			                            <i class="ti ti-clipboard-text"></i>
			                        </a>
			                        <a href="javascript:void(0)" class="text-dark link-primary">ììœ ê²Œì‹œíŒ</a>
			                    </div>
			                    <div>
			                    	ììœ ê²Œì‹œíŒ th<br>
			                    	ìµœì‹ ê¸€ 1<br>
		                        	ìµœì‹ ê¸€ 2<br>
		                        	ìµœì‹ ê¸€ 3
			                    </div>
			                </div>
			            </div>
			        </div>
			
			        <!-- ë‘ ë²ˆì§¸ ë°•ìŠ¤ (ì˜¤ëŠ˜ì˜ í•  ì¼) -->
			        <div class="col-md-4">
			            <div class="card shadow-none border">
			                <div class="card-body" style="height: 360px; max-height: 360px; overflow-y:auto;">
			                    <div class="hstack gap-6 mb-3">
			                        <a class="hstack p-0 round-32 justify-content-center btn btn-secondary rounded-circle" href="javascript:void(0)">
			                            <i class="ti ti-calendar"></i>
			                        </a>
			                        <a href="javascript:void(0)" class="text-dark link-secondary">ì˜¤ëŠ˜ì¼ì •</a>
			                    </div>
			                    <div id="today-todo-list" class="small">
								  <div class="text-muted">ì˜¤ëŠ˜ ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>
								</div>
			                </div>
			            </div>
			        </div>
			    </div>
				
				<style>
				  /* ìº˜ë¦°ë” íˆ´ë°” ì¤„ì´ê¸° */
				  .fc-toolbar {
				    font-size: 0.85rem;
				    padding: 4px 0;
				  }
				  .fc .fc-button {
				    padding: 2px 8px;
				    font-size: 0.75rem;
				    height: 28px;
				    line-height: 1;
				    border-radius: 4px;
				  }
				  .fc .fc-toolbar-title {
				    font-size: 1rem;
				  }
				  /* ë‚ ì§œ ìˆ«ì í¬ê¸° ì¤„ì´ê¸° */
				  .fc .fc-daygrid-day-number {
				    font-size: 0.75rem !important;
				    padding: 2px;
				  }
				  .fc .fc-daygrid-day {
				    padding: 4px 0;
				  }
				  /* ìš”ì¼ í—¤ë”ë„ ì‘ê²Œ */
				  .fc .fc-col-header-cell-cushion {
				    font-size: 0.75rem;
				    padding: 2px;
				  }
				  .dot {
				    display: inline-block;
				    width: 10px;
				    height: 10px;
				    border-radius: 50%;
				    margin-right: 6px;
				  }
				  .dot-company {
				    background-color: rgba(92, 100, 242, 1.0); /* ë³´ë¼ */
				  }
				  .dot-department {
				    background-color: rgba(242, 75, 120, 1.0); /* ë¶„í™ */
				  }
				  .dot-personal {
				    background-color: rgba(63, 191, 155, 1.0); /* ì—°ë‘ */
				  }
				  .dot-vacation {
				    background-color: rgba(242, 146, 29, 1.0); /* ë…¸ë‘ */
				</style>
			    <div class="row">
			        <!-- ì„¸ ë²ˆì§¸ ë°•ìŠ¤ (ìº˜ë¦°ë”) -->
			        <div class="col-md-8">
			            <div class="card shadow-none border">
			                <!-- <div class="card-body" style="height: 360px; max-height: 360px; overflow-y:auto;"> -->
			                <div class="card-body" style="height: 600px; overflow:hidden;">
			                    <div class="hstack gap-6 mb-3">
			                        <a class="hstack p-0 round-32 justify-content-center btn btn-secondary rounded-circle" href="javascript:void(0)">
			                            <i class="ti ti-calendar"></i>
			                        </a>
			                        <a href="javascript:void(0)" class="text-dark link-secondary">ì¼ì •</a>
			                    </div>
			                    <div>
			                    	<div id="calendar"
									     th:data-member-no="${#authentication.principal.member.memberNo}"
									     th:data-dept-no="${#authentication.principal.member.dept != null ? #authentication.principal.member.dept.deptNo : 0}">
									</div>
			                    	<!-- ìº˜ë¦°ë”<br> -->
			                    </div>
			                </div>
			            </div>
			        </div>
			
			        <!-- ë„¤ ë²ˆì§¸ ë°•ìŠ¤ (ì±„íŒ…) -->
			        <div class="col-md-4">
			            <div class="card shadow-none border">
			                <div class="card-body" style="height: 360px; max-height: 360px; overflow-y:auto;">
			                    <div class="hstack gap-6 mb-3">
			                        <a class="hstack p-0 round-32 justify-content-center btn btn-secondary rounded-circle" href="javascript:void(0)">
			                            <i class="ti ti-message-circle"></i>
			                        </a>
			                        <a href="javascript:void(0)" class="text-dark link-secondary">ì±„íŒ…</a>
			                    </div>
			                    <div>
			                    	ë‚´ ì±„íŒ…ë°© ìƒìœ„ 5ê°œ
			                    </div>
			                </div>
			            </div>
			        </div>
			        
			    </div>
			</div>

		</div>
	</div>
	
	<script>
         	const csrfToken = document.querySelector('meta[name="_csrf"]').content;
		const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;
       </script>

	<script>
		const startTime = function () {
			const now = new Date();
			const koreaOffset = 9 * 60;
			const localDate = new Date(now.getTime() + (koreaOffset * 60 * 1000));
			const attendDate = localDate.toISOString().slice(0, 10);
	
			const hours = String(now.getHours()).padStart(2, '0');
			const minutes = String(now.getMinutes()).padStart(2, '0');
			const seconds = String(now.getSeconds()).padStart(2, '0');
			const checkIn = `${hours}:${minutes}:${seconds}`;
	
			if (!confirm(`í˜„ì¬ì‹œê°„ ${checkIn} ì¶œê·¼ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
	
			// íœ´ê°€ì— ë”°ë¥¸ ì¶œê·¼ ê¸°ì¤€ ì‹œê°„ ì¡°ì •
			const planTitle = document.getElementById('plan_title')?.value || '';
			const isMorningLeave = planTitle.includes('[ì˜¤ì „ë°˜ì°¨]');
			let maxStartStr = document.getElementById('start_time_max').value;
	
			if (isMorningLeave) {
				// ì¶œê·¼ í—ˆìš© ì‹œê°„ 4ì‹œê°„ ëŠ¦ì¶¤
				const [h, m, s] = maxStartStr.split(":").map(Number);
				const newHour = h + 4;
				maxStartStr = `${String(newHour).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
			}
	
			fetch('/attendance/saveStartTime', {
				method: 'POST',
				headers: {
					[csrfHeader]: csrfToken,
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({
					attend_date: attendDate,
					check_in: checkIn,
					plan_title: planTitle // ğŸ”¥ ì„œë²„ì—ì„œ lateYn íŒì •í•  ë•Œ í•„ìš”
				})
			})
				.then(response => response.json())
				.then(data => {
					alert(data.res_msg);
	
					if (data.res_code === "200") {
						document.getElementById("checkInWrap").innerHTML =
							`<span id="start_time" class="fw-bold text-success">${data.attendance.checkIn}</span>`;
	
						document.getElementById('end_time_btn').disabled = false;
						const statusSpan = document.getElementById("checkInStatus");
	
						let statusText = "";
						let bgClass = "";
						let textClass = "";
	
						switch (data.attendance.lateYn) {
							case "N":
								statusText = "ì •ìƒ ì¶œê·¼";
								bgClass = "bg-success-subtle";
								textClass = "text-success";
								break;
							case "Y":
								statusText = "ì§€ê°";
								bgClass = "bg-warning-subtle";
								textClass = "text-warning";
								break;
							default:
								statusText = "ì¶œê·¼ì „";
								bgClass = "bg-secondary-subtle";
								textClass = "text-secondary";
						}
	
						statusSpan.className = `badge fw-semibold px-2 py-1 rounded ${bgClass} ${textClass}`;
						statusSpan.innerText = statusText;
					}
				})
				.catch(err => {
					alert("ì¶œê·¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ!");
					console.error("ì¶œê·¼ ì €ì¥ ì‹¤íŒ¨", err);
				});
		}
	
		const endTime = function () {
			const now = new Date();
			const attendDate = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;

			// ì¶œê·¼ ì‹œê°„ íŒŒì‹±
			const checkInStr = document.getElementById('start_time').innerHTML;
			const [inHour, inMin, inSec] = checkInStr.split(":").map(Number);
			const baseCheckInMin = inHour * 60 + inMin + inSec / 60;

			// íœ´ê°€ ìœ í˜• í™•ì¸
			const planTitle = document.getElementById('plan_title')?.value || '';
			const isMorningLeave = planTitle.includes('[ì˜¤ì „ë°˜ì°¨]');
			const isAfternoonLeave = planTitle.includes('[ì˜¤í›„ë°˜ì°¨]');

			// íšŒì‚¬ ë§ˆì§€ë…¸ì„  ì¶œê·¼ì‹œê°„
			const maxStartStr = document.getElementById('start_time_max_str')?.value;
			const [maxHour, maxMin, maxSec] = maxStartStr.split(":").map(Number);
			const maxStartMin = maxHour * 60 + maxMin;

			// ê¸°ì¤€ ì¶œê·¼ ì‹œê°„ ê²°ì •
			let baseTotalMin;
			if (!isMorningLeave && !isAfternoonLeave && baseCheckInMin >= maxStartMin) {
				baseTotalMin = maxStartMin;
			} else {
				// ì •ìƒ ì¶œê·¼ ë˜ëŠ” ë°˜ì°¨ â†’ ì‹¤ì œ ì¶œê·¼ ê¸°ì¤€
				baseTotalMin = baseCheckInMin;
			}

			// ê·¼ë¬´ì‹œê°„ ê°€ì ¸ì˜¤ê¸°
			const workDuration = parseFloat(document.getElementById('work_duration')?.value) || 9.0;

			// í‡´ê·¼ ê¸°ì¤€ ì‹œê°„ ê³„ì‚°
			let requiredMin;
			if (isMorningLeave || isAfternoonLeave) {
				requiredMin = baseCheckInMin + 4 * 60;
			} else {
				requiredMin = baseTotalMin + workDuration * 60;
			}

			// í˜„ì¬ ì‹œê°„ ê³„ì‚°
			const nowTotalMin = now.getHours() * 60 + now.getMinutes() + now.getSeconds() / 60;
			const currentTimeStr = now.toTimeString().slice(0, 8);

			let earlyLeaveYn = 'N';
			let confirmMsg = "";

			if (nowTotalMin < requiredMin) {
				const requiredHour = Math.floor(requiredMin / 60);
				const requiredMinute = Math.floor(requiredMin % 60);
				confirmMsg = `ì•„ì§ í‡´ê·¼ì‹œê°„ì´ ì•„ë‹™ë‹ˆë‹¤.\n(${requiredHour.toString().padStart(2, '0')}:${requiredMinute.toString().padStart(2, '0')}) ì´í›„ì— ì •ìƒí‡´ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.\nê·¸ë˜ë„ í‡´ê·¼í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
				earlyLeaveYn = 'Y';
				
				console.log("ğŸ§¾ ì‹¤ì œ ì¶œê·¼ ì‹œê°„ (baseCheckInMin):", baseCheckInMin);
				console.log("ğŸ§¾ ê¸°ì¤€ ì¶œê·¼ ì‹œê°„ (baseTotalMin):", baseTotalMin); // ì§€ê°ì´ë©´ 660(11ì‹œ)ì´ì–´ì•¼ í•¨
				console.log("ğŸ§¾ workDuration:", workDuration);
				console.log("ğŸ§¾ í‡´ê·¼ ê¸°ì¤€ requiredMin (ë¶„):", requiredMin);
				console.log("ğŸ•’ í‡´ê·¼ ê¸°ì¤€ ì‹œê°:", requiredHour + ":" + requiredMinute);
				console.log("ğŸ§¾ maxStartMin (íšŒì‚¬ ë§ˆì§€ë…¸ì„ ):", maxStartMin);
				console.log("ğŸ§¾ baseCheckInMin:", baseCheckInMin);
				console.log("ğŸ§¾ ë¹„êµ ê²°ê³¼:", baseCheckInMin >= maxStartMin);

			} else {
				confirmMsg = `í˜„ì¬ ì‹œê°„ ${currentTimeStr} í‡´ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤. í‡´ê·¼ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
			}
			
			
			if (!confirm(confirmMsg)) return;

			// í‡´ê·¼ ìš”ì²­
			fetch('/attendance/saveEndTime', {
				method: 'POST',
				headers: {
					[csrfHeader]: csrfToken,
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({
					attend_date: attendDate,
					check_out: currentTimeStr,
					early_leave_yn: earlyLeaveYn,
					plan_title: planTitle
				})
			})
				.then(response => response.json())
				.then(data => {
					alert(data.res_msg);

					if (data.res_code === "200") {
						document.getElementById("checkOutWrap").innerHTML =
							`<span class="fw-bold text-success">${data.attendance.check_out}</span>`;

						const statusSpan = document.getElementById("checkOutStatus");

						let statusText = "";
						let bgClass = "";
						let textClass = "";

						switch (data.attendance.early_leave_yn) {
							case "Y":
								statusText = "ì¡°í‡´";
								bgClass = "bg-primary-subtle";
								textClass = "text-primary";
								break;
							case "N":
								statusText = "ì •ìƒ í‡´ê·¼";
								bgClass = "bg-success-subtle";
								textClass = "text-success";
								break;
							default:
								statusText = "í‡´ê·¼";
								bgClass = "bg-secondary-subtle";
								textClass = "text-secondary";
						}

						statusSpan.className = `badge fw-semibold px-2 py-1 rounded ${bgClass} ${textClass}`;
						statusSpan.innerText = statusText;
						
					}
				})
				.catch(err => {
					alert("í‡´ê·¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ!");
					console.error("í‡´ê·¼ ì €ì¥ ì‹¤íŒ¨", err);
				});
		};
	</script>
	<script>
	 // ìº˜ë¦°ë” í‘œì‹œìš© JS
	  document.addEventListener('DOMContentLoaded', function () {
	    const calendarEl = document.getElementById('calendar');
	    const memberNo = calendarEl.dataset.memberNo;
	    const deptNo = calendarEl.dataset.deptNo;
	
	    const calendar = new FullCalendar.Calendar(calendarEl, {
	      themeSystem: 'bootstrap5',
	      locale: 'ko',
	      height: 500,
	      initialView: 'dayGridMonth',
	      headerToolbar: {
	        left: 'prev,next today',
	        center: 'title',
	        right: 'dayGridMonth,timeGridWeek,timeGridDay'
	      },
	      buttonText: {
	        today: 'ì˜¤ëŠ˜',
	        month: 'ì›”',
	        week: 'ì£¼',
	        day: 'ì¼'
	      },
	      events: function (fetchInfo, successCallback, failureCallback) {
	        fetch(`/calendar/events?start=${fetchInfo.startStr}&end=${fetchInfo.endStr}&type=all`)
	          .then(response => response.json())
	          .then(data => successCallback(data))
	          .catch(error => failureCallback(error));
	      },
	      eventContent: function (arg) {
	        const deptName = arg.event.extendedProps.deptName || "ë¯¸ë°°ì •";
	        const planType = arg.event.extendedProps.planType;
	        const title = arg.event.title;
	        return {
	          html: `<div>${(planType === 'ë¶€ì„œ' || planType === 'íœ´ê°€') ? `[${deptName}] ` : ''}${title}</div>`
	        };
	      },
	      eventDidMount: function(info) {
	    	    const planType = info.event.extendedProps.planType;
	    	    let backgroundColor = '';
	    	    switch (planType) {
	    	      case 'íšŒì‚¬': backgroundColor = 'rgba(92, 100, 242, 1.0)'; break;
	    	      case 'ë¶€ì„œ': backgroundColor = 'rgba(242, 75, 120, 1.0)'; break;
	    	      case 'ê°œì¸': backgroundColor = 'rgba(63, 191, 155, 1.0)'; break;
	    	      case 'íœ´ê°€': backgroundColor = 'rgba(242, 146, 29, 1.0)'; break;
	    	    }
	    	    if (backgroundColor) {
	    	      info.el.style.backgroundColor = backgroundColor;
	    	      info.el.style.border = 'none';
	    	      info.el.style.color = 'white';
	    	    }
	    	  }
	       });
	    calendar.render();
	  });
	</script>
	<script>
	 // ì˜¤ëŠ˜ì¼ì •
		document.addEventListener('DOMContentLoaded', function () {
		  const todayListEl = document.getElementById("today-todo-list");
		
		  const today = new Date();
		  const yyyy = today.getFullYear();
		  const mm = String(today.getMonth() + 1).padStart(2, '0');
		  const dd = String(today.getDate()).padStart(2, '0');
		  const todayStr = `${yyyy}-${mm}-${dd}`;
		
		  fetch(`/calendar/events?start=${todayStr}&end=${todayStr}&type=all`)
		    .then(res => res.json())
		    .then(data => {
		      const filtered = data.filter(e => {
		        const eventDate = e.start?.split('T')[0];
		        return eventDate === todayStr;
		      });
		
		      if (filtered.length === 0) {
		        todayListEl.innerHTML = `<div class="text-muted">ì˜¤ëŠ˜ ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
		      } else {
		    	  const sorted = filtered.sort((a, b) => {
		              const timeA = a.start.includes('T') ? a.start.split('T')[1] : '00:00';
		              const timeB = b.start.includes('T') ? b.start.split('T')[1] : '00:00';
		              return timeA.localeCompare(timeB);
		            });

		            const html = sorted.map(e => {
		              const type = e.extendedProps?.planType || "";
		              const content = e.extendedProps?.planContent || "";
		              const timeStr = e.start.includes('T') ? e.start.split('T')[1].slice(0, 5) : 'ì¢…ì¼';
		              const title = e.title || "";
		
		          // ìƒ‰ìƒ í´ë˜ìŠ¤
		          let dotClass = '';
		          switch (type) {
		            case "íšŒì‚¬": dotClass = "dot-company"; break;
		            case "ë¶€ì„œ": dotClass = "dot-department"; break;
		            case "ê°œì¸": dotClass = "dot-personal"; break;
		            case "íœ´ê°€": dotClass = "dot-vacation"; break;
		            default: dotClass = "dot-default";
		          }
		
		          return `
		            <div class="mb-3">
		              <span class="dot ${dotClass}"></span>
		              <strong>[${type}]</strong> ${title} <span class="text-muted ms-1">${timeStr}</span><br>
		              <span class="text-muted small">${content}</span>
		            </div>
		          `;
		        }).join('');
		        todayListEl.innerHTML = html;
		      }
		    })
		    .catch(err => {
		      console.error("ì˜¤ëŠ˜ ì¼ì • ë¡œë”© ì‹¤íŒ¨", err);
		      todayListEl.innerHTML = `<div class="text-danger">ì¼ì • ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</div>`;
		    });
		});

	</script>
	<!-- Bootstrap Common JS Files Start -->
	
	<!-- Import vendorJs Files -->
	<script th:src="@{/assets/js/vendor.min.js}"></script>
	
  	<!-- Import Js Files -->
  	<script th:src="@{/assets/libs/bootstrap/dist/js/bootstrap.bundle.min.js}"></script>
  	<script th:src="@{/assets/libs/simplebar/dist/simplebar.min.js}"></script>
  	<script th:src="@{/assets/js/theme/app.init.js}"></script>
  	<script th:src="@{/assets/js/theme/theme.js}"></script>
  	<script th:src="@{/assets/js/theme/app.min.js}"></script>
  	<script th:src="@{/assets/js/theme/sidebarmenu.js}"></script>

  	<!-- solar icons -->
  	<script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>
  	<script th:src="@{/assets/libs/owl.carousel/dist/owl.carousel.min.js}"></script>
  	<script th:src="@{/assets/libs/apexcharts/dist/apexcharts.min.js}"></script>
  	<script th:src="@{/assets/js/dashboards/dashboard.js}"></script>
  	
  	<!-- FullCalendar JS -->
	<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  	
  	<!-- Bootstrap Common JS Files End -->
	
</th:block>
</html>