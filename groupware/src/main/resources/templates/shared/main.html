<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/include/layout}">

<th:block layout:fragment="content">
  <!-- jQuery 명시적 로드 -->
  <script src="/js/jquery-3.7.1.js"></script>
  <!-- jsTree CSS + JS -->
  <link href="https://cdn.jsdelivr.net/npm/jstree@3.3.12/dist/themes/default/style.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/jstree@3.3.12/dist/jstree.min.js"></script>
  <!-- jstree.js -->
  <script src="/js/hjh/jstree.js"></script>

  <div class="container-fluid">
    <div class="row">
      <!-- 왼쪽 사이드바: jsTree 트리 -->
      <div class="col-md-3 mb-4">
        <div class="bg-white p-3 rounded-3 shadow-sm" style="height: 100%;">
          <h5 class="fw-bold mb-3">📁 폴더 목록</h5>
          <div id="shared-tree" style="min-height: 200px;"></div>
          <div class="mt-3 d-flex gap-2">
            <button id="expand_all" class="btn btn-sm btn-outline-secondary">+ 펼치기</button>
            <button id="collapse_all" class="btn btn-sm btn-outline-secondary">- 접기</button>
          </div>
        </div>
      </div>
      <!-- 오른쪽 메인 콘텐츠: 업로드 -->
      <div class="col-md-9">
        <div class="bg-white p-4 rounded-4 shadow-sm">
          <h5 class="fw-bold">📤 파일 업로드</h5>
          <form th:action="@{/shared/upload}" method="post" enctype="multipart/form-data">
            <div class="mb-3">
              <label for="file" class="form-label">파일 선택</label>
              <input class="form-control" type="file" name="file" id="file" required>
            </div>
            <div class="mb-3">
              <label for="folder" class="form-label">폴더 생성</label>
              <button type="button" onclick="createFolder()">📁 새폴더</button>
            </div>
            <button type="submit" class="btn btn-primary">업로드</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- ✅ 파일 업로드용 JS -->
  <script>
    function uploadFile(file) {
      if (!file) return;
      const formData = new FormData();
      formData.append("file", file);
      fetch("/shared/file/upload", {
        method: "POST",
        headers: {
          'header': document.querySelector('meta[name="_csrf_header"]').content,
          'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content
        },
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        alert(data.res_msg);
        if (data.res_code === "200") location.reload();
      })
      .catch(err => {
        console.error("파일 업로드 실패", err);
        alert("파일 업로드 중 오류 발생");
      });
    }
  </script>
  <script>
//폴더 생성
  function createFolder() {
    const folderName = prompt("새 폴더 이름을 입력하세요:");
    if (!folderName) return;

    const selectedId = $('#shared-tree').jstree('get_selected')[0];
    const parentFolderNo = selectedId || null;

    fetch("/shared/folder/create", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content
      },
      body: JSON.stringify({
        folderName: folderName,
        parentFolderNo: parentFolderNo,
  	 	memberNo: memberNo
      })
    })
    .then(res => res.json())
    .then(data => {
      alert(data.message);
      location.reload(); // 새로고침으로 트리 반영
    });
  }
  </script>
  <!-- ✅ 공통 JS -->
  <script th:src="@{/assets/js/vendor.min.js}"></script>
  <script th:src="@{/assets/libs/bootstrap/dist/js/bootstrap.bundle.min.js}"></script>
  <script th:src="@{/assets/libs/simplebar/dist/simplebar.min.js}"></script>
  <script th:src="@{/assets/js/theme/app.init.js}"></script>
  <script th:src="@{/assets/js/theme/theme.js}"></script>
  <script th:src="@{/assets/js/theme/app.min.js}"></script>
  <script th:src="@{/assets/js/theme/sidebarmenu.js}"></script>
  <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>
  <script th:src="@{/assets/libs/owl.carousel/dist/owl.carousel.min.js}"></script>
  <script th:src="@{/assets/libs/apexcharts/dist/apexcharts.min.js}"></script>
  <script th:src="@{/assets/js/dashboards/dashboard.js}"></script>

</th:block>
</html>
