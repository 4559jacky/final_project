<!DOCTYPE html>
<html lang="en" dir="ltr" data-bs-theme="light" data-color-theme="Blue_Theme" data-layout="horizontal"
xmlns:th="http://www.thymeleaf.org"
xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
layout:decorate="~{/include/layout}">
<th:block layout:fragment="content">

	<style>
		
  		#pos-list li {
			user-select: none;
			padding: 12px 16px;
			background-color: white;
			border: 1px solid #dee2e6;
			margin-bottom: 4px;
			border-radius: 4px;
			cursor: default;
		}

		#pos-list li.dragging {
			opacity: 0.5;
			background-color: #e9ecef;
		}
  		
  		li.empty-message {
			color: #6c757d;
			font-style: italic;
			padding: 8px;
			border-radius: 6px;
		}
		
		.drag-handle {
				cursor: grab;
				color: #6c757d;
				padding-left: 8px;
			}
		
		.dragging .drag-handle {
			cursor: grabbing;
		}
		
		.edit-btn,
		.save-btn,
		.cancel-btn,
		.delete-btn {
  			border-color: #ccc !important;
  			color: #666 !important;
  			background-color: transparent !important;
  			transition: all 0.3s ease;
		}

		.edit-btn:hover,
		.save-btn:hover,
		.cancel-btn:hover,
		.delete-btn:hover {
  			border-color: #999 !important;
  			color: #222 !important;
		}
		
	</style>

	<div class="page-titles mb-7 mb-md-5">
		<div class="row">
			<div class="col-lg-8 col-md-6 col-12 align-self-center">
				<nav aria-label="breadcrumb">
                	<ol class="breadcrumb align-items-center">
                		<li class="breadcrumb-item">
                    		<a class="text-muted text-decoration-none" th:href="@{/home}">
                     			<i class="ti ti-home fs-5"></i>
                    		</a>
                   	 	</li>
						<li class="breadcrumb-item" aria-current="page">Ïù∏ÏÇ¨ Í¥ÄÎ¶¨ / ÏßÅÍ∏â Í¥ÄÎ¶¨</li>
                  	</ol>
				</nav><br>
				<h2 class="mb-0 fw-bolder fs-8">ÏßÅÍ∏â Í¥ÄÎ¶¨</h2>
			</div><br>
		</div>
	</div>
	<div class="card">
        <div class="card-body">
        	<div class="tab-content" id="pills-tabContent">
            	<div class="tab-pane fade show active" id="pills-account" role="tabpanel" aria-labelledby="pills-account-tab" tabindex="0">
					<div class="row">
                    	<div class="col-lg-6 d-flex align-items-stretch">
                    		<div class="card w-100 border position-relative overflow-hidden">
                        		<div class="card-body p-4">
                          			<h4 class="card-title" style="font-weight: bold;">ÏßÅÍ∏â</h4>
                          			<p class="card-subtitle mb-4">To change the position order, please use drag and drop.</p>
                            		
                            		<th:block th:if="${posList != null}">
                            			<ul id="pos-list" class="list-group">
                            				<li th:each="pos : ${posList}"
                            					class="list-group-item d-flex align-items-center justify-content-start gap-2"
                            					th:attr="data-id=${pos.posNo}">
												
                            					<span class="drag-handle me-2" draggable="true" style="cursor: grab;">
													&#9776;
												</span>
												
      											<span class="pos-name flex-grow-1" th:text="${pos.posName}"></span>

      											<input type="text" class="edit-input form-control flex-grow-1 d-none" th:value="${pos.posName}" />
      											
      											<button class="edit-btn btn btn-sm btn-outline-primary">‚úèÔ∏è</button>
      											<button class="save-btn btn btn-sm btn-outline-success d-none">‚úÖ</button>
      											<button class="cancel-btn btn btn-sm btn-outline-danger d-none">‚ùå</button>
      											<button class="delete-btn btn btn-sm btn-outline-primary">üóëÔ∏è</button>
                            				</li>
											
                            			</ul>
                            		</th:block>
                            		<th:block th:if="${posList == null}">
										<ul class="list-group">
											<li class="empty-message">Îì±Î°ùÎêú ÏßÅÍ∏âÏù¥ ÏóÜÏäµÎãàÎã§.</li>
										</ul>
                            		</th:block>
  									
                        		</div>
                      		</div>
                   		</div>
                   		<div class="col-lg-6 d-flex align-items-stretch">
                    		<div class="card w-100 border position-relative overflow-hidden">
                        		<div class="card-body p-4">
                        			<form name="create_pos_form">
                          				<h4 class="card-title" style="font-weight: bold;">ÏßÅÍ∏â Îì±Î°ù</h4>
                          				<p class="card-subtitle mb-4">To register a new position, please provide the position details.</p>
                            			<div class="mb-3">
                              				<label for="pos_name" class="form-label">ÏßÅÍ∏âÎ™Ö*</label>
                              				<input type="text" class="form-control" id="pos_name" name="pos_name">
                            			</div>
                            			<div class="d-flex align-items-center justify-content-end gap-6">
                        					<button type="submit" class="btn btn-primary">Îì±Î°ù</button>
                        					<button type="reset" class="btn bg-danger-subtle text-danger" th:onclick="location.href='/'">Ï∑®ÏÜå</button>
                      					</div>
                      				</form>
                        		</div>
                      		</div>
                   		</div>
                  	</div>            	
                </div>
			</div>
		</div>
	</div>
	<script>
		// ÏßÅÍ∏â Îì±Î°ù Î°úÏßÅ
		const form = document.create_pos_form;
		form.addEventListener('submit',(event) => {
			event.preventDefault();
			
			// 1. Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
			let vali_chk = false;
			let vali_msg = "";
			
			if(!form.pos_name.value.trim()) {
				vali_msg += "ÏßÅÍ∏âÎ™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî";
				form.pos_name.focus();
			} else {
				vali_chk = true;
			}
			
			if(vali_chk == false) {
				alert(vali_msg);
			} else {
				// 2. ÏßÅÍ∏â Îì±Î°ù
				const payload = new FormData(form);
				
				fetch("/admin/pos/create", {
					method : "post",
					headers : {
						'header': document.querySelector('meta[name="_csrf_header"]').content,
						'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content
					},
					body : payload
				})
				.then(response => response.json())
				.then(data => {
					alert(data.res_msg);
					if(data.res_code == '200') {
						location.href = "/admin/pos/create";
					}
				})
				.catch(error => {
					console.log(error);
				})
			}
		});
	</script>
	
	<script>
		// ÎìúÎûòÍ∑∏ Ïï§ ÎìúÎûç Î°úÏßÅ
		document.addEventListener('DOMContentLoaded', () => {
			const list = document.getElementById('pos-list');
			if (!list) return;
			
			let draggingEle = null;
			
			// ÎìúÎûòÍ∑∏ ÏãúÏûë
			list.addEventListener('dragstart', (e) => {
				if (e.target.classList.contains('drag-handle')) {
					draggingEle = e.target.closest('li');
					draggingEle.classList.add('dragging');
				}
			});
			
			// ÎìúÎûòÍ∑∏ ÎÅù
			list.addEventListener('dragend', () => {
				if (draggingEle) {
					draggingEle.classList.remove('dragging');
					draggingEle = null;
					
					// ÏàúÏÑú Î∞∞Ïó¥ ÎßåÎì§Í∏∞ - Î¶¨Ïä§Ìä∏Í∞Ä ÏóÜÏùÑ Îïå Í±∏Îü¨Ï£ºÎäî Í≤ÉÍπåÏßÄ Ï∂îÍ∞Ä
					const orderedIds = [...list.children]
					.filter(li => li.dataset.id)
					.map((li, index) => ({
						posNo: Number(li.dataset.id),
						order: index + 1
					}));
					
					if (orderedIds.length === 0) return;
					
					// ÏàúÏÑú Ï†ÄÏû• ÏöîÏ≤≠
					fetch('/admin/pos/update/order', {
						method: 'post',
						headers: {
							'Content-Type': 'application/json',
							'header': document.querySelector('meta[name="_csrf_header"]').content,
							'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content
						},
						body: JSON.stringify(orderedIds)
					})
					.then(response => response.json())
					.then(data => {
						alert(data.res_msg);
						if(data.res_code == '200') {
							location.href = "/admin/pos/create";
						}
					})
					.catch(error => {
						console.log(error);
					});
				}
			});
			
			// ÎìúÎûòÍ∑∏ Ï§ëÏù∏ ÏöîÏÜå ÏúÑÏπò Ï°∞Ï†ï
			list.addEventListener('dragover', (e) => {
				e.preventDefault();

				const afterElement = getDragAfterElement(list, e.clientY);
				const dragging = document.querySelector('.dragging');
				
				if (!dragging) return;
				
				if (afterElement == null) {
					list.appendChild(dragging);
				} else {
					list.insertBefore(dragging, afterElement);
				}
			});
			
			// Í∏∞Ï§Ä ÏöîÏÜåÎ≥¥Îã§ ÏúÑÏóê ÏúÑÏπòÌïú Í∞ÄÏû• Í∞ÄÍπåÏö¥ ÏöîÏÜåÎ•º Ï∞æÏïÑÏïºÌï®
			function getDragAfterElement(container, y) {
				const items = [...container.querySelectorAll('li:not(.dragging)')];
				
				return items.reduce((closest, child) => {
					const box = child.getBoundingClientRect();
					const offset = y - box.top - box.height / 2;
					
					if (offset < 0 && offset > closest.offset) {
						return { offset, element: child };
					} else {
						return closest;
					}
				}, { offset: Number.NEGATIVE_INFINITY }).element;
			}
		});
	</script>
	
	<script>
		// ÏßÅÍ∏âÎ™Ö ÏàòÏ†ï Î°úÏßÅ
		document.addEventListener('DOMContentLoaded', function () {
		  	const posList = document.getElementById('pos-list');
			
		  	posList.querySelectorAll('li').forEach(li => {
		   	 	const posNameSpan = li.querySelector('.pos-name');
		    	const input = li.querySelector('.edit-input');
		    	const editBtn = li.querySelector('.edit-btn');
		    	const saveBtn = li.querySelector('.save-btn');
		    	const cancelBtn = li.querySelector('.cancel-btn');
				
		    	let originalValue = input.value;
				
		    	// ÏàòÏ†ï Î≤ÑÌäº ÌÅ¥Î¶≠
		    	editBtn.addEventListener('click', () => {
		      		posNameSpan.classList.add('d-none');
		      		input.classList.remove('d-none');
		      		input.focus();
					
		      		editBtn.classList.add('d-none');
		      		saveBtn.classList.remove('d-none');
		      		cancelBtn.classList.remove('d-none');
					
		      		originalValue = input.value;
		    	});
				
		    	// Ï†ÄÏû• Î≤ÑÌäº ÌÅ¥Î¶≠
		    	saveBtn.addEventListener('click', () => {
		      		const newName = input.value.trim();
		      		const posNo = li.dataset.id;
					
		      		if (!newName) {
		      			alert("ÏßÅÍ∏âÎ™ÖÏùÄ ÎπÑÏõåÎëò Ïàò ÏóÜÏäµÎãàÎã§.");
		        		input.focus();
		        		return;
		      		}

		      		// ÏÑúÎ≤ÑÏóê ÏóÖÎç∞Ïù¥Ìä∏ ÏöîÏ≤≠
		      		fetch(`/admin/pos/update/name`, {
		        		method: 'post',
		        		headers: {
							'Content-Type': 'application/json',
							'header': document.querySelector('meta[name="_csrf_header"]').content,
							'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content
		        		},
		        		body: JSON.stringify({
							posNo: Number(posNo),
							posName: newName
						})
		      		})
		        	.then(response => response.json())
		        	.then(data => {
		          		posNameSpan.textContent = newName;

		          		input.classList.add('d-none');
		         		posNameSpan.classList.remove('d-none');

		          		saveBtn.classList.add('d-none');
		          		cancelBtn.classList.add('d-none');
		          		editBtn.classList.remove('d-none');
		          		
						alert(data.res_msg);
						if(data.res_code == '200') {
							location.href = "/admin/pos/create";
						} else {
							location.href = "/admin/pos/create";
						}
		        	})
		        	.catch(error => {
		        		console.log(error);
		        	});
		    	});

		    	// Ï∑®ÏÜå Î≤ÑÌäº ÌÅ¥Î¶≠
		    	cancelBtn.addEventListener('click', () => {
		      		input.value = originalValue;

		      		input.classList.add('d-none');
		      		posNameSpan.classList.remove('d-none');

		      		saveBtn.classList.add('d-none');
		      		cancelBtn.classList.add('d-none');
		      		editBtn.classList.remove('d-none');
		    	});
		  	});
		});
	</script>
	
	<script>
		// ÏßÅÍ∏â ÏÇ≠Ï†ú Î°úÏßÅ
		document.addEventListener('DOMContentLoaded', function () {
			const posList = document.getElementById('pos-list');
			
			posList.querySelectorAll('li').forEach(li => {
				const deleteBtn = li.querySelector('.delete-btn');
				const posNo = li.dataset.id;
				
				deleteBtn.addEventListener('click', () => {
					if (!confirm("Ï†ïÎßê Ïù¥ ÏßÅÍ∏âÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) return;
					
					fetch("/admin/pos/delete", {
						method: "post",
						headers: {
							'Content-Type': 'application/json',
							'header': document.querySelector('meta[name="_csrf_header"]').content,
							'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content
						},
		        		body: JSON.stringify({
							posNo: Number(posNo)
						})
					})
					.then(response => response.json())
					.then(data => {
						alert(data.res_msg);
						if (data.res_code === '200') {
							li.remove();
							location.href = "/admin/pos/create";
						}
					})
					.catch(error => {
		        		console.log(error);
		        	});
				});
			});
		});
	</script>
</th:block>
</html>