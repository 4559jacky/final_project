<!DOCTYPE html>
<html lang="en" dir="ltr" th:attr="data-bs-theme=${theme}, data-color-theme=${latestProfile != null ? latestProfile.theme_color : 'Blue_Theme'}" data-layout="horizontal" data-boxed-layout="boxed" data-card="shadow" data-sidebartype="mini-sidebar"
xmlns:th="http://www.thymeleaf.org"
xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
	<!-- Required meta tags -->
	<meta charset="UTF-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	
	<!-- Spring Security -->
	<meta id="_csrf" name="_csrf" th:attr="content=${_csrf.token}">
	<meta id="_csrf_header" name="_csrf_header" th:attr="content=${_csrf.headerName}">
	
	<!-- Favicon icon-->
	<link rel="shortcut icon" type="image/png" th:href="@{/assets/images/logos/favicon.ico}" />
	
	<title>Groupware</title>
	
	<!-- Core Css -->
	<link rel="stylesheet" th:href="@{/assets/css/styles.css}" />
	
	<!-- Owl Carousel  -->
	<link rel="stylesheet" th:href="@{/assets/libs/owl.carousel/dist/assets/owl.carousel.min.css}" />
	
	<!-- Custom Css Files -->
	<link rel="stylesheet" th:href="@{/css/layout-common.css}" />
	<link rel="stylesheet" th:href="@{/css/layout-media.css}" />
	
	<!-- alarm css file -->
	<link  rel="stylesheet" th:href="@{/css/alarm.css}">
  	
</head>
<body>
	<!-- í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ì› ì‚¬ë²ˆ  -->
	<input type="hidden" id="member_no" th:value="${#authentication.principal.member.memberNo}">
	
	<!-- Preloader Start -->
  	<div class="preloader">
    	<img th:src="@{/assets/images/logos/preloader.svg}" alt="loader" class="lds-ripple img-fluid" />
  	</div>
  	<!-- Preloader End -->
	
  	<div class="page-wrapper" style="position: fixed; top: 0; width: 100%; z-index: 10; height: 45px;">
		<th:block th:replace="~{include/header :: headerLayout}"></th:block>
	</div>
	
	<div id="nav-wrapper" style="position: fixed; top: 45px; padding-top: 45px; z-index: 9; width: 100%;">
		<th:block th:replace="~{include/nav :: navLayout}"></th:block>
	</div>
	
	<div class="body-wrapper" style="padding-top: 45px;">
        <div class="container-fluid">
			<th:block layout:fragment="content"></th:block>
			<th:block layout:fragment="scripts"></th:block>
		</div>
	</div>
	
    
    <div class="dark-transparent sidebartoggler"></div>
	
	<!-- ì±„íŒ… ì•Œë¦¼ ëª¨ë‹¬ -->
	<div id="chatAlertToast" class="position-fixed end-0 bottom-0 m-4 p-3 shadow-lg rounded-3 border bg-white text-dark d-none" style="width: 320px; z-index: 1080;">
	  <div class="fw-bold text-primary mb-2">[ì±„íŒ… ì•Œë¦¼] ìƒˆë¡œìš´ ë©”ì‹œì§€ê°€ ë„ì°©í–ˆìŠµë‹ˆë‹¤.</div>
	  <div><strong>ì œëª©:</strong> <span id="toast-chat-title">-</span></div>
	  <div><strong>ë³´ë‚¸ ì‚¬ëŒ:</strong> <span id="toast-sender-name">-</span></div>
	  <div><strong>ë‚´ìš©:</strong> <span id="toast-msg-content">-</span></div>
	  <input type="hidden" id="toast-room-no" />
	</div>


	
	<!-- ì „ìê²°ì¬ ì•Œë¦¼ ëª¨ë‹¬ -->
	<div id="approval-alert-toast" class="d-none" style="
	  position: fixed;
	  bottom: 30px;
	  right: 30px;
	  background: white;
	  border: 2px solid #0d6efd;
	  padding: 20px;
	  z-index: 99999;
	  display: block;
	  opacity: 1;
	">
	  <strong>[ì „ìê²°ì¬ ë„ì°©]</strong><br>
	  <span id="approval-toast-title">í…ŒìŠ¤íŠ¸ ì œëª©</span><br>
	  <span id="approval-toast-sender">í™ê¸¸ë™</span><br>
	  <span id="approval-toast-msg">ìƒˆë¡œìš´ ê²°ì¬ê°€ ìˆìŠµë‹ˆë‹¤</span>
	</div>
	
	
	
	<!-- ğŸ—³ï¸ íˆ¬í‘œ ë§ˆê° ì•Œë¦¼ í† ìŠ¤íŠ¸ 2025-05-14(ìˆ˜ìš”ì¼)-->
	<div id="vote-alert-toast" class="d-none" style="
  		position: fixed;
  		bottom: 30px;
  		right: 30px;
  		background: #fffbe6;
  		border: 2px solid #ffc107;
  		padding: 24px 28px;
  		z-index: 99999;
  		border-radius: 14px;
  		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  		font-size: 1.1rem;
  		line-height: 1.6rem;
  		width: 340px;
  		max-width: 90%;">
  	<strong style="font-size: 1.2rem;">[íˆ¬í‘œ ë§ˆê°]</strong><br>
  	<span id="vote-toast-title" style="font-weight: bold; font-size: 1.15rem;">íˆ¬í‘œ ì œëª©</span><br>
  	<span id="vote-toast-sender" style="color: #333;">ì‘ì„±ì</span><br>
  	<span id="vote-toast-msg">ë§ˆê° ë©”ì‹œì§€</span>
	</div>
	

	<!-- Common JS Files -->
  
    <!-- jsTree -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>
	<script th:src="@{/js/jji/jstree.js}"></script>
	<script th:src="@{/js/ysw/jstree.js}"></script>
	
	<script th:src="@{/js/dark-cookie.js}"></script>
	
	<!-- WebSocket STOMP ì—°ê²° --> 
	<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
	
	<script>
		let stompClient = null;
		const myNo = document.getElementById("member_no").value;
	
		window.addEventListener("load", () => {
		  const socket = new SockJS("/ws-chat");
		  stompClient = Stomp.over(socket);
	
		  stompClient.connect({}, () => {
		    console.log("ğŸ“¡ STOMP WebSocket ì—°ê²° ì„±ê³µ");

		    
		    
		////////////////////////////////////////////////////// ì±„íŒ… ì›¹ì†Œìº£ //////////////////////////////////////////////////////////////////////////////
		    // ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ë“±ë¡
		    stompClient.send("/app/chat/session-register", {}, JSON.stringify({
		        memberNo: myNo
		      }));
		    
		    // íˆ¬í‘œ ë§ˆê° ì•Œë¦¼ 2025-05-14(ìˆ˜ìš”ì¼)
		    const voteNo = document.getElementById("voteForm")?.getAttribute("data-vote-no");
		    if (voteNo && myNo) {
		      fetch(`/vote/${voteNo}/should-alert?memberNo=${myNo}`);
		    }
	
		    // ì±„íŒ…ë°© ìƒì„± ì‹¤ì‹œê°„ ë°˜ì˜
		    stompClient.subscribe("/topic/chat/room/new", (message) => {
		      const newRoom = JSON.parse(message.body);
		      if (typeof appendNewChatRoom === "function") {
		        appendNewChatRoom(newRoom);
		      }
		    });
	
		    // ë§ˆì§€ë§‰ ë©”ì‹œì§€/ì‹œê°„ ì‹¤ì‹œê°„ ë°˜ì˜
		    stompClient.subscribe("/topic/chat/room/update", (message) => {
		      const update = JSON.parse(message.body);
		      if (typeof updateChatRoomList === "function") {
		        updateChatRoomList(update);
		      }
		    });
	
		    // ì•ˆ ì½ì€ ë©”ì‹œì§€ ìˆ˜ â†’ chat.htmlë¡œ ìœ„ì„
		    stompClient.subscribe("/topic/chat/unread", (message) => {
		      const dto = JSON.parse(message.body);
	
		      if (typeof onUnreadMessage === "function") {
		        onUnreadMessage(dto);
		      }
		    });

		    // ë‚˜ê°€ê¸° ì‹¤ì‹œê°„ ë°˜ì˜ 
		    stompClient.subscribe("/topic/chat/room/exit", (msg) => {
			  const dto = JSON.parse(msg.body);
			
			  if (typeof window.onChatMemberExit === "function") {
			    window.onChatMemberExit(dto);  // âœ… dto.chat_room_noë¡œ ì²˜ë¦¬
			  }
			});
		    
		    // ì±„íŒ… ì•Œë¦¼ 
		    const path = window.location.pathname;
		    if (!path.includes("/chat")) {
		      stompClient.subscribe(`/topic/chat/alarm/${myNo}`, (msg) => {
		        const dto = JSON.parse(msg.body);
		        showChatAlertToast(dto);
		      });
		      
		////////////////////////////////////////////////////// ì „ì ê²°ì¬  ì›¹ì†Œìº£ //////////////////////////////////////////////////////////////////////////////
		      
		   	  // ì „ìê²°ì¬ ì•Œë¦¼
		      stompClient.subscribe(`/topic/approval/alarm/${myNo}`, (msg) => {
		    	    const dto = JSON.parse(msg.body);
		    	    console.log("ì „ìê²°ì¬ ì•Œë¦¼ ë„ì°©:", dto);
		    	    showApprovalAlertToast(dto);
		      });
		   	  
		   	  // íˆ¬í‘œ ë§ˆê° ì•Œë¦¼ 2025-05-14(ìˆ˜ìš”ì¼)
		      stompClient.subscribe(`/topic/vote/alarm/${myNo}`, (msg) => {
		        const dto = JSON.parse(msg.body);
		        console.log("ğŸ—³ï¸ íˆ¬í‘œ ë§ˆê° ì•Œë¦¼ ë„ì°©:", dto);
		        showVoteAlertToast(dto.title, dto.senderName, dto.message);
		      });
		      
		    }

		  }, (error) => {
		    console.error("STOMP ì—°ê²° ì‹¤íŒ¨", error);
		  });
		});
		

		//////////////////////////////////////////////////////ì „ì ê²°ì¬  ì•Œë¦¼ ëª¨ë‹¬  //////////////////////////////////////////////////////////////////////////////
		 
		// ì „ìê²°ì¬ ì•Œë¦¼ í† ìŠ¤íŠ¸ ëª¨ë‹¬
		function showApprovalAlertToast(dto) {
	
		    const wrapper = document.getElementById("approval-alert-toast");
		    if (!wrapper) return;
		
		    // ë‚´ìš© ì„¸íŒ…
		    document.getElementById("approval-toast-title").textContent = dto.title || "ì „ìê²°ì¬";
		    document.getElementById("approval-toast-sender").textContent = dto.senderName || "";
		    document.getElementById("approval-toast-msg").textContent = dto.message || "";
		
		    // ëª¨ë‹¬ í‘œì‹œ
		    wrapper.classList.remove("d-none");
		
		    // ìë™ ë‹«ê¸° (5ì´ˆ í›„)
		    setTimeout(() => {
		      wrapper.classList.add("d-none");
		    }, 5000);
		  }
		
		// íˆ¬í‘œ ë§ˆê° 2025-05-14(ìˆ˜ìš”ì¼)
		function showVoteAlertToast(title, senderName, msg) {
			  const wrapper = document.getElementById("vote-alert-toast");
			  if (!wrapper) return;

			  document.getElementById("vote-toast-title").textContent = title || "íˆ¬í‘œ";
			  document.getElementById("vote-toast-sender").textContent = senderName || "";
			  document.getElementById("vote-toast-msg").textContent = msg || "íˆ¬í‘œê°€ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤.";

			  wrapper.classList.remove("d-none");
			  wrapper.classList.remove("active");
			  void wrapper.offsetWidth;
			  wrapper.classList.add("active");

			  setTimeout(() => {
			    wrapper.classList.add("d-none");
			  }, 5000);
			}
	
	  function closeApprovalToast() {
	    const wrapper = document.getElementById("approval-alert-toast");
	    wrapper.classList.remove("active");
	    wrapper.classList.add("d-none");
	  }
	  

	  
		////////////////////////////////////////////////////// ì±„íŒ… ì•Œë¦¼ -> ì±„íŒ…ë°© ì§„ì…  //////////////////////////////////////////////////////////////////////////////
	  
		
		// ì±„íŒ… í—¤ë” ì•Œë¦¼ ì‹¤ì‹œê°„ ë°˜ì˜ 
		function increaseAlarmBadge() {
		  const btns = document.querySelectorAll("#chatAlarmBtn"); // âœ… ëª¨ë“  í™”ë©´ì— ëŒ€ì‘
		
		  btns.forEach(btn => {
		    let badge = btn.querySelector(".chat-popup-badge");
		
		    if (!badge) {
		      badge = document.createElement("span");
		      badge.className = "popup-badge rounded-pill bg-danger text-white fs-2";
		      badge.textContent = "1";
		      btn.appendChild(badge);
		    } else {
		      let count = parseInt(badge.textContent.trim() || "0", 10);
		      badge.textContent = ++count;
		    }
		  });
		}

		function prependAlarmToDropdown(dto) {
			  const dropdowns = document.querySelectorAll(".chat-message-body");
			  if (!dropdowns.length) return;

			  dropdowns.forEach(dropdown => {
			    dropdown.style.display = "block";

			    const link = document.createElement("a");
			    link.href = "javascript:void(0)";
			    link.classList.add("dropdown-item", "py-6", "px-7", "d-flex", "align-items-center");
			    link.setAttribute("data-room-no", dto.chat_room_no);

			    link.innerHTML = `
			      <div class="w-100">
			        <h6 class="mb-0 fs-4 lh-base">${dto.chat_room_title || "ì±„íŒ…ë°©"}</h6>
			        <span class="fs-3 d-block text-body-secondary">${dto.member_name} : ${dto.chat_msg_content || "ìƒˆë¡œìš´ ë©”ì‹œì§€"}</span>
			      </div>
			    `;

			    dropdown.prepend(link);
			  });
			}

		// ì•Œë¦¼ í† ìŠ¤íŠ¸ ëª¨ë‹¬ 
		function showChatAlertToast(dto) {
		  console.log("ğŸ”¥ ëª¨ë‹¬ í•¨ìˆ˜ ì§„ì…", dto);
		
		  // ê°’ ì„¸íŒ…
		  document.getElementById("toast-room-no").value = dto.chat_room_no;
		  document.getElementById("toast-sender-name").textContent = `${dto.member_name} ${dto.member_pos_name}`;
		  document.getElementById("toast-msg-content").textContent = dto.chat_msg_content;
		  document.getElementById("toast-chat-title").textContent = dto.chat_room_title || "ì œëª© ì—†ìŒ";
		
		  const toastEl = document.getElementById("chatAlertToast");
		  toastEl.classList.remove("d-none");
		  
		
		  setTimeout(() => {
			    increaseAlarmBadge();
			    prependAlarmToDropdown(dto);
			  }, 100);

			  setTimeout(() => {
			    toastEl.classList.add("d-none");
			  }, 5000);
		
		  // 5ì´ˆ ë’¤ ì‚¬ë¼ì§
		  setTimeout(() => {
		    toastEl.classList.add("d-none");
		  }, 5000);
		}
		
		
		document.addEventListener("DOMContentLoaded", () => {
			// ì•Œë¦¼ í´ë¦­ ì‹œ ì±„íŒ…ë°© ì´ë™ 
			document.addEventListener("click", function (e) {
			  const item = e.target.closest(".dropdown-item");
			  if (!item) return;
			
			  const roomNo = item.dataset.roomNo;
			  if (roomNo) {
			    console.log("ğŸ”¥ ì•Œë¦¼ í´ë¦­ë¨! â†’ ì´ë™: ", roomNo);
			    sessionStorage.setItem("enterRoomNo", roomNo); // âœ… ì €ì¥
			    window.location.href = `/chat`;
			  }
			});
			
			// í—¤ë” ì•Œë¦¼ ì¡°íšŒ
			if (!myNo) return;

			  const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;
			  const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;

			  fetch(`/chat/alarm/list/${myNo}`, {
			    method: "POST",
			    headers: {
			      "Content-Type": "application/json",
			      [csrfHeader]: csrfToken
			    }
			  })
			  .then(res => res.json())
			  .then(data => {
			     renderChatAlarms(data); 

			  })
			  .catch(err => {
			    console.error("ì•Œë¦¼ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
			  });
			  
			  function renderChatAlarms(list) {
				  const dropdowns = document.querySelectorAll(".chat-message-body");
				  const btns = document.querySelectorAll("#chatAlarmBtn");

				  btns.forEach(btn => {
				    let badge = btn.querySelector(".chat-popup-badge");
				    if (!badge) {
				      badge = document.createElement("span");
				      badge.className = "chat-popup-badge position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger text-white";
				      btn.appendChild(badge);
				    }
				    badge.textContent = list.length;
				    badge.style.display = list.length > 0 ? "inline-block" : "none";
				  });

				  // dropdownì— ì•Œë¦¼ ëª©ë¡ í‘œì‹œ
				  dropdowns.forEach(dropdown => {
				    dropdown.innerHTML = "";
				    dropdown.style.display = "block";

				    if (list.length === 0) {
				      dropdown.innerHTML = `<div class="px-3 py-2 text-muted">ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
				      return;
				    }

				    list.forEach(alarm => {
				      const chatRoomName = alarm.chat_room_name || "ì±„íŒ…ë°©";
				      const sender = `${alarm.sender_name || ''} ${alarm.sender_pos_name || ''}`;
				      const content = alarm.chat_msg_content || "ìƒˆë¡œìš´ ë©”ì‹œì§€ê°€ ë„ì°©í–ˆìŠµë‹ˆë‹¤.";

				      const link = document.createElement("a");
				      link.href = "javascript:void(0)";
				      link.className = "py-6 px-7 d-flex align-items-center dropdown-item";
				      link.setAttribute("data-room-no", alarm.chat_room_no);

				      link.innerHTML = `
				        <div class="w-100">
				          <h6 class="mb-0 fs-4 lh-base">${chatRoomName}</h6>
				          <span class="fs-3 d-block text-body-secondary">${sender} : ${content}</span>
				        </div>
				      `;

				      dropdown.appendChild(link);
				    });
				  });
				}

		  });


	</script>

</body>
</html>