<!DOCTYPE html>
<html lang="en" dir="ltr" th:attr="data-bs-theme=${theme}, data-color-theme=${latestProfile != null ? latestProfile.theme_color : 'Blue_Theme'}" data-layout="horizontal" data-boxed-layout="boxed" data-card="shadow" data-sidebartype="mini-sidebar"
xmlns:th="http://www.thymeleaf.org"
xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
	<!-- Required meta tags -->
	<meta charset="UTF-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	
	<!-- Spring Security -->
	<meta id="_csrf" name="_csrf" th:attr="content=${_csrf.token}">
	<meta id="_csrf_header" name="_csrf_header" th:attr="content=${_csrf.headerName}">
	
	<!-- Favicon icon-->
	<link rel="shortcut icon" type="image/png" th:href="@{/assets/images/logos/favicon.ico}" />
	
	<title>Groupware</title>
	
	<!-- Core Css -->
	<link rel="stylesheet" th:href="@{/assets/css/styles.css}" />
	
	<!-- Owl Carousel  -->
	<link rel="stylesheet" th:href="@{/assets/libs/owl.carousel/dist/assets/owl.carousel.min.css}" />
	
	<!-- Custom Css Files -->
	<link rel="stylesheet" th:href="@{/css/layout-common.css}" />
	<link rel="stylesheet" th:href="@{/css/layout-media.css}" />
	
	<!-- alarm css file -->
	<link  rel="stylesheet" th:href="@{/css/alarm.css}">
  	
</head>
<body>
	<!-- í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ì› ì‚¬ë²ˆ  -->
	<input type="hidden" id="member_no" th:value="${#authentication.principal.member.memberNo}">
	
	<!-- Preloader Start -->
  	<div class="preloader">
    	<img th:src="@{/assets/images/logos/preloader.svg}" alt="loader" class="lds-ripple img-fluid" />
  	</div>
  	<!-- Preloader End -->
	
  	<div class="page-wrapper" style="position: fixed; top: 0; width: 100%; z-index: 10; height: 45px;">
		<th:block th:replace="~{include/header :: headerLayout}"></th:block>
	</div>
	
	<div id="nav-wrapper" style="position: fixed; top: 45px; padding-top: 45px; z-index: 9; width: 100%;">
		<th:block th:replace="~{include/nav :: navLayout}"></th:block>
	</div>
	
	<div class="body-wrapper" style="padding-top: 45px;">
        <div class="container-fluid">
			<th:block layout:fragment="content"></th:block>
			<th:block layout:fragment="scripts"></th:block>
		</div>
	</div>
	
    
    <div class="dark-transparent sidebartoggler"></div>
	
	<!-- ì±„íŒ… ì•Œë¦¼ ëª¨ë‹¬ -->
	<div id="chatAlertToast" class="position-fixed end-0 bottom-0 m-4 p-3 shadow-lg rounded-3 border bg-white text-dark d-none" style="width: 320px; z-index: 1080;">
	  <div class="fw-bold text-primary mb-2">[ì•Œë¦¼] ì±„íŒ… </div>
	  <div><strong><span id="toast-chat-title">-</span></strong></div>
	  <div> <span id="toast-sender-name">-</span> : <span id="toast-msg-content">-</span></div>
	  <input type="hidden" id="toast-room-no" />
	</div>


	
	<!-- ì „ìê²°ì¬ ì•Œë¦¼ ëª¨ë‹¬ -->
	<div id="approval-alert-toast" class="d-none" style="
	  position: fixed;
	  bottom: 30px;
	  right: 30px;
	  background: white;
	  border: 2px solid #0d6efd;
	  padding: 20px;
	  z-index: 99999;
	  display: block;
	  opacity: 1;
	">
	  <strong>[ì•Œë¦¼]</strong><br>
	  <span id="approval-toast-title">í…ŒìŠ¤íŠ¸ ì œëª©</span><br>
	  <span id="approval-toast-msg">ìƒˆë¡œìš´ ê²°ì¬ê°€ ìˆìŠµë‹ˆë‹¤</span>
	</div>
	
	
	
	<!-- ğŸ—³ï¸ íˆ¬í‘œ ë§ˆê° ì•Œë¦¼ í† ìŠ¤íŠ¸ 2025-05-14(ìˆ˜ìš”ì¼)-->
	<div id="vote-alert-toast" class="d-none" style="
  		position: fixed;
  		bottom: 30px;
  		right: 30px;
  		background: #fffbe6;
  		border: 2px solid #ffc107;
  		padding: 24px 28px;
  		z-index: 99999;
  		border-radius: 14px;
  		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  		font-size: 1.1rem;
  		line-height: 1.6rem;
  		width: 340px;
  		max-width: 90%;">
  	<strong style="font-size: 1.2rem;">[íˆ¬í‘œ ë§ˆê°]</strong><br>
  	<span id="vote-toast-title" style="font-weight: bold; font-size: 1.15rem;">íˆ¬í‘œ ì œëª©</span><br>
  	<span id="vote-toast-sender" style="color: #333;">ì‘ì„±ì</span><br>
  	<span id="vote-toast-msg">ë§ˆê° ë©”ì‹œì§€</span>
	</div>
	
	
	<!-- âœ… ì»¤ìŠ¤í…€ alert ëª¨ë‹¬ -->
	<div class="modal fade" id="customAlertModal" tabindex="-1" aria-hidden="true">
	  <div class="modal-dialog modal-dialog-centered">
	    <div class="modal-content border-0 shadow-sm rounded-4 px-4 py-3" style="max-width: 400px;">
	      <div class="d-flex justify-content-end">
	        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
	      </div>
	      <div class="modal-body text-center text-body">
	        <p id="customAlertMsg" class="fs-5 mb-4">ì•Œë¦¼ ë‚´ìš©</p>
	        <button type="button" class="btn btn-primary px-4" data-bs-dismiss="modal">í™•ì¸</button>
	      </div>
	    </div>
	  </div>
	</div>
	
	<!-- âœ… ì»¤ìŠ¤í…€ confirm ëª¨ë‹¬ -->
	<div class="modal fade" id="customConfirmModal" tabindex="-1" aria-hidden="true">
	  <div class="modal-dialog modal-dialog-centered">
	    <div class="modal-content border-0 shadow-sm rounded-4 px-4 py-3" style="max-width: 400px;">
	      <div class="d-flex justify-content-end">
	        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
	      </div>
	      <div class="modal-body text-center text-body">
	        <p id="customConfirmMsg" class="fs-5 mb-4">ì •ë§ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
	        <div class="d-flex justify-content-center gap-3">
	          <button type="button" id="confirmYesBtn" class="btn btn-primary px-4">í™•ì¸</button>
	          <button type="button" class="btn btn-danger px-4" data-bs-dismiss="modal">ì·¨ì†Œ</button>
	        </div>
	      </div>
	    </div>
	  </div>
	</div>

	<!-- Common JS Files -->
  
    <!-- jsTree -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>
	<script th:src="@{/js/jji/jstree.js}"></script>
	<script th:src="@{/js/ysw/jstree.js}"></script>
	
	<script th:src="@{/js/dark-cookie.js}"></script>
	
	<!-- WebSocket STOMP ì—°ê²° --> 
	<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
	
	<script>
		let stompClient = null;
		const myNo = document.getElementById("member_no").value;
	
		window.addEventListener("load", () => {
		  const socket = new SockJS("/ws-chat");
		  stompClient = Stomp.over(socket);
	
		  stompClient.connect({}, () => {
		    console.log("ğŸ“¡ STOMP WebSocket ì—°ê²° ì„±ê³µ");

		    

		////////////////////////////////////////////////////// ì±„íŒ… ì›¹ì†Œìº£ //////////////////////////////////////////////////////////////////////////////
		    // ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ë“±ë¡
		    stompClient.send("/app/chat/session-register", {}, JSON.stringify({
		        memberNo: myNo
		      }));
		    
	
		    // ì±„íŒ…ë°© ìƒì„± ì‹¤ì‹œê°„ ë°˜ì˜
		    stompClient.subscribe("/topic/chat/room/new", (message) => {
		      const newRoom = JSON.parse(message.body);
		      if (typeof appendNewChatRoom === "function") {
		        appendNewChatRoom(newRoom);
		      }
		    });
	
		    // ë§ˆì§€ë§‰ ë©”ì‹œì§€/ì‹œê°„ ì‹¤ì‹œê°„ ë°˜ì˜
		    stompClient.subscribe("/topic/chat/room/update", (message) => {
		      const update = JSON.parse(message.body);
		      if (typeof updateChatRoomList === "function") {
		        updateChatRoomList(update);
		      }
		      if (typeof updateHomeChatPreview === "function") {
	    	    updateHomeChatPreview(update); // home.html ì „ìš©
	    	  }
		    });
	
		    // ì•ˆ ì½ì€ ë©”ì‹œì§€ ìˆ˜ â†’ chat.htmlë¡œ ìœ„ì„
		    stompClient.subscribe("/topic/chat/unread", (message) => {
		      const dto = JSON.parse(message.body);
	
		    	 
		      if (typeof onUnreadMessage === "function") {
		        onUnreadMessage(dto);
		      }
		    });

		    // ë‚˜ê°€ê¸° ì‹¤ì‹œê°„ ë°˜ì˜ 
		    stompClient.subscribe("/topic/chat/room/exit", (msg) => {
			  const dto = JSON.parse(msg.body);
			
			  if (typeof window.onChatMemberExit === "function") {
			    window.onChatMemberExit(dto);  // âœ… dto.chat_room_noë¡œ ì²˜ë¦¬
			  }
			});
		    
		    // ì±„íŒ… ì•Œë¦¼ 
		    const path = window.location.pathname;
		    if (!path.includes("/chat")) {
		      stompClient.subscribe(`/topic/chat/alarm/${myNo}`, (msg) => {
		        const dto = JSON.parse(msg.body);
		        showChatAlertToast(dto);
		      });
		      
		////////////////////////////////////////////////////// ì „ì ê²°ì¬  ì›¹ì†Œìº£ //////////////////////////////////////////////////////////////////////////////
		      
		   	  // ì „ìê²°ì¬ ì•Œë¦¼
		      stompClient.subscribe(`/topic/approval/alarm/${myNo}`, (msg) => {
		    	    const dto = JSON.parse(msg.body);
		    	    console.log("ì „ìê²°ì¬ ì•Œë¦¼ ë„ì°©:", dto);
		    	    showApprovalAlertToast(dto);
		      });
		   	  
  		
			}
		  }, (error) => {
		    console.error("STOMP ì—°ê²° ì‹¤íŒ¨", error);
		  });
		});
		

		//////////////////////////////////////////////////////ì „ì ê²°ì¬  ì•Œë¦¼ ëª¨ë‹¬  //////////////////////////////////////////////////////////////////////////////
		 
		// ì „ìê²°ì¬ ì•Œë¦¼ í† ìŠ¤íŠ¸ ëª¨ë‹¬
		function showApprovalAlertToast(dto) {
	
		    const wrapper = document.getElementById("approval-alert-toast");
		    if (!wrapper) return;
		
		    // ë‚´ìš© ì„¸íŒ…
		    document.getElementById("approval-toast-title").textContent = dto.title || "ì „ìê²°ì¬";
		    document.getElementById("approval-toast-msg").textContent = dto.message || "";
		
		    // ëª¨ë‹¬ í‘œì‹œ
		    wrapper.classList.remove("d-none");
		    
		    setTimeout(() => {
			    prependOtherAlarmToDropdown(dto);
			}, 100);
		
		    // ìë™ ë‹«ê¸° (5ì´ˆ í›„)
		    setTimeout(() => {
		      wrapper.classList.add("d-none");
		    }, 5000);
		  }

	  function closeApprovalToast() {
	    const wrapper = document.getElementById("approval-alert-toast");
	    wrapper.classList.remove("active");
	    wrapper.classList.add("d-none");
	  }
	  
		////////////////////////////////////////////////////// ì±„íŒ… ì•Œë¦¼ -> ì±„íŒ…ë°© ì§„ì…  //////////////////////////////////////////////////////////////////////////////
	  
		
		// ì±„íŒ… í—¤ë” ì•Œë¦¼ ì‹¤ì‹œê°„ ë°˜ì˜ 
		function increaseAlarmBadge() {
		  const btns = document.querySelectorAll("#chatAlarmBtn");
		
		  btns.forEach(btn => {
		    let badge = btn.querySelector(".chat-popup-badge");
		
		    if (!badge) {
		      // âœ… ìƒˆë¡œìš´ ë±ƒì§€ ìƒì„± ì‹œ ìœ„ì¹˜ ë° ìŠ¤íƒ€ì¼ í™•ì‹¤í•˜ê²Œ ì„¸íŒ…
		      badge = document.createElement("span");
		      badge.className = "chat-popup-badge position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger text-white";
		      badge.textContent = "1";
		      btn.appendChild(badge);
		    } else {
		      let count = parseInt(badge.textContent.trim() || "0", 10);
		      badge.textContent = ++count;
		      badge.style.display = "inline-block"; // í˜¹ì‹œ ìˆ¨ê²¨ì ¸ ìˆì—ˆìœ¼ë©´ ë³´ì—¬ì¤Œ
		    }
		  });
		}


		function prependAlarmToDropdown(dto) {
			  const dropdowns = document.querySelectorAll(".chat-message-body");
			  if (!dropdowns.length) return;

			  dropdowns.forEach(dropdown => {
			    dropdown.style.display = "block";

			    // âœ… ê¸°ì¡´ "ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤." ë¬¸êµ¬ ì œê±°
			    const noAlarmMsg = dropdown.querySelector(".no-alarm-message");
			    if (noAlarmMsg) noAlarmMsg.remove();

			    const link = document.createElement("a");
			    link.href = "javascript:void(0)";
			    link.classList.add("dropdown-item", "py-6", "px-7", "d-flex", "align-items-center");
			    link.setAttribute("data-room-no", dto.chat_room_no);

			    link.innerHTML = `
			      <div class="w-100">
			        <h6 class="mb-0 fs-4 lh-base">${dto.chat_room_title || "ì±„íŒ…ë°©"}</h6>
			        <span class="fs-3 d-block text-body-secondary">${dto.member_name} : ${dto.chat_alarm_content || "ìƒˆë¡œìš´ ë©”ì‹œì§€"}</span>
			      </div>
			    `;

			    dropdown.prepend(link);
			  });
			}

		// ì•Œë¦¼ í† ìŠ¤íŠ¸ ëª¨ë‹¬ 
		function showChatAlertToast(dto) {
		  console.log("ğŸ”¥ ëª¨ë‹¬ í•¨ìˆ˜ ì§„ì…", dto);
		
		  // ê°’ ì„¸íŒ…
		  document.getElementById("toast-room-no").value = dto.chat_room_no;
		  document.getElementById("toast-sender-name").textContent = `${dto.member_name} ${dto.member_pos_name}`;
		  document.getElementById("toast-msg-content").textContent = dto.chat_msg_content;
		  document.getElementById("toast-chat-title").textContent = dto.chat_room_title || "ì œëª© ì—†ìŒ";
		
		  const toastEl = document.getElementById("chatAlertToast");
		  toastEl.classList.remove("d-none");
		  
		
		  setTimeout(() => {
			    increaseAlarmBadge();
			    prependAlarmToDropdown(dto);
			  }, 100);

			  setTimeout(() => {
			    toastEl.classList.add("d-none");
			  }, 5000);
		
		  // 5ì´ˆ ë’¤ ì‚¬ë¼ì§
		  setTimeout(() => {
		    toastEl.classList.add("d-none");
		  }, 5000);
		}
		
		
		document.addEventListener("DOMContentLoaded", () => {
			
			// ì•Œë¦¼ í´ë¦­ ì‹œ ì±„íŒ…ë°© ì´ë™ 
			document.addEventListener("click", function (e) {
			  const item = e.target.closest(".dropdown-item");
			  if (!item) return;
			
			  const roomNo = item.dataset.roomNo;
			  if (roomNo) {
			    console.log("ğŸ”¥ ì•Œë¦¼ í´ë¦­ë¨! â†’ ì´ë™: ", roomNo);
				// ì•Œë¦¼ í´ë¦­ ì‹œ ì‚­ì œ 
				if (roomNo) {
				  console.log("ğŸ”¥ ì•Œë¦¼ í´ë¦­ë¨! â†’ ì´ë™: ", roomNo);
				  sessionStorage.setItem("enterRoomNo", roomNo); // âœ… ì €ì¥
				
				  // âœ… ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬ ìš”ì²­
				  fetch(`/chat/alarm/read/${roomNo}`, {
				    method: "POST",
				    headers: {
				      "Content-Type": "application/json",
				      [csrfHeader]: csrfToken
				    },
				    body: JSON.stringify({ memberNo: myNo })
				  })
				  .then(res => res.json())
				  .then(data => {
				    // âœ… í•´ë‹¹ ì±„íŒ…ë°© ì•Œë¦¼ DOM ì‚­ì œ
				    document.querySelectorAll(`.chat-message-body .dropdown-item[data-room-no="${roomNo}"]`).forEach(el => el.remove());
				
				    // âœ… ë±ƒì§€ ìˆ«ì ê°±ì‹ 
				    const badge = document.querySelector("#chatAlarmBtn .chat-popup-badge");
				    if (badge) {
				      let count = parseInt(badge.textContent || "0", 10);
				      let removed = data.removedCount || 0;
				      count = Math.max(0, count - removed);
				      badge.textContent = count;
				      if (count === 0) badge.style.display = "none";
				    }
				
				    // âœ… ì•Œë¦¼ ë¹„ì—ˆìœ¼ë©´ ë¬¸êµ¬ ì‚½ì…
				    const dropdown = document.querySelector(".chat-message-body");
				    if (dropdown && dropdown.querySelectorAll(".dropdown-item").length === 0) {
				      dropdown.innerHTML = `<div class="px-3 py-2 text-muted no-alarm-message">ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
				    }
				  });
				
				  // âœ… ë§ˆì§€ë§‰ì— ì´ë™
				  window.location.href = `/chat`;
				}

			    
			    sessionStorage.setItem("enterRoomNo", roomNo); // âœ… ì €ì¥
			    window.location.href = `/chat`;
			  }
			});
			
			// í—¤ë” ì•Œë¦¼ ì¡°íšŒ
			if (!myNo) return;

			  const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;
			  const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;

			  fetch(`/chat/alarm/list/${myNo}`, {
			    method: "POST",
			    headers: {
			      "Content-Type": "application/json",
			      [csrfHeader]: csrfToken
			    }
			  })
			  .then(res => res.json())
			  .then(data => {
			     renderChatAlarms(data); 

			  })
			  .catch(err => {
			    console.error("ì•Œë¦¼ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
			  });
			  
			  function renderChatAlarms(list) {
				  const dropdowns = document.querySelectorAll(".chat-message-body");
				  const btns = document.querySelectorAll("#chatAlarmBtn");

				  btns.forEach(btn => {
				    let badge = btn.querySelector(".chat-popup-badge");
				    if (!badge) {
				      badge = document.createElement("span");
				      badge.className = "chat-popup-badge position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger text-white";
				      btn.appendChild(badge);
				    }
				    badge.textContent = list.length;
				    badge.style.display = list.length > 0 ? "inline-block" : "none";
				  });

				  // dropdownì— ì•Œë¦¼ ëª©ë¡ í‘œì‹œ
				  dropdowns.forEach(dropdown => {
				    dropdown.innerHTML = "";
				    dropdown.style.display = "block";

				    if (list.length === 0) {
				    	  dropdown.innerHTML = `<div class="px-3 py-2 text-muted no-alarm-message">ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
				    	  return;
				    	} else {
				    	  // í˜¹ì‹œ "ì•Œë¦¼ ì—†ìŒ" ë©”ì‹œì§€ê°€ ë‚¨ì•„ìˆìœ¼ë©´ ì œê±°
				    	  const noAlarm = dropdown.querySelector(".no-alarm-message");
				    	  if (noAlarm) noAlarm.remove();
				    	}


				    list.forEach(alarm => {
				      const chatRoomName = alarm.chat_room_name || "ì±„íŒ…ë°©";
				      const sender = `${alarm.sender_name || ''} ${alarm.sender_pos_name || ''}`;
				      const content = alarm.chat_alarm_content || "ìƒˆë¡œìš´ ë©”ì‹œì§€ê°€ ë„ì°©í–ˆìŠµë‹ˆë‹¤.";

				      const link = document.createElement("a");
				      link.href = "javascript:void(0)";
				      link.className = "py-6 px-7 d-flex align-items-center dropdown-item";
				      link.setAttribute("data-room-no", alarm.chat_room_no);

				      link.innerHTML = `
				        <div class="w-100">
				          <h6 class="mb-0 fs-4 lh-base">${chatRoomName}</h6>
				          <span class="fs-3 d-block text-body-secondary">${sender} : ${content}</span>
				        </div>
				      `;

				      dropdown.appendChild(link);
				    });
				  });
				}

		  });
		
		
		
		////////////////////////////////////ì „ìê²°ì¬  ì•ŒëŒ í—¤ë”ì— ì ìš© /////////////////////////////////////////
		
		//  í—¤ë” ì•Œë¦¼ ì‹¤ì‹œê°„ ë°˜ì˜ 
		function prependOtherAlarmToDropdown(dto) {
			  const dropdowns = document.querySelectorAll(".alarm-message-body");
			  if (!dropdowns.length) return;

			  dropdowns.forEach(dropdown => {
				
			    dropdown.style.display = "block";
			    
			    const emptyMsg = dropdown.querySelector(".no-alarm-msg");
			    if (emptyMsg) emptyMsg.remove();

			    const link = document.createElement("a");
			    link.href = "javascript:void(0)";
			    link.classList.add("dropdown-alarm", "py-6", "px-7", "d-flex", "align-items-center");
			    link.setAttribute("data-type", dto.alarmType);
			    link.setAttribute("data-alarm-no", dto.alarmNo);
			    link.setAttribute("data-no", dto.otherPkNo);
			    link.setAttribute("data-member-no", dto.approvalMemberNo);
			    console.log(dto);
			    let nowMemberNo = document.getElementById('member_no').value;
			    let approvalMemberNo = dto.approvalMemberNo;
			    console.log("ğŸ” í˜„ì¬ ìœ ì €:", nowMemberNo, "ê²°ì¬ì˜¬ë¦° ìœ ì €:", approvalMemberNo);
				console.log("=== ê²°ê³¼:", parseInt(nowMemberNo) === parseInt(approvalMemberNo));

			    link.innerHTML = `
			      <div class="w-100">
			        <h6 class="mb-0 fs-4 lh-base">${dto.title || "ì „ìê²°ì¬"}</h6>
			        <span class="fs-3 d-block text-body-secondary">${dto.message || "ìƒˆë¡œìš´ ë©”ì‹œì§€"}</span>
			      </div>
			    `;

			    dropdown.prepend(link);
			    
			    const otherAlarmBtnSmall = document.getElementById('otherAlarmBtnSmall');
			      otherAlarmBtnSmall.innerHTML = '<i class="ti ti-bell-ringing"></i><div class="notification bg-primary rounded-circle"></div>';
			      const otherAlarmBtnBig = document.getElementById('otherAlarmBtnBig');
			      otherAlarmBtnBig.innerHTML = '<i class="ti ti-bell-ringing"></i><div class="notification bg-primary rounded-circle"></div>';
			      
			      
			      const alarmCntBig = document.getElementById('alarmCountBig');
			      const alarmCntSmall = document.getElementById('alarmCountSmall');

			      alarmCntBig.textContent = 'NEW';
			      alarmCntSmall.textContent = 'NEW';
			  });
			}
		
		document.addEventListener("DOMContentLoaded", () => {
			const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;
			const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
			// ì•Œë¦¼ í´ë¦­ ì‹œ ì±„íŒ…ë°© ì´ë™ 
			document.addEventListener("click", function (e) {
				let alarm = e.target;

			  while (alarm && !alarm.classList.contains("dropdown-alarm")) {
			    alarm = alarm.parentElement;
			  }

			  if (!alarm) return;

			  const type = alarm.dataset.type;
			  const alarmNo = alarm.dataset.alarmNo; // ì•ŒëŒ PK
			  const no = alarm.dataset.no; // ê²°ì¬,ê³µì§€ì‚¬í•­,ììœ ê²Œì‹œíŒ PK
			  const memberNo = parseInt(alarm.dataset.memberNo, 10); // ê²°ì¬ ê¸°ì•ˆì PK
			  const nowMemberNo = parseInt(document.getElementById('member_no').value, 10); // í˜„ì¬ ì ‘ì†ì PK
			  
			  if(memberNo === nowMemberNo) {
				  if (type && no) {
					    switch (type) {
					      case "approval":
					        window.location.href = `/approval/send/detail/${no}`;
					        break;
					      case "notice":
					        window.location.href = `/notice/detail/${no}`;
					        break;
					      case "board":
					        window.location.href = `/board/detail/${no}`;
					        break;
					      default:
					        console.warn("ì•Œ ìˆ˜ ì—†ëŠ” ì•Œë¦¼ íƒ€ì…:", type);
					    }
				  }
			  } else {
				  if (type && no) {
					    switch (type) {
					      case "approval":
					        window.location.href = `/approval/receive/detail/${no}`;
					        break;
					      case "notice":
					        window.location.href = `/notice/detail/${no}`;
					        break;
					      case "board":
					        window.location.href = `/board/detail/${no}`;
					        break;
					      default:
					        console.warn("ì•Œ ìˆ˜ ì—†ëŠ” ì•Œë¦¼ íƒ€ì…:", type);
					    }
				  }
			  }
			  
			  fetch(`/alarm/read/${alarmNo}`, {
				  method: "GET",
				    headers: {
				      [csrfHeader]: csrfToken
				    }
				  })
				  .catch(err => {
				    console.error("ì•Œë¦¼ ìƒíƒœ ë³€í™˜ ì‹¤íŒ¨:", err);
			  	});
			
			  
			});
			
			if (!myNo) return;

			  
			  fetch('/alarm/list', {
			    method: "POST",
			    headers: {
			      "Content-Type": "application/json",
			      [csrfHeader]: csrfToken
			    }
			  })
			  .then(res => res.json())
			  .then(data => {
			     renderAlarms(data); 
			  })
			  .catch(err => {
			    console.error("ì•Œë¦¼ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
			  });
			  
			  function renderAlarms(list) {
				  const dropdowns = document.querySelectorAll(".alarm-message-body");
/* 				  const btns = document.querySelectorAll("#otherAlarmBtn");

				  btns.forEach(btn => {
				    let badge = btn.querySelector(".alarm-popup-badge");
				    if (!badge) {
				      badge = document.createElement("span");
				      badge.className = "chat-popup-badge position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger text-white";
				      btn.appendChild(badge);
				    }
				    badge.textContent = list.length;
				    badge.style.display = list.length > 0 ? "inline-block" : "none";
				  }); */

				  // dropdownì— ì•Œë¦¼ ëª©ë¡ í‘œì‹œ
				  dropdowns.forEach(dropdown => {
				    dropdown.innerHTML = "";
				    dropdown.style.display = "block";

				    if (list.length === 0) {
				    	dropdown.innerHTML = `<div class="px-3 py-2 text-muted no-alarm-msg">ìƒˆë¡œìš´ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
				      return;
				    }
				    
				    let alarmCntBig = document.getElementById('alarmCountBig');
				    let alarmCntSmall = document.getElementById('alarmCountSmall');
				    
				    alarmCntBig.textContent = 'NEW';
				    alarmCntSmall.textContent = 'NEW';

				    list.forEach(alarm => {
				    	const link = document.createElement("a");
					    link.href = "javascript:void(0)";
					    link.classList.add("dropdown-alarm", "py-6", "px-7", "d-flex", "align-items-center");
					    link.setAttribute("data-type", alarm.alarmType);
					    link.setAttribute("data-alarm-no", alarm.alarmNo);
					    link.setAttribute("data-no", alarm.otherPkNo);
					    if(alarm.alarmType == 'approval') {
					    	link.setAttribute("data-member-no", alarm.approvalMemberNo);
					    }
					    link.innerHTML = `
					      <div class="w-100">
					        <h6 class="mb-0 fs-4 lh-base">${alarm.title || "ì „ìê²°ì¬"}</h6>
					        <span class="fs-3 d-block text-body-secondary">${alarm.message || "ìƒˆë¡œìš´ ë©”ì‹œì§€"}</span>
					      </div>
					    `;
				      dropdown.appendChild(link);
				      
				      const otherAlarmBtnSmall = document.getElementById('otherAlarmBtnSmall');
				      otherAlarmBtnSmall.innerHTML = '<i class="ti ti-bell-ringing"></i><div class="notification bg-primary rounded-circle"></div>';
				      const otherAlarmBtnBig = document.getElementById('otherAlarmBtnBig');
				      otherAlarmBtnBig.innerHTML = '<i class="ti ti-bell-ringing"></i><div class="notification bg-primary rounded-circle"></div>';
				      
				    });
				  });
				}

		  });
		// --------------------------------íˆ¬í‘œ ë§ˆê° ì•Œë¦¼--------------------------------------------------------
        // âœ… ëª¨ë“  í˜ì´ì§€ì—ì„œ ë§ˆê° íˆ¬í‘œ ì•Œë¦¼ ë“±ë¡ ìš”ì²­
    stompClient.send("/app/vote/register", {}, JSON.stringify({ memberNo: myNo }));


		
		
		//////////////////////alrt, confirm ì™„ì „ ëŒ€ì²´ /////////////////////////////////////////
		
		// ğŸ’¥ alert ì™„ì „ ëŒ€ì²´
		window.alert = function(message) {
		  const msgEl = document.getElementById("customAlertMsg");
		  msgEl.textContent = message;

		  const modal = new bootstrap.Modal(document.getElementById("customAlertModal"));
		  modal.show();
		};

		// ğŸ’¥ confirm ì™„ì „ ëŒ€ì²´ (ë¹„ë™ê¸° Promise ë²„ì „)
		window.confirm = function(message) {
		  return new Promise((resolve) => {
		    const msgEl = document.getElementById("customConfirmMsg");
		    msgEl.textContent = message;

		    const modalEl = document.getElementById("customConfirmModal");
		    const modal = new bootstrap.Modal(modalEl);
		    modal.show();

		    // ë²„íŠ¼ ì´ˆê¸°í™” (ì´ë²¤íŠ¸ ì¤‘ë³µ ë°©ì§€)
		    const yesBtnOld = document.getElementById("confirmYesBtn");
		    const yesBtnNew = yesBtnOld.cloneNode(true);
		    yesBtnOld.parentNode.replaceChild(yesBtnNew, yesBtnOld);

		    yesBtnNew.addEventListener("click", () => {
		      modal.hide();
		      resolve(true);
		    });

		    // "ì·¨ì†Œ" ëˆ„ë¥´ê±°ë‚˜ ë‹«ìœ¼ë©´ false
		    modalEl.addEventListener("hidden.bs.modal", () => {
		      resolve(false);
		    }, { once: true });
		  });
		};

		
	
    // âœ… ë§ˆê° íˆ¬í‘œ ì•Œë¦¼ ìˆ˜ì‹  êµ¬ë…
    if (myNo) {
      stompClient.subscribe(`/topic/vote/alarm/${myNo}`, (msg) => {
        const dto = JSON.parse(msg.body);
        console.log("ğŸ“¢ íˆ¬í‘œ ë§ˆê° ì•Œë¦¼ ìˆ˜ì‹ :", dto);
        showVoteAlertToast(dto.title, dto.senderName, dto.message, dto.boardNo); // âœ… boardNo ì‚¬ìš©
      });
    }

    // âœ… ìƒˆë¡œê³ ì¹¨ ì‹œ ë§ˆê° íˆ¬í‘œ ì•Œë¦¼ í™•ì¸
    checkClosed();

/**
 * ğŸŸ¡ íˆ¬í‘œ ë§ˆê° í† ìŠ¤íŠ¸ ì•Œë¦¼ + í—¤ë” ë“œë¡­ë‹¤ìš´ ì¶”ê°€
 */
function showVoteAlertToast(title, senderName, msg, boardNo) {
  const wrapper = document.getElementById("vote-alert-toast");
  if (!wrapper) return;

  document.getElementById("vote-toast-title").textContent = title || "íˆ¬í‘œ ë§ˆê°";
  document.getElementById("vote-toast-sender").textContent = senderName || "";
  document.getElementById("vote-toast-msg").textContent = msg || "íˆ¬í‘œê°€ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤.";

  wrapper.classList.remove("d-none");
  wrapper.classList.remove("active");
  void wrapper.offsetWidth;
  wrapper.classList.add("active");

  // ğŸ§© í—¤ë” ì¢… ëª¨ì–‘ ë“œë¡­ë‹¤ìš´ ì•Œë¦¼ ì¶”ê°€
  if (boardNo) {
    prependOtherAlarmToDropdown({
      boardNo,
      title,
      senderName,
      message: msg
    });
  }

  // ğŸ• ìë™ ìˆ¨ê¹€
  setTimeout(() => {
    wrapper.classList.add("d-none");
  }, 5000);
}

/**
 * ğŸ›ï¸ í—¤ë” ë“œë¡­ë‹¤ìš´ì— íˆ¬í‘œ ë§ˆê° ì•Œë¦¼ ì¶”ê°€
 */
function prependOtherAlarmToDropdown(dto) {
  const dropdowns = document.querySelectorAll(".other-message-body");
  if (!dropdowns.length) return;

  dropdowns.forEach(dropdown => {
    dropdown.style.display = "block";

    const link = document.createElement("a");
    link.href = `/board/detail/${dto.boardNo}`; // âœ… ê²Œì‹œê¸€ ìƒì„¸ ë§í¬ - ìˆ˜ì •í•´ì•¼í•¨
    link.classList.add("dropdown-item", "py-6", "px-7", "d-flex", "align-items-center");

    link.innerHTML = `
      <div class="w-100">
        <h6 class="mb-0 fs-4 lh-base">[íˆ¬í‘œ ë§ˆê°]</h6>
        <span class="fs-3 d-block text-body-secondary">${dto.senderName} : ${dto.message}</span>
      </div>
    `;

    dropdown.prepend(link);
  });
}

/**
 * ğŸ” ìƒˆë¡œê³ ì¹¨ ì‹œ ë§ˆê° íˆ¬í‘œ ì•Œë¦¼ í‘œì‹œ ì—¬ë¶€ í™•ì¸
 */
function checkClosed() {
  const voteNo = document.getElementById("voteForm")?.getAttribute("data-vote-no");
  const memberNo = document.getElementById("member_no")?.value;

  if (voteNo && memberNo) {
    fetch(`/vote/${voteNo}/should-alert?memberNo=${memberNo}`)
      .then(res => {
        if (!res.ok) throw new Error("ì•Œë¦¼ í™•ì¸ ì‹¤íŒ¨");
        return res.json();
      })
      .then(data => {
        if (data && data.shouldAlert) {
          showVoteAlertToast(data.title, data.senderName, data.message, data.boardNo); // âœ… boardNo ì‚¬ìš©
        }
      })
      .catch(err => {
        console.error("âŒ checkClosed ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜:", err);
      });
  }
}

	</script>

</body>
</html>