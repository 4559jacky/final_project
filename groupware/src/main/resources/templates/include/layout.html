<!DOCTYPE html>
<html lang="en" dir="ltr" th:attr="data-bs-theme=${theme}, data-color-theme=${latestProfile != null ? latestProfile.theme_color : 'Blue_Theme'}" data-layout="horizontal" data-boxed-layout="boxed" data-card="shadow" data-sidebartype="mini-sidebar"
xmlns:th="http://www.thymeleaf.org"
xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
	<!-- Required meta tags -->
	<meta charset="UTF-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	
	<!-- Spring Security -->
	<meta id="_csrf" name="_csrf" th:attr="content=${_csrf.token}">
	<meta id="_csrf_header" name="_csrf_header" th:attr="content=${_csrf.headerName}">
	
	<!-- Favicon icon-->
	<link rel="shortcut icon" type="image/png" th:href="@{/assets/images/logos/favicon.ico}" />
	
	<title>Groupware</title>
	
	<!-- Core Css -->
	<link rel="stylesheet" th:href="@{/assets/css/styles.css}" />
	
	<!-- Owl Carousel  -->
	<link rel="stylesheet" th:href="@{/assets/libs/owl.carousel/dist/assets/owl.carousel.min.css}" />
	
	<!-- Custom Css Files -->
	<link rel="stylesheet" th:href="@{/css/layout-common.css}" />
	<link rel="stylesheet" th:href="@{/css/layout-media.css}" />
	
	<!-- alarm css file -->
	<link  rel="stylesheet" th:href="@{/css/alarm.css}">
  	
</head>
<body>
	
	<!-- Preloader Start -->
  	<div class="preloader">
    	<img th:src="@{/assets/images/logos/preloader.svg}" alt="loader" class="lds-ripple img-fluid" />
  	</div>
  	<!-- Preloader End -->
	
  	<div class="page-wrapper" style="position: fixed; top: 0; width: 100%; z-index: 10; height: 45px;">
		<th:block th:replace="~{include/header :: headerLayout}"></th:block>
	</div>
	
	<div id="nav-wrapper" style="position: fixed; top: 45px; padding-top: 45px; z-index: 9; width: 100%;">
		<th:block th:replace="~{include/nav :: navLayout}"></th:block>
	</div>
	
	<div class="body-wrapper" style="padding-top: 45px;">
        <div class="container-fluid">
			<th:block layout:fragment="content"></th:block>
			<th:block layout:fragment="scripts"></th:block>
		</div>
	</div>
	
    <!--  Shopping Cart -->
    <div class="offcanvas offcanvas-end shopping-cart" tabindex="-1" id="offcanvasRight" aria-labelledby="offcanvasRightLabel">
      <div class="offcanvas-header justify-content-between py-4">
        <h5 class="offcanvas-title fs-5 fw-semibold" id="offcanvasRightLabel">
          Shopping Cart
        </h5>
        <span class="badge bg-primary rounded-2 px-3 py-1 lh-sm">5 new</span>
      </div>
      <div class="offcanvas-body h-100 px-4 pt-0" data-simplebar>
        <ul class="mb-0">
          <li class="pb-7">
            <div class="d-flex align-items-center">
              <img th:src="@{/assets/images/products/product-1.jpg}" width="95" height="75" class="rounded-1 me-9 flex-shrink-0" alt="flexy-img" />
              <div>
                <h6 class="mb-1">Supreme toys cooker</h6>
                <p class="mb-0 text-muted fs-2">Kitchenware Item</p>
                <div class="d-flex align-items-center justify-content-between mt-2">
                  <h6 class="fs-2 fw-semibold mb-0 text-muted">$250</h6>
                  <div class="input-group input-group-sm w-50">
                    <button class="btn border-0 round-20 minus p-0 bg-success-subtle text-success" type="button" id="add1">
                      -
                    </button>
                    <input type="text" class="form-control round-20 bg-transparent text-muted fs-2 border-0 text-center qty" placeholder="" aria-label="Example text with button addon" aria-describedby="add1" value="1" />
                    <button class="btn text-success bg-success-subtle p-0 round-20 border-0 add" type="button" id="addo2">
                      +
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </li>
          <li class="pb-7">
            <div class="d-flex align-items-center">
              <img th:src="@{/assets/images/products/product-2.jpg}" width="95" height="75" class="rounded-1 me-9 flex-shrink-0" alt="flexy-img" />
              <div>
                <h6 class="mb-1">Supreme toys cooker</h6>
                <p class="mb-0 text-muted fs-2">Kitchenware Item</p>
                <div class="d-flex align-items-center justify-content-between mt-2">
                  <h6 class="fs-2 fw-semibold mb-0 text-muted">$250</h6>
                  <div class="input-group input-group-sm w-50">
                    <button class="btn border-0 round-20 minus p-0 bg-success-subtle text-success" type="button" id="add2">
                     -
                    </button>
                    <input type="text" class="form-control round-20 bg-transparent text-muted fs-2 border-0 text-center qty" placeholder="" aria-label="Example text with button addon" aria-describedby="add2" value="1" />
                    <button class="btn text-success bg-success-subtle p-0 round-20 border-0 add" type="button" id="addon34">
                      +
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </li>
          <li class="pb-7">
            <div class="d-flex align-items-center">
              <img th:src="@{/assets/images/products/product-3.jpg}" width="95" height="75" class="rounded-1 me-9 flex-shrink-0" alt="flexy-img" />
              <div>
                <h6 class="mb-1">Supreme toys cooker</h6>
                <p class="mb-0 text-muted fs-2">Kitchenware Item</p>
                <div class="d-flex align-items-center justify-content-between mt-2">
                  <h6 class="fs-2 fw-semibold mb-0 text-muted">$250</h6>
                  <div class="input-group input-group-sm w-50">
                    <button class="btn border-0 round-20 minus p-0 bg-success-subtle text-success" type="button" id="add3">
                      -
                    </button>
                    <input type="text" class="form-control round-20 bg-transparent text-muted fs-2 border-0 text-center qty" placeholder="" aria-label="Example text with button addon" aria-describedby="add3" value="1" />
                    <button class="btn text-success bg-success-subtle p-0 round-20 border-0 add" type="button" id="addon3">
                      +
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </li>
        </ul>
        <div class="align-bottom">
          <div class="d-flex align-items-center pb-7">
            <span class="text-dark fs-3">Sub Total</span>
            <div class="ms-auto">
              <span class="text-dark fw-semibold fs-3">$2530</span>
            </div>
          </div>
          <div class="d-flex align-items-center pb-7">
            <span class="text-dark fs-3">Total</span>
            <div class="ms-auto">
              <span class="text-dark fw-semibold fs-3">$6830</span>
            </div>
          </div>
          <a href="./main/eco-checkout.html" class="btn btn-outline-primary w-100">Go to shopping cart</a>
        </div>
      </div>
    </div>
    <div class="dark-transparent sidebartoggler"></div>
	
	<!-- ÌòÑÏû¨ Î°úÍ∑∏Ïù∏Ìïú ÏÇ¨Ïõê ÏÇ¨Î≤à  -->
	<input type="hidden" id="member_no" th:value="${#authentication.principal.member.memberNo}">
	
	<!-- Ï±ÑÌåÖ ÏïåÎ¶º Î™®Îã¨ -->
	<div id="chat-alert-toast" class="position-fixed end-0 bottom-0 p-3 d-none" style="z-index: 1080;">
	  <div class="toast align-items-start text-dark shadow" role="alert" style="border: none; border-radius: 0.5rem;">
	    <div class="toast-header bg-primary text-white">
	      <strong class="me-auto">ÏÉàÎ°úÏö¥ Î©îÏÑ∏ÏßÄÍ∞Ä ÎèÑÏ∞©ÌñàÏäµÎãàÎã§.</strong>
	      <button type="button" class="btn-close btn-close-white ms-2 mb-1" onclick="closeChatToast()"></button>
	    </div>
	    <div class="toast-body">
	      <div><strong>[</strong> <span id="toast-chat-title">ÏïåÎ¶º</span><strong>]</strong></div>
	      <div><strong id="toast-sender-name"></strong></div>
	      <div><span id="toast-msg-content"></span></div> 
	    </div>
	    <input type="hidden" id="toast-room-no" />
	  </div>
	</div>
	
	<!-- Ï†ÑÏûêÍ≤∞Ïû¨ ÏïåÎ¶º Î™®Îã¨ -->
	<div id="approval-alert-toast" class="d-none" style="
	  position: fixed;
	  bottom: 30px;
	  right: 30px;
	  background: white;
	  border: 2px solid #0d6efd;
	  padding: 20px;
	  z-index: 99999;
	  display: block;
	  opacity: 1;
	">
	  <strong>[Ï†ÑÏûêÍ≤∞Ïû¨ ÎèÑÏ∞©]</strong><br>
	  <span id="approval-toast-title">ÌÖåÏä§Ìä∏ Ï†úÎ™©</span><br>
	  <span id="approval-toast-sender">ÌôçÍ∏∏Îèô</span><br>
	  <span id="approval-toast-msg">ÏÉàÎ°úÏö¥ Í≤∞Ïû¨Í∞Ä ÏûàÏäµÎãàÎã§</span>
	</div>
	
	
	
	<!-- üó≥Ô∏è Ìà¨Ìëú ÎßàÍ∞ê ÏïåÎ¶º ÌÜ†Ïä§Ìä∏ 2025-05-14(ÏàòÏöîÏùº)-->
	<div id="vote-alert-toast" class="d-none" style="
  		position: fixed;
  		bottom: 30px;
  		right: 30px;
  		background: #fffbe6;
  		border: 2px solid #ffc107;
  		padding: 24px 28px;
  		z-index: 99999;
  		border-radius: 14px;
  		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  		font-size: 1.1rem;
  		line-height: 1.6rem;
  		width: 340px;
  		max-width: 90%;">
  	<strong style="font-size: 1.2rem;">[Ìà¨Ìëú ÎßàÍ∞ê]</strong><br>
  	<span id="vote-toast-title" style="font-weight: bold; font-size: 1.15rem;">Ìà¨Ìëú Ï†úÎ™©</span><br>
  	<span id="vote-toast-sender" style="color: #333;">ÏûëÏÑ±Ïûê</span><br>
  	<span id="vote-toast-msg">ÎßàÍ∞ê Î©îÏãúÏßÄ</span>
	</div>
	

	<!-- Common JS Files -->
  
    <!-- jsTree -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>
	<script th:src="@{/js/jji/jstree.js}"></script>
	<script th:src="@{/js/ysw/jstree.js}"></script>
	
	<script th:src="@{/js/dark-cookie.js}"></script>
	
	<!-- WebSocket STOMP Ïó∞Í≤∞ --> 
	<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
	
	<script>
		let stompClient = null;
	
		window.addEventListener("load", () => {
		  const socket = new SockJS("/ws-chat");
		  stompClient = Stomp.over(socket);
	
		  stompClient.connect({}, () => {
		    console.log("üì° STOMP WebSocket Ïó∞Í≤∞ ÏÑ±Í≥µ");

		    const myNo = document.getElementById("member_no")?.value;
		    if (!myNo) return;
		    
		    stompClient.send("/app/chat/session-register", {}, JSON.stringify({
		        memberNo: myNo
		      }));
		    // ‚úÖ Î™®Îì† ÌéòÏù¥ÏßÄÏóêÏÑú ÎßàÍ∞ê Ìà¨Ìëú ÏïåÎ¶º ÏöîÏ≤≠
		    stompClient.send("/app/vote/register", {}, JSON.stringify({ memberNo: myNo }));
		    
	
		    // Ï±ÑÌåÖÎ∞© ÏÉùÏÑ± Ïã§ÏãúÍ∞Ñ Î∞òÏòÅ
		    stompClient.subscribe("/topic/chat/room/new", (message) => {
		      const newRoom = JSON.parse(message.body);
		      if (typeof appendNewChatRoom === "function") {
		        appendNewChatRoom(newRoom);
		      }
		    });
	
		    // ÎßàÏßÄÎßâ Î©îÏãúÏßÄ/ÏãúÍ∞Ñ Ïã§ÏãúÍ∞Ñ Î∞òÏòÅ
		    stompClient.subscribe("/topic/chat/room/update", (message) => {
		      const update = JSON.parse(message.body);
		      if (typeof updateChatRoomList === "function") {
		        updateChatRoomList(update);
		      }
		    });
	
		    // Ïïà ÏùΩÏùÄ Î©îÏãúÏßÄ Ïàò ‚Üí chat.htmlÎ°ú ÏúÑÏûÑ
		    stompClient.subscribe("/topic/chat/unread", (message) => {
		      const dto = JSON.parse(message.body);
	
		      if (typeof onUnreadMessage === "function") {
		        onUnreadMessage(dto);
		      }
		    });

		    
		    // Ï±ÑÌåÖ ÏïåÎ¶º 

		    const path = window.location.pathname;
		    if (!path.includes("/chat")) {
		      stompClient.subscribe(`/topic/chat/alarm/${myNo}`, (msg) => {
		        const dto = JSON.parse(msg.body);
		        showChatAlertToast(dto);
		      });
		      
		   	  // Ï†ÑÏûêÍ≤∞Ïû¨ ÏïåÎ¶º
		      stompClient.subscribe(`/topic/approval/alarm/${myNo}`, (msg) => {
		    	    const dto = JSON.parse(msg.body);
		    	    console.log("Ï†ÑÏûêÍ≤∞Ïû¨ ÏïåÎ¶º ÎèÑÏ∞©:", dto);
		    	    showApprovalAlertToast(dto);
		      });
		   	  
		      // ‚úÖ Ìà¨Ìëú ÎßàÍ∞ê ÏïåÎ¶ºÏùÄ Î¨¥Ï°∞Í±¥ Íµ¨ÎèÖ (Î™®Îì† ÌéòÏù¥ÏßÄ)
		      if (myNo) {
		        stompClient.subscribe(`/topic/vote/alarm/${myNo}`, (msg) => {
		          const dto = JSON.parse(msg.body);
		          console.log("üì¢ Ìà¨Ìëú ÎßàÍ∞ê ÏïåÎ¶º ÏàòÏã†:", dto);
		          showVoteAlertToast(dto.title, dto.senderName, dto.message);
		        });
		      }
  		
			}
		  }, (error) => {
		    console.error("STOMP Ïó∞Í≤∞ Ïã§Ìå®", error);
		  });
		});

		
		// ÏïåÎ¶º ÌÜ†Ïä§Ìä∏ Î™®Îã¨ 
		function showChatAlertToast(dto) {
		  console.log("üî• Î™®Îã¨ Ìï®Ïàò ÏßÑÏûÖ", dto);
		
		  const wrapper = document.getElementById("chat-alert-toast");
		  if (!wrapper) return;
		
		  // Í∞í ÏÑ∏ÌåÖ
		  document.getElementById("toast-room-no").value = dto.chat_room_no;
		  document.getElementById("toast-sender-name").textContent = `${dto.member_name} ${dto.member_pos_name}`;
		  document.getElementById("toast-msg-content").textContent = dto.chat_msg_content;
		
		  // ‚úÖ Î¨¥Ï°∞Í±¥ Ï¥àÍ∏∞Ìôî
		  wrapper.classList.remove("d-none");     // display: none Ï†úÍ±∞
		  wrapper.classList.remove("active");     // Ïù¥Ï†Ñ active Ï†úÍ±∞
		  void wrapper.offsetWidth;               // Í∞ïÏ†ú reflow
		  wrapper.classList.add("active");        // Îã§Ïãú active Ï∂îÍ∞Ä
		
		  // ‚úÖ 5Ï¥à ÌõÑ Ïà®ÍπÄ Ï≤òÎ¶¨
		  setTimeout(() => {
		    wrapper.classList.remove("active");
		    wrapper.classList.add("d-none");      // Îã§Ïãú Ïà®ÍπÄ
		  }, 5000);
		}
		
		
		// Ï†ÑÏûêÍ≤∞Ïû¨ ÏïåÎ¶º ÌÜ†Ïä§Ìä∏ Î™®Îã¨
		function showApprovalAlertToast(dto) {
	
		    const wrapper = document.getElementById("approval-alert-toast");
		    if (!wrapper) return;
		
		    // ÎÇ¥Ïö© ÏÑ∏ÌåÖ
		    document.getElementById("approval-toast-title").textContent = dto.title || "Ï†ÑÏûêÍ≤∞Ïû¨";
		    document.getElementById("approval-toast-sender").textContent = dto.senderName || "";
		    document.getElementById("approval-toast-msg").textContent = dto.message || "";
		
		    // Î™®Îã¨ ÌëúÏãú
		    wrapper.classList.remove("d-none");
		
		    // ÏûêÎèô Îã´Í∏∞ (5Ï¥à ÌõÑ)
		    setTimeout(() => {
		      wrapper.classList.add("d-none");
		    }, 5000);
		  }

	  function closeApprovalToast() {
	    const wrapper = document.getElementById("approval-alert-toast");
	    wrapper.classList.remove("active");
	    wrapper.classList.add("d-none");
	  }

		// ‚úÖ ÌÜ†Ïä§Ìä∏ ÏïåÎ¶º ÌëúÏãú Ìï®Ïàò
	    function showVoteAlertToast(title, senderName, msg) {
	      const wrapper = document.getElementById("vote-alert-toast");
	      if (!wrapper) return;

	      document.getElementById("vote-toast-title").textContent = title || "Ìà¨Ìëú ÎßàÍ∞ê";
	      document.getElementById("vote-toast-sender").textContent = senderName || "";
	      document.getElementById("vote-toast-msg").textContent = msg || "Ìà¨ÌëúÍ∞Ä ÎßàÍ∞êÎêòÏóàÏäµÎãàÎã§.";

	      wrapper.classList.remove("d-none");
	      wrapper.classList.remove("active");
	      void wrapper.offsetWidth;
	      wrapper.classList.add("active");

	      setTimeout(() => {
	        wrapper.classList.add("d-none");
	      }, 5000);
	      
	    }
		
	    function checkClosed() {
	    	  const voteNo = document.getElementById("voteForm")?.getAttribute("data-vote-no");
	    	  const memberNo = document.getElementById("member_no")?.value;

	    	  if (voteNo && memberNo) {
	    	    fetch(`/vote/${voteNo}/should-alert?memberNo=${memberNo}`)
	    	      .then(res => {
	    	        if (!res.ok) throw new Error("ÏïåÎ¶º ÌôïÏù∏ Ïã§Ìå®");
	    	        return res.json();
	    	      })
	    	      .then(data => {
	    	        if (data && data.shouldAlert) {
	    	          showVoteAlertToast(data.title, data.senderName, data.message);
	    	        }
	    	      })
	    	      .catch(err => {
	    	        console.error("‚ùå checkClosed Ïã§Ìñâ Ï§ë Ïò§Î•ò:", err);
	    	      });
	    	  }
	    	}
	  
	  
	</script>

</body>
</html>