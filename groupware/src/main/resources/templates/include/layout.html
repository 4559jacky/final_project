<!DOCTYPE html>
<html lang="en" dir="ltr" th:attr="data-bs-theme=${theme}, data-color-theme=${latestProfile != null ? latestProfile.theme_color : 'Blue_Theme'}" data-layout="horizontal" data-boxed-layout="boxed" data-card="shadow" data-sidebartype="mini-sidebar"
xmlns:th="http://www.thymeleaf.org"
xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
	<!-- Required meta tags -->
	<meta charset="UTF-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	
	<!-- Spring Security -->
	<meta id="_csrf" name="_csrf" th:attr="content=${_csrf.token}">
	<meta id="_csrf_header" name="_csrf_header" th:attr="content=${_csrf.headerName}">
	
	<!-- Favicon icon-->
	<link rel="shortcut icon" type="image/png" th:href="@{/assets/images/logos/favicon.ico}" />
	
	<title>Groupware</title>
	
	<!-- Core Css -->
	<link rel="stylesheet" th:href="@{/assets/css/styles.css}" />
	
	<!-- Owl Carousel  -->
	<link rel="stylesheet" th:href="@{/assets/libs/owl.carousel/dist/assets/owl.carousel.min.css}" />
	
	<!-- Custom Css Files -->
	<link rel="stylesheet" th:href="@{/css/layout-common.css}" />
	<link rel="stylesheet" th:href="@{/css/layout-media.css}" />
	
	<!-- alarm css file -->
	<link  rel="stylesheet" th:href="@{/css/alarm.css}">
  	
</head>
<body>
	<!-- 현재 로그인한 사원 사번  -->
	<input type="hidden" id="member_no" th:value="${#authentication.principal.member.memberNo}">
	
	<!-- Preloader Start -->
  	<div class="preloader">
    	<img th:src="@{/assets/images/logos/preloader.svg}" alt="loader" class="lds-ripple img-fluid" />
  	</div>
  	<!-- Preloader End -->
	
  	<div class="page-wrapper" style="position: fixed; top: 0; width: 100%; z-index: 10; height: 45px;">
		<th:block th:replace="~{include/header :: headerLayout}"></th:block>
	</div>
	
	<div id="nav-wrapper" style="position: fixed; top: 45px; padding-top: 45px; z-index: 9; width: 100%;">
		<th:block th:replace="~{include/nav :: navLayout}"></th:block>
	</div>
	
	<div class="body-wrapper" style="padding-top: 45px;">
        <div class="container-fluid">
			<th:block layout:fragment="content"></th:block>
			<th:block layout:fragment="scripts"></th:block>
		</div>
	</div>
	
    
    <div class="dark-transparent sidebartoggler"></div>
	
	<!-- 채팅 알림 모달 -->
	<div id="chatAlertToast" class="position-fixed end-0 bottom-0 m-4 p-3 shadow-lg rounded-3 border bg-white text-dark d-none" style="width: 320px; z-index: 1080;">
	  <div class="fw-bold text-primary mb-2">[채팅 알림] 새로운 메시지가 도착했습니다.</div>
	  <div><strong>제목:</strong> <span id="toast-chat-title">-</span></div>
	  <div><strong>보낸 사람:</strong> <span id="toast-sender-name">-</span></div>
	  <div><strong>내용:</strong> <span id="toast-msg-content">-</span></div>
	  <input type="hidden" id="toast-room-no" />
	</div>


	
	<!-- 전자결재 알림 모달 -->
	<div id="approval-alert-toast" class="d-none" style="
	  position: fixed;
	  bottom: 30px;
	  right: 30px;
	  background: white;
	  border: 2px solid #0d6efd;
	  padding: 20px;
	  z-index: 99999;
	  display: block;
	  opacity: 1;
	">
	  <strong>[전자결재 도착]</strong><br>
	  <span id="approval-toast-title">테스트 제목</span><br>
	  <span id="approval-toast-sender">홍길동</span><br>
	  <span id="approval-toast-msg">새로운 결재가 있습니다</span>
	</div>
	
	
	
	<!-- 🗳️ 투표 마감 알림 토스트 2025-05-14(수요일)-->
	<div id="vote-alert-toast" class="d-none" style="
  		position: fixed;
  		bottom: 30px;
  		right: 30px;
  		background: #fffbe6;
  		border: 2px solid #ffc107;
  		padding: 24px 28px;
  		z-index: 99999;
  		border-radius: 14px;
  		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  		font-size: 1.1rem;
  		line-height: 1.6rem;
  		width: 340px;
  		max-width: 90%;">
  	<strong style="font-size: 1.2rem;">[투표 마감]</strong><br>
  	<span id="vote-toast-title" style="font-weight: bold; font-size: 1.15rem;">투표 제목</span><br>
  	<span id="vote-toast-sender" style="color: #333;">작성자</span><br>
  	<span id="vote-toast-msg">마감 메시지</span>
	</div>
	

	<!-- Common JS Files -->
  
    <!-- jsTree -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>
	<script th:src="@{/js/jji/jstree.js}"></script>
	<script th:src="@{/js/ysw/jstree.js}"></script>
	
	<script th:src="@{/js/dark-cookie.js}"></script>
	
	<!-- WebSocket STOMP 연결 --> 
	<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
	
	<script>
		let stompClient = null;
		const myNo = document.getElementById("member_no").value;
	
		window.addEventListener("load", () => {
		  const socket = new SockJS("/ws-chat");
		  stompClient = Stomp.over(socket);
	
		  stompClient.connect({}, () => {
		    console.log("📡 STOMP WebSocket 연결 성공");

		    
		    
		////////////////////////////////////////////////////// 채팅 웹소캣 //////////////////////////////////////////////////////////////////////////////
		    // 로그인한 사용자 등록
		    stompClient.send("/app/chat/session-register", {}, JSON.stringify({
		        memberNo: myNo
		      }));
		    
		    // 투표 마감 알림 2025-05-14(수요일)
		    const voteNo = document.getElementById("voteForm")?.getAttribute("data-vote-no");
		    if (voteNo && myNo) {
		      fetch(`/vote/${voteNo}/should-alert?memberNo=${myNo}`);
		    }
	
		    // 채팅방 생성 실시간 반영
		    stompClient.subscribe("/topic/chat/room/new", (message) => {
		      const newRoom = JSON.parse(message.body);
		      if (typeof appendNewChatRoom === "function") {
		        appendNewChatRoom(newRoom);
		      }
		    });
	
		    // 마지막 메시지/시간 실시간 반영
		    stompClient.subscribe("/topic/chat/room/update", (message) => {
		      const update = JSON.parse(message.body);
		      if (typeof updateChatRoomList === "function") {
		        updateChatRoomList(update);
		      }
		    });
	
		    // 안 읽은 메시지 수 → chat.html로 위임
		    stompClient.subscribe("/topic/chat/unread", (message) => {
		      const dto = JSON.parse(message.body);
	
		      if (typeof onUnreadMessage === "function") {
		        onUnreadMessage(dto);
		      }
		    });

		    // 나가기 실시간 반영 
		    stompClient.subscribe("/topic/chat/room/exit", (msg) => {
			  const dto = JSON.parse(msg.body);
			
			  if (typeof window.onChatMemberExit === "function") {
			    window.onChatMemberExit(dto);  // ✅ dto.chat_room_no로 처리
			  }
			});
		    
		    // 채팅 알림 
		    const path = window.location.pathname;
		    if (!path.includes("/chat")) {
		      stompClient.subscribe(`/topic/chat/alarm/${myNo}`, (msg) => {
		        const dto = JSON.parse(msg.body);
		        showChatAlertToast(dto);
		      });
		      
		////////////////////////////////////////////////////// 전자 결재  웹소캣 //////////////////////////////////////////////////////////////////////////////
		      
		   	  // 전자결재 알림
		      stompClient.subscribe(`/topic/approval/alarm/${myNo}`, (msg) => {
		    	    const dto = JSON.parse(msg.body);
		    	    console.log("전자결재 알림 도착:", dto);
		    	    showApprovalAlertToast(dto);
		      });
		   	  
		   	  // 투표 마감 알림 2025-05-14(수요일)
		      stompClient.subscribe(`/topic/vote/alarm/${myNo}`, (msg) => {
		        const dto = JSON.parse(msg.body);
		        console.log("🗳️ 투표 마감 알림 도착:", dto);
		        showVoteAlertToast(dto.title, dto.senderName, dto.message);
		      });
		      
		    }

		  }, (error) => {
		    console.error("STOMP 연결 실패", error);
		  });
		});
		

		//////////////////////////////////////////////////////전자 결재  알림 모달  //////////////////////////////////////////////////////////////////////////////
		 
		// 전자결재 알림 토스트 모달
		function showApprovalAlertToast(dto) {
	
		    const wrapper = document.getElementById("approval-alert-toast");
		    if (!wrapper) return;
		
		    // 내용 세팅
		    document.getElementById("approval-toast-title").textContent = dto.title || "전자결재";
		    document.getElementById("approval-toast-sender").textContent = dto.senderName || "";
		    document.getElementById("approval-toast-msg").textContent = dto.message || "";
		
		    // 모달 표시
		    wrapper.classList.remove("d-none");
		
		    // 자동 닫기 (5초 후)
		    setTimeout(() => {
		      wrapper.classList.add("d-none");
		    }, 5000);
		  }
		
		// 투표 마감 2025-05-14(수요일)
		function showVoteAlertToast(title, senderName, msg) {
			  const wrapper = document.getElementById("vote-alert-toast");
			  if (!wrapper) return;

			  document.getElementById("vote-toast-title").textContent = title || "투표";
			  document.getElementById("vote-toast-sender").textContent = senderName || "";
			  document.getElementById("vote-toast-msg").textContent = msg || "투표가 마감되었습니다.";

			  wrapper.classList.remove("d-none");
			  wrapper.classList.remove("active");
			  void wrapper.offsetWidth;
			  wrapper.classList.add("active");

			  setTimeout(() => {
			    wrapper.classList.add("d-none");
			  }, 5000);
			}
	
	  function closeApprovalToast() {
	    const wrapper = document.getElementById("approval-alert-toast");
	    wrapper.classList.remove("active");
	    wrapper.classList.add("d-none");
	  }
	  

	  
		////////////////////////////////////////////////////// 채팅 알림 -> 채팅방 진입  //////////////////////////////////////////////////////////////////////////////
	  
		
		// 채팅 헤더 알림 실시간 반영 
		function increaseAlarmBadge() {
		  const btns = document.querySelectorAll("#chatAlarmBtn"); // ✅ 모든 화면에 대응
		
		  btns.forEach(btn => {
		    let badge = btn.querySelector(".chat-popup-badge");
		
		    if (!badge) {
		      badge = document.createElement("span");
		      badge.className = "popup-badge rounded-pill bg-danger text-white fs-2";
		      badge.textContent = "1";
		      btn.appendChild(badge);
		    } else {
		      let count = parseInt(badge.textContent.trim() || "0", 10);
		      badge.textContent = ++count;
		    }
		  });
		}

		function prependAlarmToDropdown(dto) {
			  const dropdowns = document.querySelectorAll(".chat-message-body");
			  if (!dropdowns.length) return;

			  dropdowns.forEach(dropdown => {
			    dropdown.style.display = "block";

			    const link = document.createElement("a");
			    link.href = "javascript:void(0)";
			    link.classList.add("dropdown-item", "py-6", "px-7", "d-flex", "align-items-center");
			    link.setAttribute("data-room-no", dto.chat_room_no);

			    link.innerHTML = `
			      <div class="w-100">
			        <h6 class="mb-0 fs-4 lh-base">${dto.chat_room_title || "채팅방"}</h6>
			        <span class="fs-3 d-block text-body-secondary">${dto.member_name} : ${dto.chat_msg_content || "새로운 메시지"}</span>
			      </div>
			    `;

			    dropdown.prepend(link);
			  });
			}

		// 알림 토스트 모달 
		function showChatAlertToast(dto) {
		  console.log("🔥 모달 함수 진입", dto);
		
		  // 값 세팅
		  document.getElementById("toast-room-no").value = dto.chat_room_no;
		  document.getElementById("toast-sender-name").textContent = `${dto.member_name} ${dto.member_pos_name}`;
		  document.getElementById("toast-msg-content").textContent = dto.chat_msg_content;
		  document.getElementById("toast-chat-title").textContent = dto.chat_room_title || "제목 없음";
		
		  const toastEl = document.getElementById("chatAlertToast");
		  toastEl.classList.remove("d-none");
		  
		
		  setTimeout(() => {
			    increaseAlarmBadge();
			    prependAlarmToDropdown(dto);
			  }, 100);

			  setTimeout(() => {
			    toastEl.classList.add("d-none");
			  }, 5000);
		
		  // 5초 뒤 사라짐
		  setTimeout(() => {
		    toastEl.classList.add("d-none");
		  }, 5000);
		}
		
		
		document.addEventListener("DOMContentLoaded", () => {
			// 알림 클릭 시 채팅방 이동 
			document.addEventListener("click", function (e) {
			  const item = e.target.closest(".dropdown-item");
			  if (!item) return;
			
			  const roomNo = item.dataset.roomNo;
			  if (roomNo) {
			    console.log("🔥 알림 클릭됨! → 이동: ", roomNo);
			    sessionStorage.setItem("enterRoomNo", roomNo); // ✅ 저장
			    window.location.href = `/chat`;
			  }
			});
			
			// 헤더 알림 조회
			if (!myNo) return;

			  const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;
			  const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;

			  fetch(`/chat/alarm/list/${myNo}`, {
			    method: "POST",
			    headers: {
			      "Content-Type": "application/json",
			      [csrfHeader]: csrfToken
			    }
			  })
			  .then(res => res.json())
			  .then(data => {
			     renderChatAlarms(data); 

			  })
			  .catch(err => {
			    console.error("알림 불러오기 실패:", err);
			  });
			  
			  function renderChatAlarms(list) {
				  const dropdowns = document.querySelectorAll(".chat-message-body");
				  const btns = document.querySelectorAll("#chatAlarmBtn");

				  btns.forEach(btn => {
				    let badge = btn.querySelector(".chat-popup-badge");
				    if (!badge) {
				      badge = document.createElement("span");
				      badge.className = "chat-popup-badge position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger text-white";
				      btn.appendChild(badge);
				    }
				    badge.textContent = list.length;
				    badge.style.display = list.length > 0 ? "inline-block" : "none";
				  });

				  // dropdown에 알림 목록 표시
				  dropdowns.forEach(dropdown => {
				    dropdown.innerHTML = "";
				    dropdown.style.display = "block";

				    if (list.length === 0) {
				      dropdown.innerHTML = `<div class="px-3 py-2 text-muted">알림이 없습니다.</div>`;
				      return;
				    }

				    list.forEach(alarm => {
				      const chatRoomName = alarm.chat_room_name || "채팅방";
				      const sender = `${alarm.sender_name || ''} ${alarm.sender_pos_name || ''}`;
				      const content = alarm.chat_msg_content || "새로운 메시지가 도착했습니다.";

				      const link = document.createElement("a");
				      link.href = "javascript:void(0)";
				      link.className = "py-6 px-7 d-flex align-items-center dropdown-item";
				      link.setAttribute("data-room-no", alarm.chat_room_no);

				      link.innerHTML = `
				        <div class="w-100">
				          <h6 class="mb-0 fs-4 lh-base">${chatRoomName}</h6>
				          <span class="fs-3 d-block text-body-secondary">${sender} : ${content}</span>
				        </div>
				      `;

				      dropdown.appendChild(link);
				    });
				  });
				}

		  });


	</script>

</body>
</html>