<!DOCTYPE html>
<html lang="en" dir="ltr" data-bs-theme="light"
	data-color-theme="Blue_Theme" data-layout="horizontal"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{/include/layout}">

<th:block layout:fragment="content">
	<!-- jQuery -->
	<script th:src="@{/js/jquery-3.7.1.js}"></script>
	<!-- jsTree -->
	<link rel="stylesheet"
		href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css" />
	<link th:href="@{/css/jji.css}" rel="stylesheet">

	<div class="container-fluid px-4">
		<!-- Breadcrumb -->
		<div class="col-lg-8 col-md-6 col-12 align-self-center">
			<nav aria-label="breadcrumb">
				<ol class="breadcrumb align-items-center">
					<li class="breadcrumb-item"><a
						class="text-muted text-decoration-none" th:href="@{/home}"> <i
							class="ti ti-home fs-5"></i>
					</a></li>
					<li class="breadcrumb-item" aria-current="page">전자 결재 시스템</li>
					<li class="breadcrumb-item active" aria-current="page">받은 문서함</li>
				</ol>
			</nav>
			<br>
			<h2 class="mb-0 fw-bolder fs-8">전자 결재 시스템</h2>
		</div>
		<br>

		<!-- Tabs -->
		<ul class="nav nav-tabs mb-4">
			<li class="nav-item"><a class="nav-link" th:href="@{/approval}">보낸
					문서함</a></li>
			<li class="nav-item"><a class="nav-link"
				th:href="@{/approval/receive}">받은 문서함</a></li>
			<li class="nav-item"><a class="nav-link active"
				th:href="@{/approval/create}">결재 작성</a></li>
		</ul>
		<div class="container-fluid my-5 px-4">
			<div class="row">
				<!-- 왼쪽 결재 양식 선택 영역 -->
				<div class="col-md-3">
					<div class="card shadow-sm rounded-4 p-4">
						<h5 class="fw-bold mb-4 text-center">결재 양식</h5>
						<div class="d-grid gap-3">
							<th:block th:if=${!#lists.isEmpty(formList)}
								th:each="form : ${formList}">
								<th:block th:if="${form.approvalFormStatus == 'Y'}">
									<!-- class="btn btn-primary" -->
									<button class="btn btn-outline-info form-btn"
										th:text="${form.approvalFormName}"
										th:onclick="|javascript:viewForm('${form.approvalFormNo}')|">양식
										이름</button>
								</th:block>
							</th:block>
						</div>
					</div>
				</div>
				<div class="col-md-9">
					<form name="create_approval_form" action="/approval/create"
						method="post">
						<div class="card shadow-sm rounded-4 p-4 bg-white"
							style="min-height: 600px; position: relative;" id="form_div">
							<th:block>
								<input type="hidden" name="appr_sender"
									th:value="${#authentication.principal.member.memberNo}">
								<h4 id="approval_form_name" class="fw-bold text-center mb-4">양식
									제목</h4>
								<div class="text-end" style="min-width: 180px;">
									작성일 : <span id="reg_date"></span>
								</div>
								<table class="table table-bordered align-middle">
									<tbody>
										<tr>
											<th class="text-center bg-light" style="width: 15%;">기안자</th>
											<td name="sender_name" style="width: 20%;"></td>
											<th class="text-center bg-light" style="width: 15%;">부서</th>
											<td name="dept_name" style="width: 20%;"></td>
											<th class="text-center bg-light" style="width: 15%;">직급</th>
											<td name="pos_name"></td>
										</tr>
										<tr>
											<th class="text-center bg-light">제목</th>
											<td colspan="5"><input type="text" name="appr_title"
												class="form-control w-100"></td>
										</tr>
										<tr>
											<th class="text-center bg-light">일시</th>
											<td colspan="5">
												<div class="d-flex align-items-center" style="gap: 8px;">
													<input type="date" name="start_date" class="form-control"
														style="width: 200px; height: 36px;"> <span>
														~ </span> <input type="date" name="end_date" class="form-control"
														style="width: 200px; height: 36px;">
												</div>
											</td>
										</tr>
										<tr>
											<th class="text-center bg-light">결재자</th>
											<td colspan="4">
												<table class="table table-bordered text-center w-100">
													<thead class="table-light">
														<tr id="approver">
															<th class="text-center bg-light" style="width: 20%;" name="approver"></th>
															<th class="text-center bg-light" style="width: 20%;" name="approver"></th>
															<th class="text-center bg-light" style="width: 20%;" name="approver"></th>
															<th class="text-center bg-light" style="width: 20%;" name="approver"></th>
															<th class="text-center bg-light" style="width: 20%;" name="approver"></th>
														</tr>
													</thead>
													<tbody>
														<tr id="approver_signature">
															<td class="text-center" style="height: 80px;"></td>
															<td class="text-center" style="height: 80px;"></td>
															<td class="text-center" style="height: 80px;"></td>
															<td class="text-center" style="height: 80px;"></td>
															<td class="text-center" style="height: 80px;"></td>
														</tr>
													</tbody>
												</table>
											</td>
											<td>
												<button type="button" data-bs-toggle="modal"
													class="btn btn-primary" data-bs-target="#approvalLineModal"
													style="font-size: 14px;">결재 라인</button>
											</td>
										</tr>
										<tr>
											<th class="text-center bg-light">합의자</th>
											<td colspan="5">
												<table class="table table-bordered text-center w-100">
													<thead class="table-light">
														<tr id="agreementer">
															<th class="text-center bg-light" style="width: 20%;" name="agreementer"></th>
															<th class="text-center bg-light" style="width: 20%;" name="agreementer"></th>
															<th class="text-center bg-light" style="width: 20%;" name="agreementer"></th>
															<th class="text-center bg-light" style="width: 20%;" name="agreementer"></th>
															<th class="text-center bg-light" style="width: 20%;" name="agreementer"></th>
														</tr>
													</thead>
													<tbody>
														<tr id="agreementer_signature">
															<td class="text-center" style="height: 80px;"></td>
															<td class="text-center" style="height: 80px;"></td>
															<td class="text-center" style="height: 80px;"></td>
															<td class="text-center" style="height: 80px;"></td>
															<td class="text-center" style="height: 80px;"></td>
														</tr>
													</tbody>
												</table>
											</td>
										</tr>
										<tr>
											<th class="text-center bg-light">참조자</th>
											<td colspan="5"><div id="referencer" name="referencer"></div></td>
										</tr>
										<tr>
											<th class="text-center bg-light">첨부 파일</th>
											<td colspan="5"></td>
										</tr>
									</tbody>
								</table>
							</th:block>
							<!-- 여기에 동적 양식 들어감 -->
							<div id="approval-content"></div>
						</div>
						<!-- 승인요청 버튼: div2 하단 오른쪽 정렬 -->
						<div class="d-flex justify-content-end mt-3">
							<button type="submit" class="btn btn-primary">승인요청</button>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>


	<!-- alert 창 -->
	<div id="custom-alert"
		class="alert text-white d-flex align-items-center alert-dismissible fade"
		role="alert"
		style="position: fixed; top: 100px; left: 50%; transform: translateX(-50%); z-index: 9999; max-width: 400px; width: 90%; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); padding: 15px 25px; background-color: rgba(255, 53, 69, 0.65) !important;">
		<i class="bi bi-exclamation-triangle-fill me-2"></i>
		<div id="alert-msg" style="font-size: 1.0rem; text-align: center;"></div>
		<button type="button" class="btn-close btn-close-white ms-auto"
			data-bs-dismiss="alert" aria-label="Close"></button>
	</div>


	<!-- 결재라인 모달창 -->
	<div class="modal fade" id="approvalLineModal" tabindex="-1"
		aria-hidden="true">
		<div class="modal-dialog" style="max-width: 1000px;">
			<!-- 너비만 크게 조정 -->
			<div class="modal-content p-4 rounded-4 shadow-lg">
				<div class="modal-header border-bottom">
					<h5 class="modal-title fw-bold fs-4">결재 라인 선택</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="닫기"></button>
				</div>

				<div class="modal-body">
					<!-- 상단: 조직도 + 사원 목록 -->
					<div class="row mb-4" style="height: 280px;">
						<!-- 조직도 -->
						<div class="col-6 pe-3 border-end d-flex flex-column">
							<h6 class="fw-semibold mb-2">조직도</h6>
							<div id="appr_jstree"
								class="flex-grow-1 overflow-auto border rounded bg-light p-2">
								<!-- JSTree 내용 -->
							</div>
						</div>

						<!-- 사원 목록 -->
						<div class="col-6 ps-3 d-flex flex-column">
							<h6 class="fw-semibold mb-2">선택한 부서의 사원 목록</h6>
							<div id="memberListBox"
								class="flex-grow-1 overflow-auto border rounded bg-light p-2"
								style="max-height: 250px;">
								<!-- ✅ 스크롤 영역 고정 높이 설정 -->
								<ul id="memberList" class="list-group fs-6 mb-0"></ul>
							</div>
						</div>
					</div>
					<BR> <bR>
					<!-- 하단: 결재자/참조자/합의자 -->
					<div class="row gx-3 text-center" style="height: 200px;">
						<div class="col d-flex flex-column">
							<div class="d-flex justify-content-between mb-2">
								<span class="fw-semibold">결재자</span>
								<button class="btn btn-primary btn-sm"
									onclick="approver_btn();">등록</button>
							</div>
							<div
								class="flex-grow-1 overflow-auto border rounded bg-white p-2">
								<ul id="approverList" class="list-group fs-6 mb-0"></ul>
							</div>
						</div>
						<div class="col d-flex flex-column">
							<div class="d-flex justify-content-between mb-2">
								<span class="fw-semibold">합의자</span>
								<button class="btn btn-primary btn-sm"
									onclick="agreementer_btn();">등록</button>
							</div>
							<div
								class="flex-grow-1 overflow-auto border rounded bg-white p-2">
								<ul id="agreementerList" class="list-group fs-6 mb-0"></ul>
							</div>
						</div>
						<div class="col d-flex flex-column">
							<div class="d-flex justify-content-between mb-2">
								<span class="fw-semibold">참조자</span>
								<button class="btn btn-primary btn-sm"
									onclick="referencer_btn();">등록</button>
							</div>
							<div
								class="flex-grow-1 overflow-auto border rounded bg-white p-2">
								<ul id="referencerList" class="list-group fs-6 mb-0"></ul>
							</div>
						</div>
					</div>
				</div>
				<BR>
				<div class="modal-footer justify-content-end">
					<button type="button" class="btn btn-primary"
						onclick="selectApprovalMember();">선택 완료</button>
				</div>
			</div>
		</div>
	</div>


	<script>
	
	// 처음 페이지로 들어오면 자동으로 맨 위에 양식이 클릭
	document.addEventListener("DOMContentLoaded", function() {
        // 첫 번째 버튼을 자동 클릭
        const firstButton = document.querySelector('.form-btn');
        if (firstButton) {
          firstButton.click();
        }
      });
	
	
	
	const viewForm = function (approvalFormNo) {

		  if (approvalFormNo !== null) {
		    fetch('/approval/create/' + approvalFormNo, {
		      method: 'POST',
		      headers: {
		        'Content-Type': 'application/json',
		        [document.querySelector('meta[name="_csrf_header"]').content]:
		          document.querySelector('meta[name="_csrf"]').content
		      }
		    })
		      .then(response => response.json())
		      .then(data => {
		    	  
		    	  const approvalForm = data.approvalForm;
		    	  const member = data.member;
		    	  
		    	  console.log(approvalForm);
		    	  
		    	  const form_div = document.getElementById('form_div');
		    	  let form_no = document.createElement('input');
		    	  form_no.setAttribute('type', 'hidden');
		    	  form_no.setAttribute('name', 'approval_type_no');
		    	  form_no.setAttribute('value', `${approvalFormNo}`);
		    	  
		    	  form_div.appendChild(form_no);
		    	  
		    	  const approval_div = document.getElementById('approval-content');
		    	  approval_div.innerHTML = '';

		    	  // 제목 삽입
		          const titleElement = document.getElementById('approval_form_name');
		          if (titleElement) {
		            titleElement.innerText = approvalForm.approval_form_name;
		          }
		          
		       	  // 기안자 정보 삽입
		          document.querySelector("td[name='sender_name']").innerText = member.member_name;
		          document.querySelector("td[name='dept_name']").innerText = member.dept_name;
		          document.querySelector("td[name='pos_name']").innerText = member.pos_name;

		    	  // contenteditable div
		    	  const editor = document.createElement('div');
		    	  editor.className = 'form-control';
		    	  editor.setAttribute('name','appr_content');
		    	  editor.contentEditable = true;
		    	  editor.innerHTML = approvalForm.approval_form;
		    	  editor.style.minHeight = '300px';
		    	  approval_div.appendChild(editor);
		    	  
		    	  const input = document.createElement('input');
		    	  input.setAttribute('type', 'hidden');
		    	  input.setAttribute('name', 'appr_text');
		    	  
		    	  approval_div.append(input);
		    	  
					// 기존 선택된 버튼에서 클래스 제거
					document.querySelectorAll('.btn-outline-info, .btn-outline-secondary').forEach(btn => {
					  btn.classList.remove('selected-button');
					});
					
					// 클릭한 버튼 찾아서 클래스 추가
					const clickedBtn = [...document.querySelectorAll('.btn')].find(
					  btn => btn.getAttribute('onclick') === `javascript:viewForm('${approvalFormNo}')`
					);
					
					if (clickedBtn) {
					  clickedBtn.classList.add('selected-button');
					}
		      });
		  } else {
		    alert('먼저 작성할 양식을 선택해주세요.');
		  }
		};
	
	// 결재라인 버튼 클릭시 모달창에 등록한 관련자 정보를 가져옴
	document.addEventListener('DOMContentLoaded', function() {
		$('#approvalLineModal').on('shown.bs.modal', function() {
			
			let approverList = document.querySelectorAll("th[name='approver']");

		    approverList.forEach(function(member) {
		    	
		    	let text = member.innerText;
		    	text = text.split(' ')[1];
		    	let input = member.querySelector("input[name='approver_no']");
		    	if(input) {
		    		let memberNo = input.value;
		    		const li = document.createElement("li");
	                li.className = 'list-group-item approver_li';
	                li.innerHTML = `<button class="selected_approver btn-sm btn btn-rounded btn-light" value="${memberNo}">-</button> ${text}`;
	                document.getElementById("approverList").appendChild(li);
		    	}
		    });

		    let agreementerList = document.querySelectorAll("th[name='agreementer']");

		    agreementerList.forEach(function(member) {
		    	console.log(member)
		    	let text = member.innerText;
		    	let input = member.querySelector("input[name='agreementer_no']");
		    	if(input) {
		    		let memberNo = input.value;
		    		const li = document.createElement("li");
	                li.className = 'list-group-item agreementer_li';
	                li.innerHTML = `<button class="selected_agreementer btn-sm btn btn-rounded btn-light" value="${memberNo}">-</button> ${text}`;
	                document.getElementById("agreementerList").appendChild(li);
		    	}
		    });

		    let referencerList = document.querySelectorAll("span[name='referencerSpan']");

		    referencerList.forEach(function(member) {
		    	let text = member.innerText;
		    	let memberNo = member.querySelector("input[name='referencer_no']").value;
		    	
                const li = document.createElement("li");
                li.className = 'list-group-item referencer_li';
                li.innerHTML = `<button class="selected_referencer btn-sm btn btn-rounded btn-light" value="${memberNo}">-</button> ${text}`;
                document.getElementById("referencerList").appendChild(li);
		    });
		});
		
		// 모달창 닫을 때 li 초기화
		$('#approvalLineModal').on('hidden.bs.modal', function () {
			
			const list = document.getElementById("memberList");
            list.innerHTML = ""; // 기존 목록 초기화
			
	        document.getElementById("approverList").innerHTML = "";
	        document.getElementById("agreementerList").innerHTML = "";
	        document.getElementById("referencerList").innerHTML = "";
	    });
		
	})
		
		
	
	// 결재자 등록
	const approver_btn = function() {
	    let checkedMember = [];
	    document.querySelectorAll('.member-checkbox:checked').forEach(function(checkbox) {
	        checkedMember.push(checkbox.value);
	    });

	    console.log(checkedMember);

	    checkedMember.forEach(function(member) {
	        // 이미 추가된 결재자인지 확인
	        let isAlreadyAddedApprover = Array.from(document.querySelectorAll('.selected_approver')).some(el => el.value === member);
	        let isAlreadyAddedReferencer = Array.from(document.querySelectorAll('.selected_referencer')).some(el => el.value === member);
	        let isAlreadyAddedAgreementer = Array.from(document.querySelectorAll('.selected_agreementer')).some(el => el.value === member);

	        if (!isAlreadyAddedApprover && !isAlreadyAddedReferencer && !isAlreadyAddedAgreementer) { // 중복이 아닐 때만 추가
	            fetch('/member/' + member, {
	                method: 'GET'
	            })
	            .then(response => response.json())
	            .then(data => {
	                const list = document.getElementById("approverList");

	                const li = document.createElement("li");
	                li.className = 'list-group-item approver_li';
	                li.innerHTML = `<button class="selected_approver btn-sm btn btn-rounded btn-light" value="${data.member_no}">-</button> ${data.member_name}`;
	                
	                list.appendChild(li);
	            })
	            .catch(err => {
	                console.error("사원 목록 불러오기 실패:", err);
	            });
	        } else {
	        	alert('각 항목에 추가된 사원은 중복으로 추가 할 수 없습니다.');
	            console.log(`이미 추가된 사원: ${member}`);
	        }
	    });
	};
	
	 // 결재자 목록에서 - 버튼 클릭 시 항목 제거
    document.getElementById('approverList').addEventListener('click', function(event) {
        // 클릭된 요소가 .selected_approver 버튼인지 확인
        if (event.target && event.target.classList.contains('selected_approver')) {
            let approverId = event.target.value;  // 클릭한 버튼의 value 값 가져오기
            console.log(approverId);

            // 클릭된 버튼의 부모 <li> 요소를 찾아서 삭제
            let listItem = event.target.closest('li');  // 버튼의 부모 li 찾기
            if (listItem) {
                listItem.remove();  // <li> 요소 삭제
            }
        }
    });
	 
	 
	 
 	// 합의자 등록버튼
    const agreementer_btn = function() {
	    let checkedMember = [];
	    document.querySelectorAll('.member-checkbox:checked').forEach(function(checkbox) {
	        checkedMember.push(checkbox.value);
	    });

	    console.log(checkedMember);

	    checkedMember.forEach(function(member) {
	        // 이미 추가된 합의자인지 확인
	        let isAlreadyAddedApprover = Array.from(document.querySelectorAll('.selected_approver')).some(el => el.value === member);
	        let isAlreadyAddedReferencer = Array.from(document.querySelectorAll('.selected_referencer')).some(el => el.value === member);
	        let isAlreadyAddedAgreementer = Array.from(document.querySelectorAll('.selected_agreementer')).some(el => el.value === member);

	        if (!isAlreadyAddedApprover && !isAlreadyAddedReferencer && !isAlreadyAddedAgreementer) { // 중복이 아닐 때만 추가
	            fetch('/member/' + member, {
	                method: 'GET'
	            })
	            .then(response => response.json())
	            .then(data => {
	                const list = document.getElementById("agreementerList");

	                const li = document.createElement("li");
	                li.className = 'list-group-item agreementer_li';
	                li.innerHTML = `<button class="selected_agreementer btn-sm btn btn-rounded btn-light" value="${data.member_no}">-</button> ${data.member_name}`;
	                
	                list.appendChild(li);
	            })
	            .catch(err => {
	                console.error("사원 목록 불러오기 실패:", err);
	            });
	        } else {
	        	alert('각 항목에 추가된 사원은 중복으로 추가 할 수 없습니다.');
	            console.log(`이미 추가된 사원: ${member}`);
	        }
	    });
	};
	
	 // 합의자 목록에서 - 버튼 클릭 시 항목 제거
    document.getElementById('agreementerList').addEventListener('click', function(event) {
        // 클릭된 요소가 .selected_approver 버튼인지 확인
        if (event.target && event.target.classList.contains('selected_agreementer')) {
            let approverId = event.target.value;  // 클릭한 버튼의 value 값 가져오기
            console.log(approverId);

            // 클릭된 버튼의 부모 <li> 요소를 찾아서 삭제
            let listItem = event.target.closest('li');  // 버튼의 부모 li 찾기
            if (listItem) {
                listItem.remove();  // <li> 요소 삭제
            }
        }
    });
	 
	 
 	// 참조자 등록버튼
    const referencer_btn = function() {
	    let checkedMember = [];
	    document.querySelectorAll('.member-checkbox:checked').forEach(function(checkbox) {
	        checkedMember.push(checkbox.value);
	    });

	    console.log(checkedMember);

	    checkedMember.forEach(function(member) {
	        // 이미 추가된 결재자인지 확인
	        let isAlreadyAddedApprover = Array.from(document.querySelectorAll('.selected_approver')).some(el => el.value === member);
	        let isAlreadyAddedReferencer = Array.from(document.querySelectorAll('.selected_referencer')).some(el => el.value === member);
	        let isAlreadyAddedAgreementer = Array.from(document.querySelectorAll('.selected_agreementer')).some(el => el.value === member);
	        

	        if (!isAlreadyAddedApprover && !isAlreadyAddedReferencer && !isAlreadyAddedAgreementer) { // 중복이 아닐 때만 추가
	            fetch('/member/' + member, {
	                method: 'GET'
	            })
	            .then(response => response.json())
	            .then(data => {
	                const list = document.getElementById("referencerList");

	                const li = document.createElement("li");
	                li.className = 'list-group-item referencer_li';
	                li.innerHTML = `<button class="selected_referencer btn-sm btn btn-rounded btn-light" value="${data.member_no}">-</button> ${data.member_name}`;
	                
	                list.appendChild(li);
	            })
	            .catch(err => {
	                console.error("사원 목록 불러오기 실패:", err);
	            });
	        } else {
	        	alert('각 항목에 추가된 사원은 중복으로 추가 할 수 없습니다.');
	            console.log(`이미 추가된 사원: ${member}`);
	        }
	    });
	};
	
	 // 참조자 목록에서 - 버튼 클릭 시 항목 제거
    document.getElementById('referencerList').addEventListener('click', function(event) {
        if (event.target && event.target.classList.contains('selected_referencer')) {
            let referencerId = event.target.value;  // 클릭한 버튼의 value 값 가져오기
            console.log(referencerId);

            // 클릭된 버튼의 부모 <li> 요소를 찾아서 삭제
            let listItem = event.target.closest('li');  // 버튼의 부모 li 찾기
            if (listItem) {
                listItem.remove();  // <li> 요소 삭제
            }
        }
    }); 
	 
	 
	 
	
	 // 결재라인 선택완료 버튼 누를 시
    const selectApprovalMember = function () {
        let approverList = document.querySelectorAll('.approver_li');
        if (approverList.length > 5) {
            alert('결재자는 최대 5명까지 지정할 수 있습니다.');
            return; // 더 이상 진행하지 않고 함수 종료
        }
        
        let approverThList = document.querySelectorAll('#approver th');
        let approverTdList = document.querySelectorAll('#approver_signature td');

        // 기존 내용 초기화
        approverThList.forEach(th => th.innerHTML = '');
        approverTdList.forEach(td => td.innerHTML = '');

        let index = 0;
        approverList.forEach(approver => {
            let button = approver.querySelector('.selected_approver');

            if (button && index < 5) {
                let approverId = button.value;
                let approverName = approver.innerText.replace('-', '').trim();
                approverName = approverName.split(' ')[0];

                // 해당 위치에 이름 삽입
                approverThList[index].textContent = '('+(index+1)+') '+approverName;

                // 서명란 입력 (예시로 서명 이미지나 텍스트가 들어갈 수 있음)
                approverTdList[index].textContent = '서명란';

                // hidden input 추가
                let input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'approver_no';
                input.value = approverId;

                approverThList[index].appendChild(input);
                index++;
            }
        });
        
        // agreementer
		let agreementerList = document.querySelectorAll('.agreementer_li');
        
        let agreementerThList = document.querySelectorAll('#agreementer th');
        let agreementerTdList = document.querySelectorAll('#agreementer_signature td');
        
        if (agreementerList.length > 5) {
            alert('합의자는 최대 5명까지 지정할 수 있습니다.');
            return;
        }

        // 기존 내용 초기화
        agreementerThList.forEach(th => th.innerHTML = '');
        agreementerTdList.forEach(td => td.innerHTML = '');

        let index1 = 0;
        agreementerList.forEach(agreementer => {
            let button = agreementer.querySelector('.selected_agreementer');

            if (button && index1 < 5) {
                let agreementerId = button.value;
                let agreementerName = agreementer.innerText.replace('-', '').trim();
                agreementerName = agreementerName.split(' ')[0];

                // 해당 위치에 이름 삽입
                agreementerThList[index1].textContent = agreementerName;

                // 서명란 입력 (예시로 서명 이미지나 텍스트가 들어갈 수 있음)
                agreementerTdList[index1].textContent = '서명란';

                // hidden input 추가
                let input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'agreementer_no';
                input.value = agreementerId;

                agreementerThList[index1].appendChild(input);
                index1++;
            }
        });

        // referencer
        let referencerList = document.querySelectorAll('.referencer_li');
        let referencerDiv = document.getElementById('referencer');
        referencerDiv.innerHTML = ''; // 초기화
        
        let index2 = 1;

        referencerList.forEach(referencer => {
            let button = referencer.querySelector('.selected_referencer');
            if (button) {
                let referencerId = button.value;
                let referencerName = referencer.innerText.replace('-', '').trim();
                referencerName = referencerName.split(' ')[0];
                

                if (!referencerDiv.querySelector(`span[data-referencer-id="${referencerId}"]`)) {
                    let span = document.createElement('span');
                    span.setAttribute('data-referencer-id', referencerId);
                    span.setAttribute('name', 'referencerSpan');
                    span.textContent = referencerName;

                    

                    let input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'referencer_no';
                    input.value = referencerId;

                    span.appendChild(input);
                    
                    if(referencerList.length != index2) {
                    	referencerDiv.appendChild(span);
                    	referencerDiv.append('/');
                    } else {
                    	referencerDiv.appendChild(span);
                    }
                    
                }
            }
            index2++;
        });

        // 모달 닫기
        bootstrap.Modal.getInstance(document.getElementById("approvalLineModal")).hide();
    };
    
    
		
		// 승인요청 버튼 클릭 시 결재 생성
		const createApprovalForm = document.create_approval_form;
		createApprovalForm.addEventListener('submit', (e) =>{
			e.preventDefault();
			let valid = false;
			let valid_msg = '';
			
			const hasApprover = Array.from(approverThList).some(th => th.textContent.trim() !== '');
			
			if(!createApprovalForm.appr_title.value) {
				valid_msg += '결재 제목을 입력해주세요.';
			} else if(!createApprovalForm.start_date.value) {
				valid_msg += '시작일을 입력해주세요.';
			} else if(!createApprovalForm.end_date.value) {
				valid_msg += '종료일 입력해주세요.';
			} else if(!hasApprover) {
				valid_msg += '결재자는 한명이상 등록되어야합니다.';
			} else {
				valid = true;
			}
			
			if(valid == false) {
				alert(valid_msg);
			} else {
				console.log(valid);
				console.log('test');
				console.log(document.querySelector("div[name='appr_content']").innerHTML);
				document.querySelector("input[name='appr_text']").value = 
					document.querySelector("div[name='appr_content']").innerHTML;
				let payload = new FormData(createApprovalForm);
				const csrfToken = document.querySelector('meta[name="_csrf"]').content;
				const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;
				payload.append('_csrf', csrfToken);
				fetch('/approval/create', {
					method:'post',
					body:payload,
					headers: {
						[csrfHeader]: csrfToken
					},
					credentials: 'include'
				})
				.then(response => response.json())
				.then(data => {
					alert(data.res_msg);
					if(data.res_code =='200') {
						console.log('성공');
						location.href = '/approval';
					}
				})
			}
		})
		
	  	
	</script>

	<script>
		// 얼럿창 생성 및 소멸
		document.addEventListener('DOMContentLoaded', function () {
	    	const alertBox = document.getElementById("custom-alert");
	    	
	    	if (alertBox) {
				setTimeout(function () {
					alertBox.classList.remove('show');
					alertBox.classList.add('fade');
				
					setTimeout(function () {
						alertBox.classList.add('d-none');
					}, 300);
				}, 3000);
			}
	  	});
	</script>

	<script>
		// 얼럿창 x버튼
    	document.addEventListener('DOMContentLoaded', function() {
        	const alertCloseButton = document.querySelector('.btn-close');
        	if (alertCloseButton) {
            	alertCloseButton.addEventListener('click', function() {
                	const alertBox = document.getElementById("custom-alert");
                	alertBox.classList.add('d-none');
            	});
        	}
    	});
	</script>


	<!-- Bootstrap Common JS Files Start -->

	<!-- Import vendorJs Files -->
	<script th:src="@{/assets/js/vendor.min.js}"></script>

	<!-- Import Js Files -->
	<script
		th:src="@{/assets/libs/bootstrap/dist/js/bootstrap.bundle.min.js}"></script>
	<script th:src="@{/assets/libs/simplebar/dist/simplebar.min.js}"></script>
	<script th:src="@{/assets/js/theme/app.init.js}"></script>
	<script th:src="@{/assets/js/theme/theme.js}"></script>
	<script th:src="@{/assets/js/theme/app.min.js}"></script>
	<script th:src="@{/assets/js/theme/sidebarmenu.js}"></script>

	<!-- solar icons -->
	<script
		src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>
	<script th:src="@{/assets/libs/owl.carousel/dist/owl.carousel.min.js}"></script>
	<script th:src="@{/assets/libs/apexcharts/dist/apexcharts.min.js}"></script>
	<script th:src="@{/assets/js/dashboards/dashboard.js}"></script>

	<!-- Bootstrap Common JS Files End -->

</th:block>
</html>
