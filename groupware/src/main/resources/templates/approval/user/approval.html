<!DOCTYPE html>
<html lang="en" dir="ltr" data-bs-theme="light"
	data-color-theme="Blue_Theme" data-layout="horizontal"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{/include/layout}">

<th:block layout:fragment="content">
	<!-- jQuery -->
	<script th:src="@{/js/jquery-3.7.1.js}"></script>
	<!-- JSignature -->
	<script th:src="@{/js/jji/Jsignature/Jsignature.min.js}"></script>
	<link th:href="@{/css/jji.css}" rel="stylesheet">

	<div class="container-fluid px-4">
		<!-- Breadcrumb -->
		<div class="col-lg-8 col-md-6 col-12 align-self-center">
			<nav aria-label="breadcrumb">
				<ol class="breadcrumb align-items-center">
					<li class="breadcrumb-item"><a
						class="text-muted text-decoration-none" th:href="@{/home}"> <i
							class="ti ti-home fs-5"></i>
					</a></li>
					<li class="breadcrumb-item" aria-current="page">전자 결재 시스템</li>
					<li class="breadcrumb-item active" aria-current="page">보낸 문서함</li>
				</ol>
			</nav>
			<br>
			<h2 class="mb-0 fw-bolder fs-8">전자 결재 시스템</h2>
		</div>
		<br>

		<!-- Tabs -->
		<ul class="nav nav-tabs mb-4">
			<li class="nav-item"><a class="nav-link active"
				th:href="@{/approval}">보낸 문서함</a></li>
			<li class="nav-item"><a class="nav-link"
				th:href="@{/approval/receive}">받은 문서함</a></li>
			<li class="nav-item"><a class="nav-link"
				th:href="@{/approval/create}">결재 작성</a></li>
		</ul>

		<!-- Summary Cards -->
		<div class="container-fluid my-5 px-4">
			<div class="row g-3 text-center">
				<div class="col-md">
					<div class="card shadow-sm rounded-4 p-3 h-100">
						<div class="fs-3">📤</div>
						<div class="fw-semibold mt-2">결재 요청</div>
						<div class="fs-4 fw-bold mt-1 text-primary"
							th:text="${requestCount}">0</div>
					</div>
				</div>
				<div class="col-md">
					<div class="card shadow-sm rounded-4 p-3 h-100">
						<div class="fs-3">⏳</div>
						<div class="fw-semibold mt-2">결재 대기 중</div>
						<div class="fs-4 fw-bold mt-1 text-warning"
							th:text="${waitingCount}">0</div>
					</div>
				</div>
				<div class="col-md">
					<div class="card shadow-sm rounded-4 p-3 h-100">
						<div class="fs-3">❌</div>
						<div class="fw-semibold mt-2">결재 반려</div>
						<div class="fs-4 fw-bold mt-1 text-danger"
							th:text="${rejectedCount}">0</div>
					</div>
				</div>
				<div class="col-md">
					<div class="card shadow-sm rounded-4 p-3 h-100">
						<div class="fs-3">✅</div>
						<div class="fw-semibold mt-2">결재 완료</div>
						<div class="fs-4 fw-bold mt-1 text-success"
							th:text="${approvedCount}">0</div>
					</div>
				</div>
			</div>
		</div>


		<!-- Search + Button -->
		<div class="d-flex justify-content-between align-items-center mb-3">
			<form action="/approval/search" method="get">
				<div
					class="d-flex align-items-center rounded-pill shadow-sm px-3 py-2"
					style="background-color: white; max-width: 350px; height: 40px; border: 1px solid #ced4da;">
					<button type="submit" class="btn border-0 bg-transparent p-0">
						<i class="ti ti-search fs-5 text-primary"></i>
					</button>
					<input type="text" name="keyword"
						class="form-control border-0 bg-transparent ms-2"
						placeholder="검색어를 입력하세요."
						style="box-shadow: none; background-color: transparent;">
				</div>
			</form>

			<!-- 버튼 그룹 -->
			<div class="d-flex gap-2">
				<button class="btn btn-primary rounded-pill" data-bs-toggle="modal"
					id="signature_btn" data-bs-target="#signatureModal"
					th:value="${#authentication.principal.member.memberNo}">전자서명
					등록</button>
				<button class="btn btn-primary rounded-pill"
					onclick='createApproval();'>결재 작성</button>
			</div>
		</div>

		<!-- Table -->
		<div class="table-wrapper p-4 bg-white rounded-4 shadow-sm">
			<div class="table-responsive">
				<table class="table align-middle text-center">
					<!-- 테이블 헤더 -->
					<thead class="table-light">
						<tr>
							<th>번호</th>
							<th>제목</th>
							<th>작성자</th>
							<th>상태</th>
							<th>작성일</th>
							<th>양식 종류</th>
						</tr>
					</thead>
					<!-- 테이블 바디 -->
					<tbody>
						<tr th:if="${#lists.isEmpty(approvalList)}">
							<td colspan="6">보낸 결재 요청이 없습니다.</td>
						</tr>
						<tr th:if="${!#lists.isEmpty(approvalList)}"
							th:each="approval, approvalStatus : ${approvalList}"
							th:attr="data-approver-no=${approval.apprNo}">
							<td th:text="${approval.apprNo}">번호</td>
							<td th:text="${approval.apprTitle}">제목</td>
							<td th:text="${approval.member.memberName}">작성자</td>
							<td><span class="badge bg-warning-subtle text-dark"
								th:text="${approval.apprStatus}">상태</span></td>
							<td
								th:text="${#temporals.format(approval.apprReqDate,'yyyy-MM-dd HH:mm')}">요청일</td>
							<td th:text="${approval.approvalForm.approvalFormName}">양식
								종류</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>



		<!-- Pagination -->
		<nav class="d-flex justify-content-center mt-4">
			<ul class="pagination">
				<li class="page-item disabled"><a class="page-link">‹</a></li>
				<li class="page-item active"><a class="page-link" href="#">1</a></li>
				<li class="page-item"><a class="page-link" href="#">2</a></li>
				<li class="page-item"><a class="page-link" href="#">3</a></li>
				<li class="page-item"><a class="page-link" href="#">...</a></li>
				<li class="page-item"><a class="page-link" href="#">10</a></li>
				<li class="page-item"><a class="page-link" href="#">›</a></li>
			</ul>
		</nav>
	</div>

	<!-- Modal -->
	<div class="modal fade" id="signatureModal" tabindex="-1"
		aria-labelledby="signatureModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-lg modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="signatureModalLabel">서명란: 마우스로
						입력하세요</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="닫기"></button>
				</div>

				<div class="modal-body">
					<div id="signatureContainer" class="p-3 bg-light rounded shadow-sm">
						<div id="signature" style="width: 100%; height: 250px;"></div>
					</div>
				</div>

				<div class="modal-footer">
					<button onclick="saveSignature(); return false;"
						class="btn btn-primary">저장</button>
					<button onclick="closeSignature(); return false;"
						class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
				</div>
			</div>
		</div>
	</div>


	<script>
		const createApproval = function() {
			location.href = '/approval/create';
		}

		let memberNo = 0;
		
		const token = $('meta[name="_csrf"]').attr('content');
		const header = $('meta[name="_csrf_header"]').attr('content');

		let isSignatureInitialized = false;

		$(document).ready(function() {
			$('#signatureModal').on('shown.bs.modal', function() {
				memberNo = $('#signature_btn').val(); // 회원 번호 가져오기
				console.log("memberNo:", memberNo);

				// 한 번만 초기화되게 체크
				if (!isSignatureInitialized) {
					$("#signature").jSignature({
						height : 300,
						width : 600
					});
					isSignatureInitialized = true;
				}
			});

			// 모달 닫힐 때 서명 내용 초기화
			$('#signatureModal').on('hidden.bs.modal', function() {
				if (isSignatureInitialized) {
					$("#signature").jSignature("reset");
				}
			});
		});

		// 서명 저장
		function saveSignature() {
			const data = $("#signature").jSignature("getData", "image");
			
			const imageData = data[1];
			
			$.ajax({
				url: '/member/create/signature',
				method:'post',
				data: {
					memberNo : memberNo,
					signature:imageData
				},
				beforeSend: function(xhr) {
			        xhr.setRequestHeader(header, token);  // spring security
			    },
				success: function(data) {
					alert(data.res_msg);
				},
				error: function() {
					alert('서명 저장 실패');
				}
			})

			// 모달 닫기
			$('#signatureModal').modal('hide');
		}

		// 서명 삭제
		function deleteSignature() {
			$("#" + memberNo + "_img").attr("src", "");
			$("#" + memberNo + "_del").css("display", "none");
		}

		// 서명 닫기
		function closeSignature() {
			$('#signatureModal').modal('hide');
		}
	</script>



	<!-- ---------------------------------------------------------------------------- -->

	<!-- Custom JS Files -->



	<!-- Bootstrap Common JS Files Start -->

	<!-- Import vendorJs Files -->
	<!-- <script th:src="@{/assets/js/vendor.min.js}"></script> -->

	<!-- Import Js Files -->
	<script
		th:src="@{/assets/libs/bootstrap/dist/js/bootstrap.bundle.min.js}"></script>
	<script th:src="@{/assets/libs/simplebar/dist/simplebar.min.js}"></script>
	<script th:src="@{/assets/js/theme/app.init.js}"></script>
	<script th:src="@{/assets/js/theme/theme.js}"></script>
	<script th:src="@{/assets/js/theme/app.min.js}"></script>
	<script th:src="@{/assets/js/theme/sidebarmenu.js}"></script>

	<!-- solar icons -->
	<script
		src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>
	<script th:src="@{/assets/libs/owl.carousel/dist/owl.carousel.min.js}"></script>
	<script th:src="@{/assets/libs/apexcharts/dist/apexcharts.min.js}"></script>
	<script th:src="@{/assets/js/dashboards/dashboard.js}"></script>

	<!-- Bootstrap Common JS Files End -->

	<!-- Custom JS Files -->


</th:block>
</html>
