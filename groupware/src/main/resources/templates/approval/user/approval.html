<!DOCTYPE html>
<html lang="en" dir="ltr" data-bs-theme="light"
	data-color-theme="Blue_Theme" data-layout="horizontal"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{/include/layout}">

<th:block layout:fragment="content">
	<!-- jQuery -->
	<script th:src="@{/js/jquery-3.7.1.js}"></script>
	<!-- JSignature -->
	<script th:src="@{/js/jji/Jsignature/Jsignature.min.js}"></script>
	<link th:href="@{/css/jji.css}" rel="stylesheet">

	<div class="container-fluid px-4">
		<!-- Breadcrumb -->
		<div class="col-lg-8 col-md-6 col-12 align-self-center">
			<nav aria-label="breadcrumb">
				<ol class="breadcrumb align-items-center">
					<li class="breadcrumb-item"><a
						class="text-muted text-decoration-none" th:href="@{/home}"> <i
							class="ti ti-home fs-5"></i>
					</a></li>
					<li class="breadcrumb-item" aria-current="page">ì „ì ê²°ì¬ ì‹œìŠ¤í…œ</li>
					<li class="breadcrumb-item active" aria-current="page">ë³´ë‚¸ ë¬¸ì„œí•¨</li>
				</ol>
			</nav>
			<br>
			<h2 class="mb-0 fw-bolder fs-8">ì „ì ê²°ì¬ ì‹œìŠ¤í…œ</h2>
		</div>
		<br>

		<!-- Tabs -->
		<ul class="nav nav-tabs mb-4">
			<li class="nav-item"><a class="nav-link active"
				th:href="@{/approval}">ë³´ë‚¸ ë¬¸ì„œí•¨</a></li>
			<li class="nav-item"><a class="nav-link"
				th:href="@{/approval/receive}">ë°›ì€ ë¬¸ì„œí•¨</a></li>
			<li class="nav-item"><a class="nav-link"
				th:href="@{/approval/create}">ê²°ì¬ ì‘ì„±</a></li>
		</ul>

		<!-- Summary Cards -->
		<div class="container-fluid my-5 px-4">
			<div class="row g-3 text-center">
				<div class="col-md">
					<div class="card shadow-sm rounded-4 p-3 h-100">
						<div class="fs-3">ğŸ“¤</div>
						<div class="fw-semibold mt-2">ê²°ì¬ ìš”ì²­</div>
						<div class="fs-4 fw-bold mt-1 text-primary"
							th:text="${requestCount}">0</div>
					</div>
				</div>
				<div class="col-md">
					<div class="card shadow-sm rounded-4 p-3 h-100">
						<div class="fs-3">â³</div>
						<div class="fw-semibold mt-2">ê²°ì¬ ëŒ€ê¸° ì¤‘</div>
						<div class="fs-4 fw-bold mt-1 text-warning"
							th:text="${waitingCount}">0</div>
					</div>
				</div>
				<div class="col-md">
					<div class="card shadow-sm rounded-4 p-3 h-100">
						<div class="fs-3">âŒ</div>
						<div class="fw-semibold mt-2">ê²°ì¬ ë°˜ë ¤</div>
						<div class="fs-4 fw-bold mt-1 text-danger"
							th:text="${rejectedCount}">0</div>
					</div>
				</div>
				<div class="col-md">
					<div class="card shadow-sm rounded-4 p-3 h-100">
						<div class="fs-3">âœ…</div>
						<div class="fw-semibold mt-2">ê²°ì¬ ì™„ë£Œ</div>
						<div class="fs-4 fw-bold mt-1 text-success"
							th:text="${approvedCount}">0</div>
					</div>
				</div>
			</div>
		</div>


		<!-- Search -->
		<div class="d-flex justify-content-between align-items-center mb-3">
			<form class="d-flex align-items-center gap-2 flex-wrap"
				action="/approval" method="get">
				<select name="search_type"
					class="form-select w-auto bg-primary-subtle border-0"
					style="width: 120px;">
					<option th:value="''" th:selected="${searchDto.search_type == null}">ì„ íƒ</option>
					<option th:value="appr_title" th:selected="${searchDto.search_type == 'appr_title'}">ì œëª©</option>
					<option th:value="approval_form_name" th:selected="${searchDto.search_type == 'approval_form_name'}">ì–‘ì‹ ì¢…ë¥˜</option>
				</select>
				<div class="position-relative" style="max-width: 350px;">
					<input type="text" name="search_text" th:value="${searchDto.search_text}"
						class="form-control search-chat py-2 ps-5" id="text-srh"
						placeholder="Search Contact">
					<button type="submit"
						class="btn position-absolute top-50 start-0 translate-middle-y bg-transparent border-0 p-0 ms-3">
						<i class="ti ti-search fs-6 text-dark"></i>
					</button>
				</div>

				<div class="sort">
					<select id="order_type" name="order_type"
						class="form-select w-auto bg-primary-subtle border-0">
						<option value="1" th:selected="${searchDto.order_type == 1}">ìµœì‹ ìˆœ</option>
						<option value="2" th:selected="${searchDto.order_type == 2}">ì˜¤ë˜ëœìˆœ</option>
					</select>
				</div>
			</form>
			<div class="d-flex gap-2">
				<th:block th:if="${#strings.isEmpty(member.signature)}">
					<button class="btn btn-primary" data-bs-toggle="modal"
						id="signature_btn" data-bs-target="#signatureModal"
						th:value="${#authentication.principal.member.memberNo}">ì „ìì„œëª…
						ë“±ë¡</button>
				</th:block>
				<th:block th:if="${!#strings.isEmpty(member.signature)}">
					<button class="btn btn-primary" data-bs-toggle="modal"
						id="saveSignature_btn" data-bs-target="#saveSignatureModal"
						th:value="${#authentication.principal.member.memberNo}">ì „ìì„œëª…
						ë³´ê¸°</button>
				</th:block>
				<button class="btn btn-primary" onclick='createApproval();'>ê²°ì¬
					ì‘ì„±</button>
			</div>
		</div>

		<!-- Table -->
		<div class="table-wrapper p-4 bg-white rounded-4 shadow-sm">
			<div class="table-responsive">
				<table class="table align-middle text-center">
					<!-- í…Œì´ë¸” í—¤ë” -->
					<thead class="bg-light">
						<tr>
							<th>ë²ˆí˜¸</th>
							<th>ì œëª©</th>
							<th>ì‘ì„±ì</th>
							<th>ìƒíƒœ</th>
							<th>ì‘ì„±ì¼</th>
							<th>ì–‘ì‹ ì¢…ë¥˜</th>
						</tr>
					</thead>
					<!-- í…Œì´ë¸” ë°”ë”” -->
					<tbody>
						<tr th:if="${#lists.isEmpty(approvalList)}">
							<td colspan="6">ë³´ë‚¸ ê²°ì¬ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</td>
						</tr>
						<tr th:if="${!#lists.isEmpty(approvalList)}"
							th:each="approval, approvalStatus : ${approvalList}"
							th:attr="data-approver-no=${approval.apprNo}">
							<td
								th:text="${(pageDto.nowPage-1)*(pageDto.numPerPage)+approvalStatus.count}">ë²ˆí˜¸</td>
							<td th:text="${approval.apprTitle}">ì œëª©</td>
							<td th:text="${approval.member.memberName}">ì‘ì„±ì</td>
							<th:block th:if="${approval.apprStatus == 'A'}">
								<td><span
									class="mb-1 badge  bg-warning-subtle text-warning">í•©ì˜
										ëŒ€ê¸°ì¤‘</span></td>
							</th:block>
							<th:block th:if="${approval.apprStatus == 'D'}">
								<td><span class="mb-1 badge  bg-info-subtle text-info">ê²°ì¬
										ëŒ€ê¸°ì¤‘</span></td>
							</th:block>
							<th:block th:if="${approval.apprStatus == 'C'}">
								<td><span
									class="mb-1 badge  bg-success-subtle text-success">ìŠ¹ì¸ </span></td>
							</th:block>
							<th:block th:if="${approval.apprStatus == 'R'}">
								<td><span class="mb-1 badge  bg-danger-subtle text-danger">ë°˜ë ¤</span></td>
							</th:block>
							<td
								th:text="${#temporals.format(approval.apprRegDate,'yyyy-MM-dd HH:mm')}">ìš”ì²­ì¼</td>
							<td th:text="${approval.approvalForm.approvalFormName}">ì–‘ì‹
								ì¢…ë¥˜</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>



		<!-- Pagination -->
		<nav class="d-flex justify-content-center mt-4">
			<ul class="pagination mb-0">
				<!-- ì´ì „ í˜ì´ì§€ ë²„íŠ¼ -->
				<li th:if="${pageDto.prev}"
					class="page-item"
					th:classappend="${pageDto.prev} ? '' : 'disabled'"><a
					class="page-link"
					th:href="@{/approval(nowPage=${pageDto.pageBarStart - 1}, search_type=${searchDto.search_type}, search_text=${searchDto.search_text}, order_type=${searchDto.order_type})}"
					aria-label="Previous"> <span aria-hidden="true">&laquo;</span>
				</a></li>

				<!-- í˜ì´ì§€ ë²ˆí˜¸ -->
				<li class="page-item"
					th:each="num : ${#numbers.sequence(pageDto.pageBarStart, pageDto.pageBarEnd)}"
					th:classappend="${pageDto.nowPage == num} ? ' active'"><a
					class="page-link"
					th:href="@{/approval(nowPage=${num}, search_type=${searchDto.search_type}, search_text=${searchDto.search_text}, order_type=${searchDto.order_type})}"
					th:text="${num}"> </a></li>

				<!-- ë‹¤ìŒ í˜ì´ì§€ ë²„íŠ¼ -->
				<li th:if="${pageDto.next}"
					class="page-item"
					th:classappend="${pageDto.next} ? '' : 'disabled'"><a
					class="page-link"
					th:href="@{/approval(nowPage=${pageDto.pageBarEnd + 1}, search_type=${searchDto.search_type}, search_text=${searchDto.search_text}, order_type=${searchDto.order_type})}"
					aria-label="Next"> <span aria-hidden="true">&raquo;</span>
				</a></li>
			</ul>
		</nav>
	</div>

	<!-- Modal -->
	<div class="modal fade" id="signatureModal" tabindex="-1"
		aria-labelledby="signatureModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-lg modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="signatureModalLabel">ì„œëª…ë€: ë§ˆìš°ìŠ¤ë¡œ
						ì…ë ¥í•˜ì„¸ìš”</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="ë‹«ê¸°"></button>
				</div>

				<div class="modal-body">
					<div id="signatureContainer" class="p-3 bg-light rounded shadow-sm">
						<div id="signature" style="width: 100%; height: 250px;"></div>
					</div>
				</div>

				<div class="modal-footer">
					<button onclick="saveSignature(); return false;"
						class="btn btn-primary">ì €ì¥</button>
					<button onclick="closeSignature(); return false;"
						class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
				</div>
			</div>
		</div>
	</div>

	<!-- ì„œëª… ì¡°íšŒ Modal -->
	<div class="modal fade" id="saveSignatureModal" tabindex="-1"
		aria-labelledby="signatureModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-lg modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="saveSignatureModalLabel">ì„œëª…</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="ë‹«ê¸°"></button>
				</div>

				<div class="modal-body">
					<div id="saveSignatureContainer"
						class="p-3 bg-light rounded shadow-sm">
						<div id="saveSignature" style="width: 100%; height: 250px;">
							<input type="hidden" th:value="${member.signature}"
								id="member_signature"> <img src="" id="signImg"
								class="signature-img" alt="ì„œëª… ì´ë¯¸ì§€">
						</div>
					</div>
				</div>

				<div class="modal-footer">
					<button class="btn btn-primary" data-bs-toggle="modal"
						id="updateSignature_btn" data-bs-target="#updateSignatureModal"
						th:value="${#authentication.principal.member.memberNo}">ë³€ê²½</button>
					<button onclick="closeSignature(); return false;"
						class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
				</div>
			</div>
		</div>
	</div>

	<!-- ì„œëª… ì—…ë°ì´íŠ¸ Modal -->
	<div class="modal fade" id="updateSignatureModal" tabindex="-1"
		aria-labelledby="signatureModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-lg modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="updateSignatureModalLabel">ì„œëª…ë€:
						ë§ˆìš°ìŠ¤ë¡œ ì…ë ¥í•˜ì„¸ìš”</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="ë‹«ê¸°"></button>
				</div>

				<div class="modal-body">
					<div id="updateSignatureContainer"
						class="p-3 bg-light rounded shadow-sm">
						<div id="updateSignature" style="width: 100%; height: 250px;"></div>
					</div>
				</div>

				<div class="modal-footer">
					<button onclick="updateSignature(); return false;"
						class="btn btn-primary">ë³€ê²½</button>
					<button onclick="closeSignature(); return false;"
						class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
				</div>
			</div>
		</div>
	</div>


	<script>
		document.getElementById('order_type').addEventListener('change',
				function(e) {
					const searchType = document.querySelector('select[name="search_type"]').value;
					const searchText = document.querySelector('input[name="search_text"]').value;
					const orderType = e.target.value;
					// search_type=appr_title&search_text=1&order_type=1
					const params = new URLSearchParams({
						search_type: searchType,
						search_text: searchText,
						order_type: orderType
					});
					location.href = "/approval?" + params.toString();
		});

		const createApproval = function() {
			location.href = '/approval/create';
		}

		let memberNo = 0;

		const token = $('meta[name="_csrf"]').attr('content');
		const header = $('meta[name="_csrf_header"]').attr('content');

		let isSignatureInitialized = false;

		$(document).ready(function() {

			$('#saveSignatureModal').on('shown.bs.modal', function() {

				memberNo = $('#saveSignature_btn').val(); // íšŒì› ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
				console.log("memberNo:", memberNo);

				const signature = $('#member_signature').val();

				if (signature) {
					const imgSrc = 'data:image/png;base64,' + signature;
					$('#signImg').attr('src', imgSrc);
				} else {
					$('#signImg').attr('src', '');
				}
			});

			$('#signatureModal').on('shown.bs.modal', function() {

				memberNo = $('#signature_btn').val(); // íšŒì› ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
				console.log("memberNo:", memberNo);

				// í•œ ë²ˆë§Œ ì´ˆê¸°í™”ë˜ê²Œ ì²´í¬
				if (!isSignatureInitialized) {
					$("#signature").jSignature({
						height : 300,
						width : 600
					});
					isSignatureInitialized = true;
				}
			});

			$('#updateSignatureModal').on('shown.bs.modal', function() {

				memberNo = $('#updateSignature_btn').val(); // íšŒì› ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
				console.log("memberNo:", memberNo);

				// í•œ ë²ˆë§Œ ì´ˆê¸°í™”ë˜ê²Œ ì²´í¬
				if (!isSignatureInitialized) {
					$("#updateSignature").jSignature({
						height : 300,
						width : 600
					});
					isSignatureInitialized = true;
				}
			});

			// ëª¨ë‹¬ ë‹«í ë•Œ ì„œëª… ë‚´ìš© ì´ˆê¸°í™”
			$('#signatureModal').on('hidden.bs.modal', function() {
				if (isSignatureInitialized) {
					$("#signature").jSignature("reset");
				}
			});

			$('#updateSignatureModal').on('hidden.bs.modal', function() {
				if (isSignatureInitialized) {
					$("#updateSignature").jSignature("reset");
				}
			});
		});

		// ì„œëª… ì €ì¥
		function saveSignature() {
			const data = $("#signature").jSignature("getData", "image");

			const imageData = data[1];

			$.ajax({
				url : '/member/create/signature',
				method : 'post',
				data : {
					memberNo : memberNo,
					signature : imageData
				},
				beforeSend : function(xhr) {
					xhr.setRequestHeader(header, token); // spring security
				},
				success : function(data) {
					alert(data.res_msg);
					location.reload();
				},
				error : function() {
					alert('ì„œëª… ì €ì¥ ì‹¤íŒ¨');
				}
			})

			// ëª¨ë‹¬ ë‹«ê¸°
			$('#signatureModal').modal('hide');
		}

		// ì„œëª…ë³€ê²½
		function updateSignature() {
			const data = $("#updateSignature").jSignature("getData", "image");

			const imageData = data[1];

			$.ajax({
				url : '/member/update/signature',
				method : 'post',
				data : {
					memberNo : memberNo,
					updateSignature : imageData
				},
				beforeSend : function(xhr) {
					xhr.setRequestHeader(header, token); // spring security
				},
				success : function(data) {
					alert(data.res_msg);
					location.reload();
				},
				error : function() {
					alert('ì„œëª… ì €ì¥ ì‹¤íŒ¨');
				}
			})

			// ëª¨ë‹¬ ë‹«ê¸°
			$('#signatureModal').modal('hide');
		}

		// ì„œëª… ì‚­ì œ
		function deleteSignature() {
			$("#" + memberNo + "_img").attr("src", "");
			$("#" + memberNo + "_del").css("display", "none");
		}

		// ì„œëª… ë‹«ê¸°
		function closeSignature() {
			$('#signatureModal').modal('hide');
		}
	</script>



	<!-- ---------------------------------------------------------------------------- -->

	<!-- Custom JS Files -->



	<!-- Bootstrap Common JS Files Start -->

	<!-- Import vendorJs Files -->
	<!-- <script th:src="@{/assets/js/vendor.min.js}"></script> -->

	<!-- Import Js Files -->
	<script
		th:src="@{/assets/libs/bootstrap/dist/js/bootstrap.bundle.min.js}"></script>
	<script th:src="@{/assets/libs/simplebar/dist/simplebar.min.js}"></script>
	<script th:src="@{/assets/js/theme/app.init.js}"></script>
	<script th:src="@{/assets/js/theme/theme.js}"></script>
	<script th:src="@{/assets/js/theme/app.min.js}"></script>
	<script th:src="@{/assets/js/theme/sidebarmenu.js}"></script>

	<!-- solar icons -->
	<script
		src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>
	<script th:src="@{/assets/libs/owl.carousel/dist/owl.carousel.min.js}"></script>
	<script th:src="@{/assets/libs/apexcharts/dist/apexcharts.min.js}"></script>
	<script th:src="@{/assets/js/dashboards/dashboard.js}"></script>

	<!-- Bootstrap Common JS Files End -->

	<!-- Custom JS Files -->


</th:block>
</html>
