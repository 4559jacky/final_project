<!DOCTYPE html>
<html lang="en" dir="ltr" data-bs-theme="light"
	data-color-theme="Blue_Theme" data-layout="horizontal"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{/include/layout}">

<th:block layout:fragment="content">
	<!-- jQuery -->
	<script th:src="@{/js/jquery-3.7.1.js}"></script>
	<link th:href="@{/css/jji.css}" rel="stylesheet">

	<div class="container-fluid px-4">
		<!-- Breadcrumb -->
		<div class="col-lg-8 col-md-6 col-12 align-self-center">
			<nav aria-label="breadcrumb">
				<ol class="breadcrumb align-items-center">
					<li class="breadcrumb-item"><a
						class="text-muted text-decoration-none" th:href="@{/home}"> <i
							class="ti ti-home fs-5"></i>
					</a></li>
					<li class="breadcrumb-item" aria-current="page">전자 결재 시스템</li>
					<li class="breadcrumb-item active" aria-current="page">받은 문서함</li>
				</ol>
			</nav>
			<br>
			<h2 class="mb-0 fw-bolder fs-8">전자 결재 시스템</h2>
		</div>
		<br>

		<!-- Tabs -->
		<ul class="nav nav-tabs mb-4">
			<li class="nav-item"><a class="nav-link active" th:href="@{/approval}">보낸
					문서함</a></li>
			<li class="nav-item"><a class="nav-link"
				th:href="@{/approval/receive}">받은 문서함</a></li>
			<li class="nav-item"><a class="nav-link"
				th:href="@{/approval/create}">결재 작성</a></li>
		</ul>

		<div class="container-fluid px-4">
			<div class="card p-4 shadow-sm border-0 rounded-4 mb-4">
				<input type="hidden" name="memberNo" id="memberNo"
					th:value="${#authentication.principal.member.memberNo}"> <input
					type="hidden" name="approvalNo" id="approvalNo"
					th:value="${approval.apprNo}">
				<h4 id="approval_form_name" class="fw-bold text-center mb-4"
					th:text="${approval.approvalForm.approvalFormName}">양식 제목</h4>
				<div class="text-end" style="min-width: 180px;">
					작성일 : <span id="reg_date"
						th:text="${#temporals.format(approval.apprRegDate,'yyyy.MM.dd HH:mm')}"></span>
				</div>
				<table class="table table-bordered align-middle">
					<tbody>
						<tr>
							<th class="text-center bg-light" style="width: 15%;">기안자</th>
							<td style="width: 20%;" th:text="${approval.member.memberName}"></td>
							<th class="text-center bg-light" style="width: 15%;">부서</th>
							<td style="width: 20%;"
								th:text="${approval.member.dept.deptName}"></td>
							<th class="text-center bg-light" style="width: 15%;">직급</th>
							<td style="width: 20%;" th:text="${approval.member.pos.posName}"></td>
						</tr>
						<tr>
							<th class="text-center bg-light">제목</th>
							<td colspan="5">
								<div th:text="${approval.apprTitle}"></div>
							</td>
						</tr>
						<tr>
							<th class="text-center bg-light">일시</th>
							<td colspan="5">
								<div class="d-flex align-items-center" style="gap: 8px;">
									<div th:text="${approval.startDate}"></div>
									<span> ~ </span>
									<div th:text="${approval.endDate}"></div>
								</div>
							</td>
						</tr>
						<tr>
							<th class="text-center bg-light">결재자</th>
							<td colspan="5"><table
									class="table table-bordered text-center w-100">
									<thead class="table-light">
										<tr id="approver">
										  <th:block th:each="i : ${#numbers.sequence(0, 4)}">
										    <th class="text-center bg-light" style="width: 20%;" name="approver"
										        th:text="${(i < approverList.size()) ? approverList[i].member.memberName : ''}">
										    </th>
										  </th:block>
										</tr>
									</thead>
									<tbody>
										<tr id="approver_signature">
										  <th:block th:each="i : ${#numbers.sequence(0, 4)}">
										    <td class="text-center" style="height: 80px; padding: 0;">
										      <th:block th:if="${i < approverList.size()}">
										        <th:block th:if="${approverList[i].approverDecisionStatus == 'C'}">
										          <th:block th:if="${approverList[i].member.signature != null}">
										            <input type="hidden" th:value="${approverList[i].member.signature}" th:id="'approver_signature' + ${i + 1}">
										            <img th:src="@{${approverList[i].member.signature}}" th:id="'approverSignImg' + ${i + 1}" class="signature-img" alt="서명 이미지">
										          </th:block>
										          <th:block th:if="${approverList[i].member.signature == null}">
										            <input type="hidden" th:id="'approver_signature' + ${i + 1}">
										            <img th:src="@{/img/approval_btn.png}" class="signature-img" alt="서명 이미지">
										          </th:block>
										        </th:block>
										        <th:block th:if="${approverList[i].approverDecisionStatus == 'R'}">
										        	<img th:src="@{/img/companion_btn.png}" class="signature-img" alt="서명 이미지">
										        </th:block>
										      </th:block>
										    </td>
										  </th:block>
										</tr>
									</tbody>
								</table></td>
						</tr>
						<tr>
							<th class="text-center bg-light">합의자</th>
							<td colspan="5">
								<table class="table table-bordered text-center w-100">
									<thead class="table-light">
										<tr id="agreementer">
										  <th:block th:each="i : ${#numbers.sequence(0, 4)}">
										    <th class="text-center bg-light" style="width: 20%;" name="agreementer"
										        th:text="${i < agreementerList.size()} ? ${agreementerList[i].member.memberName} : ''">
										    </th>
										  </th:block>
										</tr>
									</thead>
									<tbody>
										<tr id="agreementer_signature">
										  <th:block th:each="i : ${#numbers.sequence(0, 4)}">
										    <td class="text-center" style="height: 80px; padding: 0;">
										      <th:block th:if="${i < agreementerList.size()}">
										        <th:block th:if="${agreementerList[i].agreementerAgreeStatus == 'C'}">
										          <th:block th:if="${agreementerList[i].member.signature != null}">
										            <input type="hidden" th:value="${agreementerList[i].member.signature}" th:id="'agreementer_signature' + ${i+1}">
										            <img th:src="@{${agreementerList[i].member.signature}}" th:id="'agreementerSignImg' + ${i+1}" class="signature-img" alt="서명 이미지">
										          </th:block>
										          <th:block th:if="${agreementerList[i].member.signature == null}">
										            <input type="hidden" th:id="'agreementer_signature' + ${i+1}">
										            <img th:src="@{/img/approval_btn.png}" class="signature-img" alt="서명 이미지">
										          </th:block>
										        </th:block>
										        <th:block th:if="${agreementerList[i].agreementerAgreeStatus == 'R'}">
										        	<img th:src="@{/img/companion_btn.png}" class="signature-img" alt="서명 이미지">
										        </th:block>
										      </th:block>
										    </td>
										  </th:block>
										</tr>
									</tbody>
								</table>
							</td>
						</tr>
						<tr>
							<th class="text-center bg-light">참조자</th>
							<td colspan="5"><th:block
									th:if="${!#lists.isEmpty(referencerList)}"
									th:each="referencer, status : ${referencerList}">
									<th:block th:if="${referencerList.size() != status.count}">
										<span th:text="|${referencer.member.memberName} /|"></span>
									</th:block>
									<th:block th:if="${referencerList.size() == status.count}">
										<span th:text="${referencer.member.memberName}"></span>
									</th:block>
								</th:block></td>
						</tr>
						<tr>
							<th class="text-center bg-light">첨부 파일</th>
							<td colspan="5">파일 내용 추가 예정</td>
						</tr>
					</tbody>
				</table>

				<!-- 동적 양식 영역 -->
				<div id="approval-content" class="mb-4"
					th:utext="${approval.apprText}"></div>
					
				<th:block th:if="${approval.apprStatus == 'R'}">
					<hr>
					<div class="mb-4">
						<h5>반려 사유</h5><span th:text="${#temporals.format(approval.apprResDate,'yyyy.MM.dd HH:mm')}"></span>
					</div>
					<div class="mb-4" id="appr_reason">
						<span th:text="${approval.apprReason}">반려 사유</span>
					</div>
				</th:block>
			</div>
		</div>
	</div>

	<script>
		$(document).ready(function() {
			
			$(document).ready(function() {
				for (let i = 1; i <= 5; i++) {
					const signature = $(`#approver_signature${i}`).val();
					const imgTag = $(`#approverSignImg${i}`);

					if (signature) {
						imgTag.attr('src', 'data:image/png;base64,' + signature);
					} else {
						imgTag.attr('src', '');
					}
				}
				
				for (let i = 1; i <= 5; i++) {
					const signature = $(`#agreementer_signature${i}`).val();
					const imgTag = $(`#agreementerSignImg${i}`);

					if (signature) {
						imgTag.attr('src', 'data:image/png;base64,' + signature);
					} else {
						imgTag.attr('src', '');
					}
				}
			});
			
		});
	</script>



	<!-- Import vendorJs Files -->
	<script th:src="@{/assets/js/vendor.min.js}"></script>

	<!-- Import Js Files -->
	<script
		th:src="@{/assets/libs/bootstrap/dist/js/bootstrap.bundle.min.js}"></script>
	<script th:src="@{/assets/libs/simplebar/dist/simplebar.min.js}"></script>
	<script th:src="@{/assets/js/theme/app.init.js}"></script>
	<script th:src="@{/assets/js/theme/theme.js}"></script>
	<script th:src="@{/assets/js/theme/app.min.js}"></script>
	<script th:src="@{/assets/js/theme/sidebarmenu.js}"></script>

	<!-- solar icons -->
	<script
		src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>
	<script th:src="@{/assets/libs/owl.carousel/dist/owl.carousel.min.js}"></script>
	<script th:src="@{/assets/libs/apexcharts/dist/apexcharts.min.js}"></script>
	<script th:src="@{/assets/js/dashboards/dashboard.js}"></script>

	<!-- Bootstrap Common JS Files End -->
</th:block>
</html>
