<!DOCTYPE html>
<html
xmlns:th="http://www.thymeleaf.org"
xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
layout:decorate="~{/include/layout}">

<th:block layout:fragment="content">
  <script th:src="@{/js/jquery-3.7.1.js}"></script>
  <div class="col-lg-8 col-md-6 col-12 align-self-center">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb align-items-center">
        <li class="breadcrumb-item">
          <a class="text-muted text-decoration-none" th:href="@{/home}"> <i class="ti ti-home fs-5"></i></a>
        </li>
        <li class="breadcrumb-item" aria-current="page">공지사항 게시판</li>
      </ol>
    </nav>
    <br>
    <h2 class="mb-0 fw-bolder fs-8">공지사항 게시글 작성</h2>
  </div>
  <br>

  <form name="create_notice_form" action="/notice/create" method="post" enctype="multipart/form-data">
    <input type="hidden" name="_csrf" th:value="${_csrf.token}" /> <!-- ✅ CSRF 토큰 필드 추가 -->
    <div class="container mt-4">
      <div class="card shadow-sm p-4">
        <div class="row align-items-center mb-3">
          <div class="col-md-9 col-sm-12 mb-2 mb-md-0">
            <label for="notice_title" class="form-label fw-semibold">제목</label>
            <input type="text" class="form-control" id="notice_title" name="notice_title" placeholder="게시글 제목을 입력하세요">
            <input type="hidden" name="member_no" th:value="${#authentication.principal.member.memberNo}"/>
          </div>
        </div>
        <!-- SmartEditor2 영역 -->
        <div class="post-form">
          <textarea id="smartEditor" name="notice_content" rows="10" cols="100" style="width:100%;"></textarea>
        </div>
          <div class="col-md-3 col-sm-12 text-md-end text-start">
            <label class="d-none d-md-block invisible">제출</label>
            <input type="submit" class="btn btn-primary px-3 py-1" value="작성 완료">
          </div>
      </div>
    </div>
  </form>
</th:block>

<th:block layout:fragment="scripts">
  <!-- ✅ SmartEditor2 관련 스크립트: 반드시 이 순서와 경로 사용 -->
  <script src="/smarteditor2/js/lib/jindo2.all.js"></script>
  <script src="/smarteditor2/js/lib/jindo_component.js"></script>
  <script src="/smarteditor2/js/SE2M_Configuration.js"></script>
  <script src="/smarteditor2/js/SE2BasicCreator.js"></script>
  <script src="/smarteditor2/js/smarteditor2.js"></script>
  <script src="/smarteditor2/js/HuskyEZCreator.js" charset="utf-8"></script> <!-- ✅ 정확한 경로 고정 -->

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      let oEditors = [];
      nhn.husky.EZCreator.createInIFrame({
        oAppRef: oEditors,
        elPlaceHolder: "smartEditor",
        sSkinURI: "/smarteditor2/SmartEditor2Skin.html", // ✅ 이 경로는 절대 변경하지 않음
        fCreator: "createSEditor2"
      });

      const form = document.create_notice_form;
      form.addEventListener("submit", (e) => {
        e.preventDefault();

        oEditors.getById["smartEditor"].exec("UPDATE_CONTENTS_FIELD", []);

        const title = form.notice_title.value;
        const content = form.notice_content.value;

        let vali_check = false;
        let vali_text = "";

        if (!title) {
          vali_text += "제목을 입력하세요.";
        } else if (!content || content === '<p><br></p>') {
          vali_text += "내용을 입력하세요.";
        } else {
          vali_check = true;
        }

        if (!vali_check) {
          alert(vali_text);
          return;
        }

        const payload = new FormData(form);
        const csrfToken = document.querySelector('input[name="_csrf"]').value;

        fetch("/notice/create", {
          method: "POST",
          headers: {
            "X-CSRF-TOKEN": csrfToken
          },
          body: payload
        })
        .then(response => response.json())
        .then(data => {
          alert(data.res_msg);
          if (data.res_code === "200") {
            location.href = "/notice";
          }
        })
        .catch(err => console.error("에러 발생:", err));
      });
    });
  </script>

  <!-- 기존 JS 구성 유지 -->
  <script th:src="@{/assets/js/vendor.min.js}"></script>
  <script th:src="@{/assets/libs/bootstrap/dist/js/bootstrap.bundle.min.js}"></script>
  <script th:src="@{/assets/libs/simplebar/dist/simplebar.min.js}"></script>
  <script th:src="@{/assets/js/theme/app.init.js}"></script>
  <script th:src="@{/assets/js/theme/theme.js}"></script>
  <script th:src="@{/assets/js/theme/app.min.js}"></script>
  <script th:src="@{/assets/js/theme/sidebarmenu.js}"></script>
  <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>
  <script th:src="@{/assets/libs/owl.carousel/dist/owl.carousel.min.js}"></script>
  <script th:src="@{/assets/libs/apexcharts/dist/apexcharts.min.js}"></script>
  <script th:src="@{/assets/js/dashboards/dashboard.js}"></script>
</th:block>
</html>
