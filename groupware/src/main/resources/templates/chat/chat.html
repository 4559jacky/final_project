<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{/include/layout}">
<th:block layout:fragment="content">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
	<link rel="stylesheet"
		href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css" />
	<link th:href="@{/css/ysw.css}" rel="stylesheet">

	<!-- ìƒë‹¨ ë©”ë‰´ í‘œì‹œ  -->
	<div class="col-lg-8 col-md-6 col-12 align-self-center">
		<nav aria-label="breadcrumb">
			<ol class="breadcrumb align-items-center">
				<li class="breadcrumb-item"><a
					class="text-muted text-decoration-none" th:href="@{/home}"> <i
						class="ti ti-home fs-5"></i>
				</a></li>
				<li class="breadcrumb-item" aria-current="page">ì‚¬ë‚´ ì±„íŒ…</li>
			</ol>
		</nav>
		<br>
		<h2 class="mb-0 fw-bolder fs-8">ì‚¬ë‚´ ì±„íŒ…</h2>
	</div>
	<br>

	<div class="card overflow-hidden chat-application">
		<div
			class="d-flex align-items-center justify-content-between gap-6 m-3 d-lg-none">
			<button class="btn btn-primary d-flex" type="button"
				data-bs-toggle="offcanvas" data-bs-target="#chat-sidebar"
				aria-controls="chat-sidebar">
				<i class="ti ti-menu-2 fs-5"></i>
			</button>
		</div>
		<div class="d-flex">
			<div class="w-30 d-none d-lg-block border-end user-chat-box">
				<div class="px-4 pt-9 pb-6">
					<!-- í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ì› ì •ë³´  -->
					<div class="d-flex align-items-center justify-content-between mb-3">
						<div class="d-flex align-items-center">
							<div class="position-relative">
								<img th:src="@{/img/default_profile.png}" width="54" height="54" class="rounded-circle" />
							</div>
							<div class="ms-3">
								<h6 th:text="|${#authentication.principal.member.memberName} ${#authentication.principal.member.pos.posName}|" class="fw-semibold mb-2"></h6>
								<p th:text="${#authentication.principal.member.dept.deptName}" class="mb-0 fs-2">ë¶€ì„œ</p>
							</div>
						</div>

					</div>
					<!-- ì±„íŒ… ëª©ë¡ ê²€ìƒ‰ -->
					<form class="position-relative mb-4">
						<input type="text" class="form-control search-chat py-2 ps-5"
							id="text-srh" placeholder="ì±„íŒ…ë°© ì´ë¦„ì„ ê²€ìƒ‰í•˜ì„¸ìš”." /> <i
							class="ti ti-search position-absolute top-50 start-0 translate-middle-y fs-6 text-dark ms-3"></i>
					</form>
				</div>
				<!-- ì±„íŒ…ë°© ëª©ë¡ -->
				<div class="app-chat" style="max-height: 572px; height: 572px;">
					<div data-simplebar style="height: 100%;">
						<ul th:if="${!#lists.isEmpty(chatRoomList)}"
							th:each="chatRoom : ${chatRoomList}"
							th:attr="data-room-no=${chatRoom.chat_room_no}"
							class="chat-users mb-0">
							
							<li>
								<a href="javascript:void(0)"
									class="px-4 py-3 bg-hover-light-black d-flex align-items-start justify-content-between chat-user"
									id="chat_user_3"
									th:attr="data-room-id=${chatRoom.chat_room_no}">
									
									<div class="d-flex align-items-center">
										<span class="position-relative">
											<img src="../assets/images/profile/user-8.jpg" alt="user-8"
												width="48" height="48" class="rounded-circle" />
											<span class="position-absolute bottom-0 end-0 p-1 badge rounded-pill bg-warning">
												<span class="visually-hidden">New alerts</span>
											</span>
										</span>
										<div class="ms-3 d-inline-block w-75">
											<h6 th:text="${chatRoom.chat_room_title}" class="mb-1 fw-semibold chat-title">ì±„íŒ…ë°© ì´ë¦„</h6>
											<span th:text="${chatRoom.last_msg}" class="fs-3 text-truncate text-body-color d-block">ë§ˆì§€ë§‰ ë©”ì„¸ì§€</span>
										</div>
									</div>
									<p th:text="${#temporals.format(chatRoom.last_msg_date, 'yy-MM-dd mm:ss')}" class="fs-2 mb-0 text-muted">ë³´ë‚¸ ì‹œê°„</p>
								</a>
							</li>
						</ul>
						<ul th:if="${#lists.isEmpty(chatRoomList)}" class="chat-users mb-0">
							<li>
								<div class="ms-3 d-inline-block w-75 text-center">
									<h6 class="mb-1 fw-semibold chat-title">í˜„ì¬ ì±„íŒ… ì¤‘ì¸ ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</h6>
								</div>
							</li>
						</ul>
					</div>
				</div>

				<div class="px-9 py-6 border-top text-center">
				    <button class="btn btn-primary px-4" id="create_btn" type="button">
				      + ìƒˆë¡œìš´ ì±„íŒ… ì¶”ê°€ 
				    </button>
				</div>
			</div>
			<div class="w-70 w-xs-100 chat-container">
				<div class="chat-box-inner-part h-100">
					<div class="chat-not-selected h-100 d-none">
						<div
							class="d-flex align-items-center justify-content-center h-100 p-5">
							<div class="text-center">
								<span class="text-primary"> <i
									class="ti ti-message-dots fs-10"></i>
								</span>
								<h6 class="mt-2">Open chat from the list</h6>
							</div>
						</div>
					</div>
					<!-- ì±„íŒ… ë°•ìŠ¤  -->
					 <!-- ìƒë‹¨ ì±„íŒ…ë°© ì •ë³´ ì¶œë ¥  -->
					<div class="chatting-box d-block">
						<div
							class="p-9 border-bottom chat-meta-user d-flex align-items-center justify-content-between">
							<div class="hstack gap-3 current-chat-user-name">
								<div class="position-relative">
								</div>
								<div>
									<h6 class="mb-1 name fw-semibold"></h6>
									<p class="mb-0 dept"></p>
								</div>
							</div>
							<ul class="list-unstyled mb-0 d-flex align-items-center">
								<li><a
									class="chat-menu text-dark px-2 fs-7 bg-hover-primary nav-icon-hover position-relative z-index-5"
									href="javascript:void(0)"> <i class="ti ti-menu-2"></i>
								</a></li>
							</ul>
						</div>
						<div class="d-flex parent-chat-box">
						<!-- ì±„íŒ… ë‚´ìš© ì¶œë ¤ -->
							<div class="chat-box w-xs-100">
								<div class="chat-box-inner p-9" data-simplebar>
									<div class="chat-list chat active-chat" data-user-id="0">
										
									</div>
									<div class="chat-list chat" data-user-id="3">
									</div>
								</div>
								<div class="px-9 py-6 border-top chat-send-message-footer">
									<div class="d-flex align-items-center justify-content-between">
										<div class="d-flex align-items-center gap-2 w-85">
											<input type="text"
												class="form-control message-type-box text-muted border-0 p-0 ms-2"
												placeholder="ë©”ì„¸ì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”." fdprocessedid="0p3op" id="msgContent"/>
										</div>
										<input type= hidden id="chatRoomNo">
										<input type= hidden id="sendMemberNo" th:value="${#authentication.principal.member.memberNo}">
										<input type= hidden id="sendMemberName" th:value="${#authentication.principal.member.memberName}">
										<input type= hidden id="sendMemberPos" th:value="${#authentication.principal.member.pos.posName}">
										<input type= hidden id="sendMemberDept" th:value="${#authentication.principal.member.dept.deptName}">
										<ul class="list-unstyledn mb-0 d-flex align-items-center">
											<li><a
												class="text-dark px-2 fs-7 bg-hover-primary nav-icon-hover position-relative z-index-5"
												href="javascript:void(0)"> <i class="ti ti-photo-plus"></i>
											</a></li>
											<li><a
												class="text-dark px-2 fs-7 bg-hover-primary nav-icon-hover position-relative z-index-5"
												href="javascript:void(0)"> <i class="ti ti-paperclip"></i>
											</a></li>
											<li>
												<a
												  class="text-dark px-2 fs-7 bg-hover-primary nav-icon-hover position-relative z-index-5"
												  href="javascript:void(0)"
												  id="send_btn">
												  <i class="ti ti-brand-telegram"></i>
												</a>
											</li>
										</ul>
									</div>
								</div>
							</div>
							<div class="app-chat-offcanvas border-start d-flex flex-column" >
    
						    <!-- ìŠ¤í¬ë¡¤ë˜ëŠ” ì˜ì—­ -->
						    <div class="flex-grow-1 overflow-auto" data-simplebar>
						        <div class="p-3 d-flex align-items-center justify-content-end">
						            <a class="chat-menu d-lg-none d-block text-dark fs-6 bg-hover-primary nav-icon-hover position-relative z-index-5"
						               href="javascript:void(0)">
						                <i class="ti ti-x"></i>
						            </a>
						        </div>
						        <div class="offcanvas-body px-4 pt-0">
						            <!-- ì°¸ì—¬ì -->
									<div class="section-block mb-5">
										<h6 class="fw-semibold mb-3 text-nowrap d-flex align-items-center gap-2">
										  ì°¸ì—¬ì <span class="text-muted" id="memberCount">(3)</span>
										  <button class="btn btn-rounded btn-light" id="add_btn" type="button"  style="font-size: 14px; padding: 1px 6px;">+</button>
										</h6>
										<div class="d-flex flex-wrap gap-2" id="memberInfo"></div>
									</div>
						            <!-- ì´ë¯¸ì§€ -->
						            <div class="section-block mb-5">
						                <h6 class="fw-semibold mb-3 text-nowrap">
						                    ì´ë¯¸ì§€ <span class="text-muted">(36)</span>
						                </h6>
						                <div class="row g-2">
						                    <div class="col-4">
						                        <img src="../assets/images/products/product-1.jpg" width="100%" class="rounded" alt="ì´ë¯¸ì§€" />
						                    </div>
						                    <div class="col-4">
						                        <img src="../assets/images/products/product-2.jpg" width="100%" class="rounded" alt="ì´ë¯¸ì§€" />
						                    </div>
						                </div>
						            </div>
						
						            <!-- íŒŒì¼ -->
						            <div class="section-block mb-5">
						                <h6 class="fw-semibold mb-3 text-nowrap">
						                    Files <span class="text-muted">(36)</span>
						                </h6>
						                <a href="javascript:void(0)" class="hstack gap-3 file-chat-hover justify-content-between text-nowrap mb-3">
						                    <div class="d-flex align-items-center gap-3">
						                        <div class="rounded-1 text-bg-light p-6">
						                            <img src="../assets/images/chat/icon-zip-folder.svg" alt="zip" width="24" height="24" />
						                        </div>
						                        <div>
						                            <h6 class="fw-semibold">work-project.zip</h6>
						                            <div class="d-flex align-items-center gap-3 fs-2 text-muted">
						                                <span>2 MB</span> <span>2 Dec 2024</span>
						                            </div>
						                        </div>
						                    </div>
						                    <span class="position-relative nav-icon-hover download-file">
						                        <i class="ti ti-download text-dark fs-6 bg-hover-primary"></i>
						                    </span>
						                </a>
						            </div>
						        </div>
						    </div>
						
						    <!-- í•­ìƒ ì•„ë˜ ê³ ì •ë˜ëŠ” ë²„íŠ¼ -->
						    <div class="border-top px-4 py-3">
						        <div class="d-flex justify-content-end">
						            <button class="btn btn-danger px-4" id="out_btn" type="button">ë‚˜ê°€ê¸°</button>
						        </div>
						    </div>
						</div>

						</div>
					</div>
				</div>
			</div>
			<div class="offcanvas offcanvas-start user-chat-box chat-offcanvas"
				tabindex="-1" id="chat-sidebar"
				aria-labelledby="offcanvasExampleLabel">
				<div class="offcanvas-header">
					<h5 class="offcanvas-title" id="offcanvasExampleLabel">ì±„íŒ…ëª©ë¡</h5>
					<button type="button" class="btn-close" data-bs-dismiss="offcanvas"
						aria-label="Close"></button>
				</div>
				<div class="px-4 pt-9 pb-6">
					<div class="d-flex align-items-center justify-content-between mb-3">
						<div class="d-flex align-items-center">
							<div class="position-relative">
								<img src="../assets/images/profile/user-1.jpg" alt="user1"
									width="54" height="54" class="rounded-circle" />
							</div>
							<div class="ms-3">
								<h6 th:text="|${#authentication.principal.member.memberName} ${#authentication.principal.member.pos.posName}|" class="fw-semibold mb-2"></h6>
								<p th:text="${#authentication.principal.member.dept.deptName}" class="mb-0 fs-2">ë¶€ì„œ</p>
							</div>
						</div>

					</div>
					<form class="position-relative mb-4">
						<input type="text" class="form-control search-chat py-2 ps-5"
							id="text-srh" placeholder="ì±„íŒ…ë°© ì´ë¦„ì„ ê²€ìƒ‰í•˜ì„¸ìš”." /> <i
							class="ti ti-search position-absolute top-50 start-0 translate-middle-y fs-6 text-dark ms-3"></i>
					</form>
				</div>
				<div class="app-chat">
					<ul th:if="${!#lists.isEmpty(chatRoomList)}" 
						th:each="chatRoom : ${chatRoomList}"
						th:attr="data-room-no=${chatRoom.chat_room_no}"
						class="class="chat-users p-0 m-0" style="padding-top: 0; padding-bottom: 0;"" data-simplebar>
						<li><a href="javascript:void(0)"
							class="px-4 py-3 bg-hover-light-black d-flex align-items-start justify-content-between chat-user"
							id="chat_user_3" data-user-id="3">
								<div class="d-flex align-items-center">
									<span class="position-relative"> <img
										src="../assets/images/profile/user-8.jpg" alt="user-8"
										width="48" height="48" class="rounded-circle" /> <span
										class="position-absolute bottom-0 end-0 p-1 badge rounded-pill bg-warning">
											<span class="visually-hidden">New alerts</span>
									</span>
									</span>
									<div class="ms-3 d-inline-block w-75">
										<h6 th:text="${chatRoom.chat_room_title}" class="mb-1 fw-semibold chat-title">ì±„íŒ…ë°© ì´ë¦„</h6>
										<span th:text="${chatRoom.last_msg}" class="fs-3 text-truncate text-body-color d-block">ë§ˆì§€ë§‰ ë©”ì„¸ì§€</span>
									</div>
								</div>
								<p th:text="${#temporals.format(chatRoom.last_msg_date, 'yy-MM-dd mm:ss')}" class="fs-2 mb-0 text-muted">ë³´ë‚¸ ì‹œê°„</p>
						</a></li>
					</ul>
					<ul th:if="${#lists.isEmpty(chatRoomList)}" class="chat-users mb-0 mh-n100" data-simplebar>
						<li>
							<div class="ms-3 d-inline-block w-75 text-center">
								<h6 class="mb-1 fw-semibold chat-title">ì±„íŒ… ì¤‘ì¸ ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</h6>
							</div>
						</li>
					</ul>
				</div>
			</div>
		</div>
	</div>
	
	<!-- ì±„íŒ…ë°© ì¶”ê°€ ëª¨ë‹¬ -->
	<div class="modal fade" id="selectMemberModal" tabindex="-1">
		<div class="modal-dialog modal-dialog-centered"
			style="max-width: 800px; width: auto; max-height: none;">
			<div class="modal-content p-3" style="max-height: none;">
				<div class="modal-header">
					<h5 class="modal-title fw-bold fs-4"> ì±„íŒ…ë°© ì¶”ê°€ </h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
				    <!-- ì±„íŒ…ë°© ì œëª© ì…ë ¥ -->
				    <label for="title" class="form-label">ë“±ë¡í•  ì±„íŒ…ë°©ëª…</label> 
					<input type="text" class="form-control" id="title" name="title"
							style="color: black;" placeholder="ë“±ë¡í•˜ì‹¤ ì±„íŒ…ë°©ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."><br>
					<!-- ìƒë‹¨: ì¡°ì§ë„ + ì‚¬ì› ëª©ë¡ -->
					<div class="row mb-4" style="height: 280px;">
						<p style="color: gray;">ì±„íŒ…ì— ì¶”ê°€í•  ì¸ì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
						<!-- ì¡°ì§ë„ -->
						<div class="col-6 pe-3 border-end d-flex flex-column">
							<h6 class="fw-semibold mb-2">ì¡°ì§ë„</h6>
							<div id="ysw_create_jstree"
								class="ps-2 h-100 overflow-auto border rounded bg-light p-2">
								<!-- JSTree ì˜ì—­ -->
							</div>
						</div>

						<!-- ì‚¬ì› ëª©ë¡ -->
						<div class="col-6 ps-3 d-flex flex-column">
							<h6 class="fw-semibold mb-2">ì„ íƒí•œ ë¶€ì„œì˜ ì‚¬ì› ëª©ë¡</h6>
							<div id="memberListBox"
								class="h-100 overflow-auto border rounded bg-light p-2" style="max-height: 280px;">
								<!-- âœ… ìŠ¤í¬ë¡¤ ì˜ì—­ ê³ ì • ë†’ì´ ì„¤ì • -->
								<ul id="memberList" class="list-group fs-6 mb-0"></ul>
							</div>
						</div>
					</div><br><br>
		
					<!-- í•˜ë‹¨: ì„ íƒëœ ì¸ì›, ì²«ë²ˆì¨° ëª¨ë‹¬ì°½ì˜ ì •ë³´ -->
					<form name="chatRoom_create_form">
						<input type="hidden" id="chatRoomTitle" name="chat_room_title">
						<input type="hidden" id="createMemberNo" name="create_member_no"
                            th:value="${#authentication.principal.member.memberNo}">
						<br><br>
						<div id="selectedUsersInputs">
							<input type="hidden" name="member_no" th:value="${#authentication.principal.member.memberNo}"  th:attr="data-id=${#authentication.principal.member.memberNo}" >
						</div>
						<div class="row gx-3 text-center" style="height: 200px;">
							<div id="selectMemberListBox" class="h-100 overflow-auto border rounded bg-light p-2">
								<ul id="selectMemberList" class="list-group fs-6"></ul>	
							</div>
						</div>
						<div class="modal-footer justify-content-end">
							<button type="submit" class="btn btn-primary px-4">ì±„íŒ…ë°© ì¶”ê°€</button>
						</div><bR>
					</form>
				</div>
			</div>
		</div>
	</div>
	
	<!-- ì¸ì› ì¶”ê°€ ëª¨ë‹¬ -->
	<div class="modal fade" id="addMemberModal" tabindex="-1">
		<div class="modal-dialog modal-dialog-centered"
			style="max-width: 800px; width: auto; max-height: none;">
			<div class="modal-content p-3" style="max-height: none;">
				<div class="modal-header">
					<h5 class="modal-title fw-bold fs-4"> ì°¸ì—¬ì ì¶”ê°€ </h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<div class="row mb-4" style="height: 280px;">
						<p style="color: gray;">ì±„íŒ…ì— ì¶”ê°€í•  ì¸ì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
						<!-- ì¡°ì§ë„ -->
						<div class="col-6 pe-3 border-end d-flex flex-column">
							<h6 class="fw-semibold mb-2">ì¡°ì§ë„</h6>
							<div id="ysw_add_jstree"
								class="ps-2 h-100 overflow-auto border rounded bg-light p-2">
								<!-- JSTree ì˜ì—­ -->
							</div>
						</div>

						<!-- ì‚¬ì› ëª©ë¡ -->
						<div class="col-6 ps-3 d-flex flex-column">
							<h6 class="fw-semibold mb-2">ì„ íƒí•œ ë¶€ì„œì˜ ì‚¬ì› ëª©ë¡</h6>
							<div id="memberListBoxs"
								class="h-100 overflow-auto border rounded bg-light p-2" style="max-height: 280px;">
								<!-- âœ… ìŠ¤í¬ë¡¤ ì˜ì—­ ê³ ì • ë†’ì´ ì„¤ì • -->
								<ul id="memberLists" class="list-group fs-6 mb-0"></ul>
							</div>
						</div>
					</div><br><br>
		
					<!-- í•˜ë‹¨: ì„ íƒëœ ì¸ì›, ì²«ë²ˆì¨° ëª¨ë‹¬ì°½ì˜ ì •ë³´ -->
					<form name="chatRoom_add_form">
						<br><br>
						<div id="addUsersInputs"></div>
						<div class="row gx-3 text-center" style="height: 200px;">
							<div id="addMemberListBox" class="h-100 overflow-auto border rounded bg-light p-2">
								<ul id="addMemberList" class="list-group fs-6"></ul>	
							</div>
						</div>
						<div class="modal-footer justify-content-end">
							<button type="submit" class="btn btn-primary px-4">ì±„íŒ…ë°© ì¶”ê°€</button>
						</div><bR>
					</form>
				</div>
			</div>
		</div>
	</div>
	
	<script>
		
		// ì±„íŒ…ë°© ì¶”ê°€
		document.getElementById('create_btn').onclick = function () {
			const nextModal = new bootstrap.Modal(document.getElementById("selectMemberModal"));
		    nextModal.show();
		}
		
		// ì±„íŒ… ì¸ì› ì„ íƒ
		document.addEventListener("DOMContentLoaded",function(){
			const selectBtn = document.querySelectorAll(".selectBtn");
			const selectUserList = document.getElementById("selectMemberList");
			const selectedUsersInputs = document.getElementById("selectedUsersInputs");

			
			document.addEventListener("click", function (e) {
			    if (e.target.classList.contains("selectBtn")) {
			        const memberNo = e.target.getAttribute("data-id");
			        const memberName = e.target.getAttribute("data-name");
			        const memberPos = e.target.getAttribute("data-pos");
			        
			        // ì¤‘ë³µ ë°©ì§€ 
			        const result = Array.from(selectUserList.querySelectorAll("input[data-id]"))
		                .some(input => input.getAttribute("data-id") === memberNo);
	
		            if (result) {
		                return;
		            }
			        
			        const li = document.createElement("li");
			        li.className = "list-group-item";
			        li.innerHTML = `
					    <input 
					        type="button" 
					        value="-"  
					        data-id="${memberNo}" 
					        class="deleteBtn btn-sm btn btn-rounded btn-light">
					    ${memberName} (${memberPos})
					`;

					    
			     // í•¨ê»˜ ìˆ¨ì€ input ìƒì„±
			        const hiddenInput = document.createElement("input");
			        hiddenInput.type = "hidden";
			        hiddenInput.name = "member_no"; // ë°±ì—”ë“œì—ì„œ ì´ nameìœ¼ë¡œ ë°›ì•„ìš”!
			        hiddenInput.value = memberNo;
			        hiddenInput.setAttribute("data-id", memberNo);
			        hiddenInput.setAttribute("data-pos", memberPos);
			        hiddenInput.setAttribute("data-name", memberName);

			        // ë¦¬ìŠ¤íŠ¸ì™€ ìˆ¨ì€ input ì¶”ê°€
			        selectUserList.appendChild(li);
			        selectedUsersInputs.appendChild(hiddenInput);
			        
			    }
			});
			
		});
		
		// ì±„íŒ…ë°© ì¶”ê°€ ì¸ì› ì‚­ì œ 
		document.addEventListener("DOMContentLoaded",function(){
			document.addEventListener("click", function (e) {
			    if (e.target.classList.contains("deleteBtn")) {
			    	  const memberNo = e.target.getAttribute("data-id"); // ğŸ‘ˆ ì‚­ì œ ëŒ€ìƒ ID
			            const li = e.target.closest("li");
			            if (li) li.remove();

			            // í•´ë‹¹ memberNoë¥¼ ê°€ì§„ hidden input ì‚­ì œ
			            const hiddenInput = document.querySelector(`#selectedUsersInputs input[data-id='${memberNo}']`);
			            if (hiddenInput) hiddenInput.remove();
			    }
			});
			
		});
		
		// ì±„íŒ…ë°© ì¶”ê°€  ë²„íŠ¼ í´ë¦­ ì‹œ ì •ë³´ ì €ì¥ 
		const createForm = document.chatRoom_create_form;
		
		createForm.addEventListener('submit',(e) => {
			e.preventDefault()
			
			const selectedInputs = document.querySelectorAll("#selectedUsersInputs input[name='member_no']");
			const chatRoomTitle = document.getElementById("title").value;
			const chatRoomTitleInput = document.getElementById("chatRoomTitle"); // ì‹¤ì œ ì„œë²„ë¡œ ì „ì†¡ë  ì œëª© hidden input
			const createMemberNo = document.getElementById("createMemberNo").value; // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ì› ë²ˆí˜¸
			
			// ìœ íš¨ì„± ê²€ì‚¬ (ë³¸ì¸ ì™¸ì— ìµœì†Œ 1ëª… ì´ìƒ ìˆì–´ì•¼ í•¨)
			const validSelectList = Array.from(selectedInputs).filter(input => input.value !== createMemberNo);
			
			// ìœ íš¨ì„± ê²€ì‚¬
			if (validSelectList.length === 0) {
			    alert("ì±„íŒ…ì— ì¶”ê°€í•  ì¸ì›ì„ 1ëª… ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.");
			    return;
			}

			  chatRoomTitleInput.value = chatRoomTitle;


			const payload = new FormData(createForm);
			
			
			fetch("/create",{
				method:'post',
				headers : {
					'header': document.querySelector('meta[name="_csrf_header"]').content,
	              	'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content
				},
				body:payload,
			})
			.then(response => response.json())
			.then(data => {
				alert(data.res_msg);
				if (data.res_code == "200") {
					location.reload();
				}
			});
			
		})
		
		// ì±„íŒ… ì¸ì› ì„ íƒ ëª¨ë‹¬ì°½ ë¦¬ì…‹
		document.getElementById("selectMemberModal").addEventListener("hidden.bs.modal", () => {
			document.getElementById("title").value = ""; // ì±„íŒ…ë°© ì œëª© ì´ˆê¸°í™”
			document.getElementById("chatRoomTitle").value = ""; 
			document.getElementById("selectMemberList").innerHTML = "";

		    // ìˆ¨ê²¨ì§„ input ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”
		    selectedUsersInputs.innerHTML = "";
		});
	
		
		
		 document.addEventListener("DOMContentLoaded", function () {
			 // ì±„íŒ…ë°© ê²€ìƒ‰ 
			 $(".search-chat").on("keyup", function () {
				  var value = $(this).val().toLowerCase();
				  $(".chat-users li").filter(function () {
				    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
				  });
			});
			 

	    // ì±„íŒ…ë°© ëª©ë¡ í´ë¦­ ì‹œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜ 
		$(".app-chat .chat-user").on("click", function () {
		    // ì´ë¯¸ í´ë¦­í–ˆì„ ë•Œ return 
			if ($(this).hasClass("active")) return;
		    // ì…ë ¥ì°½ ì´ˆê¸°í™” 
		    $("#msgContent").val("");
		    // ì±„íŒ…ë°© ì •ë³´ ì„¸íŒ…
		    const roomNo = $(this).data("room-id");
		    const memberName = $(this).find(".chat-title").text();
		    const memberDept = $(this).find(".dept").text();
		    const memberImage = $(this).find("img").attr("src");
		
		    $("#chatRoomNo").val(roomNo);
		
		    const csrfHeader = $('meta[name="_csrf_header"]').attr("content");
		    const csrfToken = $('meta[name="_csrf"]').attr("content");
		    const headers = { [csrfHeader]: csrfToken };
		
		    // ìœ ì € ì •ë³´ fetch
		    fetch(`/selectChatRoom/${roomNo}`, { method: 'post', headers })
		        .then(res => res.json())
		        .then(data => {
		            $("#memberCount").text(`(${data.memberInfos.length})`);
		            const $memberInfo = $("#memberInfo").empty();
		
		            data.memberInfos.forEach(m => {
		                const html = `
		                    <div class="d-flex align-items-center justify-content-between mb-3">
		                        <div class="d-flex align-items-center">
		                            <div class="ms-3">
		                                <h6 class="fw-semibold mb-2">${m.memberName} ${m.positionName ?? ''}</h6>
		                                <p class="mb-0 fs-2">${m.departmentName ?? ''}</p>
		                            </div>
		                        </div>
		                    </div>
		                    <input type="hidden" class="receiverNoInput" value="${m.memberNo}" />
		                `;
		                $memberInfo.append(html);
		            });
		        });
		
		    // ìƒë‹¨ ìœ ì € ì •ë³´
		    const isMobile = window.innerWidth <= 767;
		    $(".current-chat-user-name .name").text(isMobile ? memberName.split(" ")[0] : memberName);
		    $(".current-chat-user-name img").attr("src", memberImage);
		
		    // ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸°
		    fetch(`/selectChatMsg/${roomNo}`, { method: 'post', headers })
		        .then(res => res.json())
		        .then(data => {
		            const $chatList = $(".chat-box-inner .chat.active-chat").empty();
		            const myMemberNo = $("#createMemberNo").val();
		
		            data.forEach(msg => {
		                const isMine = msg.member_no == myMemberNo;
		                $chatList.append(createMessageBubble(msg, isMine, memberImage));
		            });
		
		            $chatList.scrollTop($chatList.prop("scrollHeight"));
		        });
		
		    // ì±„íŒ… stomp ì—°ê²°
		    connectStomp(roomNo, memberImage, memberName);
		
		    $(".user-chat-box").removeClass("user-list-box-show");
		    $(".chat-meta-user, .chat-send-message-footer").addClass("chat-active");
		});
		
		function formatTime(isoString) {
		    const date = new Date(isoString);
		    return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
		}
		
		function createMessageBubble(msg, isMine, memberImage) {
		    const time = formatTime(msg.send_date);
		    const wrapper = document.createElement("div");
		    wrapper.className = "d-flex mb-4";
		    wrapper.style.justifyContent = isMine ? "flex-end" : "flex-start";
		    
		    // ì‹œìŠ¤í…œ ë©”ì‹œì§€ì¸ì§€ ì¼ë°˜ ë©”ì‹œì§€ì¸ì§€ í™•ì¸
		    if (msg.chat_msg_type === "Y") {
		        // ì‹œìŠ¤í…œ ë©”ì‹œì§€ (ì˜ˆ: "ë‹˜ì´ ì±„íŒ…ë°©ì„ ë‚˜ê°”ìŠµë‹ˆë‹¤.")
		    	wrapper.innerHTML = `
		    	    <div style="display: flex; justify-content: center; align-items: center; width: 100%; margin-top: 10px;">
		    	        <div style="display: block; text-align: center; color: #888; font-size: 15px; width: 100%;">
		    	            [${msg.chat_msg_content}]
		    	        </div>
		    	    </div>`;

		    } else {
		        // ì¼ë°˜ ë©”ì‹œì§€
		        wrapper.innerHTML = isMine
		            ? `<div class="d-flex align-items-end mb-3" style="max-width: 70%;">
		                    <div class="text-muted fs-2 me-2">${time}</div>
		                    <div class="p-2 bg-info-subtle text-dark rounded-1 d-inline-block fs-3">${msg.chat_msg_content}</div>
		               </div>`
		            : `<img src="${memberImage}" width="40" height="40" class="rounded-circle me-2" />
		               <div class="mb-3" style="max-width: 70%;">
		                    <div class="fw-bold fs-2">${msg.member_name} ${msg.member_pos_name ?? ''} (${msg.member_dept_name ?? ''})</div>
		                    <div class="d-flex align-items-end">
		                        <div class="p-2 text-bg-light rounded-1 d-inline-block text-dark fs-3 me-2">${msg.chat_msg_content}</div>
		                        <div class="text-muted fs-2">${time}</div>
		                    </div>
		               </div>`;
		    }

		    return wrapper;
		}

		
		let stompClient = null;
		
		const senderNo = document.getElementById("sendMemberNo").value; // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ì› ë²ˆí˜¸
		const senderName = document.getElementById("sendMemberName").value;
		const senderPos = document.getElementById("sendMemberPos").value;
		const senderDept = document.getElementById("sendMemberDept").value;
		
		function connectStomp(roomNo, memberImage, memberName) {
		
		    if (stompClient) {
		        stompClient.disconnect(() => {
		            console.log("STOMP ì—°ê²° í•´ì œ í›„ ì¬ì—°ê²°");
		            doConnect();
		        });
		    } else {
		        doConnect();
		    }
		
		    function doConnect() {
		        const socket = new SockJS("/ws-chat");
		        stompClient = Stomp.over(socket);

		        stompClient.connect({}, () => {
		            console.log("STOMP ì—°ê²° ì„±ê³µ");

		            stompClient.subscribe(`/topic/chat/room/${roomNo}`, msg => {
		            	console.log("ë©”ì‹œì§€ ìˆ˜ì‹ :", msg);
		                const data = JSON.parse(msg.body);

		                const chatList = $(".chat-box-inner .chat.active-chat"); // ë©”ì‹œì§€ ë“¤ì–´ê°ˆ ê³³

		                // ğŸ’¬ ì‹œìŠ¤í…œ ë©”ì‹œì§€ì¸ì§€ ì¼ë°˜ ë©”ì‹œì§€ì¸ì§€ êµ¬ë¶„
		                if (data.chat_msg_type === "Y") {
		                	 const systemMsgWrapper = document.createElement("div");
		                     systemMsgWrapper.style.display = "flex";
		                     systemMsgWrapper.style.justifyContent = "center";
		                     systemMsgWrapper.style.alignItems = "center";
		                     systemMsgWrapper.style.width = "100%";
		                     systemMsgWrapper.style.marginTop = "10px";

		                     systemMsgWrapper.innerHTML = `
		                         <div style="display: block; text-align: center; color: #888; font-size: 15px; width: 100%;">
		                             [${data.chat_msg_content}]
		                         </div>
		                     `;

		                     chatList.append(systemMsgWrapper);
		                } else {
		                    // ì¼ë°˜ ë©”ì‹œì§€
		                    const isMine = data.member_no == $("#createMemberNo").val();
		                    chatList.append(createMessageBubble({
		                        ...data,
		                        send_date: new Date().toISOString()
		                    }, isMine, memberImage));
		                }

		                // ìŠ¤í¬ë¡¤ ë§¨ ì•„ë˜ë¡œ
		                chatList[0].scrollTop = chatList[0].scrollHeight;
		            });

		            setupSendEvents(roomNo, senderNo);
		        });
		    }

		}
		
		function setupSendEvents(roomNo, senderNo) {
		    $("#send_btn").off("click").on("click", sendMessage);
		    $("#msgContent").off("keydown").on("keydown", function (e) {
		        if (e.key === "Enter") {
		            e.preventDefault();
		            sendMessage();
		        }
		    });
		
		    function sendMessage() {
		        const content = $("#msgContent").val().trim();
		        if (!content) return;
		
		        const receiverNos = $(".receiverNoInput").map((_, el) => parseInt($(el).val())).get();
		        
		        if (stompClient?.connected) {
		            stompClient.send("/app/chat/msg", {}, JSON.stringify({
		                member_name: senderName,
		                member_pos_name: senderPos,
		                member_dept_name: senderDept,
		                chat_room_no: roomNo,
		                member_no: senderNo,
		                member_no_list: receiverNos,
		                chat_msg_content: content
		            }));
		            $("#msgContent").val("");
		        } else {
		            console.error("STOMP ë¯¸ì—°ê²°: ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨");
		        }
		    }
		}
		
		// ì±„íŒ…ë°© ë‚˜ê°€ê¸°
		document.getElementById("out_btn").onclick = function () {
			const roomNo = document.getElementById("chatRoomNo").value;
			
			if(confirm("ì •ë§ ì±„íŒ…ë°©ì„ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?")){
				
				fetch("/updateStatus", {
					method: 'post',
					headers: {
						'Content-Type': 'application/json',
						'header': document.querySelector('meta[name="_csrf_header"]').content,
						'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content
					},
					  body: JSON.stringify({
			                chat_room_no: roomNo,
			                member_no: senderNo
			            }),
				})
					.then(res => res.json())
					.then(data => {
						alert(data.res_msg);
						if (data.res_code == "200") {
							location.reload();
						}
					});
			}
			
		}

			
		// ì¸ì› ì´ˆëŒ€í•˜ê¸° ëª¨ë‹¬
		document.getElementById('add_btn').onclick = function () {
			const nextModal = new bootstrap.Modal(document.getElementById("addMemberModal"));
		    nextModal.show();
		}
		
		
		// ì±„íŒ… ì¸ì› ì„ íƒ
		
		const addBtn = document.querySelectorAll(".addBtn");
		const addUserList = document.getElementById("addMemberList");
		const addUsersInputs = document.getElementById("addUsersInputs");
		
		document.addEventListener("click", function (e) {
		    if (e.target.classList.contains("addBtn")) {
		        const memberNo = e.target.getAttribute("data-id");
		        const memberName = e.target.getAttribute("data-name");
		        const memberPos = e.target.getAttribute("data-pos");
		        
		        // ì¤‘ë³µ ë°©ì§€ 
		        const result = Array.from(addUserList.querySelectorAll("input[data-id]"))
	                .some(input => input.getAttribute("data-id") === memberNo);

	            if (result) {
	                return;
	            }
		        
		        const li = document.createElement("li");
		        li.className = "list-group-item";
		        li.innerHTML = `
				    <input 
				        type="button" 
				        value="-"  
				        data-id="${memberNo}" 
				        class="outBtn btn-sm btn btn-rounded btn-light">
				    ${memberName} (${memberPos})
				`;

				    
		     // í•¨ê»˜ ìˆ¨ì€ input ìƒì„±
		        const hiddenInput = document.createElement("input");
		        hiddenInput.type = "hidden";
		        hiddenInput.name = "member_no"; // ë°±ì—”ë“œì—ì„œ ì´ nameìœ¼ë¡œ ë°›ì•„ìš”!
		        hiddenInput.value = memberNo;
		        hiddenInput.setAttribute("data-id", memberNo);
		        hiddenInput.setAttribute("data-pos", memberPos);
		        hiddenInput.setAttribute("data-name", memberName);

		        // ë¦¬ìŠ¤íŠ¸ì™€ ìˆ¨ì€ input ì¶”ê°€
		        addUserList.appendChild(li);
		        addUsersInputs.appendChild(hiddenInput);
		        
		    }
		});
			
		
		
		// ì±„íŒ…ë°© ì¶”ê°€ ì¸ì› ì‚­ì œ 
	
		document.addEventListener("click", function (e) {
		    if (e.target.classList.contains("outBtn")) {
		    	  const memberNo = e.target.getAttribute("data-id"); // ğŸ‘ˆ ì‚­ì œ ëŒ€ìƒ ID
		            const li = e.target.closest("li");
		            if (li) li.remove();

		            // í•´ë‹¹ memberNoë¥¼ ê°€ì§„ hidden input ì‚­ì œ
		            const hiddenInput = document.querySelector(`#addUsersInputs input[data-id='${memberNo}']`);
		            if (hiddenInput) hiddenInput.remove();
		    }
		});
			
		

		 // *******************************************************************
		 // Email Application
		 // *******************************************************************

		 //ë’¤ë¡œ ê°€ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ ì±„íŒ… ë°•ìŠ¤ ë‹«ê¸°
		 $(document).ready(function () {
		   $(".back-btn").click(function () {
		     $(".app-email-chatting-box").hide();
		   });
		   $(".chat-user").click(function () {
		     $(".app-email-chatting-box").show();
		   });
		 });

		 // *******************************************************************
		 // chat Offcanvas
		 // *******************************************************************

		 // ì‚¬ì´ë“œ ì˜¤í”„ìº”ë²„ìŠ¤(ìš°ì¸¡ ì‚¬ì´ë“œë©”ë‰´) ì—´ê¸°/ë‹«ê¸°
		 $("body").on("click", ".chat-menu", function () {
		   $(".parent-chat-box").toggleClass("app-chat-right");
		   $(this).toggleClass("app-chat-active");
		 });

        });
		
	</script>
	<script th:src="@{/assets/js/vendor.min.js}"></script>

	<!-- Import Js Files -->
	<script
		th:src="@{/assets/libs/bootstrap/dist/js/bootstrap.bundle.min.js}"></script>
	<script th:src="@{/assets/libs/simplebar/dist/simplebar.min.js}"></script>
	<script th:src="@{/assets/js/theme/app.init.js}"></script>
	<script th:src="@{/assets/js/theme/theme.js}"></script>
	<script th:src="@{/assets/js/theme/app.min.js}"></script>
	<script th:src="@{/assets/js/theme/sidebarmenu.js}"></script>

	<!-- solar icons -->
	<script
		src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>
	<script th:src="@{/assets/libs/owl.carousel/dist/owl.carousel.min.js}"></script>
	<script th:src="@{/assets/libs/apexcharts/dist/apexcharts.min.js}"></script>
	<script th:src="@{/assets/js/dashboards/dashboard.js}"></script>

	<!-- Bootstrap Common JS Files End -->
	<script
		src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>
	
</th:block>
</html>