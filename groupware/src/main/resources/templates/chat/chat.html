<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{/include/layout}">
<th:block layout:fragment="content">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
	<link rel="stylesheet"
		href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css" />
	<link th:href="@{/css/ysw.css}" rel="stylesheet">

	<!-- 상단 메뉴 표시  -->
	<div class="col-lg-8 col-md-6 col-12 align-self-center">
		<nav aria-label="breadcrumb">
			<ol class="breadcrumb align-items-center">
				<li class="breadcrumb-item"><a
					class="text-muted text-decoration-none" th:href="@{/home}"> <i
						class="ti ti-home fs-5"></i>
				</a></li>
				<li class="breadcrumb-item" aria-current="page">사내 채팅</li>
			</ol>
		</nav>
		<br>
		<h2 class="mb-0 fw-bolder fs-8">사내 채팅</h2>
	</div>
	<br>

	<div class="card overflow-hidden chat-application">
		<div
			class="d-flex align-items-center justify-content-between gap-6 m-3 d-lg-none">
			<button class="btn btn-primary d-flex" type="button"
				data-bs-toggle="offcanvas" data-bs-target="#chat-sidebar"
				aria-controls="chat-sidebar">
				<i class="ti ti-menu-2 fs-5"></i>
			</button>
		</div>
		<div class="d-flex">
			<div class="w-30 d-none d-lg-block border-end user-chat-box">
				<div class="px-4 pt-9 pb-6">
					<!-- 현재 로그인한 사원 정보  -->
					<div class="d-flex align-items-center justify-content-between mb-3">
						<div class="d-flex align-items-center">
							<div class="position-relative">
								<img th:src="@{/img/default_profile.png}" width="54" height="54" class="rounded-circle" />
							</div>
							<div class="ms-3">
								<h6 th:text="|${#authentication.principal.member.memberName} ${#authentication.principal.member.pos.posName}|" class="fw-semibold mb-2"></h6>
								<p th:text="${#authentication.principal.member.dept.deptName}" class="mb-0 fs-2">부서</p>
							</div>
						</div>

					</div>
					<!-- 채팅 목록 검색 -->
					<form class="position-relative mb-4">
						<input type="text" class="form-control search-chat py-2 ps-5"
							id="text-srh" placeholder="채팅방 이름을 검색하세요." /> <i
							class="ti ti-search position-absolute top-50 start-0 translate-middle-y fs-6 text-dark ms-3"></i>
					</form>
				</div>
				<!-- 채팅방 목록 -->
				<div class="app-chat" style="max-height: 572px; height: 572px;">
					<div data-simplebar style="height: 100%;">
						<ul th:if="${!#lists.isEmpty(chatRoomList)}"
							th:each="chatRoom : ${chatRoomList}"
							th:attr="data-room-no=${chatRoom.chatRoomNo}"
							class="chat-users mb-0">
							
							<li>
								<a href="javascript:void(0)"
									class="px-4 py-3 bg-hover-light-black d-flex align-items-start justify-content-between chat-user"
									id="chat_user_3"
									th:attr="data-room-id=${chatRoom.chatRoomNo}">
									
									<div class="d-flex align-items-center">
										<span class="position-relative">
											<img src="../assets/images/profile/user-8.jpg" alt="user-8"
												width="48" height="48" class="rounded-circle" />
											<span class="position-absolute bottom-0 end-0 p-1 badge rounded-pill bg-warning">
												<span class="visually-hidden">New alerts</span>
											</span>
										</span>
										<div class="ms-3 d-inline-block w-75">
											<h6 th:text="${chatRoom.chatRoomTitle}" class="mb-1 fw-semibold chat-title">채팅방 이름</h6>
											<span th:text="${chatRoom.lastMsg}" class="fs-3 text-truncate text-body-color d-block">마지막 메세지</span>
										</div>
									</div>
									<p th:text="${#temporals.format(chatRoom.lastMsgDate, 'yy-MM-dd mm:ss')}" class="fs-2 mb-0 text-muted">보낸 시간</p>
								</a>
							</li>
						</ul>
						<ul th:if="${#lists.isEmpty(chatRoomList)}" class="chat-users mb-0">
							<li>
								<div class="ms-3 d-inline-block w-75 text-center">
									<h6 class="mb-1 fw-semibold chat-title">채팅 중인 방이 없습니다.</h6>
								</div>
							</li>
						</ul>
					</div>
				</div>

				<div class="px-9 py-6 border-top text-center">
				    <button class="btn btn-primary px-4" id="create_btn" type="button">
				      + 새로운 채팅 추가 
				    </button>
				</div>
			</div>
			<div class="w-70 w-xs-100 chat-container">
				<div class="chat-box-inner-part h-100">
					<div class="chat-not-selected h-100 d-none">
						<div
							class="d-flex align-items-center justify-content-center h-100 p-5">
							<div class="text-center">
								<span class="text-primary"> <i
									class="ti ti-message-dots fs-10"></i>
								</span>
								<h6 class="mt-2">Open chat from the list</h6>
							</div>
						</div>
					</div>
					<!-- 채팅 박스  -->
					 <!-- 상단 채팅방 정보 출력  -->
					<div class="chatting-box d-block">
						<div
							class="p-9 border-bottom chat-meta-user d-flex align-items-center justify-content-between">
							<div class="hstack gap-3 current-chat-user-name">
								<div class="position-relative">
								</div>
								<div>
									<h6 class="mb-1 name fw-semibold"></h6>
									<p class="mb-0 dept"></p>
								</div>
							</div>
							<ul class="list-unstyled mb-0 d-flex align-items-center">
								<li><a
									class="chat-menu text-dark px-2 fs-7 bg-hover-primary nav-icon-hover position-relative z-index-5"
									href="javascript:void(0)"> <i class="ti ti-menu-2"></i>
								</a></li>
							</ul>
						</div>
						<div class="d-flex parent-chat-box">
						<!-- 채팅 내용 출려 -->
							<div class="chat-box w-xs-100">
								<div class="chat-box-inner p-9" data-simplebar>
									<div class="chat-list chat active-chat" data-user-id="0">
										
									</div>
									<div class="chat-list chat" data-user-id="3">
									</div>
								</div>
								<div class="px-9 py-6 border-top chat-send-message-footer">
									<div class="d-flex align-items-center justify-content-between">
										<div class="d-flex align-items-center gap-2 w-85">
											<input type="text"
												class="form-control message-type-box text-muted border-0 p-0 ms-2"
												placeholder="Type a Message" fdprocessedid="0p3op" />
										</div>
										<input type= hidden id="chatRoomNo">
										<input type= hidden id="sendMemberNo" th:value="${#authentication.principal.member.memberNo}">
										<ul class="list-unstyledn mb-0 d-flex align-items-center">
											<li><a
												class="text-dark px-2 fs-7 bg-hover-primary nav-icon-hover position-relative z-index-5"
												href="javascript:void(0)"> <i class="ti ti-photo-plus"></i>
											</a></li>
											<li><a
												class="text-dark px-2 fs-7 bg-hover-primary nav-icon-hover position-relative z-index-5"
												href="javascript:void(0)"> <i class="ti ti-paperclip"></i>
											</a></li>
											<li><a
												class="text-dark px-2 fs-7 bg-hover-primary nav-icon-hover position-relative z-index-5"
												href="javascript:void(0)"> <i class="ti ti-brand-telegram"></i>
											</a></li>
										</ul>
									</div>
								</div>
							</div>
							<div class="app-chat-offcanvas border-start">
							    <div class="custom-app-scroll mh-n100" data-simplebar>
							        <div class="p-3 d-flex align-items-center justify-content-end">
							            <a class="chat-menu d-lg-none d-block text-dark fs-6 bg-hover-primary nav-icon-hover position-relative z-index-5"
							                href="javascript:void(0)"> <i class="ti ti-x"></i> </a>
							        </div>
							
							        <!-- 참여자 -->
							        <div class="offcanvas-body px-9 pt-0">
							            <div class="section-block mb-5">
							                <h6 class="fw-semibold mb-3 text-nowrap">
							                    참여자 <span class="text-muted" id="memberCount">참여자 수</span>
							                </h6>
							                <div class="d-flex flex-wrap gap-2" id="memberInfo">
							                </div>
							            </div>
							
							            <!-- 이미지 -->
							            <div class="section-block mb-5">
							                <h6 class="fw-semibold mb-3 text-nowrap">
							                    이미지 <span class="text-muted">(36)</span>
							                </h6>
							                <div class="row g-2">
							                    <div class="col-4">
							                        <img src="../assets/images/products/product-1.jpg" width="100%" class="rounded" alt="이미지" />
							                    </div>
							                    <div class="col-4">
							                        <img src="../assets/images/products/product-2.jpg" width="100%" class="rounded" alt="이미지" />
							                    </div>
							                    <!-- ...반복 -->
							                </div>
							            </div>
							
							            <!-- 파일 -->
							            <div class="section-block mb-5">
							                <h6 class="fw-semibold mb-3 text-nowrap">
							                    Files <span class="text-muted">(36)</span>
							                </h6>
							                <a href="javascript:void(0)"
							                    class="hstack gap-3 file-chat-hover justify-content-between text-nowrap mb-3">
							                    <div class="d-flex align-items-center gap-3">
							                        <div class="rounded-1 text-bg-light p-6">
							                            <img src="../assets/images/chat/icon-zip-folder.svg" alt="flexy-img" width="24"
							                                height="24" />
							                        </div>
							                        <div>
							                            <h6 class="fw-semibold">work-project.zip</h6>
							                            <div class="d-flex align-items-center gap-3 fs-2 text-muted">
							                                <span>2 MB</span> <span>2 Dec 2024</span>
							                            </div>
							                        </div>
							                    </div>
							                    <span class="position-relative nav-icon-hover download-file">
							                        <i class="ti ti-download text-dark fs-6 bg-hover-primary"></i>
							                    </span>
							                </a>
							            </div>
							        </div>
							    </div>
							</div>

						</div>
					</div>
				</div>
			</div>
			<div class="offcanvas offcanvas-start user-chat-box chat-offcanvas"
				tabindex="-1" id="chat-sidebar"
				aria-labelledby="offcanvasExampleLabel">
				<div class="offcanvas-header">
					<h5 class="offcanvas-title" id="offcanvasExampleLabel">채팅목록</h5>
					<button type="button" class="btn-close" data-bs-dismiss="offcanvas"
						aria-label="Close"></button>
				</div>
				<div class="px-4 pt-9 pb-6">
					<div class="d-flex align-items-center justify-content-between mb-3">
						<div class="d-flex align-items-center">
							<div class="position-relative">
								<img src="../assets/images/profile/user-1.jpg" alt="user1"
									width="54" height="54" class="rounded-circle" />
							</div>
							<div class="ms-3">
								<h6 th:text="|${#authentication.principal.member.memberName} ${#authentication.principal.member.pos.posName}|" class="fw-semibold mb-2"></h6>
								<p th:text="${#authentication.principal.member.dept.deptName}" class="mb-0 fs-2">부서</p>
							</div>
						</div>

					</div>
					<form class="position-relative mb-4">
						<input type="text" class="form-control search-chat py-2 ps-5"
							id="text-srh" placeholder="채팅방 이름을 검색하세요." /> <i
							class="ti ti-search position-absolute top-50 start-0 translate-middle-y fs-6 text-dark ms-3"></i>
					</form>
				</div>
				<div class="app-chat">
					<ul th:if="${!#lists.isEmpty(chatRoomList)}" 
						th:each="chatRoom : ${chatRoomList}"
						th:attr="data-room-no=${chatRoom.chatRoomNo}"
						class="class="chat-users p-0 m-0" style="padding-top: 0; padding-bottom: 0;"" data-simplebar>
						<li><a href="javascript:void(0)"
							class="px-4 py-3 bg-hover-light-black d-flex align-items-start justify-content-between chat-user"
							id="chat_user_3" data-user-id="3">
								<div class="d-flex align-items-center">
									<span class="position-relative"> <img
										src="../assets/images/profile/user-8.jpg" alt="user-8"
										width="48" height="48" class="rounded-circle" /> <span
										class="position-absolute bottom-0 end-0 p-1 badge rounded-pill bg-warning">
											<span class="visually-hidden">New alerts</span>
									</span>
									</span>
									<div class="ms-3 d-inline-block w-75">
										<h6 th:text="${chatRoom.chatRoomTitle}" class="mb-1 fw-semibold chat-title">채팅방 이름</h6>
										<span th:text="${chatRoom.lastMsg}" class="fs-3 text-truncate text-body-color d-block">마지막 메세지</span>
									</div>
								</div>
								<p th:text="${#temporals.format(chatRoom.lastMsgDate, 'yy-MM-dd mm:ss')}" class="fs-2 mb-0 text-muted">보낸 시간</p>
						</a></li>
					</ul>
					<ul th:if="${#lists.isEmpty(chatRoomList)}" class="chat-users mb-0 mh-n100" data-simplebar>
						<li>
							<div class="ms-3 d-inline-block w-75 text-center">
								<h6 class="mb-1 fw-semibold chat-title">채팅 중인 방이 없습니다.</h6>
							</div>
						</li>
					</ul>
				</div>
			</div>
		</div>
	</div>
	
	<!-- 채팅방 추가 모달 -->
	<div class="modal fade" id="selectMemberModal" tabindex="-1">
		<div class="modal-dialog modal-dialog-centered"
			style="max-width: 800px; width: auto; max-height: none;">
			<div class="modal-content p-3" style="max-height: none;">
				<div class="modal-header">
					<h5 class="modal-title fw-bold fs-4"> 채팅방 추가 </h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
				    <!-- 채팅방 제목 입력 -->
				    <label for="title" class="form-label">등록할 채팅방명</label> 
					<input type="text" class="form-control" id="title" name="title"
							style="color: black;" placeholder="등록하실 채팅방명을 입력해주세요."><br>
					<!-- 상단: 조직도 + 사원 목록 -->
					<div class="row mb-4" style="height: 280px;">
						<p style="color: gray;">채팅에 추가할 인원을 선택해주세요.</p>
						<!-- 조직도 -->
						<div class="col-6 pe-3 border-end d-flex flex-column">
							<h6 class="fw-semibold mb-2">조직도</h6>
							<div id="ysw_jstree"
								class="ps-2 h-100 overflow-auto border rounded bg-light p-2">
								<!-- JSTree 영역 -->
							</div>
						</div>

						<!-- 사원 목록 -->
						<div class="col-6 ps-3 d-flex flex-column">
							<h6 class="fw-semibold mb-2">선택한 부서의 사원 목록</h6>
							<div id="memberListBox"
								class="h-100 overflow-auto border rounded bg-light p-2" style="max-height: 280px;">
								<!-- ✅ 스크롤 영역 고정 높이 설정 -->
								<ul id="memberList" class="list-group fs-6 mb-0"></ul>
							</div>
						</div>
					</div><br><br>
		
					<!-- 하단: 선택된 인원, 첫번쨰 모달창의 정보 -->
					<form name="chatRoom_create_form">
						<input type="hidden" id="chatRoomTitle" name="chat_room_title">
						<input type="hidden" id="createMemberNo" name="create_member_no"
                            th:value="${#authentication.principal.member.memberNo}">
						<br><br>
						<div id="selectedUsersInputs">
							<input type="hidden" name="member_no" th:value="${#authentication.principal.member.memberNo}"  th:attr="data-id=${#authentication.principal.member.memberNo}" >
						</div>
						<div class="row gx-3 text-center" style="height: 200px;">
							<div id="selectMemberListBox" class="h-100 overflow-auto border rounded bg-light p-2">
								<ul id="selectMemberList" class="list-group fs-6"></ul>	
							</div>
						</div>
						<div class="modal-footer justify-content-end">
							<button type="submit" class="btn btn-primary px-4">채팅방 추가</button>
						</div><bR>
					</form>
				</div>
			</div>
		</div>
	</div>
	
	
	
	<h1>WebSocket 테스트</h1>
	<input type="text" id="msg">
	<input type="button" value="전송" onclick="sendMsg();">
	<div id="output"></div>
	<script>
		
		// 채팅방 추가
		document.getElementById('create_btn').onclick = function () {
			const nextModal = new bootstrap.Modal(document.getElementById("selectMemberModal"));
		    nextModal.show();
		}
		
		// 채팅 인원 선택
		document.addEventListener("DOMContentLoaded",function(){
			const selectBtn = document.querySelectorAll(".selectBtn");
			const selectUserList = document.getElementById("selectMemberList");
			const selectedUsersInputs = document.getElementById("selectedUsersInputs");

			
			document.addEventListener("click", function (e) {
			    if (e.target.classList.contains("selectBtn")) {
			        const memberNo = e.target.getAttribute("data-id");
			        const memberName = e.target.getAttribute("data-name");
			        const memberPos = e.target.getAttribute("data-pos");
			        
			        // 중복 방지 
			        const result = Array.from(selectUserList.querySelectorAll("input[data-id]"))
		                .some(input => input.getAttribute("data-id") === memberNo);
	
		            if (result) {
		                return;
		            }
			        
			        const li = document.createElement("li");
			        li.className = "list-group-item";
			        li.innerHTML = `
					    <input 
					        type="button" 
					        value="-"  
					        data-id="${memberNo}" 
					        class="deleteBtn btn-sm btn btn-rounded btn-light">
					    ${memberName} (${memberPos})
					`;

					    
			     // 함께 숨은 input 생성
			        const hiddenInput = document.createElement("input");
			        hiddenInput.type = "hidden";
			        hiddenInput.name = "member_no"; // 백엔드에서 이 name으로 받아요!
			        hiddenInput.value = memberNo;
			        hiddenInput.setAttribute("data-id", memberNo);
			        hiddenInput.setAttribute("data-pos", memberPos);
			        hiddenInput.setAttribute("data-name", memberName);

			        // 리스트와 숨은 input 추가
			        selectUserList.appendChild(li);
			        selectedUsersInputs.appendChild(hiddenInput);
			        
			    }
			});
			
		});
		
		// 채팅방 추가 인원 삭제 
		document.addEventListener("DOMContentLoaded",function(){
			document.addEventListener("click", function (e) {
			    if (e.target.classList.contains("deleteBtn")) {
			    	  const memberNo = e.target.getAttribute("data-id"); // 👈 삭제 대상 ID
			            const li = e.target.closest("li");
			            if (li) li.remove();

			            // 해당 memberNo를 가진 hidden input 삭제
			            const hiddenInput = document.querySelector(`#selectedUsersInputs input[data-id='${memberNo}']`);
			            if (hiddenInput) hiddenInput.remove();
			    }
			});
			
		});
		
		// 채팅방 추가  버튼 클릭 시 정보 저장 
		const createForm = document.chatRoom_create_form;
		
		createForm.addEventListener('submit',(e) => {
			e.preventDefault()
			
			const selectedInputs = document.querySelectorAll("#selectedUsersInputs input[name='member_no']");
			const chatRoomTitle = document.getElementById("title").value;
			const chatRoomTitleInput = document.getElementById("chatRoomTitle"); // 실제 서버로 전송될 제목 hidden input
			const createMemberNo = document.getElementById("createMemberNo").value; // 현재 로그인한 사원 번호
			
			// 유효성 검사 (본인 외에 최소 1명 이상 있어야 함)
			const validSelectList = Array.from(selectedInputs).filter(input => input.value !== createMemberNo);
			
			// 유효성 검사
			if (validSelectList.length === 0) {
			    alert("채팅에 추가할 인원을 1명 이상 선택해주세요.");
			    return;
			}
	
			 let finalTitle = "";// 최종 제목 변수

			  if (!chatRoomTitle) {
			    // 제목이 비어있다면 참여자 이름+직급 조합으로 설정
			    finalTitle = validSelectList
			      .map(input => {
			        const name = input.getAttribute("data-name");
			        const position = input.getAttribute("data-pos");
			        return `${name} ${position}`;
			      })
			      .join(", ");
			  }else if(chatRoomTitle){
				  // 제목이 비어있지 않다면 입력한 제목으로 설정
				  finalTitle = chatRoomTitle;
			  }

			  chatRoomTitleInput.value = finalTitle;


			const payload = new FormData(createForm);
			
			
			fetch("/create",{
				method:'post',
				headers : {
					'header': document.querySelector('meta[name="_csrf_header"]').content,
	              	'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content
				},
				body:payload,
			})
			.then(response => response.json())
			.then(data => {
				alert(data.res_msg);
				if (data.res_code == "200") {
					location.reload();
				}
			});
			
		})
		
		// 채팅 인원 선택 모달창 리셋
		document.getElementById("selectMemberModal").addEventListener("hidden.bs.modal", () => {
			document.getElementById("title").value = ""; // 채팅방 제목 초기화
			document.getElementById("chatRoomTitle").value = ""; 
			document.getElementById("selectMemberList").innerHTML = "";

		    // 숨겨진 input 리스트 초기화
		    selectedUsersInputs.innerHTML = "";
		});
	
		
		
		 document.addEventListener("DOMContentLoaded", function () {
			 // 채팅방 검색 
			 $(".search-chat").on("keyup", function () {
				  var value = $(this).val().toLowerCase();
				  $(".chat-users li").filter(function () {
				    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
				  });
			});
			 

			// 채팅방 목록 클릭 시 해당 채팅창으로 이동
			$(".app-chat .chat-user").on("click", function () {
			  // 이미 열려 있는 채팅이면 return (optional)
			  if ($(this).hasClass("active")) {
			    return;
			  }
			
			  // 유저 정보 추출
			  var roomNo = $(this).attr("data-room-id");
			  var memberName = $(this).find(".chat-title").text();
			  var memberDept = $(this).find(".dept").text();
			  var memberImage = $(this).find("img").attr("src");
			  document.getElementById('chatRoomNo').value = roomNo;
			  
			  fetch("/selectChatRoom/"+roomNo,{
				method:'post',
				headers : {
					'header': document.querySelector('meta[name="_csrf_header"]').content,
				           	'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content
					}
			  })
			  .then(response => response.json())
			  .then(data => {
				  console.log(data);
				  document.getElementById("memberCount").textContent = "("+data.memberInfos.length+")";
				  
				  const memberInfoDiv = document.getElementById('memberInfo').value;
				  
				  data.memberInfos.forEach(member => {
			           /*  const memberHTML = `
			                <div class="d-flex align-items-center justify-content-between mb-3">
			                    <div class="d-flex align-items-center">
			                        <div class="position-relative">
			                            <img src="${latestMyProfile}" alt="user" width="54" height="54" class="rounded-circle" />
			                        </div>
			                        <div class="ms-3">
			                            <h6 class="fw-semibold mb-2">${member.memberName} ${member.positionName ?? ''}</h6>
			                            <p class="mb-0 fs-2">${member.departmentName ?? ''}</p>
			                        </div>
			                    </div>
			                </div>
			            `;
			            memberInfoContainer.insertAdjacentHTML("beforeend", memberHTML); */
			        });
			  })
			  
			  // 상단 이름/이미지 설정
			  if (window.innerWidth <= 767) {
			    $(".chat-container .current-chat-user-name .name").html(
			      personName.split(" ")[0]
			    );
			  } else {
			    $(".chat-container .current-chat-user-name .name").html(memberName);
			  }
			  $(".chat-container .current-chat-user-name img").attr("src", memberImage); 
			
			  // 메세지 조회
			  fetch("/selectChatMsg/"+roomNo,{
				method:'post',
				headers : {
					'header': document.querySelector('meta[name="_csrf_header"]').content,
	              	'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content
					}
				})
				.then(response => response.json())
				.then(data => {
					  const chatListContainer = document.querySelector(".chat-box-inner .chat.active-chat");
					  chatListContainer.innerHTML = ""; // 기존 채팅 내용 비우기 
					
					  const myMemberNo = document.querySelector("#createMemberNo").value; // 현재 로그인한 사원 번호
					  
					  data.forEach(msg => {
						    const userCheck = (msg.member_no == myMemberNo); // 여기로 이동
						    
						    const wrapper = document.createElement("div");
						    wrapper.className = "d-flex mb-4";

						    if (userCheck) {
						        // ✅ 내가 보낸 메시지 (오른쪽 정렬, 시간 → 메시지 순)
						        wrapper.style.justifyContent = "flex-end";
						        wrapper.innerHTML = `
						            <div class="d-flex align-items-end mb-3" style="max-width: 70%;">
						                <div class="text-muted fs-2 me-2" style="white-space: nowrap;">${formatTime(msg.send_date)}</div>
						                <div class="p-2 bg-info-subtle text-dark rounded-1 d-inline-block fs-3">
						                    ${msg.chat_msg_content}
						                </div>
						            </div>
						        `;
						    } else {
						        // ✅ 상대가 보낸 메시지 (왼쪽 정렬, 메시지 → 시간 순)
						        wrapper.style.justifyContent = "flex-start";
						        wrapper.innerHTML = `
						            <img src="${memberImage}" alt="${memberName}" width="40" height="40" class="rounded-circle me-2" />
						            <div class="mb-3" style="max-width: 70%;">
						                <div class="fw-bold fs-2">${msg.member_name} ${msg.member_pos_name} (${msg.member_dept_name})</div>
						                <div class="d-flex align-items-end">
						                    <div class="p-2 text-bg-light rounded-1 d-inline-block text-dark fs-3 me-2">
						                        ${msg.chat_msg_content}
						                    </div>
						                    <div class="text-muted fs-2" style="white-space: nowrap;">${formatTime(msg.send_date)}</div>
						                </div>
						            </div>
						        `;
						    }



						    chatListContainer.appendChild(wrapper);
						});


				
				    // 메시지 가장 아래로 스크롤
					chatListContainer.scrollTop = chatListContainer.scrollHeight;
				});

			  function formatTime(isoString) {
				  const date = new Date(isoString);
				  return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
				}
			  
			
			  // 모바일용 메뉴 닫기 처리
			  if ($(this).parents(".user-chat-box").hasClass("user-list-box-show")) {
			    $(this).parents(".user-chat-box").removeClass("user-list-box-show");
			  }
			
			  // 하단 입력창 보이기
			  $(".chat-meta-user").addClass("chat-active");
			  $(".chat-send-message-footer").addClass("chat-active");
			});
			
			
			let stompClient = null;
		    let currentSubscription = null;
		    let chatRoomNo = null; 

		    function connectChat() {
		        let sock = new SockJS("/ws-chat");
		        stompClient = Stomp.over(sock);

		        stompClient.connect({}, function (frame) {
		            console.log('Connected: ' + frame);
		            // 👉 소켓 연결만! 채팅방 구독은 클릭할 때!
		        });
		    }

		    function subscribeChatRoom(chatRoomNo) {
		        if (currentSubscription) {
		            currentSubscription.unsubscribe(); // 기존 구독 끊기
		        }

		        currentSubscription = stompClient.subscribe('/topic/chat/room/' + chatRoomNo, function (messageOutput) {
		            let msg = JSON.parse(messageOutput.body);

		            let $messageHtml =
		                '<div class="text-start mb-3"> <div class="p-2 bg-light text-dark rounded-1 d-inline-block fs-3">' +
		                msg.chat_msg_content +
		                '</div> <div class="d-block fs-2">' +
		                formatTime(new Date()) +
		                "</div>  </div>";

		            $(".active-chat").append($messageHtml);
		            scrollToBottom();
		        });
		    }

		    function sendMsg(messageContent) {
		        let chatRoomNo = document.getElementById('chatRoomNo').value; // 🔥 input에서 읽기

		        if (!chatRoomNo) {
		            alert("채팅방을 먼저 선택하세요!");
		            return;
		        }

		        if (messageContent && stompClient && stompClient.connected) {
		            stompClient.send("/app/chat/msg", {}, JSON.stringify({
		                chat_room_no: chatRoomNo,
		                chat_msg_content: messageContent
		            }));

		            document.getElementById('msg').value = '';
		        }
		    }

		    function handleSend() {
		        let messageContent = document.getElementById('msg').value.trim();
		        if (messageContent !== "") {
		            sendMsg(messageContent);
		            appendMyMessage(messageContent);
		        }
		    }

		    function appendMyMessage(messageContent) {
		        let now = new Date();
		        let time = formatTime(now);

		        let $messageHtml =
		            '<div class="text-end mb-3"> <div class="p-2 bg-info-subtle text-dark rounded-1 d-inline-block fs-3">' +
		            messageContent +
		            '</div> <div class="d-block fs-2">' +
		            time +
		            "</div>  </div>";

		        $(".active-chat").append($messageHtml);
		        scrollToBottom();
		    }

		    function formatTime(date) {
		        let hh = date.getHours();
		        let min = date.getMinutes();

		        let ampm = hh >= 12 ? "pm" : "am";
		        hh = hh % 12;
		        hh = hh ? hh : 12;
		        hh = hh < 10 ? "0" + hh : hh;
		        min = min < 10 ? "0" + min : min;

		        return hh + ":" + min + " " + ampm;
		    }

		    function scrollToBottom() {
		        let chatBox = document.getElementById('chat-box');
		        chatBox.scrollTop = chatBox.scrollHeight;
		    }

		    $(document).ready(function () {
		        connectChat(); // ✅ 소켓 연결만!

		        $(".message-type-box").on("keydown", function (event) {
		            if (event.key === "Enter") {
		                event.preventDefault();
		                handleSend();
		            }
		        });

		        // ✅ 채팅방 클릭할 때
		        $(".chat-room-item").on("click", function () {
		            let chatRoomNo = document.getElementById('chatRoomNo').value;

		            if (!chatRoomNo) {
		                alert("채팅방 번호가 없습니다.");
		                return;
		            }

		            subscribeChatRoom(chatRoomNo);

		            // 채팅창 비우기
		            $(".active-chat").empty();
		        });
		    });
			
			

			 // *******************************************************************
			 // Email Application
			 // *******************************************************************

			 //뒤로 가기 버튼 클릭 시 채팅 박스 닫기
			 $(document).ready(function () {
			   $(".back-btn").click(function () {
			     $(".app-email-chatting-box").hide();
			   });
			   $(".chat-user").click(function () {
			     $(".app-email-chatting-box").show();
			   });
			 });

			 // *******************************************************************
			 // chat Offcanvas
			 // *******************************************************************

			 // 사이드 오프캔버스(우측 사이드메뉴) 열기/닫기
			 $("body").on("click", ".chat-menu", function () {
			   $(".parent-chat-box").toggleClass("app-chat-right");
			   $(this).toggleClass("app-chat-active");
			 });

	        });
		
	</script>
	<script th:src="@{/assets/js/vendor.min.js}"></script>

	<!-- Import Js Files -->
	<script
		th:src="@{/assets/libs/bootstrap/dist/js/bootstrap.bundle.min.js}"></script>
	<script th:src="@{/assets/libs/simplebar/dist/simplebar.min.js}"></script>
	<script th:src="@{/assets/js/theme/app.init.js}"></script>
	<script th:src="@{/assets/js/theme/theme.js}"></script>
	<script th:src="@{/assets/js/theme/app.min.js}"></script>
	<script th:src="@{/assets/js/theme/sidebarmenu.js}"></script>

	<!-- solar icons -->
	<script
		src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>
	<script th:src="@{/assets/libs/owl.carousel/dist/owl.carousel.min.js}"></script>
	<script th:src="@{/assets/libs/apexcharts/dist/apexcharts.min.js}"></script>
	<script th:src="@{/assets/js/dashboards/dashboard.js}"></script>

	<!-- Bootstrap Common JS Files End -->
	<script
		src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>
	
</th:block>
</html>