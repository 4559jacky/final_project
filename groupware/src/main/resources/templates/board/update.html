<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{include/layout :: layout}">

<head>
    <meta charset="UTF-8">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>ììœ ê²Œì‹œíŒ ìˆ˜ì •</title>

    <!-- Toast UI Editor -->
    <link href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" rel="stylesheet"/>
    <link rel="stylesheet" th:href="@{/css/kdy.css}">
</head>

<th:block layout:fragment="content">
    <div class="col-lg-8 col-md-6 col-12 align-self-center">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb align-items-center">
                <li class="breadcrumb-item">
                    <a class="text-muted text-decoration-none" th:href="@{/home}"><i class="ti ti-home fs-5"></i></a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">ììœ ê²Œì‹œíŒ ìˆ˜ì •</li>
            </ol>
        </nav>

        <h2 class="mb-0 fw-bolder fs-8 mt-4">ììœ ê²Œì‹œíŒ ìˆ˜ì •</h2>
    </div>

    <div class="mt-4 p-5 bg-white rounded-4 shadow-sm mb-5">

        <form method="post" enctype="multipart/form-data" id="board_form">
            <!-- Hidden Fields -->
            <input type="hidden" name="board_no" id="board_no" th:value="${board.boardNo}">
            <input type="hidden" name="board_content" id="board_content"/>
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

            <!-- ê²Œì‹œê¸€ ìƒë‹¨ ê³ ì • ì²´í¬ë°•ìŠ¤ -->
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="is_fixed" name="is_fixed" value="true"
                       th:checked="${board.isFixed != null and board.isFixed}"/>
                <label class="form-check-label" for="is_fixed">
                    ê²Œì‹œê¸€ ìƒë‹¨ì— ê³ ì •
                </label>
            </div>

            <!-- ì œëª© + íˆ¬í‘œ ë²„íŠ¼ (í•œ ì¤„ì— ì •ë ¬) -->
            <div class="d-flex align-items-center mb-3">
                <div class="d-flex align-items-center flex-grow-1">
                    <span class="fw-bold me-3" style="font-size: 1rem; line-height: 1; white-space: nowrap;">
                        ì œëª©
                    </span>
                    <input type="text" class="form-control bg-white text-dark"
                           id="board_title" name="board_title"
                           th:value="${board.boardTitle}"
                           maxlength="100" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                </div>
				<!-- ì˜¤ë¥¸ìª½: íˆ¬í‘œ ì‚­ì œ ë²„íŠ¼ì€ íˆ¬í‘œê°€ ìˆì„ ë•Œë§Œ í‘œì‹œ -->
				<div class="ms-3" th:if="${board.vote != null}">
    				<button type="button" class="btn btn-danger" onclick="deleteVote()">
        				íˆ¬í‘œ ì‚­ì œ
    				</button>
				</div>
            </div>

            <!-- ë‚´ìš© -->
            <div class="mb-3">
                <label for="editor" class="form-label fw-semibold">ë‚´ìš©</label>
                <div id="editor" style="margin-top: 10px;"></div>
            </div>

		<!-- ğŸ”½ ìˆ˜ì • ì‹œ ê¸°ì¡´ ì²¨ë¶€íŒŒì¼ í‘œì‹œ ë° ì‚­ì œ ì²´í¬ë°•ìŠ¤ -->
			<div class="mb-3">
  				<label class="form-label fw-semibold">ê¸°ì¡´ ì²¨ë¶€íŒŒì¼</label>
  				<div th:each="file : ${attachList}" class="file-item d-flex align-items-center gap-2 mb-1" th:attr="data-id=${file.attachNo}">
    			<input type="hidden" name="deleteFiles" th:value="${file.attachNo}" disabled/>
    			<input type="checkbox" class="form-check-input mt-0" checked onchange="toggleDeleteCheckbox(this)">
    			<span class="file-name flex-grow-1 mb-0" th:text="${file.oriName}"></span>
  			</div>
  				<div th:if="${#lists.isEmpty(attachList)}">ì²¨ë¶€íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>
			</div>

            <!-- ìƒˆ íŒŒì¼ ì²¨ë¶€ -->
			<div class="mb-3">
    			<label for="board_file" class="form-label fw-semibold">íŒŒì¼ ì¶”ê°€</label>
    			<input type="file" class="form-control bg-white text-dark" id="board_file" name="files" multiple>
			</div>

            <!-- ë²„íŠ¼ -->
            <div class="d-flex justify-content-end mt-4">
                <button type="submit" class="btn btn-primary px-4">ìˆ˜ì • ì™„ë£Œ</button>
                <a th:href="@{'/board/detail/' + ${board.boardNo}}" class="btn btn-danger px-4 ms-2">ì·¨ì†Œ</a>
            </div>
        </form>
    </div>
</th:block>

<th:block layout:fragment="scripts">
    <!-- Toast UI Editor -->
    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>

    <script th:inline="javascript">
        const initialContent = /*[[${board.boardContent}]]*/ '';
        const boardNo = /*[[${board.boardNo}]]*/ 0;
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const editor = new toastui.Editor({
                el: document.querySelector('#editor'),
                height: '400px',
                initialEditType: 'wysiwyg',
                previewStyle: 'vertical',
                initialValue: initialContent
            });

            const form = document.getElementById("board_form");

            form.addEventListener("submit", function (e) {
                e.preventDefault();

                const title = form.board_title.value.trim();
                const content = editor.getHTML();
                document.getElementById("board_content").value = content;

                let msg = "";
                if (!title) msg += "ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.\n";
                if (!content || content === '<p><br></p>') msg += "ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.\n";

                if (msg) {
                    alert(msg);
                    return;
                }

                const payload = new FormData(form);

                // CSRF ì²˜ë¦¬
                const csrfToken = document.querySelector('meta[name="_csrf"]').content;
                const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

                // ì‚­ì œí•  íŒŒì¼ ì •ë³´ ì¶”ê°€
                document.querySelectorAll("input[name='deleteFiles']").forEach(hidden => {
                    if (!hidden.disabled) {
                        payload.append("deleteFiles", hidden.value);
                    }
                });

                // fetch ìš”ì²­ (ê²Œì‹œê¸€ ìˆ˜ì • ì²˜ë¦¬)
                fetch("/board/" + boardNo + "/update", {
                    method: "POST",
                    headers: {
                        [csrfHeader]: csrfToken
                    },
                    body: payload
                })
                .then(response => response.json())
                .then(data => {
                    alert(data.res_msg);
                    if (data.res_code === '200') {
                        location.href = "/board/list";
                    }
                })
                .catch(error => {
                    console.error(error);
                    alert("ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                });
            });
        });
        // ì²´í¬ê°€ í•´ì œë  ë•Œ ì‚­ì œ ì²˜ë¦¬
        function toggleDeleteCheckbox(checkbox) {
            const item = checkbox.closest('.file-item');
            const hidden = item.querySelector('input[type=hidden]');
            const filename = item.querySelector('.file-name');

            if (!checkbox.checked) {
                hidden.disabled = false;
                filename.classList.add('text-decoration-line-through'); // ë°‘ì¤„ ì¶”ê°€
            } else {
                hidden.disabled = true;
                filename.classList.remove('text-decoration-line-through'); // ë°‘ì¤„ ì œê±°
            }
        }
    </script>
    
    <script th:inline="javascript">
    const csrfHeader = /*[[${_csrf.headerName}]]*/ 'X-CSRF-TOKEN';
    const csrfToken = /*[[${_csrf.token}]]*/ '';

    function deleteVote() {
        if (!confirm("ì •ë§ ì´ ê²Œì‹œê¸€ì˜ íˆ¬í‘œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        fetch(`/vote/delete/by-board/${boardNo}`, {
            method: 'DELETE',
            headers: {
                [csrfHeader]: csrfToken
            }
        })
        .then(res => res.ok ? res.text() : Promise.reject("íˆ¬í‘œ ì‚­ì œ ì‹¤íŒ¨"))
        .then(msg => {
            alert("íˆ¬í‘œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            // íˆ¬í‘œ ì˜ì—­ì„ ìˆ¨ê¸°ê±°ë‚˜ ìˆ˜ì • ì™„ë£Œ ì‹œì—ë„ ë°˜ì˜ë˜ë„ë¡ ì²˜ë¦¬
            location.reload();
        })
        .catch(err => {
            console.error(err);
            alert("íˆ¬í‘œ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + err);
        });
    }
</script>

    <!-- Bootstrap Common JS Files Start -->
    <script th:src="@{/assets/js/vendor.min.js}"></script>
    <script th:src="@{/assets/libs/bootstrap/dist/js/bootstrap.bundle.min.js}"></script>
    <script th:src="@{/assets/libs/simplebar/dist/simplebar.min.js}"></script>
    <script th:src="@{/assets/js/theme/app.init.js}"></script>
    <script th:src="@{/assets/js/theme/theme.js}"></script>
    <script th:src="@{/assets/js/theme/app.min.js}"></script>
    <script th:src="@{/assets/js/theme/sidebarmenu.js}"></script>

    <!-- solar icons -->
    <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>
    <script th:src="@{/assets/libs/owl.carousel/dist/owl.carousel.min.js}"></script>
    <script th:src="@{/assets/libs/apexcharts/dist/apexcharts.min.js}"></script>
    <script th:src="@{/assets/js/dashboards/dashboard.js}"></script>

    <!-- Bootstrap Common JS Files End -->
</th:block>

</html>