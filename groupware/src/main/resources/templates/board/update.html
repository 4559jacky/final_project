<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/include/layout}">

<th:block layout:fragment="content">

<head>
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
    <link href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" rel="stylesheet" />
	<link rel="stylesheet" th:href="@{/css/kdy.css}">
</head>

  <!-- 페이지 제목 -->
  <div class="col-lg-8 col-md-6 col-12 align-self-center">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb align-items-center">
        <li class="breadcrumb-item">
          <a class="text-muted text-decoration-none" th:href="@{/home}">
            <i class="ti ti-home fs-5"></i>
          </a>
        </li>
        <li class="breadcrumb-item" aria-current="page">자유게시판 수정</li>
      </ol>
    </nav>
    <h2 class="mb-0 fw-bolder fs-8 mt-3">자유 게시판 수정</h2>
  </div>

  <!-- 제목과 폼 사이 여백 -->
  <div class="mt-5"></div>

  <div class="p-5 bg-white rounded-4 shadow-sm mb-5">
    <!-- 투표 추가 버튼 -->
    <div class="mb-3 text-end">
      <button type="button" class="btn btn-outline-secondary" onclick="openVoteModal()">투표 추가</button>
    </div>

    <form method="post" enctype="multipart/form-data" id="board_form">
      <input type="hidden" name="board_no" id="board_no" th:value="${board.boardNo}">
      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

      <!-- 제목 -->
      <div class="row mb-3 align-items-center">
        <div class="mb-3">
          <label for="board_title" class="form-label"><strong>제목</strong></label>
          <input type="text"
                 class="form-control bg-white text-dark"
                 id="board_title"
                 name="board_title"
                 th:value="${board.boardTitle}"
                 maxlength="100"
                 placeholder="제목을 입력하세요"
                 required>
        </div>
      </div>

      <!-- 내용 입력 -->
      <div class="mb-3">
        <label for="board_content" class="form-label"><strong>내용</strong></label>
        <div id="editor" style="margin-top: 10px;"></div>
        <textarea id="board_content"
                  name="board_content"
                  hidden
                  th:text="${board.boardContent}"></textarea>
      </div>

      <!-- 1) 기존 첨부파일 삭제 토글 -->
      <div id="existing-files" class="mb-3">
        <label class="form-label"><strong>기존 첨부파일</strong></label>
        <div th:each="attach : ${attachList}"
             class="file-item d-flex align-items-center mb-1"
             th:attr="data-id=${attach.attachNo}">
          <!-- 삭제 대상 ID 전송용 hidden -->
          <input type="hidden"
                 name="deleteFiles"
                 th:value="${attach.attachNo}"
                 disabled/>
          <span class="flex-grow-1" th:text="${attach.oriName}">파일명.jpg</span>
          <button type="button"
                  class="btn btn-sm btn-danger ms-2"
                  onclick="toggleDelete(this)">×</button>
        </div>
      </div>

      <!-- 2) 새 파일 동적 추가 -->
      <div id="new-files" class="mb-3">
        <label class="form-label"><strong>새 파일 첨부</strong></label>
        <!-- addFileInput()로 input이 추가됩니다 -->
      </div>
      <button type="button"
              class="btn btn-sm btn-outline-primary mb-4"
              onclick="addFileInput()">+ 파일 추가</button>

      <!-- 수정 완료 버튼 -->
      <div class="d-flex justify-content-end gap-2 mt-4">
        <button type="submit" class="btn btn-primary">수정 완료</button>
        <button type="button" class="btn btn-danger" onclick="window.location.href='/board/list'">취소</button>
      </div>
    </form>
  </div>

  <!-- Start Editor CDN -->
  <link href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css"
        rel="stylesheet" />
  <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>

  <script>
    // 1) 에디터 초기화
    const editor = new toastui.Editor({
      el: document.querySelector('#editor'),
      height: '400px',
      initialEditType: 'wysiwyg',
      previewStyle: 'vertical',
      initialValue: document.getElementById('board_content').textContent.trim()
    });

    // 2) 기존 파일 삭제/복원 토글
    function toggleDelete(btn) {
      const item   = btn.closest('.file-item');
      const hidden = item.querySelector('input[type=hidden]');
      if (hidden.disabled) {
        hidden.disabled = false;                       // 삭제 대상으로 활성화
        item.classList.add('text-decoration-line-through');
        btn.textContent = '↺';                         // 복원 아이콘
        btn.classList.replace('btn-danger', 'btn-secondary');
      } else {
        hidden.disabled = true;                        // 삭제 취소
        item.classList.remove('text-decoration-line-through');
        btn.textContent = '×';
        btn.classList.replace('btn-secondary', 'btn-danger');
      }
    }

    // 3) 새 파일 input 동적 추가/삭제
    function addFileInput() {
      const container = document.getElementById('new-files');
      const div = document.createElement('div');
      div.className = 'd-flex align-items-center mb-1';

      const input = document.createElement('input');
      input.type  = 'file';
      input.name  = 'files';
      input.className = 'form-control form-control-sm';

      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'btn btn-sm btn-danger ms-2';
      btn.textContent = '×';
      btn.onclick = () => div.remove();

      div.append(input, btn);
      container.append(div);
    }

    // 4) 폼 제출 시 에디터 내용, 삭제 대상, 새 파일 반영
    document.getElementById("board_form").addEventListener("submit", function(e) {
      e.preventDefault();

      const title   = document.getElementById("board_title").value.trim();
      const content = editor.getHTML();
      const boardNo = document.getElementById("board_no").value;

      if (!title) { alert("제목을 입력하세요."); return; }
      if (!content){ alert("내용을 입력하세요."); return; }

      // FormData에 기존 폼 항목 포함
      const formData = new FormData(this);
      formData.set("board_content", content);

      // 활성화된 deleteFiles(hidden)의 값만 전송
      document.querySelectorAll("input[name='deleteFiles']").forEach(hidden => {
        if (!hidden.disabled) {
          formData.append("deleteFiles", hidden.value);
        }
      });

      // Fetch로 전송
      fetch(`/board/${boardNo}/update`, {
        method: "POST",
        body: formData
      })
      .then(res => res.json())
      .then(data => {
        alert(data.res_msg);
        if (data.res_code === '200') location.href = "/board/list";
      })
      .catch(err => alert("에러 발생: " + err));
    });
  </script>


  	<script th:src="@{/assets/js/vendor.min.js}"></script>

    <!-- Bootstrap Common JS Files Start -->
    <script th:src="@{/assets/js/vendor.min.js}"></script>
    <script th:src="@{/assets/libs/bootstrap/dist/js/bootstrap.bundle.min.js}"></script>
    <script th:src="@{/assets/libs/simplebar/dist/simplebar.min.js}"></script>
    <script th:src="@{/assets/js/theme/app.init.js}"></script>
    <script th:src="@{/assets/js/theme/theme.js}"></script>
    <script th:src="@{/assets/js/theme/app.min.js}"></script>
    <script th:src="@{/assets/js/theme/sidebarmenu.js}"></script>

    <!-- solar icons -->
    <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>
    <script th:src="@{/assets/libs/owl.carousel/dist/owl.carousel.min.js}"></script>
    <script th:src="@{/assets/libs/apexcharts/dist/apexcharts.min.js}"></script>
    <script th:src="@{/assets/js/dashboards/dashboard.js}"></script>

    <!-- Bootstrap Common JS Files End -->
</th:block>

</html>