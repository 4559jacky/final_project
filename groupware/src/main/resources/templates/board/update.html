<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/include/layout}">

<th:block layout:fragment="content">

  <div class="col-lg-8 col-md-6 col-12 align-self-center">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb align-items-center">
        <li class="breadcrumb-item">
          <a class="text-muted text-decoration-none" th:href="@{/home}">
            <i class="ti ti-home fs-5"></i>
          </a>
        </li>
        <li class="breadcrumb-item" aria-current="page">자유게시판 수정</li>
      </ol>
    </nav>
    <h2 class="mb-0 fw-bolder fs-8 mt-3">자유 게시판 수정</h2>
  </div>

  <form method="post" enctype="multipart/form-data" id="board_form">
    <input type="hidden" name="board_no" th:value="${board.board_no}">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

    <!-- 제목 입력 -->
    <div class="mb-3">
      <label for="board_title" class="form-label"><strong>제목</strong></label>
      <input type="text" class="form-control" id="board_title" name="board_title" maxlength="100" th:value="${board.board_title}" placeholder="제목을 입력하세요" required>
    </div>

    <!-- 파일 첨부 -->
    <div class="mb-3">
      <label class="form-label"><strong>파일 첨부</strong></label>
      <input type="file" id="file_input" name="files" multiple>
    </div>

    <!-- 내용 입력 (Summernote) -->
    <div class="mb-3">
      <label for="board_content" class="form-label"><strong>내용</strong></label>
      <textarea id="board_content" name="board_content" required></textarea>
    </div>

    <!-- 수정 완료 버튼 -->
    <div class="d-flex justify-content-end">
      <button type="submit" class="btn btn-primary">수정 완료</button>
    </div>
  </form>

  <!-- JS -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>

  <script>
    $(document).ready(function() {
      // Summernote 초기화
      $('#board_content').summernote({
        height: 300,
        lang: 'ko-KR',
        placeholder: '내용을 입력하세요',
        width: '100%',
        toolbar: [
          ['style', ['bold', 'italic', 'underline', 'clear']],
          ['fontsize', ['fontsize']],
          ['para', ['ul', 'ol', 'paragraph']],
          ['insert', ['link', 'video']],
          ['view', ['fullscreen', 'codeview']]
        ],
        callbacks: {
          onImageUpload: function(files) {
            let data = new FormData();
            data.append("file", files[0]);
            $.ajax({
              url: "/board/uploadImage",
              type: "POST",
              data: data,
              processData: false,
              contentType: false,
              success: function(result) {
                $('#board_content').summernote('insertImage', result.url);
              },
              error: function() {
                alert("이미지 업로드 실패");
              }
            });
          }
        }
      });

      // 기존 게시글 내용을 Summernote에 설정
      $('#board_content').summernote('code', /*[[${board.board_content}]]*/);
    });

    // 폼 제출 처리
    document.getElementById("board_form").addEventListener("submit", function (e) {
      e.preventDefault();

      const title = document.getElementById("board_title").value.trim();
      const content = $('#board_content').summernote('code');

      if (!title) {
        alert("제목을 입력하세요.");
        return;
      }
      if ($('#board_content').summernote('isEmpty')) {
        alert("내용을 입력하세요.");
        return;
      }

      const formData = new FormData(this);
      formData.set("board_content", content);

      fetch(`/board/${boardNo}/update`, {
        method: "POST",
        body: formData
      })
      .then(res => res.json())
      .then(data => {
        if (data.res_code === '200') {
          alert("수정이 완료되었습니다.");
          location.href = "/board/list";
        } else {
          alert(data.res_msg);
        }
      })
      .catch(err => alert("에러 발생: " + err.message));
    });
  </script>

  <!-- 기타 JS -->
  <script th:src="@{/assets/js/vendor.min.js}"></script>
  <script th:src="@{/assets/libs/bootstrap/dist/js/bootstrap.bundle.min.js}"></script>
  <script th:src="@{/assets/libs/simplebar/dist/simplebar.min.js}"></script>
  <script th:src="@{/assets/js/theme/app.init.js}"></script>
  <script th:src="@{/assets/js/theme/theme.js}"></script>
  <script th:src="@{/assets/js/theme/app.min.js}"></script>
  <script th:src="@{/assets/js/theme/sidebarmenu.js}"></script>
  <script th:src="@{/assets/libs/owl.carousel/dist/owl.carousel.min.js}"></script>
  <script th:src="@{/assets/libs/apexcharts/dist/apexcharts.min.js}"></script>
  <script th:src="@{/assets/js/dashboards/dashboard.js}"></script>

</th:block>
</html>