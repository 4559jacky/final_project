<!DOCTYPE html>
<html lang="en" dir="ltr" data-bs-theme="light" data-color-theme="Blue_Theme" data-layout="horizontal"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/include/layout}">

<th:block layout:fragment="content">
			<!--상단 홈 아이콘 / ...  -->
	<div class="col-lg-8 col-md-6 col-12 align-self-center">
          <nav aria-label="breadcrumb">
              <ol class="breadcrumb align-items-center">
                 <li class="breadcrumb-item">
                   <a class="text-muted text-decoration-none" th:href="@{/home}">
                     <i class="ti ti-home fs-5"></i>
                    </a>
                 </li>
              <li class="breadcrumb-item" aria-current="page">자유게시판 게시글 수정</li>
               </ol>
           </nav><br>
    <h2 class="mb-0 fw-bolder fs-8">자유게시판 게시글 수정</h2>
    </div><br>

  <!-- Summernote CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css">


    <form th:action="@{/board/update}" method="post" enctype="multipart/form-data" id="board_form">

      <!-- 제목 + 투표 버튼 -->
      <div class="mb-3">
        <div class="d-flex justify-content-between align-items-end">
          <label class="form-label mb-0"><strong>제목</strong></label>
          <button type="button" class="btn btn-outline-primary btn-sm" onclick="addVote()">투표 삭제</button>
        </div>
        <input type="text" class="form-control mt-1" id="board_title" name="board_title" placeholder="제목을 입력하세요">
      </div>

	<!-- 파일 첨부 제목 -->
	<div class="mb-3">
  		<label class="form-label mb-1"><strong>파일 첨부</strong></label>

  	<!-- 드래그 앤 드롭 박스 -->
  	<div class="dropzone mt-2" id="dropzone" style="border: 1px dashed #ccc; padding: 20px; text-align: center; border-radius: 10px;">
    	<p class="mb-0">여기에 파일을 끌어다 놓거나<span id="file_trigger" style="color: #0d6efd; text-decoration: underline; cursor: pointer;">파일 추가</span>를 누르세요.</p>
  	</div>

  	<!-- 실제 파일 입력 필드 (숨김) -->
  	<input type="file" id="file_input" name="files" multiple style="display: none;">
	</div>

      <!-- 내용 + Summernote -->
      <div class="mb-3">
        <label class="form-label" for="board_content"><strong>내용</strong></label>
        <textarea id="board_content" name="board_content"></textarea>
      </div>

      <!-- 등록 / 임시저장 버튼 -->
      <div class="d-flex justify-content-end gap-2 mt-4">
        <button type="submit" class="btn btn-primary">수정 완료</button>
      </div>

    </form>

  <!-- jQuery + Summernote JS -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>

  <!-- Summernote & 드래그 앤 드롭 초기화 -->
  <script>
  const form = document.update_board_form;
	form.addEventListener('submit',(e)=>{
		e.preventDefault();
		let vali_check = false;
		let vali_text='';
		if(form.board_title.value == ''){
			vali_text += '제목을 입력하세요.';
			form.board_title.focus();
		} else if(form.board_content.value == ''){
			vali_text += '내용을 입력하세요.';
			form.board_content.focus();
		} else{
			vali_check = true;
		}
		
		if(vali_check == false){
			alert(vali_text);
		} else{
			const boardNo = form.board_no.value;
			const payload = new FormData(form);
			fetch('/board/'+boardNo+"/update",{
				method : 'post',
				body : payload
			})
			.then(response => response.json())
			.then(data => {
				alert(data.res_msg);
				if(data.res_code == 200){
					location.href="/board";
				}
			})
		}
	})
  
  
    $('#board_content').summernote({
      height: 300,
      lang: 'ko-KR',
      placeholder: '300자 이내로 입력하세요',
      width: '100%',
      callbacks: {
        onImageUpload: function(files) {
          let data = new FormData();
          data.append("file", files[0]);
          $.ajax({
            url: "/board/uploadImage",
            method: "POST",
            data: data,
            processData: false,
            contentType: false,
            success: function(result) {
              $('#board_content').summernote('insertImage', result.url);
            }
          });
        }
      }
    });

    // 드래그 엔 드롭
    const dropzone = document.getElementById("dropzone");
    const fileInput = document.getElementById("file_input");
    const fileTrigger = document.getElementById("file_trigger");

    // 클릭 시 파일 선택창 열기
    fileTrigger.addEventListener("click", () => {
      fileInput.click();
    });

    // 드래그 영역 진입 시
    dropzone.addEventListener("dragover", (e) => {
      e.preventDefault();
      dropzone.style.backgroundColor = "#f1f1f1";
    });

    // 드래그 영역 벗어날 때
    dropzone.addEventListener("dragleave", (e) => {
      e.preventDefault();
      dropzone.style.backgroundColor = "white";
    });

    // 드래그하여 놓았을 때
    dropzone.addEventListener("drop", (e) => {
      e.preventDefault();
      dropzone.style.backgroundColor = "white";

      const files = e.dataTransfer.files;
      fileInput.files = files;
    });

    function addVote() {
      alert("투표 추가 준비중!");
    }

  </script>

</th:block>
</html>