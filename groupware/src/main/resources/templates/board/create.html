<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/include/layout}">

<th:block layout:fragment="content">
  <div class="col-lg-8 col-md-6 col-12 align-self-center">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb align-items-center">
        <li class="breadcrumb-item">
          <a class="text-muted text-decoration-none" th:href="@{/home}">
            <i class="ti ti-home fs-5"></i>
          </a>
        </li>
        <li class="breadcrumb-item" aria-current="page">자유게시판</li>
      </ol>
    </nav>
    <h2 class="mb-0 fw-bolder fs-8 mt-3">자유 게시판 작성</h2>
  </div>

  <!-- 게시글 작성 폼 -->
  <form id="board_form" class="mt-4" th:action="@{/board}" th:method="post" enctype="multipart/form-data" onsubmit="submitBoard(event)">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

    <div class="row mb-3 align-items-center">
      <div class="col-md-10">
        <label for="board_title" class="form-label"><strong>제목</strong></label>
        <input type="text" class="form-control" id="board_title" name="board_title" maxlength="100" placeholder="제목을 입력하세요" required>
      </div>
      <div class="col-md-2 mt-4 text-end">
        <button type="button" class="btn btn-outline-secondary" onclick="openVoteModal()">투표 추가</button>
      </div>
    </div>

    <div class="mb-3">
      <label for="board_file" class="form-label"><strong>파일 첨부</strong></label>
      <input class="form-control" type="file" id="board_file" name="board_file" multiple>
    </div>

    <div class="mb-3">
      <label for="board_content" class="form-label"><strong>내용</strong></label>
      <textarea id="board_content" name="board_content" required></textarea>
    </div>

    <div class="d-flex justify-content-end gap-2 mt-4">
      <button type="submit" class="btn btn-primary">작성 완료</button>
      <button type="button" class="btn btn-primary" onclick="saveTemp()">임시 저장</button>
      <button type="button" class="btn btn-primary" onclick="window.location.href='/board/list'">취소</button>
    </div>
  </form>

  <!-- Summernote 관련 스크립트 -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/lang/summernote-ko-KR.min.js"></script>

  <script>
    $(document).ready(function () {
      // Summernote 초기화
      $('#board_content').summernote({
        height: 300,
        lang: 'ko-KR',
        toolbar: [
          ['style', ['bold', 'italic', 'underline', 'clear']],
          ['para', ['ul', 'ol', 'paragraph']],
          ['insert', ['link', 'picture', 'video']],
          ['view', ['fullscreen', 'codeview']]
        ]
      });
    });

    // 게시글 작성 처리
    function submitBoard(event) {
      event.preventDefault();

      const title = document.getElementById("board_title").value;
      const content = $('#board_content').summernote('code');

      const formData = new FormData();
      formData.append("board_title", title);
      formData.append("board_content", content);

      const files = document.getElementById("board_file").files;
      for (let i = 0; i < files.length; i++) {
        formData.append("board_file", files[i]);
      }

      fetch("/board", {
        method: "POST",
        body: formData
      })
      .then(response => {
        if (!response.ok) throw new Error("등록 실패");
        return response.json();
      })
      .then(data => {
        alert(data.res_msg);
        window.location.href = "/board/list";
      })
      .catch(error => {
        console.error(error);
        alert("게시글 등록 중 오류가 발생했습니다.");
      });
    }

    // 임시 저장 처리
    function saveTemp() {
      const title = document.getElementById("board_title").value;
      const content = $('#board_content').summernote('code');

      const tempData = { board_title: title, board_save_content: content };

      fetch("/temp_board", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(tempData)
      })
      .then(response => {
        if (!response.ok) throw new Error("임시 저장 실패");
        return response.json();
      })
      .then(data => {
        alert(data.res_msg);
      })
      .catch(error => {
        console.error(error);
        alert("임시 저장 중 오류가 발생했습니다.");
      });
    }

    // 투표 모달 호출 함수 (임시)
    function openVoteModal() {
      alert("투표 추가 모달을 여는 기능을 여기에 구현하세요!");
    }
  </script>

  <!-- Bootstrap Common JS Files Start -->
  <script th:src="@{/assets/js/vendor.min.js}"></script>
  <script th:src="@{/assets/libs/bootstrap/dist/js/bootstrap.bundle.min.js}"></script>
  <script th:src="@{/assets/libs/simplebar/dist/simplebar.min.js}"></script>
  <script th:src="@{/assets/js/theme/app.init.js}"></script>
  <script th:src="@{/assets/js/theme/theme.js}"></script>
  <script th:src="@{/assets/js/theme/app.min.js}"></script>
  <script th:src="@{/assets/js/theme/sidebarmenu.js}"></script>
  <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>
  <!-- Bootstrap Common JS Files End -->
</th:block>
</html>