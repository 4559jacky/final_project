<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{include/layout :: layout}">

<head>
  <!-- head ë‚´ìš©ì€ ë ˆì´ì•„ì›ƒ í…œí”Œë¦¿ì—ì„œ ê´€ë¦¬í•˜ë¯€ë¡œ ë³´í†µ ë¹„ì›Œë‘  -->
    <link rel="stylesheet" th:href="@{/css/kdy.css}">
</head>

<body>
  <th:block layout:fragment="content">

    <div class="col-lg-8 col-md-6 col-12 align-self-center">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb align-items-center">
          <li class="breadcrumb-item">
            <a class="text-muted text-decoration-none" th:href="@{/home}">
              <i class="ti ti-home fs-5"></i>
            </a>
          </li>
          <li class="breadcrumb-item" aria-current="page">ììœ ê²Œì‹œíŒ ì‘ì„±</li>
        </ol>
      </nav>
      <h2 class="mb-0 fw-bolder fs-8 mt-3">ììœ ê²Œì‹œíŒ ì‘ì„±</h2>
    </div>

    <div class="mt-5"></div>

    <div class="p-5 bg-white rounded-4 shadow-sm mb-5">
      <form id="create_board_form" name="create_board_form" class="mt-4" th:action="@{/board}" th:method="post" enctype="multipart/form-data">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        <input type="hidden" name="member_no" th:value="${#authentication.principal.member.memberNo}">

        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="is_fixed" name="is_fixed" value="true"
                 th:checked="${boardDto != null and boardDto.is_fixed != null and boardDto.is_fixed}" />
          <label class="form-check-label" for="is_fixed">
            ê²Œì‹œê¸€ ìƒë‹¨ì— ê³ ì •
          </label>
        </div>

        <div class="d-flex align-items-center mb-3">
          <!-- ì™¼ìª½ ì˜ì—­: ì œëª© í…ìŠ¤íŠ¸ + ì…ë ¥ì°½ -->
          <div class="d-flex align-items-center flex-grow-1">
            <span class="fw-bold me-3" style="font-size: 1rem; line-height: 1; white-space: nowrap;">
              ì œëª©
            </span>
            <input type="text" class="form-control bg-white text-dark" id="board_title" name="board_title" maxlength="100" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" required>
          </div>
		<textarea id="vote_json" name="vote_json" hidden></textarea>
          <!-- ì˜¤ë¥¸ìª½ ì˜ì—­: ë²„íŠ¼ -->
          <div class="ms-3">
			<button type="button" class="btn btn-primary" onclick="addVote()">íˆ¬í‘œ ì¶”ê°€</button>
          </div>
        </div>

		<!-- íˆ¬í‘œ ì •ë³´ë¥¼ ë‹´ì„ hidden input -->
		<textarea id="vote_json" name="vote_json" hidden></textarea>

<!-- íˆ¬í‘œ ëª¨ë‹¬ -->
<div class="modal fade" id="voteModal" tabindex="-1" aria-labelledby="voteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content rounded-4 shadow">
      <div class="modal-header border-0">
		<h5 class="modal-title" id="voteModalLabel" style="font-weight: bold; color: black;">ììœ ê²Œì‹œíŒ íˆ¬í‘œ ì¶”ê°€</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="voteTitle" class="form-label">íˆ¬í‘œ ì œëª©</label>
          <input type="text" class="form-control" id="voteTitle" placeholder="íˆ¬í‘œëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.">
        </div>

        <div class="mb-3">
          <label class="form-label">í•­ëª©</label>
		<div id="optionsContainer">
		
		<div class="input-group mb-2 option-item">
  			<input type="text" class="form-control" placeholder="í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”.">
  			<button type="button" class="x-remove-btn" onclick="removeOption(this)">-</button>
		</div>
		</div>
          <!-- í•­ëª© ì¶”ê°€/ì œê±° ë²„íŠ¼ -->
          <div class="d-flex gap-2 mt-2">
            <button type="button" class="btn btn-sm btn-primary" onclick="addOption()">+ í•­ëª© ì¶”ê°€</button>
          </div>
        </div>

        <div class="mb-3">
          <label for="voteEndDate" class="form-label">ë§ˆê°ì¼ì‹œ</label>
          <input type="datetime-local" class="form-control" id="voteEndDate">
        </div>

        <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox" id="isAnonymous">
          <label class="form-check-label" for="isAnonymous">ìµëª… íˆ¬í‘œ</label>
        </div>
		<div class="form-check">
  			<input class="form-check-input" type="checkbox" id="isMultipleChoice">
  			<label class="form-check-label" for="isMultipleChoice">
    					ì¤‘ë³µ ì„ íƒ í—ˆìš© (ë¯¸ì„ íƒ ì‹œ ë‹¨ì¼ íˆ¬í‘œ)
  			</label>
		</div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="voteSubmitBtn" onclick="saveVote()">íˆ¬í‘œ ì¶”ê°€</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
      </div>
    </div>
  </div>
</div>

        <div class="mb-3">
          <label for="board_content" class="form-label"><strong>ë‚´ìš©</strong></label>
          <div id="editor" style="margin-top: 10px;"></div>
          <textarea id="board_content" name="board_content" hidden></textarea>
        </div>


<!-- íˆ¬í‘œ ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ (ì—ë””í„° ì•„ë˜ì— ìœ„ì¹˜) -->
<div id="vote-preview-container" class="mb-4"></div>

	<!-- ğŸ”¼ íŒŒì¼ ì²¨ë¶€ input -->
		<div class="mb-3">
  			<label for="board_file" class="form-label"><strong>íŒŒì¼ ì²¨ë¶€</strong></label>
  			<input type="file" class="form-control bg-white text-dark" id="board_file" name="files" multiple>
		</div>

        <div class="d-flex justify-content-end gap-2 mt-4">
          <button type="submit" class="btn btn-primary">ì‘ì„± ì™„ë£Œ</button>
          <button type="button" class="btn btn-danger" onclick="window.location.href='/board/list'">ì·¨ì†Œ</button>
        </div>
      </form>
    </div>

    <!-- Editor CSS & JS -->
   <link rel="stylesheet" href="https://uicdn.toast.com/editor/3.2.2/toastui-editor.min.css">
   <link rel="stylesheet" href="https://uicdn.toast.com/editor/3.2.2/theme/toastui-editor-dark.min.css">
   <script src="https://uicdn.toast.com/editor/3.2.2/toastui-editor-all.min.js"></script>

    <script>
    let editor;

    document.addEventListener('DOMContentLoaded', () => {
      const darkQuery = window.matchMedia('(prefers-color-scheme: dark)');

      // toastui-editor-defaultUI ìš”ì†Œì— í´ë˜ìŠ¤ í† ê¸€
      function applyThemeFromSystem(isDark) {
        const editorWrapper = document.querySelector('.toastui-editor-defaultUI');

        if (isDark) {
          document.body.classList.add('dark-mode');
          if (editorWrapper) editorWrapper.classList.add('toastui-editor-dark');
        } else {
          document.body.classList.remove('dark-mode');
          if (editorWrapper) editorWrapper.classList.remove('toastui-editor-dark');
        }
      }

      // Toast UI Editor ì´ˆê¸°í™”
      editor = new toastui.Editor({
        el: document.querySelector('#editor'),
        height: '400px',
        initialEditType: 'wysiwyg',
        previewStyle: 'vertical'
      });

      // Editor ë Œë” ì™„ë£Œ í›„ ë‹¤í¬ëª¨ë“œ ì ìš©
      setTimeout(() => {
        applyThemeFromSystem(darkQuery.matches);
      }, 0);

      // ì‹œìŠ¤í…œ í…Œë§ˆ ë³€ê²½ ê°ì§€
      darkQuery.addEventListener('change', e => {
        applyThemeFromSystem(e.matches);
      });

      // í—¤ë” ì•„ì´ì½˜ì—ì„œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜ ì •ì˜
      window.changeToDark = () => applyThemeFromSystem(true);
      window.changeToLight = () => applyThemeFromSystem(false);
    });
    	

      const form = document.create_board_form;
      const submitBtn = form.querySelector('button[type="submit"]');
      let isSubmitting = false;

      form.addEventListener('submit', (e) => {
        e.preventDefault();

        if (isSubmitting) return;  // ì¤‘ë³µ ì œì¶œ ë°©ì§€
        isSubmitting = true;
        submitBtn.disabled = true;

        let vali_check = false;
        let vali_text = "";

        if (!form.board_title.value) {
          vali_text += "ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.";
        } else if (!editor.getHTML()) {
          vali_text += "ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.";
        } else {
          vali_check = true;
        }

        if (!vali_check) {
          alert(vali_text);
          isSubmitting = false;
          submitBtn.disabled = false;
          return;
        }

        document.getElementById('board_content').value = editor.getHTML();

        const payload = new FormData(form);

        fetch("/board", {
          method: 'post',
          headers: {
            'header': document.querySelector('meta[name="_csrf_header"]').content,
            'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content
          },
          body: payload
        })
        .then(response => response.json())
        .then(data => {
          alert(data.res_msg);
          if (data.res_code === '200') {
            location.href = "/board/list";
          }
        })
        .catch(error => {
          console.error(error);
          alert("ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        })
        .finally(() => {
          isSubmitting = false;
          submitBtn.disabled = false;
        });
      });

      
   	  // í•­ëª© ì¶”ê°€
      function addOption() {
        const optionsContainer = document.getElementById('optionsContainer');

        const optionDiv = document.createElement('div');
        optionDiv.className = 'd-flex align-items-center mb-2 option-item';

        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'form-control';
        input.placeholder = 'í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”.';
        input.maxLength = 7; // ìµœëŒ€ ê¸€ììˆ˜ ì œí•œ

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.innerText = '-';
        removeBtn.className = 'minus-btn-style';
        removeBtn.onclick = () => removeOption(removeBtn);

        optionDiv.appendChild(input);
        optionDiv.appendChild(removeBtn);
        optionsContainer.appendChild(optionDiv);
      }

      function removeOption(button) {
        const optionsContainer = document.getElementById('optionsContainer');
        const optionItems = optionsContainer.querySelectorAll('.option-item');

        if (optionItems.length <= 2) {
          alert("í•­ëª©ì€ ìµœì†Œ 2ê°œ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
          return;
        }

        const item = button.closest('.option-item');
        if (item) item.remove();
      }

      function saveVote() {
        const title = document.getElementById('voteTitle').value.trim();
        const endDate = document.getElementById('voteEndDate').value;
        const isAnonymous = document.getElementById('isAnonymous').checked ? 'Y' : 'N';
        const isMultiple = document.getElementById('isMultipleChoice').checked ? 'Y' : 'N';
        const formattedEndDate = endDate.replace('T', ' ');
        const voteTypeText = (isAnonymous === 'Y' ? 'ìµëª…' : 'ì‹¤ëª…') + (isMultiple === 'Y' ? ', ì¤‘ë³µ íˆ¬í‘œ' : ', ë‹¨ì¼ íˆ¬í‘œ');

        const options = Array.from(document.querySelectorAll('#optionsContainer input'))
          .map((el, idx) => ({
            option_text: el.value.trim(),
            order_no: idx + 1
          }))
          .filter(opt => opt.option_text.length > 0);

        if (!title || !endDate || options.length < 2) {
          alert("íˆ¬í‘œ ì œëª©, ë§ˆê°ì¼ì‹œ, 2ê°œ ì´ìƒì˜ í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        // ê¸€ì ìˆ˜ ì œí•œ ê²€ì‚¬
        for (const opt of options) {
          const len = opt.option_text.length;
          if (len < 2 || len > 7) {
            alert(`"${opt.option_text}"ì€(ëŠ”) 2ì ì´ìƒ 7ì ì´í•˜ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.`);
            return;
          }
        }

        const votePayload = {
          voteDto: {
            vote_title: title,
            end_date: endDate,
            is_anonymous: isAnonymous,
            is_multiple: isMultiple
          },
          options: options
        };

        document.getElementById('vote_json').value = JSON.stringify(votePayload);

        const previewContainer = document.getElementById('vote-preview-container');
        previewContainer.innerHTML = `
        	  <div class="mb-3">
        	    <div class="d-flex justify-content-between align-items-center mb-2">
        	      <h5 class="fw-bold mb-0">
        	        [íˆ¬í‘œ] ${title}
        	        <small class="text-muted align-middle ms-2" style="font-size: 0.9rem;">[${voteTypeText}]</small>
        	      </h5>
        	      <p class="mb-0 text-muted" style="font-size: 0.9rem;">
        	        ë§ˆê°ì¼ì‹œ: ${endDate.replace('T', ' ')}
        	      </p>
        	    </div>

        	    <ul class="list-group mb-3">
        	    ${options.map(opt => `<li class="list-group-item" style="font-size: 1.1rem;">${opt.option_text}</li>`).join('')}
        	  </ul>

        	    <div class="d-flex gap-2 justify-content-end">
        	      <button type="button" class="btn btn-primary btn-sm" onclick="editVote()">íˆ¬í‘œ ìˆ˜ì •</button>
        	      <button type="button" class="btn btn-danger btn-sm" onclick="deleteVote()">íˆ¬í‘œ ì‚­ì œ</button>
        	    </div>
        	  </div>
        	`;
        bootstrap.Modal.getInstance(document.getElementById('voteModal')).hide();
      }

      function deleteVote() {
        document.getElementById('vote_json').value = '';
        document.getElementById('vote-preview-container').innerHTML = '';
      }

      function editVote() {
        const voteJson = document.getElementById('vote_json').value;
        if (!voteJson) return;

        const data = JSON.parse(voteJson);
        const vote = data.voteDto;
        const options = data.options;

        document.getElementById('voteTitle').value = vote.vote_title;
        document.getElementById('voteEndDate').value = vote.end_date;
        document.getElementById('isAnonymous').checked = vote.is_anonymous === 'Y';
        document.getElementById('isMultipleChoice').checked = vote.is_multiple === 'Y';

        const optionsContainer = document.getElementById('optionsContainer');
        optionsContainer.innerHTML = '';
        options.forEach(opt => {
          const div = document.createElement('div');
          div.className = 'input-group mb-2 option-item';
          div.innerHTML = `
            <input type="text" class="form-control" value="${opt.option_text}" maxlength="7">
            <button type="button" class="x-remove-btn" onclick="removeOption(this)">-</button>
          `;
          optionsContainer.appendChild(div);
        });

        document.getElementById('voteSubmitBtn').textContent = 'íˆ¬í‘œ ìˆ˜ì •';

        const modal = new bootstrap.Modal(document.getElementById('voteModal'));
        modal.show();
      }

      function addVote() {
        document.getElementById('voteTitle').value = '';
        document.getElementById('voteEndDate').value = '';
        document.getElementById('isAnonymous').checked = false;
        document.getElementById('isMultipleChoice').checked = false;

        const optionsContainer = document.getElementById('optionsContainer');
        optionsContainer.innerHTML = '';

        addOption();
        addOption();

        document.getElementById('vote_json').value = '';
        document.getElementById('voteSubmitBtn').textContent = 'íˆ¬í‘œ ì¶”ê°€';

        const modal = new bootstrap.Modal(document.getElementById('voteModal'));
        modal.show();
      }

      // í˜ì´ì§€ ë¡œë“œì‹œ í•­ëª© ì´ˆê¸°í™” + ë§ˆê°ì¼ ìµœì†Œê°’ ì„¤ì •
      window.addEventListener('DOMContentLoaded', () => {
        const voteEndDateInput = document.getElementById('voteEndDate');
        const now = new Date();
        const formatted = now.toISOString().slice(0, 16);
        voteEndDateInput.min = formatted;

        const optionsContainer = document.getElementById('optionsContainer');
        optionsContainer.innerHTML = '';

        addOption();
        
        document.getElementById('voteModal').addEventListener('keydown', function (e) {
            if (e.key === 'Enter') {
              e.preventDefault();
            }
          });
        });


    </script>

  <!-- Bootstrap Common JS Files Start -->
  <!-- Import vendorJs Files -->
  <script th:src="@{/assets/js/vendor.min.js}"></script>
  <!-- Import Js Files -->
  <script th:src="@{/assets/libs/bootstrap/dist/js/bootstrap.bundle.min.js}"></script>
  <script th:src="@{/assets/libs/simplebar/dist/simplebar.min.js}"></script>
  <script th:src="@{/assets/js/theme/app.init.js}"></script>
  <script th:src="@{/assets/js/theme/theme.js}"></script>
  <script th:src="@{/assets/js/theme/app.min.js}"></script>
  <script th:src="@{/assets/js/theme/sidebarmenu.js}"></script>
  <!-- solar icons -->
  <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>
  <script th:src="@{/assets/libs/owl.carousel/dist/owl.carousel.min.js}"></script>
  <script th:src="@{/assets/libs/apexcharts/dist/apexcharts.min.js}"></script>
  <script th:src="@{/assets/js/dashboards/dashboard.js}"></script>

</th:block>
</html>
