<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{include/layout :: layout}">
      
<head layout:fragment="head">
  <meta name="_csrf" th:content="${_csrf.token}" />
  <meta name="_csrf_header" th:content="${_csrf.headerName}" />
  <link href="https://cdn.jsdelivr.net/npm/start-editor@1.0.0/start-editor.min.css" rel="stylesheet">
  <link rel="stylesheet" th:href="@{/css/kdy.css}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
</head>

<th:block layout:fragment="content">

    <!-- í˜ì´ì§€ ì œëª© -->
    <div class="col-lg-8 col-md-6 col-12 align-self-center">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb align-items-center">
                <li class="breadcrumb-item">
                    <a class="text-muted text-decoration-none" th:href="@{/home}">
                        <i class="ti ti-home fs-5"></i>
                    </a>
                </li>
                <li class="breadcrumb-item">ììœ ê²Œì‹œíŒ ëª©ë¡ / ììœ ê²Œì‹œíŒ ìƒì„¸</li>
            </ol>
        </nav><br>
        <h2 class="mb-0 fw-bolder fs-8">ììœ ê²Œì‹œíŒ ìƒì„¸</h2>
    </div><br>

    <div class="mt-5"></div>

    <!-- ë³¸ë¬¸ ì¹´ë“œ -->
<div class="p-5 bg-white rounded-4 shadow-sm mb-5">

<!-- ì œëª©ê³¼ ì‘ì„± ì •ë³´ í•œ ì¤„ì— ë°°ì¹˜ -->
<div class="mb-2 d-flex justify-content-between align-items-center">
    <!-- ì œëª© (ì™¼ìª½ ì •ë ¬) -->
    <h2 th:text="${board.boardTitle ?: 'ì œëª© ì—†ìŒ'}"
        class="fw-bold mb-0"
        style="font-size: 2rem;"></h2>
        

    <!-- ì‘ì„± ì •ë³´ (ì˜¤ë¥¸ìª½ ì •ë ¬) -->
<div class="d-flex align-items-start" style="font-size: 1rem; white-space: nowrap;">
  <div>
    <div class="d-flex align-items-center">
<span>ì‘ì„±ì: </span>
<span th:text="'[' + ${board.member?.dept?.deptName ?: 'ë¶€ì„œ'} + ']' + ${board.member?.memberName ?: 'ìµëª…'}" class="me-2"></span>
    </div>
    <div><span>ì‘ì„±ì¼: </span><span th:text="${#temporals.format(board.regDate, 'yyyy-MM-dd HH:mm')}">ë“±ë¡ì¼</span></div>
    <div><span>ì¡°íšŒìˆ˜: </span><span th:text="${board.views}">0</span></div>
  </div>
</div>
</div>
<hr>
    
    <!-- ë³¸ë¬¸ ë‚´ìš© (í…Œë‘ë¦¬ ì—†ëŠ” ë²„ì „) -->
<div class="toastui-editor-contents"
     style="min-height: 300px; font-size: 1.1rem; line-height: 1.8rem; padding: 1rem;"
     th:utext="${board.boardContent}">
</div>

<br>    
<!-- íˆ¬í‘œ ì •ë³´ ì˜ì—­ -->
<div th:if="${board.vote != null}" class="mt-4">

  <div class="d-flex justify-content-between align-items-center mb-2">
    <div>
      <span class="fw-bold">[íˆ¬í‘œ] </span>
      <span class="fw-bold" th:text="${board.vote.voteTitle}">ì œëª©</span>
      <small class="text-muted ms-2" style="font-size: 0.9rem;">
        [
        <span th:if="${board.vote.isAnonymous == 'Y'}">ìµëª…</span>
        <span th:if="${board.vote.isAnonymous == 'N'}">ì‹¤ëª…</span>
        <span th:if="${board.vote.isMultiple == 'Y'}">, ì¤‘ë³µ íˆ¬í‘œ ê°€ëŠ¥</span>
        <span th:if="${board.vote.isMultiple == 'N'}">, ë‹¨ì¼ íˆ¬í‘œ</span>
        ]
      </small>
    </div>
    <div>
      <span class="text-muted" style="font-size: 0.9rem;">
        ë§ˆê°ì¼ì‹œ:
        <span id="vote-end-time"
              th:text="${#temporals.format(board.vote.endDate, 'yyyy-MM-dd HH:mm')}"
              th:data-end-time="${#temporals.format(board.vote.endDate, 'yyyy-MM-dd HH:mm:ss')}">
          2025-05-10
        </span>
      </span>
    </div>
  </div>

  <!-- íˆ¬í‘œ ê°€ëŠ¥í•œ ê²½ìš° -->
<form id="voteForm"
      th:data-vote-no="${board.vote.voteNo}"
      th:style="${isVoteClosed} ? 'display:none' : ''">
    <ul class="list-group mb-3">
      <li class="list-group-item d-flex align-items-center"
          th:each="option : ${board.vote.voteOptions}">
		<input th:name="optionNos"
       		   th:id="'option-' + ${option.optionNo}"
       		   th:value="${option.optionNo}"
       		   class="form-check-input me-2"
       		   th:type="${board.vote.isMultiple == 'Y'} ? 'checkbox' : 'radio'" />
<label class="form-check-label" style="font-size: 1.1rem;" th:for="'option-' + ${option.optionNo}" th:text="${option.optionText}">í•­ëª©</label>
      </li>
    </ul>
  </form>

<!-- íˆ¬í‘œ ë§ˆê° ë©”ì‹œì§€ë¥¼ ë²„íŠ¼ ìœ„ë¡œ ì´ë™ -->
<div id="vote-closed-message" class="alert alert-warning mt-3" style="display: none;">
  íˆ¬í‘œê°€ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤.
</div>

<!-- íˆ¬í‘œ/ê²°ê³¼ ë²„íŠ¼ ë¬¶ìŒ -->
<div class="d-flex gap-2 mt-3" id="vote-button-group">
  <button type="button" class="btn btn-primary" id="submitVoteBtn" onclick="submitVote()">íˆ¬í‘œ í•˜ê¸°</button>
  <button type="button" class="btn btn-primary" id="resultChartBtn"
          data-bs-toggle="modal" data-bs-target="#voteResultModal">
    ê²°ê³¼ ì°¨íŠ¸
  </button>
</div>
  <!-- ê²°ê³¼ ì°¨íŠ¸ ëª¨ë‹¬ -->
  <div class="modal fade"
     id="voteResultModal"
     th:attr="data-vote-no=${board.vote.voteNo}"
     tabindex="-1"
     aria-labelledby="voteResultModalLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rounded-4">
        <div class="modal-header">
          <h5 class="modal-title fw-bold" id="voteResultModalLabel">íˆ¬í‘œ ê²°ê³¼</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
        </div>
			<div class="modal-body p-4" style="height: 500px;">
  				<canvas id="voteResultChart" style="width: 100%; height: 100%;"></canvas>
			</div>
      </div>
    </div>
  </div>
</div>
<br>
<!-- ğŸ”½ ì²¨ë¶€íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì˜ì—­ -->
<div class="border-top pt-3">
  <h5 class="fw-semibold">ì²¨ë¶€íŒŒì¼</h5>

  <ul class="list-unstyled" th:if="${attachList != null and not #lists.isEmpty(attachList)}">
    <li th:each="boardAttach : ${attachList}" class="mb-1">
      <a th:href="@{/download/{id}(id=${boardAttach.attachNo})}" class="file-link">
        <i class="bi bi-file-earmark-text me-1 text-primary"></i>
        <span th:text="${boardAttach.oriName}" class="file-link">íŒŒì¼ëª…</span>
      </a>
    </li>
  </ul>

  <p th:if="${attachList == null or #lists.isEmpty(attachList)}">ì²¨ë¶€íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
</div>

    <!-- ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼(ë³¸ì¸ì´ ì“´ ê¸€ì€ ë³´ì¼ìˆ˜ìˆê³ , ë‚¨ì´ ë³¼ë•ŒëŠ” ë³´ì´ì§€ ì•Šê²Œ ì²˜ë¦¬) -->
    <th:block sec:authorize="isAuthenticated()">
        <div th:if="${#authentication.principal.member.memberNo == board.member.memberNo}" class="mt-4 text-end">
            <a th:href="@{/board/list}" class="btn btn-primary px-3 py-1">ëª©ë¡ìœ¼ë¡œ</a>
            <a class="btn btn-primary px-3 py-1" th:href="@{/board/{id}/update(id=${board.boardNo})}">ìˆ˜ì •</a>
            <a class="btn btn-danger px-3 py-1" href="#" th:onclick="|boardDelete(${board.boardNo})|">ì‚­ì œ</a>
        </div>
    </th:block>
</div>

<!--th:ifë¥¼ ì¶”ê°€í•´ì£¼ë‹ˆê¹Œ ë¹ˆì°½ì´ ë‚˜ì™”ë˜ê²Œ hidden ë˜ë©´ì„œ ëŒ“ê¸€ ë“±ë¡ì„ í•˜ë©´ ëœ°ìˆ˜ìˆê²Œ í• ìˆ˜ìˆë‹¤-->
<div class="custom-padding bg-white rounded-4 shadow-sm mb-5" th:if="${not #lists.isEmpty(replyList)}">
  <!-- ëŒ“ê¸€ ë° ëŒ€ëŒ“ê¸€ ì˜ì—­ -->
  <div id="comment-container" class="container my-4">
    <!-- ëŒ“ê¸€ + ëŒ€ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ -->
	<div th:each="reply : ${replyList}" class="reply-item mb-3">
      <div class="d-flex align-items-start mb-2">
		<!-- ì²« ë²ˆì§¸ í”„ë¡œí•„ ì´ë¯¸ì§€: ê¸°ë³¸ ì´ë¯¸ì§€ê°€ ì•„ë‹Œ, ì‚¬ìš©ì ì—…ë¡œë“œëœ ì´ë¯¸ì§€ë¥¼ ë°˜ì˜ ê¶Œí•œì´ ë§‰í˜€ìˆì–´ì„œ í”„ë¡œí•„ ì´ë¯¸ì§€ ë“±ë¡ì´ ì•ˆë˜ëŠ”ê±°ì˜€ìŒ
		ì´ì¤‘ íŒŒì‹±ì„ í•˜ë“  ê·¸ëƒ¥ ì¼ë°˜ íŒŒì‹±ì„ í•´ë„ ê¶Œí•œì„ ì„¤ì •í•´ì¤€ë‹¤ë©´ ì •ìƒì ìœ¼ë¡œ ì¼ë°˜ì‚¬ìš©ìë„ í”„ë¡œí•„ì´ ë‚˜ì˜¤ê²Œ í• ìˆ˜ìˆìŒ -->
		<div class="profile-icon rounded-circle me-3">
  			<img th:src="@{${reply.attachPath != null && !reply.attachPath.isEmpty() ? reply.attachPath : '/img/default_profile.png'}}"  
       			alt="Profile Image" 
       			class="rounded-circle" 
       			style="width: 100%; height: 100%; object-fit: cover;" 
       			onerror="this.src='/img/default_profile.png'" 
       			loading="lazy">
		</div>
        <div class="flex-grow-1">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong th:text="'[' + (${reply.deptName} != null ? ${reply.deptName} : 'ë¶€ì„œì—†ìŒ') + '] ' + (${reply.memberName} != null ? ${reply.memberName} : 'ìµëª…')" class="me-2"></strong>
              <small class="ms-2 time-display" th:text="${reply.regDateFormatted}"></small>
              <small th:if="${reply.isModifiedFlag}" class="ms-1 modified-tag"></small>
            </div>
            <th:block th:if="${reply.member_no == #authentication.principal.member.memberNo}">
              <div class="reply-actions d-flex gap-2">
                <button type="button" class="btn btn-primary btn-sm edit-btn" th:onclick="|replyUpdate(${reply.reply_no})|">ìˆ˜ì •</button>
                <button type="button" class="btn btn-danger btn-sm delete-btn" th:onclick="|replyDelete(${reply.reply_no}, ${board.boardNo})|">ì‚­ì œ</button>
                <button type="button" class="btn btn-primary btn-sm save-btn" style="display: none;" th:onclick="|saveReplyEdit(${reply.reply_no})|">í™•ì¸</button>
                <button type="button" class="btn btn-secondary btn-sm cancel-btn" style="display: none;" th:onclick="|cancelReplyEdit(${reply.reply_no})|">ì·¨ì†Œ</button>
              </div>
            </th:block>
          </div>

          <!-- ëŒ“ê¸€ ë‚´ìš© -->
          <p class="reply-content mt-2 mb-2" th:id="'reply-content-' + ${reply.reply_no}" th:text="${reply.reply_content}"></p>

          <!-- ëŒ“ê¸€ ìˆ˜ì • í¼ -->
          <div th:id="'reply-edit-form-' + ${reply.reply_no}" class="reply-edit-form">
            <textarea th:id="'edit-textarea-' + ${reply.reply_no}" class="form-control mb-2" style="resize: none; height: 60px;"></textarea>
          </div>

          <!-- ë‹µê¸€ í† ê¸€ ë° ì‘ì„± ë²„íŠ¼ -->
          <span th:id="'reply-toggle-' + ${reply.reply_no}"
                th:class="'reply-action-text ' + (${reply.subReplyCount > 0} ? 'has-sub-replies' : '')"
                th:attr="data-sub-reply-count=${reply.subReplyCount}, data-reply-no=${reply.reply_no}, data-board-no=${board.boardNo}"
                th:text="${reply.subReplyCount > 0} ? 'ë‹µê¸€ ' + ${reply.subReplyCount} + 'ê°œ' : 'ë‹µê¸€ ë‹¬ê¸°'"
                onclick="toggleSubReply(this)"
                style="cursor: pointer;"></span>

          <!-- ëŒ€ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ -->
          <div th:id="'sub-reply-list-' + ${reply.reply_no}" class="sub-reply-list collapsed" th:if="${reply.subReplies != null and !#lists.isEmpty(reply.subReplies)}">
            <div th:each="subReply : ${reply.subReplies}" class="sub-reply-item py-2">
              <div class="d-flex align-items-start">
			<!-- ë‘ ë²ˆì§¸ í”„ë¡œí•„ ì´ë¯¸ì§€: í¬ê¸°ë¥¼ 30pxë¡œ ì„¤ì •, ë™ì¼í•œ ë°©ì‹ìœ¼ë¡œ ë°˜ì˜ -->
			<div class="profile-icon rounded-circle me-3" style="width: 30px; height: 30px;">
  			<img th:src="@{${subReply.attachPath != null && !subReply.attachPath.isEmpty() ? subReply.attachPath : '/img/default_profile.png'}}" 
       			alt="Profile Image" 
       			class="rounded-circle" 
       			style="width: 100%; height: 100%; object-fit: cover;" 
       			onerror="this.src='/img/default_profile.png'" 
       			loading="lazy">
			</div>
                <div class="flex-grow-1">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <strong th:text="'[' + (${subReply.deptName} != null ? ${subReply.deptName} : 'ë¶€ì„œì—†ìŒ') + '] ' + (${subReply.memberName} != null ? ${subReply.memberName} : 'ìµëª…')" class="me-2"></strong>
                      <small class="ms-2 time-display" th:text="${subReply.regDateFormatted}"></small>
                      <small th:if="${subReply.isModifiedFlag}" class="ms-1 modified-tag"></small>
                    </div>
                    <th:block th:if="${subReply.member_no == #authentication.principal.member.memberNo}">
                      <div class="reply-actions d-flex gap-2">
                        <button type="button" class="btn btn-primary btn-sm edit-btn" th:onclick="|replyUpdate(${subReply.reply_no})|">ìˆ˜ì •</button>
                        <button type="button" class="btn btn-danger btn-sm delete-btn" th:onclick="|replyDelete(${subReply.reply_no}, ${board.boardNo})|">ì‚­ì œ</button>
                        <button type="button" class="btn btn-primary btn-sm save-btn" style="display: none;" th:onclick="|saveReplyEdit(${subReply.reply_no})|">í™•ì¸</button>
                        <button type="button" class="btn btn-secondary btn-sm cancel-btn" style="display: none;" th:onclick="|cancelReplyEdit(${subReply.reply_no})|">ì·¨ì†Œ</button>
                      </div>
                    </th:block>
                  </div>
                  <p class="reply-content mt-1 mb-1" th:id="'reply-content-' + ${subReply.reply_no}" th:text="${subReply.reply_content}"></p>
                  <div th:id="'reply-edit-form-' + ${subReply.reply_no}" class="reply-edit-form">
                    <textarea th:id="'edit-textarea-' + ${subReply.reply_no}" class="form-control mb-2" style="resize: none; height: 50px;"></textarea>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- ëŒ€ëŒ“ê¸€ ì‘ì„± í¼ -->
          <div class="sub-reply-write mt-2" style="display: none;" th:id="'sub-reply-form-' + ${reply.reply_no}">
            <form th:action="@{/replies/{boardNo}/{parentReplyNo}/create-sub(boardNo=${board.boardNo}, parentReplyNo=${reply.reply_no})}" method="POST" class="d-flex gap-2 align-items-stretch sub-reply-form-content">
              <textarea name="reply_content" placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”." required class="form-control"></textarea>
              <input type="hidden" name="board_no" th:value="${board.boardNo}" />
              <input type="hidden" name="parent_reply_no" th:value="${reply.reply_no}" />
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
              <button type="submit" class="btn btn-primary">ë“±ë¡</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
<div class="text-center mt-3" th:if="${hasMoreReplies}">
  <button id="load-more-btn" class="btn btn-primary px-4">+ ë”ë³´ê¸°</button>
</div>
</div>

   
    <!-- ëŒ“ê¸€ ì‘ì„± ì˜ì—­ (í•˜ë‹¨ ê³ ì •) -->
    <div class="comment-write">
      <th:block sec:authorize="isAuthenticated()">
        <form th:action="@{/replies/{boardNo}/create(boardNo=${board.boardNo})}" method="POST" class="d-flex gap-2 align-items-stretch">
          <textarea name="reply_content" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”." required class="form-control"></textarea>
          <input type="hidden" name="board_no" th:value="${board.boardNo}" />
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
          <button type="submit" class="btn btn-primary">ë“±ë¡</button>
        </form>
      </th:block>
      <th:block sec:authorize="isAnonymous()">
        <p class="text-muted">ë¡œê·¸ì¸ í›„ ëŒ“ê¸€ì„ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      </th:block>
    </div>        


  <script>
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;
    const csrfToken = document.querySelector('meta[name="_csrf"]').content;

 // ê²Œì‹œê¸€ ì‚­ì œ ê¸°ëŠ¥
    async function boardDelete(boardNo) {
      const confirmed = await confirm("ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
      if (!confirmed) return;

      fetch('/board/delete/' + boardNo, {
        method: 'DELETE',
        headers: {
          [csrfHeader]: csrfToken,
          'Content-Type': 'application/json'
        }
      })
      .then(res => res.json())
      .then(data => {
        alert(data.res_msg);
        if (data.res_code === "200") {
          location.href = '/board/list';
        }
      })
      .catch(err => {
        alert("ì—ëŸ¬ ë°œìƒ: " + err);
      });
    }
        
    // ëŒ“ê¸€ ìˆ˜ì • ì‹œì‘
    function replyUpdate(replyNo) {
      const content = document.getElementById(`reply-content-${replyNo}`);
      const form = document.getElementById(`reply-edit-form-${replyNo}`);
      const textarea = document.getElementById(`edit-textarea-${replyNo}`);
      const actions = content.closest('.reply-item, .sub-reply-item').querySelector('.reply-actions');
      textarea.value = content.innerText.trim();
      content.style.display = 'none';
      form.style.display = 'block';
      actions.querySelector('.edit-btn').style.display = 'none';
      actions.querySelector('.delete-btn').style.display = 'none';
      actions.querySelector('.save-btn').style.display = 'inline-block';
      actions.querySelector('.cancel-btn').style.display = 'inline-block';
    }

    // ëŒ“ê¸€ ìˆ˜ì • ì €ì¥
    function saveReplyEdit(replyNo) {
      const content = document.getElementById(`reply-content-${replyNo}`);
      const form = document.getElementById(`reply-edit-form-${replyNo}`);
      const textarea = document.getElementById(`edit-textarea-${replyNo}`);
      const actions = content.closest('.reply-item, .sub-reply-item').querySelector('.reply-actions');
      const timeElement = content.parentElement.querySelector('.time-display');
      const newContent = textarea.value.trim();
      if (!newContent) {
        alert("ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
        return;
      }
      fetch(`/replies/${replyNo}/update`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          [csrfHeader]: csrfToken
        },
        body: JSON.stringify({ reply_content: newContent })
      })
      .then(res => {
        if (!res.ok) throw new Error("ì‘ë‹µ ì‹¤íŒ¨");
        return res.json();
      })
      .then(data => {
        if (data.success) {
          content.innerText = newContent;
          content.style.display = 'block';
          form.style.display = 'none';
          actions.querySelector('.edit-btn').style.display = 'inline-block';
          actions.querySelector('.delete-btn').style.display = 'inline-block';
          actions.querySelector('.save-btn').style.display = 'none';
          actions.querySelector('.cancel-btn').style.display = 'none';
          let modifiedTag = timeElement.parentElement.querySelector('.modified-tag');
          if (!modifiedTag) {
            modifiedTag = document.createElement('small');
            modifiedTag.className = 'modified-tag ms-1';
            modifiedTag.innerText = '(ìˆ˜ì •ë¨)';
            timeElement.parentElement.appendChild(modifiedTag);
          }
          alert("ëŒ“ê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } else {
          alert("ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      })
      .catch(err => {
        console.error("ìˆ˜ì • ì‹¤íŒ¨:", err);
        alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      });
    }

    // ëŒ“ê¸€ ìˆ˜ì • ì·¨ì†Œ
    function cancelReplyEdit(replyNo) {
      const content = document.getElementById(`reply-content-${replyNo}`);
      const form = document.getElementById(`reply-edit-form-${replyNo}`);
      const actions = content.closest('.reply-item, .sub-reply-item').querySelector('.reply-actions');
      content.style.display = 'block';
      form.style.display = 'none';
      actions.querySelector('.edit-btn').style.display = 'inline-block';
      actions.querySelector('.delete-btn').style.display = 'inline-block';
      actions.querySelector('.save-btn').style.display = 'none';
      actions.querySelector('.cancel-btn').style.display = 'none';
    }

    // ëŒ“ê¸€ ì‚­ì œ
      async function replyDelete(replyNo, boardNo) {
    const confirmed = await confirm("ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
    if (!confirmed) return;

    fetch(`/replies/${replyNo}/delete`, {
      method: 'POST',
      headers: {
        [csrfHeader]: csrfToken,
        'Content-Type': 'application/json'
      }
    })
    .then(res => res.json())
    .then(data => {
      alert(data.res_msg);
      if (data.res_code === "200") {
        location.reload();
      }
    })
    .catch(err => {
      console.error('ì‚­ì œ ì‹¤íŒ¨:', err);
      alert("ì—ëŸ¬ ë°œìƒ: " + err);
    });
  }

    // ë‹µê¸€ í† ê¸€ ë° ëŒ€ëŒ“ê¸€ í¼ í‘œì‹œ
  function toggleSubReply(element) {
    const replyNo = element.getAttribute('data-reply-no');
    const subReplyList = document.getElementById(`sub-reply-list-${replyNo}`);
    const subReplyForm = document.getElementById(`sub-reply-form-${replyNo}`);
    const count = parseInt(element.getAttribute('data-sub-reply-count')) || 0;

    if (subReplyList) {
      subReplyList.classList.toggle('collapsed');
    }

    if (subReplyForm) {
      subReplyForm.style.display = subReplyForm.style.display === 'block' ? 'none' : 'block';
    }

    const isOpen = subReplyForm && subReplyForm.style.display === 'block';
    element.innerText = count > 0 ? `ë‹µê¸€ ${count}ê°œ(${isOpen ? 'â–²' : 'â–¼'})` : 'ë‹µê¸€ ë‹¬ê¸°';
  }

    // ëŒ€ëŒ“ê¸€ í¼ ì œì¶œ ì²˜ë¦¬
    document.querySelectorAll('.sub-reply-form-content').forEach(form => {
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        const replyNo = this.querySelector('input[name="parent_reply_no"]').value;
        const toggleButton = document.getElementById(`reply-toggle-${replyNo}`);
        let subReplyCount = parseInt(toggleButton.getAttribute('data-sub-reply-count')) || 0;
        fetch(this.action, {
          method: 'POST',
          headers: {
            [csrfHeader]: csrfToken,
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: new URLSearchParams(new FormData(this)).toString()
        })
        .then(res => {
          if (res.ok) {
            subReplyCount++;
            toggleButton.setAttribute('data-sub-reply-count', subReplyCount);
            toggleButton.classList.add('has-sub-replies');
            toggleButton.innerText = `ë‹µê¸€ ${subReplyCount}ê°œ(â–¼)`;
            this.closest('.sub-reply-write').style.display = 'none';
            this.reset();
            fetch(`/replies/count/${replyNo}`, {
              headers: { [csrfHeader]: csrfToken }
            })
            .then(res => res.json())
            .then(data => {
              if (data.count !== undefined) {
                toggleButton.setAttribute('data-sub-reply-count', data.count);
                toggleButton.innerText = `ë‹µê¸€ ${data.count}ê°œ(â–²)`;
              }
            });
            location.reload();
          } else {
            alert('ë‹µê¸€ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
        })
        .catch(err => {
          console.error('ëŒ€ëŒ“ê¸€ ë“±ë¡ ì˜¤ë¥˜:', err);
          alert('ì˜¤ë¥˜ ë°œìƒ: ' + err);
        });
      });
    });
// + ë”ë³´ê¸° ë²„íŠ¼ ì¶”ê°€
let currentPage = 1; // page=0ì€ ì´ë¯¸ ì„œë²„ ë Œë”ë§ë¨
const pageSize = 5;
const boardNo = /*[[${board.boardNo}]]*/ 0;

function loadMoreReplies() {
	  fetch(`/replies/${boardNo}?page=${currentPage}&size=${pageSize}`, {
	    headers: { [csrfHeader]: csrfToken }
	  })
	    .then(res => res.json())
	    .then(data => {
	      const replies = data.replies;
	      const hasMore = data.hasMore;
	      const container = document.getElementById('comment-container');
	      
	      if (!replies || replies.length === 0) {
	        document.getElementById('load-more-btn')?.remove();
	        return;
	      }

	      replies.forEach(reply => {
	        const div = document.createElement('div');
	        div.className = 'reply-item mb-3';
	        div.innerHTML = `
	          <div class="d-flex align-items-start mb-2">
	            <div class="profile-icon rounded-circle me-3">
	              <img src="${reply.attachPath || '/img/default_profile.png'}" class="rounded-circle" style="width: 100%; height: 100%; object-fit: cover;">
	            </div>
	            <div class="flex-grow-1">
	              <div class="d-flex justify-content-between align-items-center">
	                <div>
	                  <strong>[${reply.deptName || 'ë¶€ì„œì—†ìŒ'}] ${reply.memberName || 'ìµëª…'}</strong>
	                  <small class="ms-2 time-display">${reply.regDateFormatted}</small>
	                </div>
	              </div>
	              <p class="reply-content mt-2 mb-2">${reply.reply_content}</p>
	            </div>
	          </div>
	        `;

	        // ë®ì–´ì“°ê¸° X â†’ ê·¸ëƒ¥ containerì— ì¶”ê°€
	        container.appendChild(div);
	      });

	      if (!hasMore) {
	        document.getElementById('load-more-btn')?.remove();
	      } else {
	        currentPage++;
	      }
	    })
	    .catch(err => {
	      console.error("âŒ ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
	    });
	}
document.getElementById('load-more-btn')?.addEventListener('click', loadMoreReplies);
  </script>
  
  
  <script th:inline="javascript">
  const csrfHeader1 = 'X-CSRF-TOKEN';
  const csrfToken1 = '';
  const memberNo = /*[[${#authentication?.principal?.member?.memberNo}]]*/ 0;

  document.addEventListener("DOMContentLoaded", function () {
	  const form = document.getElementById('voteForm');
	  const voteNo = form?.getAttribute('data-vote-no');
	  const voteBtn = document.getElementById('submitVoteBtn');
	  const chartBtn = document.getElementById('resultChartBtn');
	  const voteClosedMsg = document.getElementById('vote-closed-message');
	  const endSpan = document.getElementById('vote-end-time');
	  const endTimeStr = endSpan?.getAttribute('data-end-time');
	  const endTime = endTimeStr ? new Date(endTimeStr.replace(' ', 'T')) : null;

	  // 1. íˆ¬í‘œ ì—¬ë¶€ í™•ì¸
	  fetch(`/vote/${voteNo}/has-voted?memberNo=${memberNo}`)
	    .then(res => res.json())
	    .then(data => {
	      if (data.voted) {
	        voteBtn.disabled = true;
	        voteBtn.classList.remove('btn-primary');
	        voteBtn.classList.add('btn-danger');
	        voteBtn.innerText = 'íˆ¬í‘œ ì™„ë£Œ';
	        chartBtn.style.display = 'inline-block'; // íˆ¬í‘œí•œ ì‚¬ìš©ìë§Œ ê²°ê³¼ ì°¨íŠ¸ ë³´ê¸° ê°€ëŠ¥
	      }
	    });

	  // 2. ë§ˆê° ì—¬ë¶€ í™•ì¸
	  fetch(`/vote/${voteNo}/is-closed`)
	    .then(res => res.json())
	    .then(data => {
	      if (data.closed) {
	        if (form) form.style.display = 'none'; // í¼ ì œê±°
	        if (voteBtn) voteBtn.remove(); // ë²„íŠ¼ ì œê±°
	        if (voteClosedMsg) voteClosedMsg.style.display = 'block';

	        // ë§ˆê° + ì´ë¯¸ íˆ¬í‘œí•œ ì‚¬ìš©ìë¼ë©´ ì°¨íŠ¸ ë³´ê¸° ê°€ëŠ¥
	        fetch(`/vote/${voteNo}/has-voted?memberNo=${memberNo}`)
	          .then(res => res.json())
	          .then(data => {
	            if (data.voted) {
	              chartBtn.style.display = 'inline-block';
	            }
	          });
	      }
	    });

	  // 3. ì‹¤ì‹œê°„ ë§ˆê° ì²´í¬ -> ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ë°”ê¾¸ê¸°
document.addEventListener("DOMContentLoaded", function () {
  const now = new Date();
  if (endTime && now >= endTime) {
    if (form) form.style.display = 'none';
    if (voteBtn) voteBtn.remove();
    if (voteClosedMsg) voteClosedMsg.style.display = 'block';

    fetch(`/vote/${voteNo}/has-voted?memberNo=${memberNo}`)
      .then(res => res.json())
      .then(data => {
        if (data.voted) {
          chartBtn.style.display = 'inline-block';
        }
      });
  }
});

	  if (endTime) {
	    checkClosed();
	    setInterval(checkClosed, 1000);
	  }
	});
  
  // íˆ¬í‘œ ì œì¶œ
function submitVote() {
  const form = document.getElementById('voteForm');
  const voteNo = form.getAttribute('data-vote-no');
  const selectedOptions = Array.from(form.querySelectorAll("input[name='optionNos']:checked"))
    .map(opt => opt.value);

  if (selectedOptions.length === 0) {
    alert("í•˜ë‚˜ ì´ìƒì˜ í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
    return;
  }

  fetch(`/vote/${voteNo}/submit?` + new URLSearchParams({
    optionNos: selectedOptions
  }), {
    method: 'POST',
    headers: {
      [csrfHeader]: csrfToken
    }
  })
    .then(res => res.ok ? res.text() : Promise.reject("íˆ¬í‘œ ì‹¤íŒ¨"))
    .then(() => {
      alert("íˆ¬í‘œ ì™„ë£Œ!");
   // ë²„íŠ¼ ì²˜ë¦¬
      const voteBtn = document.getElementById('submitVoteBtn');
      voteBtn.disabled = true;
      voteBtn.classList.remove('btn-primary');
      voteBtn.classList.add('btn-danger');
      voteBtn.innerText = 'íˆ¬í‘œ ì™„ë£Œ';

      // ì°¨íŠ¸ ë²„íŠ¼ ë³´ì´ê¸°
      document.getElementById('resultChartBtn').style.display = 'inline-block';

    })
  }

  // Chart.js ê²°ê³¼ ì°¨íŠ¸ í‘œì‹œ(ë§‰ëŒ€ ê·¸ë˜í”„)
  document.getElementById('voteResultModal').addEventListener('show.bs.modal', function () {
  const voteNo = this.getAttribute('data-vote-no');

  fetch(`/vote/${voteNo}/result`, {
    headers: { [csrfHeader]: csrfToken }
  })
    .then(res => res.json())
    .then(data => {
      const labels = data.map(opt => opt.optionText);
      const counts = data.map(opt => opt.voteCount);
      const voters = data.map(opt => opt.voters || []);
      const isAnonymous = data[0]?.anonymous === 'Y';

      const ctx = document.getElementById('voteResultChart').getContext('2d');

      if (window.voteChart) window.voteChart.destroy();

      const backgroundColors = [
        '#0d6efd', '#6f42c1', '#fd7e14',
        '#198754', '#dc3545', '#20c997',
        '#ffc107', '#6610f2'
      ];

      window.voteChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'ë“í‘œ ìˆ˜',
            data: counts,
            backgroundColor: backgroundColors.slice(0, labels.length),
            borderRadius: 5,
            borderSkipped: false,
            barThickness: 40
          }]
        },
        options: {
        	  responsive: true,
        	  maintainAspectRatio: false, // ì¤‘ìš”!
        	  animation: false, // ì• ë‹ˆë©”ì´ì…˜ ì œê±°
        	  scales: {
        	    x: {
        	      grid: { display: false },
        	      title: { display: false }
        	    },
        	    y: {
        	      beginAtZero: true,
        	      ticks: {
        	        stepSize: 1,
        	        callback: value => `${value}í‘œ`
        	      },
        	      title: {
        	        display: true,
        	        text: 'ë“í‘œ ìˆ˜'
        	      }
        	    }
        	  },
        	  plugins: {
        	    legend: { display: false },
        	    tooltip: {
        	    	  callbacks: {
        	    	    title: function () {
        	    	      // ìƒë‹¨ title(ì˜ˆ: "22: í•­ëª©ëª…") ì œê±°
        	    	      return '';
        	    	    },
        	    	    label: function (context) {
        	    	    	  const value = context.raw;
        	    	    	  const index = context.dataIndex;

        	    	    	  const rawLabel = context.label;
        	    	    	  const cleanedLabel = rawLabel.includes(':')
        	    	    	    ? rawLabel.split(':').slice(1).join(':').trim()
        	    	    	    : rawLabel;

        	    	    	  const lines = [`${cleanedLabel}: ${value}í‘œ`];

        	    	    	  if (!isAnonymous) {
        	    	    	    const voterNames = voters[index];
        	    	    	    if (voterNames && voterNames.length > 0) {
        	    	    	      const chunked = [];
        	    	    	      for (let i = 0; i < voterNames.length; i += 3) {
        	    	    	    	  chunked.push(voterNames.slice(i, i + 3).join(', '));
        	    	    	    	}
        	    	    	      lines.push(...chunked); // ê° ì¤„ ì¶”ê°€
        	    	    	    } else {
        	    	    	      lines.push('íˆ¬í‘œì ì—†ìŒ');
        	    	    	    }
        	    	    	  }

        	    	    	  return lines;
        	    	    	}
        	    	  }
        	    	}
        	  },
        	  onClick: function (e, elements) {
        	    // ê·¸ë˜í”„ í´ë¦­ ì´ë²¤íŠ¸ ì œê±°
        	  }
        	}
      });
    })
    .catch(err => {
      alert("íˆ¬í‘œ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      console.error(err);
    });
});
</script>
 
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Start Editor JS -->
  <script src="https://cdn.jsdelivr.net/npm/start-editor@1.0.0/start-editor.min.js"></script>
  <!-- JavaScript íŒŒì¼ ë¡œë”© -->
  <script th:src="@{/assets/js/vendor.min.js}"></script>
  <script th:src="@{/assets/libs/bootstrap/dist/js/bootstrap.bundle.min.js}"></script>
  <script th:src="@{/assets/libs/simplebar/dist/simplebar.min.js}"></script>
  <script th:src="@{/assets/js/theme/app.init.js}"></script>
  <script th:src="@{/assets/js/theme/theme.js}"></script>
  <script th:src="@{/assets/js/theme/app.min.js}"></script>
  <script th:src="@{/assets/js/theme/sidebarmenu.js}"></script>
  <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>
  <script th:src="@{/assets/libs/owl.carousel/dist/owl.carousel.min.js}"></script>
  <script th:src="@{/assets/libs/apexcharts/dist/apexcharts.min.js}"></script>
  <script th:src="@{/assets/js/dashboards/dashboard.js}"></script>
</th:block>
</html>