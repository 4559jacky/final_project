<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/include/layout}">
      
 <head>
   <link rel="stylesheet" th:href="@{/css/kdy.css}">
   		<!-- Bootstrap Icons CDN -->
   <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
</head>

<head layout:fragment="head">
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />

    <!-- Start Editor CSS -->
    <link href="https://cdn.jsdelivr.net/npm/start-editor@1.0.0/start-editor.min.css" rel="stylesheet">

</head>

<th:block layout:fragment="content">


    <!-- í˜ì´ì§€ ì œëª© -->
    <div class="col-lg-8 col-md-6 col-12 align-self-center">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb align-items-center">
                <li class="breadcrumb-item">
                    <a class="text-muted text-decoration-none" th:href="@{/home}">
                        <i class="ti ti-home fs-5"></i>
                    </a>
                </li>
                <li class="breadcrumb-item">ììœ ê²Œì‹œíŒ ìƒì„¸/ëŒ“ê¸€</li>
            </ol>
        </nav><br>
        <h2 class="mb-0 fw-bolder fs-8">ììœ ê²Œì‹œíŒ ìƒì„¸</h2>
    </div><br>

    <div class="mt-5"></div>

    <!-- ë³¸ë¬¸ ì¹´ë“œ -->
<div class="p-5 bg-white rounded-4 shadow-sm mb-5">

<!-- ì œëª©ê³¼ ì‘ì„± ì •ë³´ í•œ ì¤„ì— ë°°ì¹˜ -->
<div class="mb-2 d-flex justify-content-between align-items-center">
    <!-- ì œëª© (ì™¼ìª½ ì •ë ¬) -->
    <h2 th:text="${board.boardTitle ?: 'ì œëª© ì—†ìŒ'}"
        class="fw-bold mb-0"
        style="font-size: 2rem;"></h2>

    <!-- ì‘ì„± ì •ë³´ (ì˜¤ë¥¸ìª½ ì •ë ¬) -->
    <div class="text-dark" style="font-size: 1rem; white-space: nowrap;">
        <span>ì‘ì„±ì: </span>
        <span th:text="${board.member?.memberName ?: 'ìµëª…'}"></span>
        <span> | ì‘ì„±ì¼: </span>
        <span th:text="${#temporals.format(board.regDate, 'yyyy-MM-dd HH:mm')}">ë“±ë¡ì¼</span>
        <span> | ì¡°íšŒìˆ˜: </span>
        <span th:text="${board.views}">0</span>
    </div>
</div>

    <hr>

    <!-- ë³¸ë¬¸ ë‚´ìš© (í…Œë‘ë¦¬ ì—†ëŠ” ë²„ì „) -->
    <div class="toastui-editor-contents"
         style="background-color: white; min-height: 300px; font-size: 1.1rem; line-height: 1.8rem; padding: 1rem;"
         th:utext="${board.boardContent ?: 'ë‚´ìš© ì—†ìŒ'}">
    </div>

    <hr>

<!-- ì²¨ë¶€íŒŒì¼ -->
<div class="pt-3">
    <h5 class="fw-semibold">ì²¨ë¶€íŒŒì¼</h5>

<ul th:if="${attachList != null and not #lists.isEmpty(attachList)}">
  <li th:each="boardAttach : ${attachList}">
    <a th:href="@{/download/{id}(id=${boardAttach.attachNo})}" 
       class="file-link"
       th:data-url="@{/upload/path/{filename}(filename=${boardAttach.oriName})}">
       
       <i class="bi bi-file-earmark-image me-1"></i>
       <span th:text="${boardAttach.oriName}">íŒŒì¼ëª…</span>
    </a>
  </li>
</ul>

    <p th:if="${attachList == null or #lists.isEmpty(attachList)}">ì²¨ë¶€íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
</div>

    <!-- ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ -->
    <th:block sec:authorize="isAuthenticated()">
        <div th:if="${#authentication.principal.member.memberNo == board.member.memberNo}" class="mt-4 text-end">
            <a th:href="@{/board/list}" class="btn btn-primary px-3 py-1">ëª©ë¡ìœ¼ë¡œ</a>
            <a class="btn btn-primary px-3 py-1" th:href="@{/board/{id}/update(id=${board.boardNo})}">ìˆ˜ì •</a>
            <a class="btn btn-danger px-3 py-1" href="#" th:onclick="|boardDelete(${board.boardNo})|">ì‚­ì œ</a>
        </div>
    </th:block>
</div>



   <!-- ëŒ“ê¸€ ì‘ì„± ì˜ì—­ -->
<div class="p-4 bg-white rounded-4 shadow-sm mb-4">
    <label class="fw-bold fs-5 mb-3 d-block">ğŸ’¬ ëŒ“ê¸€ ë‹¬ê¸°</label>
    <th:block sec:authorize="isAuthenticated()">
        <form th:action="@{/replies/{boardNo}/create(boardNo=${board.boardNo})}" method="POST"
              style="display: flex; gap: 10px; align-items: stretch;">
            <textarea name="reply_content" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" required
                      style="resize: none; flex-grow: 1; height: 60px;" class="form-control"></textarea>
            <button type="submit" class="btn btn-primary" style="height: 60px; min-width: 80px;">ë“±ë¡</button>
            <input type="hidden" name="board_no" th:value="${board.boardNo}">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        </form>
    </th:block>
    <th:block sec:authorize="isAnonymous()">
        <p>ë¡œê·¸ì¸ í›„ ëŒ“ê¸€ì„ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    </th:block>
</div>

<!-- ëŒ“ê¸€ + ëŒ€ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ -->
    <div th:each="reply : ${replyList}" class="reply-item mb-3 p-3 border rounded-3">
    <div class="reply-container">
        <div class="reply-info d-flex justify-content-between">
            <div class="reply-author">
                <span th:text="${reply.memberName}">ì‘ì„±ì ì´ë¦„</span>
                <span th:text="${reply.timeAgo}">ëª‡ì‹œê°„ ì „</span>
            </div>
            <div class="reply-actions">
                <button type="button" class="btn btn-sm btn-outline-warning" th:onclick="|reportReply(${reply.reply_no})|">ì‹ ê³ </button>
            </div>
        </div>

        <div class="reply-content">
            <p th:text="${reply.reply_content}">ëŒ“ê¸€ ë‚´ìš©</p>
        </div>

        <!-- ë‹µê¸€ ë²„íŠ¼ -->
        <div class="d-flex align-items-center mb-2">
            <button type="button" class="btn btn-sm btn-outline-primary" th:onclick="|showReplyForm(${reply.reply_no})|">ëŒ“ê¸€ë‹¬ê¸°</button>
        </div>
    </div>

    <!-- ëŒ€ëŒ“ê¸€ ì…ë ¥ í¼ (ê¸°ë³¸ ìˆ¨ê¹€) -->
    <div th:id="'reply-form-' + ${reply.reply_no}" style="display: none;" class="mb-2">
        <form th:action="@{/replies/{boardNo}/{parentReplyNo}/create-sub(boardNo=${board.boardNo}, parentReplyNo=${reply.reply_no})}" method="POST"
              style="display: flex; gap: 10px;">
            <textarea name="reply_content" class="form-control" required style="resize: none; flex-grow: 1; height: 60px;"></textarea>
            <button type="submit" class="btn btn-secondary">ë“±ë¡</button>
            <input type="hidden" name="board_no" th:value="${board.boardNo}">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        </form>
    </div>

    <!-- ëŒ€ëŒ“ê¸€ ëª©ë¡ -->
    <div class="ps-4 border-start mt-2" th:if="${reply.subReplies != null and !#lists.isEmpty(reply.subReplies)}">
        <div th:each="subReply : ${reply.subReplies}" class="sub-reply-item py-1">
            <div class="reply-content">
                <strong th:text="${subReply.memberName}">ì‘ì„±ì</strong> :
                <span th:text="${subReply.reply_content}">ë‚´ìš©</span>
            </div>
        </div>
    </div>
</div>
            
<!-- ì‚­ì œ JS ë° ëŒ€ëŒ“ê¸€ í¼ í‘œì‹œ JS -->
    <script>
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;
        const csrfToken = document.querySelector('meta[name="_csrf"]').content;

        const boardDelete = (boardNo) => {
            if (!confirm("ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

            fetch(`/board/delete/${boardNo}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [csrfHeader]: csrfToken
                }
            })
            .then(res => res.json())
            .then(data => {
                alert(data.res_msg);
                if (data.res_code === '200') {
                    location.href = '/board/list';
                }
            });
        };

        function showReplyForm(replyNo) {
            const form = document.getElementById('reply-form-' + replyNo);
            form.style.display = form.style.display === 'none' || form.style.display === '' ? 'block' : 'none';
        }
    </script>

	
        <!-- Start Editor JS -->
        <script src="https://cdn.jsdelivr.net/npm/start-editor@1.0.0/start-editor.min.js"></script>

        <!-- Import vendorJs Files -->
        <script th:src="@{/assets/js/vendor.min.js}"></script>

        <!-- JavaScript íŒŒì¼ ë¡œë”© -->
        <script th:src="@{/assets/js/vendor.min.js}"></script>
        <script th:src="@{/assets/libs/bootstrap/dist/js/bootstrap.bundle.min.js}"></script>
        <script th:src="@{/assets/libs/simplebar/dist/simplebar.min.js}"></script>
        <script th:src="@{/assets/js/theme/app.init.js}"></script>
        <script th:src="@{/assets/js/theme/theme.js}"></script>
        <script th:src="@{/assets/js/theme/app.min.js}"></script>
        <script th:src="@{/assets/js/theme/sidebarmenu.js}"></script>

        <!-- solar icons -->
        <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>
        <script th:src="@{/assets/libs/owl.carousel/dist/owl.carousel.min.js}"></script>
        <script th:src="@{/assets/libs/apexcharts/dist/apexcharts.min.js}"></script>
        <script th:src="@{/assets/js/dashboards/dashboard.js}"></script>

    </th:block>
</html>