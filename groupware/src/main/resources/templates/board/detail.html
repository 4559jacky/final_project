<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/include/layout}">
      
<head layout:fragment="head">
  <meta name="_csrf" th:content="${_csrf.token}" />
  <meta name="_csrf_header" th:content="${_csrf.headerName}" />
  <link href="https://cdn.jsdelivr.net/npm/start-editor@1.0.0/start-editor.min.css" rel="stylesheet">
  <link rel="stylesheet" th:href="@{/css/kdy.css}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
</head>

<th:block layout:fragment="content">

    <!-- 페이지 제목 -->
    <div class="col-lg-8 col-md-6 col-12 align-self-center">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb align-items-center">
                <li class="breadcrumb-item">
                    <a class="text-muted text-decoration-none" th:href="@{/home}">
                        <i class="ti ti-home fs-5"></i>
                    </a>
                </li>
                <li class="breadcrumb-item">자유게시판 상세/댓글</li>
            </ol>
        </nav><br>
        <h2 class="mb-0 fw-bolder fs-8">자유게시판 상세</h2>
    </div><br>

    <div class="mt-5"></div>

    <!-- 본문 카드 -->
<div class="p-5 bg-white rounded-4 shadow-sm mb-5">

<!-- 제목과 작성 정보 한 줄에 배치 -->
<div class="mb-2 d-flex justify-content-between align-items-center">
    <!-- 제목 (왼쪽 정렬) -->
    <h2 th:text="${board.boardTitle ?: '제목 없음'}"
        class="fw-bold mb-0"
        style="font-size: 2rem;"></h2>
        

    <!-- 작성 정보 (오른쪽 정렬) -->
<div class="d-flex justify-content-between align-items-center text-dark" style="font-size: 1rem; white-space: nowrap;">
    <div>
    <div>
        <button type="button" class="btn btn-warning px-3 py-1">신고</button>
    </div>
    	<div>
	        <span>작성자: </span>
    	    <span th:text="${board.member?.memberName ?: '익명'}"></span>
    	</div>
    	<div>
	        <span>작성일: </span>
    	    <span th:text="${#temporals.format(board.regDate, 'yyyy-MM-dd HH:mm')}">등록일</span>
    	</div>
    	<div>
	        <span>조회수: </span>
    	    <span th:text="${board.views}">0</span>
    	</div>
    </div>
</div>
</div>
    <hr>
    
    <!-- 본문 내용 (테두리 없는 버전) -->
    <div class="toastui-editor-contents"
         style="background-color: white; min-height: 300px; font-size: 1.1rem; line-height: 1.8rem; padding: 1rem;"
         th:utext="${board.boardContent ?: '내용 없음'}">
    </div>
    <hr>

<!-- 첨부파일 -->
<div class="pt-3">
    <h5 class="fw-semibold">첨부파일</h5>

<ul th:if="${attachList != null and not #lists.isEmpty(attachList)}">
  <li th:each="boardAttach : ${attachList}">
    <a th:href="@{/download/{id}(id=${boardAttach.attachNo})}" 
       class="file-link"
       th:data-url="@{/upload/path/{filename}(filename=${boardAttach.oriName})}">
       <i class="bi bi-file-earmark-text me-1"></i> <!-- 멘토 선생님 피드백 반영(텍스트 아이콘 사용)했음 좋겠다 하셔서 바꿈  -->
       <span th:text="${boardAttach.oriName}">파일명</span>
    </a>
  </li>
</ul>

    <p th:if="${attachList == null or #lists.isEmpty(attachList)}">첨부파일이 없습니다.</p>
</div>

    <!-- 수정/삭제 버튼(본인이 쓴 글은 보일수있고, 남이 볼때는 보이지 않게 처리) -->
    <th:block sec:authorize="isAuthenticated()">
        <div th:if="${#authentication.principal.member.memberNo == board.member.memberNo}" class="mt-4 text-end">
            <a th:href="@{/board/list}" class="btn btn-primary px-3 py-1">목록으로</a>
            <a class="btn btn-primary px-3 py-1" th:href="@{/board/{id}/update(id=${board.boardNo})}">수정</a>
            <a class="btn btn-danger px-3 py-1" href="#" th:onclick="|boardDelete(${board.boardNo})|">삭제</a>
        </div>
    </th:block>
</div>



<!-- 댓글 작성 영역 -->
<div class="p-4 bg-white rounded-4 shadow-sm mb-4">
    <label class="fw-bold fs-5 mb-3 d-block">💬 댓글 달기</label>
    <th:block sec:authorize="isAuthenticated()">
        <form th:action="@{/replies/{boardNo}/create(boardNo=${board.boardNo})}" method="POST"
              style="display: flex; gap: 10px; align-items: stretch;">
            <textarea name="reply_content" placeholder="댓글을 입력하세요" required
                      style="resize: none; flex-grow: 1; height: 60px;" class="form-control"></textarea>
            <button type="submit" class="btn btn-primary" style="height: 60px; min-width: 80px;">등록</button>
            <input type="hidden" name="board_no" th:value="${board.boardNo}"/>
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        </form>
    </th:block>
    <th:block sec:authorize="isAnonymous()">
        <p>로그인 후 댓글을 작성할 수 있습니다.</p>
    </th:block>
</div>

<!-- 댓글 + 대댓글 리스트 -->
<div th:each="reply : ${replyList}" class="reply-item mb-3 p-3 border rounded-3">
    <div class="reply-container">
        <div class="reply-info d-flex justify-content-between">
            <div class="reply-author">
                <span th:text="${reply.memberName}">작성자 이름</span>
                <span th:text="${reply.timeAgo}">몇시간 전</span>
            </div>

            <!-- 본인이 쓴 댓글일 경우에만 수정/삭제 버튼 노출 -->
            <th:block th:if="${reply.member_no == #authentication.principal.member.memberNo}">
                <div class="mt-4 text-end">
                    <div class="reply-actions d-flex gap-2 justify-content-end">
                    
                        <!-- 수정 버튼: 수정 폼을 보여줌 -->
                        <button type="button" class="btn btn-primary px-3 py-1"
                                th:onclick="|showEditReplyForm(${reply.reply_no})|">수정</button>
                        <!-- 삭제 버튼: 삭제 확인 후 바로 삭제 -->
                        <button type="button" class="btn btn-danger px-3 py-1"
                                th:onclick="|replyDelete(${reply.reply_no})|">삭제</button>
                    </div>
                </div>
            </th:block>
        </div>

        <!-- 신고 버튼 (모든 사용자에게 노출) -->
        <div class="text-end">
            <button type="button" class="btn btn-warning btn-sm"
                    th:onclick="|reportReply(${reply.reply_no})|">신고</button>
        </div>

        <!-- 댓글 내용 (수정되면 입력창으로 변경됨) -->
        <div class="reply-content">
            <p th:text="${reply.reply_content}">댓글 내용</p>

            <!-- 댓글 수정 폼 (기본 숨김) -->
            <div id="edit-reply-form-${reply.reply_no}" style="display: none;" class="mt-2">
                <form th:action="@{/replies/{replyNo}/update(replyNo=${reply.reply_no})}" method="POST">
                    <textarea name="reply_content" th:text="${reply.reply_content}" class="form-control" required
                              style="resize: none; flex-grow: 1; height: 60px;"></textarea>
                    <button type="submit" class="btn btn-success mt-2">저장</button>
                    <input type="hidden" name="board_no" th:value="${board.boardNo}"/>
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                </form>
            </div>
        </div>

        <!-- 답글 버튼 -->
        <div class="d-flex align-items-center mb-2">
            <button type="button" class="btn btn-sm btn-primary"
                    th:onclick="|showReplyForm(${reply.reply_no})|">댓글달기</button>
        </div>
    </div>

    <!-- 대댓글 입력 폼 (기본 숨김) -->
    <div th:id="'reply-form-' + ${reply.reply_no}" style="display: none;" class="mb-2">
        <form th:action="@{/replies/{boardNo}/{parentReplyNo}/create-sub(boardNo=${board.boardNo}, parentReplyNo=${reply.reply_no})}"
              method="POST" style="display: flex; gap: 10px;">
            <textarea name="reply_content" class="form-control" required
                      style="resize: none; flex-grow: 1; height: 60px;"></textarea>
            <button type="submit" class="btn btn-primary">등록</button>
            <input type="hidden" name="board_no" th:value="${board.boardNo}"/>
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        </form>
    </div>

    <!-- 대댓글 목록 -->
    <div class="ps-4 border-start mt-2"
         th:if="${reply.subReplies != null and !#lists.isEmpty(reply.subReplies)}">
        <div th:each="subReply : ${reply.subReplies}" class="sub-reply-item py-1">
            <div class="reply-info d-flex justify-content-between">
                <div>
                    <strong th:text="${subReply.memberName}">작성자</strong> :
                    <span th:text="${subReply.reply_content}">내용</span>
                </div>

                <th:block th:if="${subReply.member_no == #authentication.principal.member.memberNo}">
                    <div class="reply-actions d-flex gap-2">
                        <!-- 수정 버튼: 수정 폼을 보여줌 -->
                        <button type="button" class="btn btn-primary btn-sm"
                                th:onclick="|showEditReplyForm(${subReply.reply_no})|">수정</button>
                        <!-- 삭제 버튼: 삭제 확인 후 바로 삭제 -->
                        <button type="button" class="btn btn-danger btn-sm"
                                th:onclick="|replyDelete(${subReply.reply_no})|">삭제</button>
                    </div>
                </th:block>
            </div>
        </div>
    </div>
</div>

            
<!-- 삭제 JS 및 대댓글 폼 표시 JS -->
    <script>
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;
        const csrfToken = document.querySelector('meta[name="_csrf"]').content;

        function boardDelete(boardNo) {
        	  if (!confirm("정말 삭제하시겠습니까?")) return;

        	  fetch('/board/delete/' + boardNo, {
        	    method: 'DELETE',
        	    headers: {
        	      [csrfHeader]: csrfToken,  // 🔐 CSRF 토큰 추가!
        	      'Content-Type': 'application/json'
        	    }
        	  })
        	  .then(res => res.json())
        	  .then(data => {
        	    if (data.res_code === "200") {
        	      alert(data.res_msg);
        	      location.href = '/board/list';
        	    } else {
        	      alert(data.res_msg);
        	    }
        	  })
        	  .catch(err => {
        	    alert("에러 발생: " + err);
        	  });
        	}
          
       // 댓글 삭제 기능
         const replyDelete = (replyNo) => {
        if (!confirm("댓글을 삭제하시겠습니까?")) return;

        fetch(`/replies/delete/${replyNo}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                [csrfHeader]: csrfToken
            }
        })
        .then(response => {
            if (response.ok) {
                alert("댓글이 삭제되었습니다.");
                location.reload();
            } else {
                alert("댓글 삭제 실패");
            }
        })
        .catch(error => {
            console.error("댓글 삭제 오류:", error);
            alert("에러 발생. 관리자에게 문의해주세요.");
        });
    };

    const showEditReplyForm = (replyNo) => {
        const replyForm = document.getElementById(`edit-reply-form-${replyNo}`);
        if (replyForm !== null) {
            // 수정 폼을 보이거나 숨기기
            replyForm.style.display = (replyForm.style.display === 'none' || replyForm.style.display === '') ? 'block' : 'none';
        }
    };

    const showReplyForm = (replyNo) => {
        const replyForm = document.getElementById(`reply-form-${replyNo}`);
        if (replyForm) {
            replyForm.style.display = replyForm.style.display === 'none' ? 'block' : 'none';
        }
    };
    </script>

	
        <!-- Start Editor JS -->
        <script src="https://cdn.jsdelivr.net/npm/start-editor@1.0.0/start-editor.min.js"></script>

        <!-- JavaScript 파일 로딩 -->
        <script th:src="@{/assets/js/vendor.min.js}"></script>
        <script th:src="@{/assets/libs/bootstrap/dist/js/bootstrap.bundle.min.js}"></script>
        <script th:src="@{/assets/libs/simplebar/dist/simplebar.min.js}"></script>
        <script th:src="@{/assets/js/theme/app.init.js}"></script>
        <script th:src="@{/assets/js/theme/theme.js}"></script>
        <script th:src="@{/assets/js/theme/app.min.js}"></script>
        <script th:src="@{/assets/js/theme/sidebarmenu.js}"></script>

        <!-- solar icons -->
        <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>
        <script th:src="@{/assets/libs/owl.carousel/dist/owl.carousel.min.js}"></script>
        <script th:src="@{/assets/libs/apexcharts/dist/apexcharts.min.js}"></script>
        <script th:src="@{/assets/js/dashboards/dashboard.js}"></script>

    </th:block>
</html>