<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/include/layout}">
      
<head layout:fragment="head">
  <meta name="_csrf" th:content="${_csrf.token}" />
  <meta name="_csrf_header" th:content="${_csrf.headerName}" />
  <link href="https://cdn.jsdelivr.net/npm/start-editor@1.0.0/start-editor.min.css" rel="stylesheet">
  <link rel="stylesheet" th:href="@{/css/kdy.css}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
</head>

<th:block layout:fragment="content">

    <!-- í˜ì´ì§€ ì œëª© -->
    <div class="col-lg-8 col-md-6 col-12 align-self-center">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb align-items-center">
                <li class="breadcrumb-item">
                    <a class="text-muted text-decoration-none" th:href="@{/home}">
                        <i class="ti ti-home fs-5"></i>
                    </a>
                </li>
                <li class="breadcrumb-item">ììœ ê²Œì‹œíŒ ìƒì„¸/ëŒ“ê¸€</li>
            </ol>
        </nav><br>
        <h2 class="mb-0 fw-bolder fs-8">ììœ ê²Œì‹œíŒ ìƒì„¸</h2>
    </div><br>

    <div class="mt-5"></div>

    <!-- ë³¸ë¬¸ ì¹´ë“œ -->
<div class="p-5 bg-white rounded-4 shadow-sm mb-5">

<!-- ì œëª©ê³¼ ì‘ì„± ì •ë³´ í•œ ì¤„ì— ë°°ì¹˜ -->
<div class="mb-2 d-flex justify-content-between align-items-center">
    <!-- ì œëª© (ì™¼ìª½ ì •ë ¬) -->
    <h2 th:text="${board.boardTitle ?: 'ì œëª© ì—†ìŒ'}"
        class="fw-bold mb-0"
        style="font-size: 2rem;"></h2>
        

    <!-- ì‘ì„± ì •ë³´ (ì˜¤ë¥¸ìª½ ì •ë ¬) -->
<div class="d-flex align-items-start" style="font-size: 1rem; white-space: nowrap;">
  <div>
    <div class="d-flex align-items-center">
      <span>ì‘ì„±ì: </span>
      <span th:text="${board.member?.memberName ?: 'ìµëª…'}" class="me-2"></span>
      <button type="button" class="btn btn-outline-danger btn-sm" title="ì‹ ê³ " style="padding: 0.15rem 0.5rem; height: 28px;">
        <i class="bi bi-exclamation-triangle-fill"></i>
      </button>
    </div>
    <div><span>ì‘ì„±ì¼: </span><span th:text="${#temporals.format(board.regDate, 'yyyy-MM-dd HH:mm')}">ë“±ë¡ì¼</span></div>
    <div><span>ì¡°íšŒìˆ˜: </span><span th:text="${board.views}">0</span></div>
  </div>
</div>
</div>
<hr>
    
    <!-- ë³¸ë¬¸ ë‚´ìš© (í…Œë‘ë¦¬ ì—†ëŠ” ë²„ì „) -->
    <div class="toastui-editor-contents"
         style="background-color: white; min-height: 300px; font-size: 1.1rem; line-height: 1.8rem; padding: 1rem;"
         th:utext="${board.boardContent ?: 'ë‚´ìš© ì—†ìŒ'}">
    </div>
    <hr>

<!-- ì²¨ë¶€íŒŒì¼ -->
<div class="pt-3">
    <h5 class="fw-semibold">ì²¨ë¶€íŒŒì¼</h5>

<ul th:if="${attachList != null and not #lists.isEmpty(attachList)}">
  <li th:each="boardAttach : ${attachList}">
    <a th:href="@{/download/{id}(id=${boardAttach.attachNo})}" 
       class="file-link"
       th:data-url="@{/upload/path/{filename}(filename=${boardAttach.oriName})}">
       <i class="bi bi-file-earmark-text me-1"></i> <!-- ë©˜í†  ì„ ìƒë‹˜ í”¼ë“œë°± ë°˜ì˜(í…ìŠ¤íŠ¸ ì•„ì´ì½˜ ì‚¬ìš©)í–ˆìŒ ì¢‹ê² ë‹¤ í•˜ì…”ì„œ ë°”ê¿ˆ  -->
       <span th:text="${boardAttach.oriName}">íŒŒì¼ëª…</span>
    </a>
  </li>
</ul>

    <p th:if="${attachList == null or #lists.isEmpty(attachList)}">ì²¨ë¶€íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
</div>

    <!-- ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼(ë³¸ì¸ì´ ì“´ ê¸€ì€ ë³´ì¼ìˆ˜ìˆê³ , ë‚¨ì´ ë³¼ë•ŒëŠ” ë³´ì´ì§€ ì•Šê²Œ ì²˜ë¦¬) -->
    <th:block sec:authorize="isAuthenticated()">
        <div th:if="${#authentication.principal.member.memberNo == board.member.memberNo}" class="mt-4 text-end">
            <a th:href="@{/board/list}" class="btn btn-primary px-3 py-1">ëª©ë¡ìœ¼ë¡œ</a>
            <a class="btn btn-primary px-3 py-1" th:href="@{/board/{id}/update(id=${board.boardNo})}">ìˆ˜ì •</a>
            <a class="btn btn-danger px-3 py-1" href="#" th:onclick="|boardDelete(${board.boardNo})|">ì‚­ì œ</a>
        </div>
    </th:block>
</div>



<!-- ëŒ“ê¸€ ì‘ì„± ì˜ì—­ -->
<div class="comment-write p-4 bg-white rounded-4 shadow-sm mb-4">
    <label class="fw-bold fs-5 mb-3 d-block">ğŸ’¬ ëŒ“ê¸€ ë‹¬ê¸°</label>
    <th:block sec:authorize="isAuthenticated()">
        <form th:action="@{/replies/{boardNo}/create(boardNo=${board.boardNo})}" method="POST" class="d-flex gap-2 align-items-stretch">
            <textarea name="reply_content" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" required class="form-control" style="resize: none; height: 60px;"></textarea>
            <button type="submit" class="btn btn-primary" style="min-width: 80px;">ë“±ë¡</button>
            <input type="hidden" name="board_no" th:value="${board.boardNo}"/>
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        </form>
    </th:block>
    <th:block sec:authorize="isAnonymous()">
        <p class="text-muted">ë¡œê·¸ì¸ í›„ ëŒ“ê¸€ì„ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    </th:block>
</div>

<!-- ëŒ“ê¸€ + ëŒ€ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ -->
<div th:each="reply : ${replyList}" class="reply-item mb-3 p-3 border rounded-3">
    <div class="d-flex align-items-start mb-2">
        <!-- í”„ë¡œí•„ ì•„ì´ì½˜ -->
        <div class="profile-icon rounded-circle bg-secondary text-white d-flex justify-content-center align-items-center me-3" style="width:40px; height:40px; font-size: 20px;">
            <i class="bi bi-person"></i> <!-- Bootstrap Icons ì‚¬ìš© ì˜ˆ -->
        </div>
        <div class="flex-grow-1">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong th:text="${reply.memberName}">ì‘ì„±ì</strong>
                    <small class="text-muted ms-2" th:text="${reply.timeAgo}"></small> <!--ì¼ë‹¨ ì•„ì§ ë³´ë¥˜(íŒ€ì›ë“¤ì€ ë…„ë„ ë‚ ì§œì‹ìœ¼ë¡œ ë°”ê¿§ìœ¼ë©´ ì¢‹ê² ë‹¤ê³  í–ˆê³ , ì„ ìƒë‹˜ì€ ì•Œì•„ì„œ ìƒê°í•´ì„œ í–ˆìœ¼ë©´ ì¢‹ê² ë‹¤ê³  í•´ì„œ ì¢€ ìƒê°í•´ë³´ê¸°)  -->
                </div>
                <th:block th:if="${reply.member_no == #authentication.principal.member.memberNo}">
                    <div class="reply-actions d-flex gap-2">
                        <button type="button" class="btn btn-primary btn-sm" th:onclick="|replyUpdate(${reply.reply_no})|">ìˆ˜ì •</button>
                        <button type="button" class="btn btn-danger btn-sm" th:onclick="|replyDelete(${reply.reply_no}, ${board.boardNo})|">ì‚­ì œ</button>
                    </div>
                </th:block>
                <th:block th:if="${reply.member_no != #authentication.principal.member.memberNo}">
    				<button type="button" class="btn btn-outline-danger btn-sm" title="ì‹ ê³ ">
        				<i class="bi bi-exclamation-triangle-fill"></i>
    				</button>
				</th:block>
            </div>

            <p class="reply-content mt-2 mb-2" th:id="'reply-content-' + ${reply.reply_no}" th:text="${reply.reply_content}"></p>
            
            <!-- ìˆ˜ì • í¼ -->
            <div th:id="'reply-edit-form-' + ${reply.reply_no}" style="display: none;">
                <textarea th:id="'edit-textarea-' + ${reply.reply_no}" class="form-control mb-2" style="resize: none; height: 60px;"></textarea>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-primary btn-sm" th:onclick="|cancelReplyEdit(${reply.reply_no})|">ì·¨ì†Œ</button>
                </div>
            </div>

            <!-- ë‹µê¸€ ë²„íŠ¼ -->
            <div class="mb-2">
                <button type="button" class="btn btn-sm btn-primary" th:onclick="|showReplyForm(${reply.reply_no})|">ëŒ“ê¸€ë‹¬ê¸°</button>
            </div>

            <!-- ëŒ€ëŒ“ê¸€ ì…ë ¥ í¼ -->
            <div th:id="'reply-form-' + ${reply.reply_no}" class="reply-form mb-3" style="display: none;">
                <form th:action="@{/replies/{boardNo}/{parentReplyNo}/create-sub(boardNo=${board.boardNo}, parentReplyNo=${reply.reply_no})}" method="POST" class="d-flex gap-2">
                    <textarea name="reply_content" class="form-control" required style="resize: none; flex-grow: 1; height: 60px;" placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                    <button type="submit" class="btn btn-primary" style="min-width: 80px;">ë“±ë¡</button>
                    <input type="hidden" name="board_no" th:value="${board.boardNo}"/>
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                </form>
            </div>

            <!-- ëŒ€ëŒ“ê¸€ ëª©ë¡ -->
            <div class="sub-reply-list ps-4 border-start" th:if="${reply.subReplies != null and !#lists.isEmpty(reply.subReplies)}">
                <div th:each="subReply : ${reply.subReplies}" class="sub-reply-item py-2">
                    <div class="d-flex align-items-start">
                        <div class="profile-icon rounded-circle bg-secondary text-white d-flex justify-content-center align-items-center me-3" style="width:30px; height:30px; font-size: 16px;">
                            <i class="bi bi-person"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong th:text="${subReply.memberName}">ì‘ì„±ì</strong>
                                    <small class="text-muted ms-2" th:text="${subReply.timeAgo}"></small>
                                </div>
                                <th:block th:if="${subReply.member_no == #authentication.principal.member.memberNo}">
                                    <div class="reply-actions d-flex gap-2">
                                        <button type="button" class="btn btn-primary btn-sm" th:onclick="|replyUpdate(${subReply.reply_no})|">ìˆ˜ì •</button>
                                        <button type="button" class="btn btn-danger btn-sm" th:onclick="|replyDelete(${subReply.reply_no})|">ì‚­ì œ</button>
                                    </div>
                                </th:block>
                               <th:block th:if="${subReply.member_no != #authentication.principal.member.memberNo}">
    								<button type="button" class="btn btn-outline-danger btn-sm" title="ì‹ ê³ ">
        								<i class="bi bi-exclamation-triangle-fill"></i>
    								</button>
								</th:block>
                            </div>
                            <p class="reply-content mt-1 mb-1" th:id="'reply-content-' + ${subReply.reply_no}" th:text="${subReply.reply_content}"></p>

                            <!-- ëŒ€ëŒ“ê¸€ ìˆ˜ì • í¼ -->
                            <div th:id="'reply-edit-form-' + ${subReply.reply_no}" style="display: none;">
                                <textarea th:id="'edit-textarea-' + ${subReply.reply_no}" class="form-control mb-2" style="resize: none; height: 50px;"></textarea>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-primary btn-sm" th:onclick="|cancelReplyEdit(${subReply.reply_no})|">ì·¨ì†Œ</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
 <!-- ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ ë°˜ë³µë¬¸ ëë‚œ í›„ -->
<div class="scroll-to-top-wrapper text-center my-4">
    <i class="bi bi-arrow-bar-up scroll-to-top-icon" style="font-size: 2rem; cursor: pointer;" title="ë§¨ ìœ„ë¡œ ì´ë™"></i>
</div>
            
<!-- ì‚­ì œ JS ë° ëŒ€ëŒ“ê¸€ í¼ í‘œì‹œ JS -->
    <script>
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;
        const csrfToken = document.querySelector('meta[name="_csrf"]').content;

        // ê²Œì‹œê¸€ ì‚­ì œ ê¸°ëŠ¥
        function boardDelete(boardNo) {
        	  if (!confirm("ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        	  fetch('/board/delete/' + boardNo, {
        	    method: 'DELETE',
        	    headers: {
        	      [csrfHeader]: csrfToken,  // ğŸ” CSRF í† í° ì¶”ê°€!
        	      'Content-Type': 'application/json'
        	    }
        	  })
        	  .then(res => res.json())
        	  .then(data => {
        	    if (data.res_code === "200") {
        	      alert(data.res_msg);
        	      location.href = '/board/list';
        	    } else {
        	      alert(data.res_msg);
        	    }
        	  })
        	  .catch(err => {
        	    alert("ì—ëŸ¬ ë°œìƒ: " + err);
        	  });
        	}
        
        
        // ëŒ“ê¸€ ìˆ˜ì • ê¸°ëŠ¥
        function replyUpdate(replyNo) {
            const content = document.getElementById(`reply-content-${replyNo}`);
            const form = document.getElementById(`reply-edit-form-${replyNo}`);
            const textarea = document.getElementById(`edit-textarea-${replyNo}`);

            // textareaê°€ ë³´ì´ë©´, ì €ì¥ ìš”ì²­
            if (form.style.display === 'block') {
                const newContent = textarea.value.trim();
                const csrfToken = document.querySelector('input[name="_csrf"]').value;

                if (!newContent) {
                    alert("ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
                    return;
                }

                fetch(`/replies/${replyNo}/update`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRF-TOKEN": csrfToken
                    },
                    body: JSON.stringify({ reply_content: newContent })
                })
                .then(res => {
                    if (!res.ok) throw new Error("ì‘ë‹µ ì‹¤íŒ¨");
                    return res.json();
                })
                .then(data => {
                    if (data.success) {
                        content.innerText = newContent;
                        form.style.display = 'none';
                        content.style.display = 'block';
                        alert("ëŒ“ê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    } else {
                        alert("ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                    }
                })
                .catch(err => {
                    console.error("ìˆ˜ì • ì‹¤íŒ¨:", err);
                    alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                });

            } else {
                // textarea ì—´ê¸°
                textarea.value = content.innerText.trim();
                content.style.display = 'none';
                form.style.display = 'block';
            }
        }
        // ëŒ“ê¸€ ì·¨ì†Œ ê¸°ëŠ¥
        function cancelReplyEdit(replyNo) {
            // ìˆ˜ì • í¼ì„ ìˆ¨ê¹ë‹ˆë‹¤.
            document.getElementById(`reply-edit-form-${replyNo}`).style.display = 'none';
            // ì›ë˜ ëŒ“ê¸€ ë‚´ìš©ì„ ë‹¤ì‹œ ë³´ì´ë„ë¡ í•©ë‹ˆë‹¤.
            document.getElementById(`reply-content-${replyNo}`).style.display = 'block';
        }
        
          
       // ëŒ“ê¸€ ì‚­ì œ ê¸°ëŠ¥
         function replyDelete(replyNo) {
  			if (!confirm("ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
  			fetch(`/replies/${replyNo}/delete`, {
    			method: 'POST',
    			headers: {
      		[csrfHeader]: csrfToken,  // CSRF í† í° ì¶”ê°€
      		'Content-Type': 'application/json'
    		}
  		})
  		.then(res => res.json())
  		.then(data => {
    		if (data.res_code === "200") {
      			alert(data.res_msg);  // ëŒ“ê¸€ ì‚­ì œ ì„±ê³µ ë©”ì‹œì§€
      			location.reload();  // í˜ì´ì§€ ìƒˆë¡œ ê³ ì¹¨ (ëŒ“ê¸€ ëª©ë¡ ê°±ì‹ )
    	} else {
      			alert(data.res_msg);  // ëŒ“ê¸€ ì‚­ì œ ì‹¤íŒ¨ ë©”ì‹œì§€
    	}
  	})
  		.catch(err => {
    		alert("ì—ëŸ¬ ë°œìƒ: " + err);  // ì—ëŸ¬ ì²˜ë¦¬
  		});
	}

    const showEditReplyForm = (replyNo) => {
        const replyForm = document.getElementById(`edit-reply-form-${replyNo}`);
        if (replyForm !== null) {
            // ìˆ˜ì • í¼ì„ ë³´ì´ê±°ë‚˜ ìˆ¨ê¸°ê¸°
            replyForm.style.display = (replyForm.style.display === 'none' || replyForm.style.display === '') ? 'block' : 'none';
        }
    };

    const showReplyForm = (replyNo) => {
        const replyForm = document.getElementById(`reply-form-${replyNo}`);
        if (replyForm) {
            replyForm.style.display = replyForm.style.display === 'none' ? 'block' : 'none';
        }
    };
    
    let page = 1;
    const loadMoreComments = () => {
        // ì—¬ê¸°ì„œ ì¶”ê°€ ëŒ“ê¸€ì„ ë¡œë“œí•˜ëŠ” APIë¥¼ í˜¸ì¶œí•˜ì„¸ìš”.
        page++;
        fetch(`/comments?page=${page}`)
            .then(response => response.json())
            .then(data => {
                // ë¡œë“œëœ ëŒ“ê¸€ ë°ì´í„°ë¥¼ í™”ë©´ì— ì¶”ê°€
                const commentContainer = document.getElementById('comment-container');
                data.comments.forEach(comment => {
                    const commentElement = document.createElement('div');
                    commentElement.classList.add('reply-item');
                    commentElement.innerHTML = `
                        <p>${comment.content}</p>
                        <p>ì‘ì„±ì: ${comment.memberName}</p>
                    `;
                    commentContainer.appendChild(commentElement);
                });
            });
    };

    const observer = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                loadMoreComments();
            }
        });
    }, {
        rootMargin: '100px',
    });

    observer.observe(document.querySelector('#load-more-trigger'));
    
    
 	// ìœ„ë¡œ ê°€ëŠ” ë²„íŠ¼ ì œì–´
    document.addEventListener('DOMContentLoaded', function () {
    const scrollToTopIcon = document.querySelector('.scroll-to-top-icon');

    scrollToTopIcon.addEventListener('click', function () {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'  // ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ íš¨ê³¼
        });
    });
});
    </script>

	
        <!-- Start Editor JS -->
        <script src="https://cdn.jsdelivr.net/npm/start-editor@1.0.0/start-editor.min.js"></script>

        <!-- JavaScript íŒŒì¼ ë¡œë”© -->
        <script th:src="@{/assets/js/vendor.min.js}"></script>
        <script th:src="@{/assets/libs/bootstrap/dist/js/bootstrap.bundle.min.js}"></script>
        <script th:src="@{/assets/libs/simplebar/dist/simplebar.min.js}"></script>
        <script th:src="@{/assets/js/theme/app.init.js}"></script>
        <script th:src="@{/assets/js/theme/theme.js}"></script>
        <script th:src="@{/assets/js/theme/app.min.js}"></script>
        <script th:src="@{/assets/js/theme/sidebarmenu.js}"></script>

        <!-- solar icons -->
        <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>
        <script th:src="@{/assets/libs/owl.carousel/dist/owl.carousel.min.js}"></script>
        <script th:src="@{/assets/libs/apexcharts/dist/apexcharts.min.js}"></script>
        <script th:src="@{/assets/js/dashboards/dashboard.js}"></script>

    </th:block>
</html>