<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/include/layout}">

<head layout:fragment="head">
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />

    <!-- Start Editor CSS -->
    <link href="https://cdn.jsdelivr.net/npm/start-editor@1.0.0/start-editor.min.css" rel="stylesheet">

    <style>
        #start-editor img {
            max-width: 50%;
            height: auto;
            display: block;
            margin: 0 auto;
        }

        .file-link {
            display: inline-block;
            color: #007bff;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }

        .file-link:hover {
            color: #000;
            text-decoration: underline;
        }

        .file-preview img {
            margin-top: 10px;
            max-width: 200px;
            height: auto;
            display: block;
        }

		.reply-list {
   			 margin-left: 20px; /* 대댓글 들여쓰기 */
    		 border-left: 2px solid #eee; /* 경계선 */
    		 padding-left: 15px; /* 패딩 추가 */
		}

        .reply-item {
            margin-top: 15px;
        }

        .reply-form {
            display: none;
            margin-top: 10px;
            padding-left: 20px;
            border-left: 2px solid #ddd;
        }

        .reply-content {
            margin-top: 5px;
        }
    </style>
</head>

<th:block layout:fragment="content">

    <!-- 페이지 제목 -->
    <div class="col-lg-8 col-md-6 col-12 align-self-center">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb align-items-center">
                <li class="breadcrumb-item">
                    <a class="text-muted text-decoration-none" th:href="@{/home}">
                        <i class="ti ti-home fs-5"></i>
                    </a>
                </li>
                <li class="breadcrumb-item">자유게시판 상세/댓글</li>
            </ol>
        </nav>
        <h2 class="mb-0 fw-bolder fs-8">자유게시판 상세</h2>
    </div>

    <div class="mt-5"></div>

    <!-- 본문 카드 -->
    <div class="p-5 bg-white rounded-4 shadow-sm mb-5">
        <h2 class="text-center mb-4"
            th:text="${board.boardTitle ?: '제목 없음'}"
            style="font-size: 2rem; font-weight: 900;"></h2>

        <div class="mb-4 text-end text-muted small" style="font-size: 1.1rem;">
            <i class="ti ti-eye"></i>
            <span th:text="${board.views}">0</span> |
            <span th:text="${#temporals.format(board.regDate, 'yyyy-MM-dd HH:mm')}">등록일</span><br>
            <div>작성자: <span th:text="${board.member?.memberName ?: '익명'}"></span></div>
        </div>

        <hr>

        <!-- 본문 내용 -->
        <div id="start-editor" class="form-control"
             style="background-color: white; min-height: 300px; font-size: 1.1rem; line-height: 1.8rem; border: 1px solid #ced4da; border-radius: 0.375rem;"
             th:utext="${board.boardContent ?: '내용 없음'}">
        </div>

        <hr>

        <!-- 첨부파일 -->
        <div th:if="${!#lists.isEmpty(attachList)}"
             th:each="boardAttach : ${attachList}">
            <a th:onclick="|location.href='@{/download/{id}(id=${boardAttach.attachNo})}'|"
               th:text="${boardAttach.oriName}"
               class="file-link"
               th:data-url="@{/upload/path/{filename}(filename=${boardAttach.oriName})}">파일명</a>

            <div class="file-preview">
                <img th:src="@{/upload/path/{filename}(filename=${boardAttach.oriName})}" alt="파일 미리보기"/>
            </div>
        </div>

        <hr>

        <!-- 수정/삭제 버튼 -->
        <th:block sec:authorize="isAuthenticated()">
            <div th:if="${#authentication.principal.member.memberNo == board.member.memberNo}" class="text-end">
                <a class="btn btn-primary" th:href="@{/board/{id}/update(id=${board.boardNo})}">수정</a>
                <a class="btn btn-danger" href="#" th:onclick="|boardDelete(${board.boardNo})|">삭제</a>
            </div>
        </th:block>
    </div>
    
    
   <!-- 댓글 작성 영역 -->
<div class="p-4 bg-white rounded-4 shadow-sm mb-4">
    <label class="fw-bold fs-5 mb-3 d-block">💬 댓글 달기</label>
    <th:block sec:authorize="isAuthenticated()">
        <form th:action="@{/replies/{boardNo}/create(boardNo=${board.boardNo})}" method="POST"
              style="display: flex; gap: 10px; align-items: stretch;">
            <textarea name="reply_content" placeholder="댓글을 입력하세요" required
                      style="resize: none; flex-grow: 1; height: 60px;" class="form-control"></textarea>
            <button type="submit" class="btn btn-primary" style="height: 60px; min-width: 80px; padding: 6px 16px;">등록</button>
            <input type="hidden" name="board_no" th:value="${board.boardNo}">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        </form>
    </th:block>
    <th:block sec:authorize="isAnonymous()">
        <p>로그인 후 댓글을 작성할 수 있습니다.</p>
    </th:block>
</div>
<!-- 댓글 리스트 출력 영역 -->
<div id="reply_list">
    <div th:each="reply : ${replyList}" class="reply-item" style="margin-bottom:15px;">
        <div class="reply-content">
            <span th:text="${reply.memberName}"></span> :
            <span th:text="${reply.reply_content}"></span>
        </div>

        <!-- 대댓글 달기 버튼 -->
        <button type="button" class="btn btn-link" th:onclick="|showReplyForm(${reply.reply_no})|">대댓글 달기</button>

        <!-- 대댓글 입력 폼 -->
        <div class="reply-form" th:id="'reply-form-' + ${reply.reply_no}" style="display:none; margin-top:10px;">
            <form th:action="@{/replies/{parentReplyNo}/createSubReply(parentReplyNo=${reply.reply_no})}" method="POST"
                  style="display: flex; gap: 10px; align-items: stretch;">
                <textarea name="reply_content" placeholder="대댓글을 입력하세요" required
                          class="form-control" style="resize: none; flex-grow: 1; height: 60px;"></textarea>
                <button type="submit" class="btn btn-primary" style="height: 60px; min-width: 80px;">등록</button>
                <input type="hidden" name="board_no" th:value="${board.boardNo}">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            </form>
        </div>

        <!-- 대댓글 리스트 -->
        <div class="reply-list">
            <div th:each="subReply : ${reply.subReplies}" class="sub-reply-item" style="margin-bottom:10px;">
                <div class="reply-content">
                    <span th:text="${subReply.memberName}"></span> :
                    <span th:text="${subReply.reply_content}"></span>
                </div>
            </div>
        </div>
    </div>
</div>
    <!-- 삭제 JS -->
    <script>
        const boardNo = /*[[${board.boardNo}]]*/ null;
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;
        const csrfToken = document.querySelector('meta[name="_csrf"]').content;

        const boardDelete = (boardNo) => {
            if (!confirm("게시글을 삭제하시겠습니까?")) return;

            fetch(`/board/delete/${boardNo}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [csrfHeader]: csrfToken
                }
            })
            .then(res => res.json())
            .then(data => {
                alert(data.res_msg);
                if (data.res_code === '200') {
                    location.href = '/board/list';
                }
            });
        };

        function showReplyForm(replyNo) {
            const form = document.getElementById('reply-form-' + replyNo);
            form.style.display = (form.style.display === 'none' || form.style.display === '') ? 'block' : 'none';
        }
    </script>
	
        <!-- Start Editor JS -->
        <script src="https://cdn.jsdelivr.net/npm/start-editor@1.0.0/start-editor.min.js"></script>

        <!-- Import vendorJs Files -->
        <script th:src="@{/assets/js/vendor.min.js}"></script>

        <!-- JavaScript 파일 로딩 -->
        <script th:src="@{/assets/js/vendor.min.js}"></script>
        <script th:src="@{/assets/libs/bootstrap/dist/js/bootstrap.bundle.min.js}"></script>
        <script th:src="@{/assets/libs/simplebar/dist/simplebar.min.js}"></script>
        <script th:src="@{/assets/js/theme/app.init.js}"></script>
        <script th:src="@{/assets/js/theme/theme.js}"></script>
        <script th:src="@{/assets/js/theme/app.min.js}"></script>
        <script th:src="@{/assets/js/theme/sidebarmenu.js}"></script>

        <!-- solar icons -->
        <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>
        <script th:src="@{/assets/libs/owl.carousel/dist/owl.carousel.min.js}"></script>
        <script th:src="@{/assets/libs/apexcharts/dist/apexcharts.min.js}"></script>
        <script th:src="@{/assets/js/dashboards/dashboard.js}"></script>

    </th:block>
</html>