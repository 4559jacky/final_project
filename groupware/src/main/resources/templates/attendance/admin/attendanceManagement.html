<!DOCTYPE html>
<html
xmlns:th="http://www.thymeleaf.org"
xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
layout:decorate="~{include/layout :: layout}">
<th:block layout:fragment="content">
<style>
  #member-tbody tr {
    cursor: pointer; /* ì»¤ì„œ í¬ì¸í„° ì„¤ì • */
    transition: background 0.2s ease-in-out;
  }

  #member-tbody tr:hover {
    background-color: #f1f3f5; /* ì‚´ì§ í•˜ì´ë¼ì´íŠ¸ íš¨ê³¼ */
  }
</style>
	
	<script th:src="@{/js/jquery-3.7.1.js}"></script>
	
	<link th:href="@{/css/cjs/member_list.css}" rel="stylesheet">
	
	<div class="page-titles mb-7 mb-md-5">
	  <div class="row">
	    <div class="col-12">
	      <nav aria-label="breadcrumb">
	        <ol class="breadcrumb align-items-center">
	          <li class="breadcrumb-item">
	            <a class="text-muted text-decoration-none" th:href="@{/home}">
	              <i class="ti ti-home fs-5"></i>
	            </a>
	          </li>
	          <li class="breadcrumb-item" aria-current="page">ê·¼íƒœ / ê·¼íƒœ ê´€ë¦¬</li>
	        </ol>
	      </nav>
	
	      <div class="d-flex justify-content-between align-items-center mt-3">
	        <h2 class="mb-0 fw-bolder fs-8">ê·¼íƒœ ê´€ë¦¬</h2>
	        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#workPolicyModal">
			  ê·¼íƒœ ì •ì±… ì„¤ì •
			</button>
	      </div>
	    </div>
	  </div>
	</div>
	
	<!-- ğŸ’¥ ì‚¬ì› ê·¼íƒœ ê´€ë¦¬ ê°ì‹¸ë˜ div ì œê±°ë¨ -->

	<!-- ğŸ“Œ ë°”ë¡œ ì´ divë¶€í„° ì‹œì‘ -->
	<div class="card w-100 border position-relative overflow-hidden">
	  <div class="card-body p-4">
	    <form name="attendance_members_form" action="/attendance/management" method="get">
	
	      <!-- ğŸ” ê²€ìƒ‰ + ë‚ ì§œ -->
	      <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
	        
	        <!-- ğŸ” ê²€ìƒ‰ -->
	        <div class="d-flex align-items-center me-3 mb-2" style="max-width: 400px;">
	          <h4 class="card-title fw-bold mb-0 me-3" style="min-width: 100px;">ì‚¬ì› ëª©ë¡</h4>
	          <div class="input-group input-group-sm w-100">
	            <input type="text" id="search_text" name="search_text"
	              th:value="${searchDto.search_text}" class="form-control" placeholder="ì‚¬ì›ëª…(ì‚¬ë²ˆ) ê²€ìƒ‰" />
	            <button class="btn btn-primary" id="searchBtn">ê²€ìƒ‰</button>
	            <button class="btn btn-secondary" id="resetBtn" type="button">ì´ˆê¸°í™”</button>
	          </div>
	        </div>
	
	        <!-- ğŸ“… ë‚ ì§œ -->
	        <div style="max-width: 200px;">
	          <input type="date" id="target_date" name="target_date" th:value="${targetDate}" class="form-control form-control-sm">
	        </div>
	      </div>
	
	      <!-- ğŸ“‹ í…Œì´ë¸” -->
	      <div class="table-responsive mb-4 border rounded-1">
	        <table class="table text-nowrap mb-0 align-middle">
	          <thead class="text-dark fs-4">
	            <tr>
	              <th><h6 class="fs-4 fw-semibold mb-0">ì‚¬ì›ëª…(ì‚¬ë²ˆ)</h6></th>
	              <th><h6 class="fs-4 fw-semibold mb-0">ë‚ ì§œ</h6></th>
	              <th><h6 class="fs-4 fw-semibold mb-0">ì¶œê·¼ ì‹œê°„</h6></th>
	              <th><h6 class="fs-4 fw-semibold mb-0">í‡´ê·¼ ì‹œê°„</h6></th>
	              <th><h6 class="fs-4 fw-semibold mb-0">ì¶œê·¼ ìƒíƒœ</h6></th>
	              <th><h6 class="fs-4 fw-semibold mb-0">í‡´ê·¼ ìƒíƒœ</h6></th>
	            </tr>
	          </thead>
	          <tbody id="member-tbody">
	            <tr th:each="dto : ${memberAttendanceList}">
	              <td>
	                <div class="d-flex align-items-center">
	                  <div class="ms-3">
	                    <h6 class="fs-4 fw-semibold mb-0 member-name" th:text="${dto.member.memberName}">ì‚¬ì›ëª…</h6>
	                    <span class="fw-normal" th:text="|#${dto.member.memberNo}|">#ì‚¬ë²ˆ</span>
	                  </div>
	                </div>
	                <input type="hidden" id="memberNo" th:value="${dto.member.memberNo}">
	              </td>
	              <td class="text-center"><h6 class="fs-4 fw-semibold mb-0" th:text="${dto.attendDate != null ? #temporals.format(dto.attendDate, 'yyyy.MM.dd') : '-'}"></h6></td>
	              <td class="text-center"><h6 class="fs-4 fw-semibold mb-0" th:text="${dto.startTime != null ? dto.startTime : '-'}"></h6></td>
	              <td class="text-center"><h6 class="fs-4 fw-semibold mb-0" th:text="${dto.endTime != null ? dto.endTime : '-'}"></h6></td>
	              <td class="text-center"><h6 class="fs-4 fw-semibold mb-0" th:text="${dto.lateYn == 'Y' ? 'ì§€ê°' : (dto.lateYn == null ? '-' : 'ì •ìƒ')}"></h6></td>
	              <td class="text-center"><h6 class="fs-4 fw-semibold mb-0" th:text="${dto.earlyLeaveYn == 'Y' ? 'ì¡°í‡´' : (dto.earlyLeaveYn == null ? '-' : 'ì •ìƒ')}"></h6></td>
	            </tr>
	          </tbody>
	        </table>
	      </div>
	
	      <!-- ğŸ“Œ í˜ì´ì§• -->
	      <div class="d-flex justify-content-center align-items-center mt-3 position-relative">
	        <nav>
	          <ul class="pagination mb-0">
	            <li class="page-item" th:classappend="${!pageDto.prev} ? 'd-none'">
	              <a class="page-link"
	                th:href="${pageDto.prev} ? @{/attendance/management(nowPage=${pageDto.pageBarStart-1}, search_text=${searchDto.search_text}, target_date=${searchDto.target_date})} : '#'"
	                aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>
	            </li>
	
	            <th:block th:each="num : ${#numbers.sequence(pageDto.pageBarStart, pageDto.pageBarEnd)}">
	              <li class="page-item" th:classappend="${pageDto.nowPage == num} ? 'active'">
	                <a class="page-link"
	                  th:classappend="${pageDto.nowPage == num} ? ' text-bg-primary border-primary text-white'"
	                  th:href="@{/attendance/management(nowPage=${num}, search_text=${searchDto.search_text}, target_date=${searchDto.target_date})}"
	                  th:text="${num}">í˜ì´ì§€</a>
	              </li>
	            </th:block>
	
	            <li class="page-item" th:classappend="${!pageDto.next} ? 'd-none'">
	              <a class="page-link"
	                th:href="${pageDto.next} ? @{/attendance/management(nowPage=${pageDto.pageBarEnd+1}, search_text=${searchDto.search_text}, target_date=${searchDto.target_date})} : '#'"
	                aria-label="Next"><span aria-hidden="true">&raquo;</span></a>
	            </li>
	          </ul>
	        </nav>
	      </div>
	
	    </form>
	  </div>
	</div>

	
	<script>
		document.addEventListener('DOMContentLoaded', function () {
			  const dateInput = document.getElementById("target_date");
	
			  dateInput.addEventListener("change", function () {
			    const searchText = document.getElementById('search_text').value;
			    const targetDate = this.value;
	
	
			    // ğŸ”„ GET ìš”ì²­
			    location.href = '/attendance/management?search_text='+searchText+'&target_date='+targetDate;
			});
		});
	</script>
	
	<!-- ëª¨ë‹¬ì°½ -->
	<div class="modal fade" id="workPolicyModal" tabindex="-1" aria-hidden="true">
	  <div class="modal-dialog modal-dialog-centered modal-lg"> <!-- ë„ˆë¹„ ë„‰ë„‰í•˜ê²Œ -->
	    <div class="modal-content">
	      <div class="modal-header">
	        <h5 class="modal-title fw-bold">ê·¼íƒœ ì •ì±… ì„¤ì •</h5>
	        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
	      </div>
	      
	      <div class="modal-body">
	        <form name="work_time_form" action="/attendance/manage" method="post">
	          <input type="hidden" value="1" name="work_schedule_policy_no">
	
	          <div class="row g-4 align-items-start">
	            <!-- ì¶œê·¼ ì‹œê°„ ë²”ìœ„ -->
	            <div class="col-md-6">
	              <label class="form-label fw-semibold">ì¶œê·¼ ê°€ëŠ¥ ì‹œê°„ ë²”ìœ„ (ìœ ì—° ê·¼ë¬´ì œ)</label>
	              <div class="row g-2 align-items-center mb-2">
	                <div class="col-auto">
	                  <input type="time" name="start_time_min" id="start_time_min" class="form-control"
	                    th:value="${workSchedulePolicy.startTimeMin}">
	                </div>
	                <div class="col-auto">~</div>
	                <div class="col-auto">
	                  <input type="time" name="start_time_max" id="start_time_max" class="form-control"
	                    th:value="${workSchedulePolicy.startTimeMax}">
	                </div>
	              </div>
	              <small class="text-muted">ìœ ì—° ê·¼ë¬´ì œë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©´ ë™ì¼í•œ ì‹œê°„ìœ¼ë¡œ ì„¤ì •í•˜ì„¸ìš”.</small>
	            </div>
	
	            <!-- ê·¼ë¬´ ì‹œê°„ ì„¤ì • -->
	            <div class="col-md-6">
	              <div class="mb-3">
	                <label for="work_duration" class="form-label fw-semibold mb-1">í•˜ë£¨ ìµœì†Œ ê·¼ë¬´ì‹œê°„</label>
	                <div class="input-group">
	                  <input type="number" step="0.5" name="work_duration" id="work_duration" class="form-control"
	                    placeholder="ì˜ˆ: 8.5" th:value="${workSchedulePolicy.workDuration}">
	                  <span class="input-group-text">ì‹œê°„</span>
	                </div>
	                <small class="text-muted">ìµœì†Œ ê·¼ë¬´ì‹œê°„ì€ íœ´ê²Œì‹œê°„ 1ì‹œê°„ì´ í¬í•¨ë©ë‹ˆë‹¤.<br>ì‹¤ì œ ê·¼ë¬´ì‹œê°„ : ìµœì†Œ ê·¼ë¬´ì‹œê°„ - 1h</small>
	              </div>
	
	              <div class="mb-3">
	                <label for="week_work_min_time" class="form-label fw-semibold mb-1">ì£¼ ìµœì†Œ ê·¼ë¬´ì‹œê°„</label>
	                <div class="input-group">
	                  <input type="number" step="0.5" name="week_work_min_time" id="week_work_min_time"
	                    class="form-control" placeholder="ì˜ˆ: 40" th:value="${workSchedulePolicy.weekWorkMinTime}">
	                  <span class="input-group-text">ì‹œê°„</span>
	                </div>
	              </div>
	
	              <div>
	                <label for="week_work_max_time" class="form-label fw-semibold mb-1">ì£¼ ìµœëŒ€ ê·¼ë¬´ì‹œê°„</label>
	                <div class="input-group">
	                  <input type="number" step="0.5" name="week_work_max_time" id="week_work_max_time"
	                    class="form-control" placeholder="ì˜ˆ: 52" th:value="${workSchedulePolicy.weekWorkMaxTime}">
	                  <span class="input-group-text">ì‹œê°„</span>
	                </div>
	              </div>
	            </div>
	          </div>
	
	          <div class="mt-4 text-end">
	            <button type="submit" class="btn btn-primary">ì €ì¥</button>
	            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
	          </div>
	        </form>
	      </div>
	
	    </div>
	  </div>
	</div>

	<script>
		workTimeForm = document.work_time_form;
		workTimeForm.addEventListener('submit', function(e){
			e.preventDefault();
			
			const start_time_min = document.getElementById('start_time_min').value;
		    const start_time_max = document.getElementById('start_time_max').value;
		    const work_duration = parseFloat(document.getElementById('work_duration').value);
		    const week_work_min_time = parseFloat(document.getElementById('week_work_min_time').value);
		    const week_work_max_time = parseFloat(document.getElementById('week_work_max_time').value);
			
		    if (!start_time_min || !start_time_max) {
		        alert("ì¶œê·¼ ê°€ëŠ¥ ì‹œê°„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
		        return;
		    }
		    
		    if (isNaN(work_duration) || isNaN(week_work_min_time) || isNaN(week_work_max_time)) {
		        alert("ê·¼ë¬´ì‹œê°„ì„ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.");
		        return;
		    }
		    
		    const payload = new FormData(workTimeForm);
		    const csrfToken = document.querySelector('meta[name="_csrf"]').content;
			const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;
		    
		    fetch('/attendance/manage', {
		    	method:'post',
		    	headers: {
					[csrfHeader]: csrfToken
				},
		    	body: payload,
		    })
		    .then(response => response.json())
			.then(data => {
				alert(data.res_msg);
				if(data.res_code =='200') {
					document.getElementById('start_time_min').value = data.workPolicy.startTimeMin;
					document.getElementById('start_time_max').value = data.workPolicy.startTimeMax;
					document.getElementById('work_duration').value = data.workPolicy.workDuration;
					document.getElementById('week_work_min_time').value = data.workPolicy.weekWorkMinTime;
					document.getElementById('week_work_max_time').value = data.workPolicy.weekWorkMaxTime;
				}
			})
		});
	</script>
	
	<!-- ê·¼ë¬´ ìƒíƒœ ìˆ˜ì • ëª¨ë‹¬ -->
	<div class="modal fade" id="memberattendanceStatusUpdate" tabindex="-1" aria-hidden="true">
	  <div class="modal-dialog modal-dialog-centered" style="max-width: 500px;">
	    <div class="modal-content">
	      <div class="modal-header">
	        <h5 class="modal-title fw-bold">ê·¼ë¬´ ìƒíƒœ ìˆ˜ì •</h5>
	        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
	      </div>
	
	      <div class="modal-body text-start">
			  <p><strong id="modalMemberName">ì‚¬ì›ëª… (#ì‚¬ë²ˆ)</strong></p>
			
			  <div class="mb-3">
			    <label for="attendDate" class="form-label fw-semibold">ë‚ ì§œ</label>
			    <input type="text" class="form-control" id="attendDate" readonly>
			  </div>
			
			  <!-- âœ… ì¶œê·¼/í‡´ê·¼ ì‹œê°„ í•œ ì¤„ -->
			  <div class="row">
			    <div class="col-md-6 mb-3">
			      <label for="editStartTime" class="form-label fw-semibold">ì¶œê·¼ ì‹œê°„</label>
			      <input type="time" class="form-control" id="editStartTime">
			    </div>
			    <div class="col-md-6 mb-3">
			      <label for="editEndTime" class="form-label fw-semibold">í‡´ê·¼ ì‹œê°„</label>
			      <input type="time" class="form-control" id="editEndTime">
			    </div>
			  </div>
			
			  <!-- âœ… ì¶œê·¼/í‡´ê·¼ ìƒíƒœ í•œ ì¤„ -->
			  <div class="row">
			    <div class="col-md-6 mb-3">
			      <label for="editLateYn" class="form-label fw-semibold">ì¶œê·¼ ìƒíƒœ</label>
			      <select class="form-select" id="editLateYn">
			        <option value="N">ì •ìƒ</option>
			        <option value="Y">ì§€ê°</option>
			      </select>
			    </div>
			    <div class="col-md-6 mb-3">
			      <label for="editEarlyLeaveYn" class="form-label fw-semibold">í‡´ê·¼ ìƒíƒœ</label>
			      <select class="form-select" id="editEarlyLeaveYn">
			        <option value="N">ì •ìƒ</option>
			        <option value="Y">ì¡°í‡´</option>
			      </select>
			    </div>
			  </div>
			</div>
	
	      <div class="modal-footer">
	        <button type="button" class="btn btn-primary" onclick="saveAttendanceUpdate()">ì €ì¥</button>
	        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
	      </div>
	    </div>
	  </div>
	</div>
	
	<script>
	  let selectedMemberNo = null;
	
	  document.querySelectorAll('#member-tbody tr').forEach(tr => {
	    tr.addEventListener('click', () => {
	      const name = tr.querySelector('.member-name')?.textContent.trim();
	      const memberNo = tr.querySelector('input#memberNo')?.value;
	      const attendDate = tr.querySelectorAll('td')[1]?.textContent.trim();
	      const startTime = tr.querySelectorAll('td')[2]?.textContent.trim();
	      const endTime = tr.querySelectorAll('td')[3]?.textContent.trim();
	      const lateStatus = tr.querySelectorAll('td')[4]?.textContent.trim();
	      const earlyLeaveStatus = tr.querySelectorAll('td')[5]?.textContent.trim();
	
	      if (!memberNo || !name) return;
	
	      // ê°’ ì„¸íŒ…
	      document.getElementById('attendDate').value = attendDate;
	      document.getElementById('modalMemberName').textContent = `${name} (#${memberNo})`;
	      document.getElementById('editStartTime').value = startTime !== '-' ? startTime : '';
	      document.getElementById('editEndTime').value = endTime !== '-' ? endTime : '';
	      document.getElementById('editLateYn').value = (lateStatus === 'ì§€ê°') ? 'Y' : 'N';
	      document.getElementById('editEarlyLeaveYn').value = (earlyLeaveStatus === 'ì¡°í‡´') ? 'Y' : 'N';
	
	      selectedMemberNo = memberNo;
	
	      const modalEl = document.getElementById('memberattendanceStatusUpdate');
	      const modal = new bootstrap.Modal(modalEl);
	      modal.show();
	    });
	  });
	
	  function saveAttendanceUpdate() {
	    const start = document.getElementById('editStartTime').value;
	    const end = document.getElementById('editEndTime').value;
	    const lateYn = document.getElementById('editLateYn').value;
	    const earlyYn = document.getElementById('editEarlyLeaveYn').value;
	
	    const formData = new FormData();
	    formData.append("startTime", start);
	    formData.append("endTime", end);
	    formData.append("lateYn", lateYn);
	    formData.append("earlyLeaveYn", earlyYn);
	
	    const csrfToken = document.querySelector('meta[name="_csrf"]').content;
	    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;
	
	    if (!selectedMemberNo) return;
	
	    fetch(`/attendance/update/${selectedMemberNo}`, {
	      method: 'POST',
	      headers: {
	        [csrfHeader]: csrfToken
	      },
	      body: formData
	    })
	    .then(res => res.json())
	    .then(data => {
	      alert(data.res_msg || "ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
	      if (data.res_code == 200) {
	        location.reload();
	      }
	    })
	    .catch(err => console.error("ì—ëŸ¬:", err));
	  }
	</script>
	

	<script>
		// ì´ˆê¸°í™” ë²„íŠ¼ì„ ëˆŒëŸ¬ì„œ ê²€ìƒ‰ì„ ë¬´íš¨í™”ì‹œí‚¤ëŠ” ë¡œì§ 
		document.getElementById("resetBtn").addEventListener("click", function () {
		  location.href = '/attendance/management';
		});
	</script>
	
	<!-- Bootstrap Common JS Files Start -->
	
	<!-- Import vendorJs Files -->
	<script th:src="@{/assets/js/vendor.min.js}"></script>
	
  	<!-- Import Js Files -->
  	<script th:src="@{/assets/libs/bootstrap/dist/js/bootstrap.bundle.min.js}"></script>
  	<script th:src="@{/assets/libs/simplebar/dist/simplebar.min.js}"></script>
  	<script th:src="@{/assets/js/theme/app.init.js}"></script>
  	<script th:src="@{/assets/js/theme/theme.js}"></script>
  	<script th:src="@{/assets/js/theme/app.min.js}"></script>
  	<script th:src="@{/assets/js/theme/sidebarmenu.js}"></script>
	
  	<!-- solar icons -->
  	<script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>
  	<script th:src="@{/assets/libs/owl.carousel/dist/owl.carousel.min.js}"></script>
  	<script th:src="@{/assets/libs/apexcharts/dist/apexcharts.min.js}"></script>
  	<script th:src="@{/assets/js/dashboards/dashboard.js}"></script>
  	
  	<!-- Bootstrap Common JS Files End -->
  	
  	<!-- jsTree -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>
	<script th:src="@{/js/cjs/jstree.js}"></script>

</th:block>
</html>