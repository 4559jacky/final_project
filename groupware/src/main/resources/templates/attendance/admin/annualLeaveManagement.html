<!DOCTYPE html>
<html
xmlns:th="http://www.thymeleaf.org"
xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
layout:decorate="~{include/layout :: layout}">
<th:block layout:fragment="content">
<style>
  #member-tbody tr {
    cursor: pointer; /* ì»¤ì„œ í¬ì¸í„° ì„¤ì • */
    transition: background 0.2s ease-in-out;
  }

  #member-tbody tr:hover {
    background-color: #f1f3f5; /* ì‚´ì§ í•˜ì´ë¼ì´íŠ¸ íš¨ê³¼ */
  }
</style>
	
	<script th:src="@{/js/jquery-3.7.1.js}"></script>
	
	<link th:href="@{/css/cjs/member_list.css}" rel="stylesheet">
	
	<div class="page-titles mb-7 mb-md-5">
	  <div class="row">
	    <div class="col-12">
	      <nav aria-label="breadcrumb">
	        <ol class="breadcrumb align-items-center">
	          <li class="breadcrumb-item">
	            <a class="text-muted text-decoration-none" th:href="@{/home}">
	              <i class="ti ti-home fs-5"></i>
	            </a>
	          </li>
	          <li class="breadcrumb-item" aria-current="page">ê·¼íƒœ / ì—°ì°¨ ê´€ë¦¬</li>
	        </ol>
	      </nav>
	
	      <div class="d-flex justify-content-between align-items-center mt-3">
			  <h2 class="mb-0 fw-bolder fs-5">ì—°ì°¨ ê´€ë¦¬</h2>
			
			  <div class="d-flex gap-2">
			    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#holidayPolicyModal">
			      íœ´ì¼ ì •ì±… ë³´ê¸°
			    </button>
			    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#annualPolicyModal">
			      ì—°ì°¨ ì •ì±… ë³´ê¸°
			    </button>
			  </div>
			</div>
	    </div>
	  </div>
	</div>


	<div class="card w-100 border position-relative overflow-hidden">
   		<div class="card-body p-4">
   			<form name="attendance_members_form" action="/annual/management" method="get">
   				<div class="d-flex justify-content-between align-items-center mb-3">
		  
				  <div class="d-flex align-items-center">
				    <h4 class="card-title fw-bold mb-0 me-3" style="min-width: 100px;">ì‚¬ì› ëª©ë¡</h4>
					
				    <div class="input-group">
				      <th:block th:if="${searchDto.search_text != null}">
					  	<input type="text" id="search_text" name="search_text" th:value="${searchDto.search_text}" class="form-control form-control-sm" placeholder="ì‚¬ì›ëª…(ì‚¬ë²ˆ) ê²€ìƒ‰" />
				      </th:block>
				      <th:block th:if="${searchDto.search_text == null}">
				      	<input type="text" id="search_text" name="search_text" class="form-control form-control-sm" placeholder="ì‚¬ì›ëª…(ì‚¬ë²ˆ) ê²€ìƒ‰" />
				      </th:block>
				      <button class="btn btn-primary btn-sm" id="searchBtn">ê²€ìƒ‰</button>
				      <button class="btn btn-secondary btn-sm" id="resetBtn" type="button">ì´ˆê¸°í™”</button>
				    </div>
				  </div>
				  
				  <div style="max-width: 200px;">
					  <select name="reg_date_order" id="reg_date_order" class="form-select form-select-sm" style="width: 100%;">
					    <option th:value="1" th:selected="${searchDto.reg_date_order == 1}">ì…ì‚¬ì¼ ë¹ ë¥¸ ìˆœ</option>
					    <option th:value="2" th:selected="${searchDto.reg_date_order == 2}">ì…ì‚¬ì¼ ëŠ¦ì€ ìˆœ</option>
					  </select>
					</div>
				
				</div>
				<input type="hidden" th:value="${today}" id="today">
				<div class="table-responsive mb-4 border rounded-1">
		               <table class="table text-nowrap mb-0 align-middle">
		                 <thead class="text-dark fs-4">
		                   <tr>
		                     <!-- <th>
		                       <h6 class="fs-4 fw-semibold mb-0">ì„ íƒ</h6>
		                     </th> -->
		                     <th>
		                       <h6 class="fs-4 fw-semibold mb-0">ì‚¬ì›ëª…(ì‚¬ë²ˆ)</h6>
		                     </th>
		                     <th>
		                       <h6 class="fs-4 fw-semibold mb-0">ì…ì‚¬ì¼</h6>
		                     </th>
		                     <th>
		                       <h6 class="fs-4 fw-semibold mb-0">ê·¼ì† ì—°ìˆ˜</h6>
		                     </th>
		                     <th>
		                       <h6 class="fs-4 fw-semibold mb-0">ì—°ê°„ ì—°ì°¨</h6>
		                     </th>
		                     <th>
		                       <h6 class="fs-4 fw-semibold mb-0">ë‚¨ì€ ì—°ì°¨</h6>
		                     </th>
		                   </tr>
		                 </thead>
		                 <tbody id="member-tbody" class="member-tbody">
		              		<tr th:each="member : ${memberList}" th:attr="data-member-no=${member.memberNo}">
							<!-- <td>
								<input type="checkbox" class="form-check-input member-checkbox me-2" th:attr="data-member-no=${member.memberNo}">
							</td> -->
							<td class="text-center">
								<div>
									<h6 class="fs-4 fw-semibold mb-0 member-name" th:text="${member.memberName}">ì‚¬ì›ëª…</h6>
									<span class="fw-normal" th:text="|#${member.memberNo}|">#ì‚¬ë²ˆ</span>
								</div>
								<input type="hidden" id="memberNo" th:value="${member.memberNo}">
							</td>
							<td class="text-center">
							    <h6 class="fs-4 fw-semibold mb-0" th:text="${#temporals.format(member.regDate,'yyyy.MM.dd')}">ì…ì‚¬ì¼</h6>
							</td>
							<td class="text-center">
							  	<h6 class="fs-4 fw-semibold mb-0 th-year" th:attr="data-reg-date=${#temporals.format(member.regDate, 'yyyy-MM-dd')}">0ë…„ì°¨</h6>
							</td>
							<td class="text-center">
							  <h6 class="fs-4 fw-semibold mb-0">
							    <span th:each="policy : ${annualLeavePolicyList}"
								        th:if="${policy.year == (T(java.time.LocalDate).now().isBefore(member.regDate.plusYears(1)) 
								                                  ? 0 
								                                  : T(java.time.Period).between(member.regDate, T(java.time.LocalDate).now()).getYears())}"
								        th:text="${policy.leaveDays}">ì—°ì°¨</span>
								
								  <!-- ì—°ì°¨ ì •ì±…ì´ ì—†ëŠ” ê²½ìš°: 1ë…„ ë¯¸ë§Œì´ë©´ì„œ ì •ì±… ì—†ìŒ -->
								  <span th:unless="${#lists.contains(annualLeavePolicyList.?[year == 0], true)}"
								        th:if="${T(java.time.LocalDate).now().isBefore(member.regDate.plusYears(1))}">-</span>

							  </h6>
							</td>
							<td class="text-center">
								<h6 class="fs-4 fw-semibold mb-0" th:text="${member.annualLeave}">16</h6>
							</td>
					  	</tr>
					  	<tr th:if="${memberList == null}">
					  		<td colspan="7">ì‚¬ì› ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
					  	</tr>
		                 	</tbody>
		               </table>
		             
		             </div>
		              
				<div class="d-flex justify-content-center align-items-center mt-3 position-relative">
		
				  <nav>
					  <ul class="pagination mb-0">
					
					    <!-- ì´ì „ í˜ì´ì§€ -->
					    <li class="page-item" th:if="${pageDto.prev}">
					      <a class="page-link"
					         th:href="@{/annual/management(
					           nowPage=${pageDto.pageBarStart - 1},
					           search_text=${searchDto.search_text},
					           reg_date_order=${searchDto.reg_date_order}
					         )}" aria-label="Previous">
					        <span aria-hidden="true">&laquo;</span>
					      </a>
					    </li>
					
					    <!-- í˜ì´ì§€ ë²ˆí˜¸ -->
					    <th:block th:each="num : ${#numbers.sequence(pageDto.pageBarStart, pageDto.pageBarEnd)}">
					      <li class="page-item" th:classappend="${pageDto.nowPage == num} ? 'active'">
					        <a class="page-link"
					           th:classappend="${pageDto.nowPage == num} ? ' text-bg-primary border-primary text-white'"
					           th:href="@{/annual/management(
					             nowPage=${num},
					             search_text=${searchDto.search_text},
					             reg_date_order=${searchDto.reg_date_order}
					           )}"
					           th:text="${num}">í˜ì´ì§€</a>
					      </li>
					    </th:block>
					
					    <!-- ë‹¤ìŒ í˜ì´ì§€ -->
					    <li class="page-item" th:if="${pageDto.next}">
					      <a class="page-link"
					         th:href="@{/annual/management(
					           nowPage=${pageDto.pageBarEnd + 1},
					           search_text=${searchDto.search_text},
					           reg_date_order=${searchDto.reg_date_order}
					         )}" aria-label="Next">
					        <span aria-hidden="true">&raquo;</span>
					      </a>
					    </li>
					
					  </ul>
					</nav>
				  
				</div>
  			</form>
  		</div>
	</div>
	
	<script>
	document.addEventListener('DOMContentLoaded', function () {
		const regDateOrder = document.getElementById('reg_date_order');
		regDateOrder.addEventListener('change', function(){
			const reg_date_order = this.value;
			const search_text = document.getElementById('search_text').value;
			
			location.href = '/annual/management?search_text='+search_text+'&reg_date_order='+reg_date_order;
		})
	});
	</script>
	
	<div class="modal fade" id="holidayPolicyModal" tabindex="-1" aria-hidden="true">
	  <div class="modal-dialog modal-dialog-centered" style="max-width: 1000px;">
	    <div class="modal-content">
	      <div class="modal-header">
	        <h5 class="fw-bold mb-0">íœ´ì¼ ì •ì±… ì„¤ì •</h5>
	        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
	      </div>
	
	      <div class="modal-body">
	        <!-- ğŸ“Œ ë“±ë¡ í¼ ì˜ì—­ -->
	        <form name="holiday_form" action="/holiday/create" method="post">
	          <div class="d-flex justify-content-between align-items-center mb-4 w-100">
	            <div class="d-flex align-items-center gap-2 flex-wrap">
	              <span>ì´ë¦„</span>
	              <input type="text" class="form-control" name="holiday_name" id="holiday_name" placeholder="íœ´ì¼ëª…" style="max-width: 120px;">
	              <span>ë‚ ì§œ</span>
	              <input type="date" class="form-control" name="holiday_date" id="holiday_date" placeholder="ì—°ì°¨ì¼ìˆ˜" style="max-width: 150px;">
	              
	              <button type="submit" class="btn btn-primary">ì €ì¥</button>
	            </div>
	          </div>
	        </form>
	
	        <!-- ğŸ“Œ ì—°ì°¨ ì •ì±… ë³´ê¸° ì œëª© -->
	        <h5 class="fw-bold mb-3">ì—°ì°¨ ì •ì±… ë³´ê¸°</h5>
	
	        <!-- ğŸ“Œ í‘œ ì˜ì—­ -->
	        <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
	          <table class="table table-bordered text-center align-middle">
	            <thead class="table-light">
	              <tr>
	                <th style="width:40%;">ì´ë¦„</th>
	                <th style="width:40%;">ë‚ ì§œ</th>
	                <th style="width:10%;">ìˆ˜ì •</th>
	                <th style="width:10%;">ì‚­ì œ</th>
	              </tr>
	            </thead>
	            <tbody id="holiday-policy-body">
					<tr>

					</tr>
	            </tbody>
	          </table>
	        </div>
	      </div>
	
	      <div class="modal-footer">
	        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
	      </div>
	    </div>
	  </div>
	</div>

	
	<div class="modal fade" id="annualPolicyModal" tabindex="-1" aria-hidden="true">
	  <div class="modal-dialog modal-dialog-centered" style="max-width: 1000px;">
	    <div class="modal-content">
	      <div class="modal-header">
	        <h5 class="fw-bold mb-0">ì—°ì°¨ ì •ì±… ì„¤ì •</h5>
	        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
	      </div>
	
	      <div class="modal-body">
	        <!-- ğŸ“Œ ë“±ë¡ í¼ ì˜ì—­ -->
	        <form name="annual_leave_form" action="/annualPolicy/update" method="post">
	          <div class="d-flex justify-content-between align-items-center mb-4 w-100">
	            <div class="d-flex align-items-center gap-2 flex-wrap">
	              <input type="number" class="form-control" name="year" id="year" placeholder="ê·¼ì†ì—°ìˆ˜" min="1" style="max-width: 120px;">
	              <span>ë…„ì°¨ì—</span>
	              <input type="number" class="form-control" name="leave_days" id="leave_days" placeholder="ì—°ì°¨ì¼ìˆ˜" min="0" style="max-width: 120px;">
	              <span>ì¼</span>
	              <button type="submit" class="btn btn-primary">ì €ì¥</button>
	            </div>
	          </div>
	        </form>
	
	        <!-- ğŸ“Œ ì—°ì°¨ ì •ì±… ë³´ê¸° ì œëª© -->
	        <h5 class="fw-bold mb-3">ì—°ì°¨ ì •ì±… ë³´ê¸°</h5>
	
	        <!-- ğŸ“Œ í‘œ ì˜ì—­ -->
	        <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
	          <table class="table table-bordered text-center align-middle">
	            <thead class="table-light">
	              <tr>
	                <th style="width:45%;">ê·¼ì† ì—°ìˆ˜</th>
	                <th style="width:45%;">ì—°ì°¨ ì¼ìˆ˜</th>
	                <th style="width:10%;">ì‚­ì œ</th> <!-- âœ… ì‚­ì œ ì»¬ëŸ¼ ì¶”ê°€ -->
	              </tr>
	            </thead>
	            <tbody id="annual-policy-body">
					<tr>
						<td>1ë…„ ë¯¸ë§Œ</td>
						<td>ë§Œê·¼ ì‹œ í•œë‹¬ì— 1ì¼</td>
						<td></td>
					</tr>
	            </tbody>
	          </table>
	        </div>
	      </div>
	
	      <div class="modal-footer">
	        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
	      </div>
	    </div>
	  </div>
	</div>
	
	<script>
		const holidayForm = document.holiday_form;
			holidayForm.addEventListener('submit', function(e) {
			e.preventDefault();
			
			const holidayName = document.getElementById('holiday_name').value;
		    const holidayDate = document.getElementById('holiday_date').value;
			
		    if (!holidayName || !holidayDate) {
		        alert("íœ´ì¼ëª…ê³¼ ë‚ ì§œ ëª¨ë‘ ì…ë ¥í•˜ì…”ì•¼í•©ë‹ˆë‹¤.");
		        return;
		    }
		    
		    const payload = new FormData(holidayForm);
		    const csrfToken = document.querySelector('meta[name="_csrf"]').content;
			const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;
		    
			if(!confirm('íœ´ì¼ ì •ë³´ë¥¼ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
			
		    fetch('/holiday/create', {
		    	method:'post',
		    	headers: {
		    		
					[csrfHeader]: csrfToken
				},
		    	body: payload
		    })
		    .then(response => response.json())
		    .then(data => {
		    	
		    	alert(data.res_msg);
		    	document.getElementById('holiday_name').value = '';
			    document.getElementById('holiday_date').value = '';
		    	if(data.res_code == 200) {
			      const tbody = document.getElementById("holiday-policy-body");
			      tbody.innerHTML = ""; // ì´ˆê¸°í™”

			      data.holidayList.forEach(item => {
			        const row = document.createElement("tr");
			        row.innerHTML = `
			        	<td><input type="text" id="name${item.id}" value="${item.name}"></td>
				          <td><input type="date" id="date${item.id}" value="${item.date}"></td>
				          <td>
				            <button class="btn btn-primary" onclick="updateHoliday(${item.id})">
				              ìˆ˜ì •
				            </button>
				          </td>
				          <td>
				            <button class="btn btn-primary" onclick="deleteHoliday(${item.id})">
				              ì‚­ì œ
				            </button>
				          </td>
			        `;
			        tbody.appendChild(row);
			      });
		    	}
		    	
			})
			.catch(err => console.error("íœ´ì¼ ì •ì±… ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err));
		})
	</script>
		
	<!-- ì—°ì°¨ ì •ì±… ì„¤ì • (ê°™ì€ ì¤„ ì˜¤ë¥¸ìª½) -->
	<script>
		const annualLeaveForm = document.annual_leave_form;
		annualLeaveForm.addEventListener('submit', function(e) {
			e.preventDefault();
			
			const year = document.getElementById('year').value;
		    const leave_days = document.getElementById('leave_days').value;
			
		    if (!year || !leave_days) {
		        alert("ê·¼ì†ì—°ìˆ˜ì™€ ë“±ë¡í•  ì—°ì°¨ì¼ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
		        return;
		    }
		    
		    const payload = new FormData(annualLeaveForm);
		    const csrfToken = document.querySelector('meta[name="_csrf"]').content;
			const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;
		    
			if(!confirm(`${year}ë…„ì°¨ì˜ ì—°ì°¨ ì¼ìˆ˜ë¥¼ ${leave_days}ì¼ë¡œ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
			
		    fetch('/annualPolicy/update', {
		    	method:'post',
		    	headers: {
		    		
					[csrfHeader]: csrfToken
				},
		    	body: payload
		    })
		    .then(response => response.json())
		    .then(data => {
			      const tbody = document.getElementById("annual-policy-body");
			      tbody.innerHTML = ""; // ì´ˆê¸°í™”
			      
			      const rowOne = document.createElement("tr");
			      rowOne.innerHTML = '<td>1ë…„ ë¯¸ë§Œ</td><td>ë§Œê·¼ ì‹œ í•œ ë‹¬ ê¸°ì¤€ 1ì¼</td><td></td>';
			      tbody.appendChild(rowOne);

			      // ì „ì—­ ì €ì¥ (ì‚¬ì› ëª©ë¡ ê³„ì‚°ìš©)
			      window.annualPolicyList = data;

			      data.forEach(item => {
			        const row = document.createElement("tr");
			        row.innerHTML = `
			          <td>${item.year}ë…„ì°¨</td>
			          <td>${item.leaveDays}ì¼</td>
			          <td>
			            <button class="btn btn-primary" onclick="deletePolicy(${item.year})">
			              ì‚­ì œ
			            </button>
			          </td>
			        `;
			        tbody.appendChild(row);
			      });
			    })
			    .catch(err => console.error("ì—°ì°¨ ì •ì±… ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err));
		})
	</script>
	
	<!-- ëª¨ë‹¬ -->
	<div class="modal fade" id="memberAnnualUpdate" tabindex="-1" aria-hidden="true">
	  <div class="modal-dialog modal-dialog-centered" style="max-width: 500px;">
	    <div class="modal-content">
	      <div class="modal-header">
	        <h5 class="modal-title fw-bold">ì—°ì°¨ ìˆ˜ì •</h5>
	        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
	      </div>
	      <div class="modal-body text-center">
			  <p><strong id="memberName">ì‚¬ì›ëª… (#123)</strong></p>
			  <p>í˜„ì¬ ì—°ì°¨: <span id="currentAnnual">0</span>ì¼</p>
			
			  <!-- âœ” input + ë²„íŠ¼ ì¤„ ì •ë ¬ -->
			  <div class="d-flex justify-content-center align-items-center gap-2">
			    <input type="number" class="form-control text-center" step="0.5" id="annual_leave" style="max-width: 120px;">
			    <div class="btn-group" role="group">
			      <button type="button" class="btn btn-success" id="btnPlusAnnual">+</button>
			      <button type="button" class="btn btn-danger" id="btnMinusAnnual">-</button>
			    </div>
			  </div>
			</div>
	      <div class="modal-footer">
	        <button type="button" class="btn btn-primary" onclick="annualLeaveUpdate();">ì €ì¥</button>
	        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
	      </div>
	    </div>
	  </div>
	</div>
	
	<script>
		let selectedMemberNo = null;
		let currentAnnual = 0;
	
		document.querySelectorAll('.member-tbody').forEach(tbody => {
			  tbody.addEventListener('click', function (e) {
			    const tr = e.target.closest('tr');
			    if (!tr) return;

			    const name = tr.querySelector('.member-name')?.textContent.trim();
			    const memberNo = tr.dataset.memberNo;
			    const annualText = tr.querySelectorAll('td')[4]?.innerText.trim();
			    currentAnnual = parseFloat(annualText) || 0;
			    selectedMemberNo = memberNo;

			    if (!memberNo || !name) return;

			    document.getElementById('memberName').textContent = `${name} (#${memberNo})`;
			    document.getElementById('currentAnnual').textContent = currentAnnual;
			    document.getElementById('annual_leave').value = currentAnnual;

			    const modalEl = document.getElementById('memberAnnualUpdate');
			    const modal = new bootstrap.Modal(modalEl);
			    modal.show();
			  });
			});
	
		document.getElementById('btnPlusAnnual').addEventListener('click', function () {
			let val = parseFloat(document.getElementById('annual_leave').value) || 0;
			val = val + 0.5;
			document.getElementById('annual_leave').value = val.toFixed(1);
			document.getElementById('currentAnnual').textContent = val.toFixed(1);
		});
	
		document.getElementById('btnMinusAnnual').addEventListener('click', function () {
			let val = parseFloat(document.getElementById('annual_leave').value) || 0;
			if (val > 0) {
				val = val - 0.5;
				document.getElementById('annual_leave').value = val.toFixed(1);
				document.getElementById('currentAnnual').textContent = val.toFixed(1);
			}
		});
		
		const annualLeaveUpdate = function(){
			const formData = new FormData();
			formData.append("annual_leave", parseFloat(document.getElementById('annual_leave').value));
			const csrfToken = document.querySelector('meta[name="_csrf"]').content;
			const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;
			if(confirm('ì—°ì°¨ ê°œìˆ˜ë¥¼ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
				fetch('/member/annual/update/'+selectedMemberNo, {
					method:'post',
					headers: {
						[csrfHeader]: csrfToken
					},
					body: formData
				})
				.then(response => response.json())
				.then(data => {
					alert(data.res_msg);
					if(data.res_code == 200) {
						location.href = '/annual/management';
					}
				})
			}
		}
		
	</script>
	
	<script>
		document.addEventListener('DOMContentLoaded', function() {
		  $('#holidayPolicyModal').on('shown.bs.modal', function() {
			 loadHolidayPolicy();
		  });
		  
		  $('#holidayPolicyModal').on('hidden.bs.modal', function() {
			    loadAnnualPolicy();
			    document.getElementById('holiday_name').value = '';
			    document.getElementById('holiday_date').value = '';
		  });
		});
		
		function loadHolidayPolicy() {
			  fetch('/holiday', {
			    method: 'get'
			  })
			    .then(res => res.json())
			    .then(data => {
			      const tbody = document.getElementById("holiday-policy-body");
			      tbody.innerHTML = ""; // ì´ˆê¸°í™”

			      data.forEach(item => {
			        const row = document.createElement("tr");
			        row.innerHTML = `
			          <td><input type="text" id="name${item.id}" value="${item.name}"></td>
			          <td><input type="date" id="date${item.id}" value="${item.date}"></td>
			          <td>
			            <button class="btn btn-primary" onclick="updateHoliday(${item.id})">
			              ìˆ˜ì •
			            </button>
			          </td>
			          <td>
			            <button class="btn btn-primary" onclick="deleteHoliday(${item.id})">
			              ì‚­ì œ
			            </button>
			          </td>
			        `;
			        tbody.appendChild(row);
			      });
			    })
			    .catch(err => console.error("íœ´ì¼ ì •ì±… ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err));
			}
		
		function updateHoliday(id) {
			  if (!confirm('íœ´ì¼ ì •ë³´ë¥¼ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
			  
			  let holiday_name = document.getElementById(`name${id}`).value;
			  let holiday_date = document.getElementById(`date${id}`).value;
			  let payload = new FormData();
			  payload.append("id", id);
			  payload.append("holiday_name", holiday_name);
			  payload.append("holiday_date", holiday_date);
			  fetch('/holiday/update', {
			    method: 'post',
			    headers: {
			      'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content
			    },
			    body:payload
			  })
			    .then(response => response.json())
			    .then(data => {
			    	alert(data.res_msg);
			    	if(data.res_code == 200 || data.res_code == 409) {
				      const tbody = document.getElementById("holiday-policy-body");
				      tbody.innerHTML = ""; // ì´ˆê¸°í™”
				      
				      data.holidayList.forEach(item => {
				        const row = document.createElement("tr");
				        row.innerHTML = `
				        	 <td><input type="text" id="name${item.id}" value="${item.name}"></td>
					          <td><input type="date" id="date${item.id}" value="${item.date}"></td>
					          <td>
					            <button class="btn btn-primary" onclick="updateHoliday(${item.id})">
					              ìˆ˜ì •
					            </button>
					          </td>
					          <td>
					            <button class="btn btn-primary" onclick="deleteHoliday(${item.id})">
					              ì‚­ì œ
					            </button>
					          </td>
				        `;
				        tbody.appendChild(row);
				      });
			    	}
			    })
			    .catch(err => console.error("íœ´ì¼ ìˆ˜ì • ì‹¤íŒ¨:", err));
		}
		
		function deleteHoliday(id) {
			  if (!confirm('ì •ë§ íœ´ì¼ ì •ë³´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

			  fetch('/holiday/delete/'+id, {
			    method: 'DELETE',
			    headers: {
			      'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content
			    }
			  })
			    .then(response => response.json())
			    .then(data => {
			    	alert(data.res_msg);
			    	if(data.res_code == 200) {
			    		 const tbody = document.getElementById("holiday-policy-body");
					      tbody.innerHTML = ""; // ì´ˆê¸°í™”

					      data.holidayList.forEach(item => {
					        const row = document.createElement("tr");
					        row.innerHTML = `
					        	<td><input type="text" id="name${item.id}" value="${item.name}"></td>
						          <td><input type="date" id="date${item.id}" value="${item.date}"></td>
						          <td>
						            <button class="btn btn-primary" onclick="updateHoliday(${item.id})">
						              ìˆ˜ì •
						            </button>
						          </td>
						          <td>
						            <button class="btn btn-primary" onclick="deleteHoliday(${item.id})">
						              ì‚­ì œ
						            </button>
						          </td>
					        `;
					        tbody.appendChild(row);
					      });
			    	}
				     
			    })
			    .catch(err => console.error("íœ´ì¼ ì‚­ì œ ì‹¤íŒ¨:", err));
		}
	</script>	
	
	<script>
		document.addEventListener('DOMContentLoaded', function() {
		  $('#annualPolicyModal').on('shown.bs.modal', function() {
		    loadAnnualPolicy();
		  });
		  
		  $('#annualPolicyModal').on('hidden.bs.modal', function() {
			    document.getElementById('year').value = '';
			    document.getElementById('leave_days').value = '';
			    location.reload();
		  });
		});
		
		function loadAnnualPolicy() {
			  fetch('/annual', {
			    method: 'get'
			  })
			    .then(res => res.json())
			    .then(data => {
			      const tbody = document.getElementById("annual-policy-body");
			      tbody.innerHTML = ""; // ì´ˆê¸°í™”
			      
			      const rowOne = document.createElement("tr");
			      rowOne.innerHTML = '<td>1ë…„ ë¯¸ë§Œ</td><td>ë§Œê·¼ ì‹œ í•œ ë‹¬ ê¸°ì¤€ 1ì¼</td><td></td>';
			      tbody.appendChild(rowOne);

			      // ì „ì—­ ì €ì¥ (ì‚¬ì› ëª©ë¡ ê³„ì‚°ìš©)
			      window.annualPolicyList = data;

			      data.forEach(item => {
			        const row = document.createElement("tr");
			        row.innerHTML = `
			          <td>${item.year}ë…„ì°¨</td>
			          <td>${item.leaveDays}ì¼</td>
			          <td>
			            <button class="btn btn-primary" onclick="deletePolicy(${item.year})">
			              ì‚­ì œ
			            </button>
			          </td>
			        `;
			        tbody.appendChild(row);
			      });
			    })
			    .catch(err => console.error("ì—°ì°¨ ì •ì±… ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err));
			}
		
		function deletePolicy(year) {
			  if (!confirm(`${year}ë…„ì°¨ ì •ì±…ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

			  fetch('/annualPolicy/delete/'+year, {
			    method: 'DELETE',
			    headers: {
			      'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content
			    }
			  })
			    .then(response => response.json())
			    .then(data => {
				      const tbody = document.getElementById("annual-policy-body");
				      tbody.innerHTML = ""; // ì´ˆê¸°í™”
				      
				      const rowOne = document.createElement("tr");
				      rowOne.innerHTML = '<td>1ë…„ ë¯¸ë§Œ</td><td>ë§Œê·¼ ì‹œ í•œ ë‹¬ ê¸°ì¤€ 1ì¼</td><td></td>';
				      tbody.appendChild(rowOne);
				      
				      // ì „ì—­ ì €ì¥ (ì‚¬ì› ëª©ë¡ ê³„ì‚°ìš©)
				      window.annualPolicyList = data;

				      data.forEach(item => {
				        const row = document.createElement("tr");
				        row.innerHTML = `
				          <td>${item.year}ë…„ì°¨</td>
				          <td>${item.leaveDays}ì¼</td>
				          <td>
				            <button class="btn btn-primary" onclick="deletePolicy(${item.year})">
				              ì‚­ì œ
				            </button>
				          </td>
				        `;
				        tbody.appendChild(row);
				      });
				    })
				    .catch(err => console.error("ì—°ì°¨ ì •ì±… ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err));
		}
	</script>
	
	
	<script>
		  document.addEventListener("DOMContentLoaded", function () {
		    const todayStr = document.getElementById("today")?.value;
		    if (!todayStr) {
		      console.error("â›” today ê°’ ì—†ìŒ");
		      return;
		    }
		
		    const today = new Date(todayStr); // "YYYY-MM-DD"
		
		    document.querySelectorAll(".th-year").forEach(el => {
		      const regDateStr = el.dataset.regDate;
		      if (!regDateStr) return;
		
		      const regDate = new Date(regDateStr);
		      const yearDiff = today.getFullYear() - regDate.getFullYear();
		
		      const oneYearPassed =
		        today.getMonth() > regDate.getMonth() ||
		        (today.getMonth() === regDate.getMonth() && today.getDate() >= regDate.getDate());
		
		      if (yearDiff === 0 || (yearDiff === 1 && !oneYearPassed)) {
		        el.textContent = "1ë…„ ë¯¸ë§Œ";
		        return;
		      }
		
		      const serviceYears = oneYearPassed ? yearDiff + 1 : yearDiff;
		      el.textContent = `${serviceYears - 1}ë…„ì°¨`;
		    });
		  });
	</script>
	
	<script>
		// ì´ˆê¸°í™” ë²„íŠ¼ì„ ëˆŒëŸ¬ì„œ ê²€ìƒ‰ì„ ë¬´íš¨í™”ì‹œí‚¤ëŠ” ë¡œì§ 
		document.getElementById("resetBtn").addEventListener("click", function() {
		    location.href="/annual/management";
		});
	</script>
	
	<!-- Bootstrap Common JS Files Start -->
	
	<!-- Import vendorJs Files -->
	<script th:src="@{/assets/js/vendor.min.js}"></script>
	
  	<!-- Import Js Files -->
  	<script th:src="@{/assets/libs/bootstrap/dist/js/bootstrap.bundle.min.js}"></script>
  	<script th:src="@{/assets/libs/simplebar/dist/simplebar.min.js}"></script>
  	<script th:src="@{/assets/js/theme/app.init.js}"></script>
  	<script th:src="@{/assets/js/theme/theme.js}"></script>
  	<script th:src="@{/assets/js/theme/app.min.js}"></script>
  	<script th:src="@{/assets/js/theme/sidebarmenu.js}"></script>
	
  	<!-- solar icons -->
  	<script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>
  	<script th:src="@{/assets/libs/owl.carousel/dist/owl.carousel.min.js}"></script>
  	<script th:src="@{/assets/libs/apexcharts/dist/apexcharts.min.js}"></script>
  	<script th:src="@{/assets/js/dashboards/dashboard.js}"></script>
  	
  	<!-- Bootstrap Common JS Files End -->
  	
  	<!-- jsTree -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>
	<script th:src="@{/js/cjs/jstree.js}"></script>

</th:block>
</html>