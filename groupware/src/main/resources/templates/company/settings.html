<!DOCTYPE html>
<html
xmlns:th="http://www.thymeleaf.org"
xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
layout:decorate="~{/include/layout}">
<th:block layout:fragment="content">
	
	<!-- Custom CSS Files -->
	
	<link th:href="@{/css/cjs/settings.css}" rel="stylesheet">
	
	<!-- ---------------------------------------------------------------------------- -->
	<!-- HTML 작성 공간 -->
	<div class="page-titles mb-7 mb-md-5">
		<div class="row">
			<div class="col-lg-8 col-md-6 col-12 align-self-center">
				<nav aria-label="breadcrumb">
                	<ol class="breadcrumb align-items-center">
                		<li class="breadcrumb-item">
                    		<a class="text-muted text-decoration-none" th:href="@{/home}">
                     			<i class="ti ti-home fs-5"></i>
                    		</a>
                   	 	</li>
						<li class="breadcrumb-item" aria-current="page">최고 관리자 / 사이트 설정</li>
                  	</ol>
				</nav><br>
				<h2 class="mb-0 fw-bolder fs-8">사이트 설정</h2>
			</div><br>
		</div>
	</div>
	
	<div class="card">
    	<ul class="nav nav-pills user-profile-tab" id="pills-tab" role="tablist">
       		<li class="nav-item" role="presentation">
            	<button class="nav-link position-relative rounded-0 active d-flex align-items-center justify-content-center bg-transparent fs-3 py-3" id="pills-account-tab" data-bs-toggle="pill" data-bs-target="#pills-account" type="button" role="tab" aria-controls="pills-account" aria-selected="true">
                	<i class="ti ti-user-circle me-2 fs-6"></i>
                	<span class="d-none d-md-block">프로필 설정</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
            	<button class="nav-link position-relative rounded-0 d-flex align-items-center justify-content-center bg-transparent fs-3 py-3" id="pills-role-tab" data-bs-toggle="pill" data-bs-target="#pills-role" type="button" role="tab" aria-controls="pills-role" aria-selected="false">
                	<i class="ti ti-shield me-2 fs-6"></i>
                	<span class="d-none d-md-block">권한 설정</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
            	<button class="nav-link position-relative rounded-0 d-flex align-items-center justify-content-center bg-transparent fs-3 py-3" id="pills-notifications-tab" data-bs-toggle="pill" data-bs-target="#pills-notifications" type="button" role="tab" aria-controls="pills-notifications" aria-selected="false">
                	<i class="ti ti-puzzle me-2 fs-6"></i>
                	<span class="d-none d-md-block">기능 설정</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
            	<button class="nav-link position-relative rounded-0 d-flex align-items-center justify-content-center bg-transparent fs-3 py-3" id="pills-security-tab" data-bs-toggle="pill" data-bs-target="#pills-security" type="button" role="tab" aria-controls="pills-security" aria-selected="false">
                	<i class="ti ti-code me-2 fs-6"></i>
                	<span class="d-none d-md-block">규칙 설정</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
            	<button class="nav-link position-relative rounded-0 d-flex align-items-center justify-content-center bg-transparent fs-3 py-3" id="pills-bills-tab" data-bs-toggle="pill" data-bs-target="#pills-bills" type="button" role="tab" aria-controls="pills-bills" aria-selected="false">
                	<i class="ti ti-palette me-2 fs-6"></i>
                	<span class="d-none d-md-block">색상 설정</span>
                </button>
            </li>
		</ul>
		
		<div class="card">
		  <div class="card-body">
		    <div class="tab-content" id="pills-tabContent">
		    
		    <!-- 첫 번째 탭 -->
		      <div class="tab-pane fade show active" id="pills-account" role="tabpanel" aria-labelledby="pills-account-tab" tabindex="0">
		        <form name="create_profile_form" id="create_profile_form" enctype="multipart/form-data" class="w-100">
		          <div class="row">
		          
		            <!-- 프로필 이미지 등록 부분 -->
					<div class="col-lg-6 d-flex align-items-stretch">
					  <div class="card w-100 border position-relative overflow-hidden">
					    <div class="card-body p-4">
					      <h4 class="card-title">이미지 변경</h4>
					      <p class="card-subtitle mb-4">Click the image to change a profile.</p>
						  
					      <div class="text-center">
					        <!-- 업로드 이미지 (클릭 이벤트용) -->
					        <img id="preview_image"
					        	th:src="${companyDto != null && companyDto.profile_image_path != null ? '/uploads/' + companyDto.new_name : '/assets/images/big/img3.jpg'}"
					        	alt="profile-img"
					            class="img-fluid rounded"
					            style="width: 120px; height: 120px; object-fit: cover; cursor: pointer; transition: 0.2s;"
					            onclick="document.getElementById('profile_image').click();">
								
					        <!-- 숨겨진 파일 인풋 -->
					        <input type="file" name="profile_image" accept=".jpg,.jpeg,.png"
					               id="profile_image" class="d-none" onchange="previewSelectedImage(this)">
							
					        <p class="mt-3 mb-0 text-muted small" onclick="document.getElementById('profile_image').click()" style="cursor: pointer;">
							    이미지를 클릭하시면 변경할 수 있습니다.<br>
							    JPG, JPEG, PNG 형식만 허용되며, 최대 2MB까지 업로드할 수 있습니다.
							</p>
							
							<button type="button" class="btn btn-sm btn-outline-secondary mt-1" style="visibility:hidden;" id="resetImageBtn" onclick="resetToDefaultImage()">
							  reset
							</button>
							
					      </div>
					    </div>
					  </div>
					</div>
					
		            <!-- 기본 정보 등록 -->
		            <div class="col-lg-6 d-flex align-items-stretch">
		              <div class="card w-100 border position-relative overflow-hidden">
		                <div class="card-body p-4">
		                  <h4 class="card-title" style="font-weight: bold;">기본 정보 등록</h4>
		                  <p class="card-subtitle mb-4">Please enter a basic profile info.</p>
							
		                  <div class="mb-3">
		                    <label for="company_name" class="form-label">회사명*</label>
		                    <input type="text" class="form-control" id="company_name" name="company_name">
		                  </div>
		                </div>
						
		                <div class="d-flex align-items-center justify-content-center gap-3 mb-4">
		                  <button type="submit" class="btn btn-primary">등록</button>
		                  <button type="reset" class="btn bg-danger-subtle text-danger" onclick="location.reload();">취소</button>
		                </div>
		              </div>
		            </div>
					
		          </div>
		        </form>
		      </div>
		      
		      <!-- 두 번째 탭 -->
                <div class="tab-pane fade" id="pills-role" role="tabpanel" aria-labelledby="pills-notifications-tab" tabindex="0">
                  <div class="row">
		          
		            <!-- 사용할 기능 목록 -->
					<div class="col-lg-6 d-flex align-items-stretch">
					  <div class="card w-100 border position-relative overflow-hidden">
					    <div class="card-body p-4">
					      <h4 class="card-title d-flex justify-content-between align-items-center">권한 관리
					      	<button type="button"
						          class="btn btn-primary btn-sm"
						          data-bs-toggle="modal"
						          data-bs-target="#roleAddModal">
						    + 추가
						    </button>
					      </h4>
					      <p class="card-subtitle mb-4">Permissions can be added, modified, or removed as necessary.</p>
						  
					      <div class="text-center">
					        
					        <div class="text-start">
					        	<th:block th:if="${roleList != null and !#lists.isEmpty(roleList)}">
								  <form id="role_form" name="role_form">
								    <div class="form-group">
								      <ul class="list-unstyled mb-0">
								      	<li class="py-2 px-2 border-bottom d-flex justify-content-between align-items-center"
								      		th:each="role : ${roleList}">
								      		
								        	<div class="d-flex align-items-center">
								        	
								        	  <i class="fas fa-bars text-muted me-3" style="cursor: pointer;"></i>
								        	
										      <span class="fw-medium"
										        style="cursor: pointer;"
										        th:text="|${role.role_nickname} (${#strings.substring(role.role_name, 5)}) - ${role.member_count}명|"
										        th:attr="data-role-no=${role.role_no}">권한 이름</span>
										    </div>
										
										    <div class="d-flex"
										    	th:if="${role.role_no != 1 and role.role_no != 2}">
										      <button type="button"
										        class="btn btn-outline-secondary btn-sm me-2 edit-btn"
										        th:attr="data-role-no=${role.role_no}, 
										                 data-role-nickname=${role.role_nickname}, 
										                 data-role-name=${role.role_name}"
						          				onclick="openEditModal(this)">
										        수정
										      </button>
										      <button type="button"
										        class="btn btn-outline-danger btn-sm delete-btn"
										        th:attr="data-role-no=${role.role_no}"
										        onclick="openDeleteModal(this)">
										        삭제
										      </button>
										    </div>
										    
										    <div class="d-flex invisible" th:if="${role.role_no == 1 or role.role_no == 2}">
										      <button type="button"
										      		class="btn btn-outline-secondary btn-sm me-2"
										      		>수정</button>
										      <button type="button" class="btn btn-outline-danger btn-sm">삭제</button>
										    </div>
										</li>
								      </ul>
								    </div>
								  </form>
								</th:block>
								<th:block th:if="${roleList == null or #lists.isEmpty(roleList)}"> 
								  <div class="text-start text-muted small py-3">
								    등록된 권한이 없습니다.
								  </div>
								</th:block>
							</div>
							
					      </div>
					      
					    </div>
					  </div>
					</div>
					
					<div class="col-lg-6 d-flex align-items-stretch">
					  <div class="card w-100 border position-relative overflow-hidden">
					    <div class="card-body p-4">
					      <h4 class="card-title">권한 상세</h4>
					      <p class="card-subtitle mb-4">Check the selected Permission to see more information.</p>
						  
					      <div class="text-center">
					      
					        <div class="text-start" id="func_detail_panel">
							
							  <ul id="role_sub_list" class="list-unstyled small">
							    
							  </ul>
							  
							</div>
							
					      </div>
					    </div>
					  </div>
					</div>
					
		          </div>
                  
                </div>
              <!-- 두 번째 탭 끝 -->
		      
		      <!-- 세 번째 탭 -->
              <div class="tab-pane fade" id="pills-notifications" role="tabpanel" aria-labelledby="pills-notifications-tab" tabindex="0">
                  <div class="row">
		          
		            <!-- 사용할 기능 목록 -->
					<div class="col-lg-6 d-flex align-items-stretch">
					  <div class="card w-100 border position-relative overflow-hidden">
					    <div class="card-body p-4">
					      <h4 class="card-title">주요 기능 선택</h4>
					      <p class="card-subtitle mb-4">Choose the functions to be activated for your groupware.</p>
						  
					      <div class="text-center">
					        
					        <div class="text-start">
					        	<th:block th:if="${funcList != null and !#lists.isEmpty(funcList)}">
								  <form id="func_form" name="func_form">
								    <div class="form-group">
								      <ul class="list-unstyled">
								      	<li class="mb-2" th:each="func : ${funcList}">
								            	<input type="checkbox"
								            		name="func_no"
								            		style="cursor: pointer;"
								                	th:value="${func.func_no}"
								                	th:checked="${func.func_status == 1}"
								                	th:disabled="${func.func_no == 1 || func.func_no == 2 || func.func_no == 3 || func.func_no == 4 || func.func_no == 5}"
								                	class="form-check-input me-2"
								                	onchange="changeFuncToggle(this)">
								                	
								                <label th:for="'func_' + ${func.func_no}" class="me-2"></label>
								                
								         		<span class="fw-medium"
								         			style="cursor: pointer;"
								         			th:text="${func.func_name}"
								         			th:attr="data-func-no=${func.func_no}"
								         			onclick="loadFuncDetail(event, this)">기능 이름</span>
										</li>
								      </ul>
								    </div>
								  </form>
								</th:block>
								<th:block th:if="${funcList == null or #lists.isEmpty(funcList)}"> 
								  <div class="text-start text-muted small py-3">
								    사용 가능한 기능이 없습니다.
								  </div>
								</th:block>
							</div>
							
					      </div>
					      
					    </div>
					  </div>
					</div>
					
					<div class="col-lg-6 d-flex align-items-stretch">
					  <div class="card w-100 border position-relative overflow-hidden">
					    <div class="card-body p-4">
					      <h4 class="card-title">기능 상세 및 접근 권한 부여</h4>
					      <p class="card-subtitle mb-4">Click to modify the accessible permissions for this function.</p>
						  
					      <div class="text-center">
					      
					        <div class="text-start" id="func_detail_panel">
							
							  <ul id="func_sub_list" class="list-unstyled small">
							    
							  </ul>
							  
							</div>
							
					      </div>
					    </div>
					  </div>
					</div>
					
		          </div>
                  
                </div>
				
				<!-- 네 번째 탭 -->
                <div class="tab-pane fade" id="pills-security" role="tabpanel" aria-labelledby="pills-security-tab" tabindex="0">
                  <div class="row">
                    <div class="col-lg-12">
                      <div class="card border shadow-none">
                        <div class="card-body p-4">
                          <h4 class="card-title">규칙 설정</h4>
                          <p class="card-subtitle mb-4">Set the rule to generate IDs and passwords.</p>
                          
                          <form name="create_rule_form" id="create_rule_form" method="post">
                          	  <th:block th:if="${companyDto != null}">
	                          	<input type="hidden" name="company_no" th:value="${companyDto.company_no}">
                          	  </th:block>
                          
	                          <div class="mb-4">
							    <label for="company_initial" class="form-label fw-semibold">회사 이니셜</label>
							    <input type="text"
							    		name="company_initial"
							    		id="company_initial"
							    		th:value="${companyDto != null && companyDto.company_initial != null ? companyDto.company_initial : ''}"
							    		class="form-control"
							    		placeholder="예: mjc"
							    		maxlength="10">
							  </div>
							
							  <div class="form-check form-switch mb-4">
							    <input class="form-check-input"
							    		type="checkbox"
							    		name="rule_status"
							    		id="rule_status"
							    		th:checked="${companyDto != null && companyDto.rule_status == 1}">
							    <label class="form-check-label" for="rule_status">아이디/비밀번호 생성 규칙 사용</label>
							  </div>
							  
							  <div class="d-flex align-items-start gap-3" role="alert">
								  <div>
								    <div class="fw-bold mb-1">[규칙 안내]</div>
								    <div class="small">
								      <div><span class="fw-semibold">아이디</span>: 이니셜(소문자) + 입사년도 4자리 + 사번 뒤 5자리</div>
								      <div><span class="fw-semibold">비밀번호</span>: 이니셜(대문자) + '@' + 입사년도 2자리 + 사번 뒤 2자리</div>
								    </div>
								  </div>
								</div>
							  
							  <div class="d-flex align-items-center justify-content-end gap-3">
							    <button type="submit" class="btn btn-primary">등록</button>
			                  	<button type="reset" class="btn bg-danger-subtle text-danger" onclick="location.reload();">취소</button>
							  </div>
                          </form>
                          
                          <th:block th:if="${companyDto != null}">
	                      	<span th:attr="data-company-flag=${'false'}"></span>                
 						  </th:block>
 						  <th:block th:if="${companyDto == null}">
							<span th:attr="data-company-flag=${'true'}"></span>
 						  </th:block>
						  
                        </div>
                      </div>
                    </div>
                    
                  </div>
                </div>
				
                <!-- 다섯 번째 탭 -->
                <div class="tab-pane fade" id="pills-bills" role="tabpanel" aria-labelledby="pills-bills-tab" tabindex="0">
                  <div class="row justify-content-center">
                  	
                    <div class="col-lg-12">
                      <div class="card border shadow-none">
                        <div class="card-body p-4">
                          <h4 class="card-title mb-2">테마 색상 설정</h4>
                          <p class="card-subtitle mb-4">Click on a color to instantly change how your site looks.</p>
                          
                          <div class="d-flex flex-wrap gap-3 mb-20">
					        <!-- 각각의 컬러칩 -->
					        <div class="theme-option" data-theme="Blue_Theme" style="width: 40px; height: 40px; border-radius: 50%; background-color: #0d6efd; cursor: pointer;" title="Blue"></div>
					        <div class="theme-option" data-theme="Dark_Theme" style="width: 40px; height: 40px; border-radius: 50%; background-color: #343a40; cursor: pointer;" title="Dark"></div>
					        <div class="theme-option" data-theme="Green_Theme" style="width: 40px; height: 40px; border-radius: 50%; background-color: #00CEC3; cursor: pointer;" title="Green"></div>
					        <div class="theme-option" data-theme="Indigo_Theme" style="width: 40px; height: 40px; border-radius: 50%; background-color: #0A7EA4; cursor: pointer;" title="Indigo"></div>
					        <div class="theme-option" data-theme="Orange_Theme" style="width: 40px; height: 40px; border-radius: 50%; background-color: #FB9678; cursor: pointer;" title="Orange"></div>
					        <div class="theme-option" data-theme="Red_Theme" style="width: 40px; height: 40px; border-radius: 50%; background-color: #FF5C82; cursor: pointer;" title="Red"></div>
					        <div class="theme-option" data-theme="Purple_Theme" style="width: 40px; height: 40px; border-radius: 50%; background-color: #7352ff; cursor: pointer;" title="Purple"></div>
					      </div>
                          
                          <th:block th:if="${companyDto != null}">
	                      	<p class="mt-3">현재 테마명: <span id="selected-theme"
	                      									class="fw-bold text-primary"
	                      									th:text="${(companyDto.theme_color ?: 'Blue_Theme').substring(0, (companyDto.theme_color ?: 'Blue_Theme').indexOf('_'))}"
	                      									th:attr="data-theme=${companyDto.theme_color}">
	                      								</span>
	                      	</p>                      
 						  </th:block>
 						  <th:block th:if="${companyDto == null}">
							<span th:attr="data-flag=${'true'}"></span>
 						    <p class="mt-3">현재 테마명: <span id="selected-theme"
 						    								class="fw-bold text-primary"
 						    								th:text="Blue">
 						    							</span>
 						    </p>
 						  </th:block>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- 다섯 번째 탭 :: 끝 -->                

              </div>
        	</div>
    	</div>
	</div>

	<script>
		// 로컬 스토리지에서 마지막 선택된 탭 가져오는 로직 - UX 개선
	    document.addEventListener("DOMContentLoaded", function () {
	        
	        const lastTab = localStorage.getItem('lastTab');
	        if (lastTab) {
	            const tab = document.getElementById(lastTab);
	            if (tab) {
	                tab.click();
	            }
	        }
	    });
	
	    // 탭 클릭 시 로컬 스토리지에 저장하는 로직 - UX 개선
	    document.querySelectorAll('.nav-link').forEach(function (tab) {
	        tab.addEventListener('click', function () {
	            const tabId = this.getAttribute('id');
	            localStorage.setItem('lastTab', tabId);
	        });
	    });
	</script>
	
	<script>
		// 프로필 등록하는 로직
		const infoForm = document.create_profile_form;
		infoForm.addEventListener('submit',(event) => {
			event.preventDefault();
			
			let vali_chk = false;
			let vali_msg = "";
			
			if(!infoForm.company_name.value) {
				vali_msg += "회사명을 입력해주세요.";
				infoForm.company_name.focus();
			} else {
				vali_chk = true;
			}
			
			if(vali_chk != true) {
				alert(vali_msg);
			} else {
				const payload = new FormData(infoForm);
				
				fetch("/admin/company/create", {
					method : "post",
					headers : {
						'header': document.querySelector('meta[name="_csrf_header"]').content,
						'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content
					},
					body : payload
				})
				.then(response => response.json())
				.then(data => {
					alert(data.res_msg);
					if(data.res_code == '200') {
						location.href = "/admin/company";
					}
				})
				.catch(error => {
					console.log(error);
				})
			}
		});
	</script>
	
	<script>
		// 파일 선택시 미리보기 + 파일 크기 제한
		function previewSelectedImage(input) {
			const file = input.files[0];
			const preview = document.getElementById('preview_image');
			const resetBtn = document.getElementById('resetImageBtn');
			const maxSize = 2 * 1024 * 1024; // 2MB
			
			if (file && file.size > maxSize) {
		        alert("파일 용량은 2MB 이하만 업로드 가능합니다.");
		        input.value = "";
		        return;
		    }
			
			if (file) {
		    	const reader = new FileReader();
		    	reader.onload = function (e) {
		     		preview.src = e.target.result;
		     		resetBtn.style.visibility = "visible"; // 더이상 기본 이미지로 되돌리는 버튼을 사용할 필요가 없음
		    	};
		    	reader.readAsDataURL(file);
		  	}
		}
		
		// 선택한 파일을 내리고 기본 이미지로 되돌림
		function resetToDefaultImage() {
			// const defaultImageUrl = '/assets/images/big/img3.jpg';
			// const preview = document.getElementById('preview_image');
			// const fileInput = document.getElementById('profile_image');
			// const resetBtn = document.getElementById('resetImageBtn');
			
			// preview.src = defaultImageUrl;
			// fileInput.value = '';
			// resetBtn.style.visibility = "hidden";
			
			location.reload();
		}
	</script>
	
	<script>
		// 권한을 클릭하면 해당 권한으로 뭘 할 수 있는지 보여주는 로직 
		document.querySelectorAll('[data-role-no]').forEach(elem => {
			elem.addEventListener('click', function () {
				const roleNo = this.getAttribute('data-role-no');
				loadRoleFuncDetail(roleNo);
			});
		});
		
		// 해당 권한으로 뭘 할 수 있는지 조회해오는 로직
		function loadRoleFuncDetail(roleNo) {

			fetch(`/admin/company/role/${roleNo}/detail`, {
				method : "get"
			})
			.then(response => response.json())
			.then(data => {
				const target = document.getElementById("role_sub_list");
				target.innerHTML = "";
				
				if (data && data.length > 0) {
					data.forEach(func => {
						const li = document.createElement("li");
						li.className = "mb-1";
						li.innerHTML = `
							<i class="bi bi-check2-circle me-2 text-primary"></i>
							<span>${func.func_name}</span>
						`;
						target.appendChild(li);
					});
				} else {
					target.innerHTML = `<li class="text-muted small">이 권한으로 접근 가능한 기능이 없습니다.</li>`;
				}
			})
			.catch(error => {
				console.log(error);
			})
		}
	</script>
	
	<script>
		// 사용할 기능 체크박스를 클릭하면 DB에 접근하여 func_status를 바꿔주는 로직
		function changeFuncToggle(checkbox) {
			const checked = checkbox.checked;
		    const funcNo = checkbox.value;
		    
		    const confirmMsg = checked 
		      ? "해당 기능을 활성화하시겠습니까?" 
		      : "해당 기능을 비활성화하시겠습니까?";
		    
		    if (!confirm(confirmMsg)) {
				checkbox.checked = !checked;
				return;
		    } else {
		    	fetch('/admin/company/func/update', {
					method: "post",
					headers: {
						'Content-Type': 'application/json',
						'header': document.querySelector('meta[name="_csrf_header"]').content,
						'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content
					},
	        		body: JSON.stringify({
	        			func_no: funcNo,
	        	        func_status: checked ? 1 : 0
					})
		    	})
		    	.then(response => response.json())
				.then(data => {
					alert(data.res_msg);
					if (data.res_code === '200') {
						location.reload();
					}
				})
				.catch(error => {
	        		console.log(error);
	        	});
		    }
		}
	</script>
	
	<script>
		// 사용할 기능 이름을 클릭하면 오른쪽에 상세 정보가 보여지는 로직
		function loadFuncDetail(event, element) {
		    event.stopPropagation();  // 체크박스 input태그에 걸려있는 함수는 작동하지 않도록 버블링 차단 
		
		    const funcNo = element.getAttribute("data-func-no");
		
		    fetch(`/admin/company/func/${funcNo}/detail`, {
		        method: "get"
		    })
		    .then(response => response.json())
		    .then(data => {
		        const subList = document.getElementById("func_sub_list");
		        subList.innerHTML = "";
				
 		        // 상위 항목 렌더링
		        if (data.funcDto) {
		            const parentLi = document.createElement("li");

		            let html = `
		                <strong class="func-item" data-func-no="${data.funcDto.func_no}">
		                    ${data.funcDto.func_name}
		                </strong><br/>
		                <div class="ms-4" id="checkbox-container-${data.funcDto.func_no}" style="display:none;">
		            `;

		            // 체크박스 로직
		            if (data.roleDtoList && data.roleDtoList.length > 0) {
		                const accessibleRoles = Array.isArray(data.funcDto.accessibleRoles) ? data.funcDto.accessibleRoles : [];

		                data.roleDtoList.forEach(role => {
		                    const isDisabled = (role.role_no === 1 || role.role_no === 2);
		                    const isChecked = accessibleRoles.some(ar => ar.role_no === role.role_no);

		                    html += `
		                        <div class="form-check form-check-inline">
		                            <input class="form-check-input"
		                                   type="checkbox"
		                                   name="role_no"
		                                   value="${role.role_no}"
		                                   data-func-no="${data.funcDto.func_no}"
		                                   onchange="toggleFuncRole(this)"
		                                   ${isChecked ? 'checked' : ''}
		                                   ${isDisabled ? 'disabled' : ''}>
		                            <label class="form-check-label">${role.role_nickname}</label>
		                        </div>
		                    `;
		                });
		            }

		            html += `</div>`;
		            parentLi.innerHTML = html;
		            subList.appendChild(parentLi);

		            // 이벤트 등록
		            parentLi.querySelector('.func-item').addEventListener("click", function (e) {
		                e.stopPropagation(); // 필수
		                const funcNo = this.getAttribute("data-func-no");
		                // toggleCheckboxVisibility(funcNo);
		            });
		        }
				
		        // 하위 항목 렌더링
		        if (data.funcDtoList && data.funcDtoList.length > 0) {
		            data.funcDtoList.forEach(child => {
		                const li = document.createElement("li");
		                let html = `&nbsp;&nbsp;└ <strong class="func-item" data-func-no="${child.func_no}">${child.func_name}</strong><br/>`;

		                html += `<div class="ms-4" id="checkbox-container-${child.func_no}" style="display:none;">`;
						
		                // 체크박스 로직
		                if (data.roleDtoList && data.roleDtoList.length > 0) {
		                    const accessibleRoles = Array.isArray(child.accessibleRoles) ? child.accessibleRoles : [];

		                    data.roleDtoList.forEach(role => {
		                        const isDisabled = (role.role_no === 1 || role.role_no === 2);
		                        const isChecked = accessibleRoles.some(ar => ar.role_no === role.role_no);

		                        html += `
		                            <div class="form-check form-check-inline">
		                                <input class="form-check-input"
		                                       type="checkbox"
		                                       name="role_no"
		                                       value="${role.role_no}"
		                                       data-func-no="${child.func_no}"
		                                       onchange="toggleFuncRole(this)"
		                                       ${isChecked ? 'checked' : ''}
		                                       ${isDisabled ? 'disabled' : ''}>
		                                <label class="form-check-label">${role.role_nickname}</label>
		                            </div>
		                        `;
		                    });
		                }

		                html += `</div>`;
		                li.innerHTML = html;
		                subList.appendChild(li);

		                // 이벤트 등록
		                li.querySelector('.func-item').addEventListener("click", function () {
		                    const funcNo = this.getAttribute("data-func-no");
		                    toggleCheckboxVisibility(funcNo);
		                });
		            });
		        } else {
		            const noneLi = document.createElement("li");
		            noneLi.classList.add("text-muted");
		            noneLi.innerHTML = `&nbsp;&nbsp;└ 하위 기능이 없습니다`;
		            subList.appendChild(noneLi);
		        }
		    })
		    .catch(error => {
		        console.log(error);
		    });
		}
		
		function toggleCheckboxVisibility(funcNo) {
		    const checkboxContainer = document.getElementById(`checkbox-container-${funcNo}`);
		    if (checkboxContainer) {
		        checkboxContainer.style.display = checkboxContainer.style.display === 'none' ? 'block' : 'none';
		    }
		}
	</script>
	
	<script>
		// 체크박스를 변경함에 따라 func_mapping 테이블에 인서트 or 딜리트 하는 로직
		function toggleFuncRole(checkbox) {
		    const roleNo = checkbox.value;
		    const funcNo = checkbox.getAttribute("data-func-no");
		    const isChecked = checkbox.checked;
		   	
		    fetch(`/admin/company/funcMapping/update`, {
		        method: 'post',
		        headers: {
					'Content-Type': 'application/json',
					'header': document.querySelector('meta[name="_csrf_header"]').content,
					'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content
				},
		        body: JSON.stringify({
		            func_no: funcNo,
		            role_no: roleNo,
		            is_checked: isChecked
		        })
		    })
		    .then(response => response.json())
		    .then(data => {
				// alert(data.res_msg);
				if (data.res_code === '200') {
					
				}
			})
		    .catch(error => {
		        console.log(error);
		    });
		}
	</script>
	
	<script>
		// 규칙 등록하는 로직
		const ruleForm = document.create_rule_form;
		ruleForm.addEventListener('submit',(event) => {
			event.preventDefault();
			
			const flagElement = document.querySelector('span[data-company-flag]'); // CompanyDto가 없을 때 문제 해결하기 위해 flag 하나 숨겨둠
		    if (flagElement && flagElement.getAttribute('data-company-flag') === 'true') {
		        alert('먼저 프로필을 등록해주세요.');
				
		        return;
		    }
			
			if(!confirm("규칙을 설정하시겠습니까?")) {
				return;
			} else {
				const payload = new FormData();
				
				payload.append('company_no', ruleForm.company_no.value);
				payload.append('company_initial', ruleForm.company_initial.value.trim().toLowerCase());
			    payload.append('rule_status', ruleForm.rule_status.checked ? 1 : 0);
			    
				fetch("/admin/company/rule/update", {
					method : "post",
					headers : {
						'header': document.querySelector('meta[name="_csrf_header"]').content,
						'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content
					},
					body : payload
				})
				.then(response => response.json())
				.then(data => {
					alert(data.res_msg);
					if(data.res_code == '200') {
						location.href = "/admin/company";
					}
				})
				.catch(error => {
					console.log(error);
				})
			}
		});
	</script>
	
	<script>
		// 컬러 칩을 선택하면 동작하는 로직 :: 색상이 테마 색상이 변경되며 <p>태그 문구가 바뀜
		document.querySelectorAll('.theme-option').forEach(option => {
			option.addEventListener('click', function () {
				const selectedTheme = this.getAttribute('data-theme');
				
				const flagElement = document.querySelector('span[data-flag]'); // CompanyDto가 없을 때 문제 해결하기 위해 flag 하나 숨겨둠
			    if (flagElement && flagElement.getAttribute('data-flag') === 'true') {
			        alert('먼저 프로필을 등록해주세요.');
					
			        return;
			    }
				
				if(!confirm('테마 색상을 변경하시겠습니까?')) {
					return;
				}
				
				document.getElementById('selected-theme').textContent = selectedTheme.substring(0, selectedTheme.indexOf('_'));
				
				fetch("/admin/company/color/update", {
					method: "post",
					headers: {
						'Content-Type': 'application/json',
						'header': document.querySelector('meta[name="_csrf_header"]').content,
						'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content
					},
	        		body: JSON.stringify({
	        			theme_color: selectedTheme
					})
				})
				.then(response => response.json())
				.then(data => {
					document.getElementById('selected-theme').textContent = data.res_theme_color.substring(0, selectedTheme.indexOf('_'));
					alert(data.res_msg);
					if (data.res_code === '200') {
						location.reload();
					}
				})
				.catch(error => {
	        		console.log(error);
	        	});

			});
		});
	</script>
	
	<script>
		// 선택된 컬러 강조하는 로직
		document.addEventListener("DOMContentLoaded", function () {
		    // 타임리프에서 현재 테마명 받아오기
		    const currentTheme = document.getElementById('selected-theme')?.textContent?.toLowerCase();
			
		    // 비교한 다음 클래스 부여
		    document.querySelectorAll('.theme-option').forEach(option => {
		      	const optionTheme = option.getAttribute('data-theme');
		      	const optionShort = optionTheme.substring(0, optionTheme.indexOf('_')).toLowerCase();
				
		      	if (optionShort === currentTheme) {
		        	option.classList.add('selected');
		    	}
			});
		});
	</script>
	
	<!-- ---------------------------------------------------------------------------- -->
	
	<!-- Custom JS Files -->
	
	
	
	<!-- Bootstrap Common JS Files Start -->
	
	<!-- Import vendorJs Files -->
	<script th:src="@{/assets/js/vendor.min.js}"></script>
	
  	<!-- Import Js Files -->
  	<script th:src="@{/assets/libs/bootstrap/dist/js/bootstrap.bundle.min.js}"></script>
  	<script th:src="@{/assets/libs/simplebar/dist/simplebar.min.js}"></script>
  	<script th:src="@{/assets/js/theme/app.init.js}"></script>
  	<script th:src="@{/assets/js/theme/theme.js}"></script>
  	<script th:src="@{/assets/js/theme/app.min.js}"></script>
  	<script th:src="@{/assets/js/theme/sidebarmenu.js}"></script>
	
  	<!-- solar icons -->
  	<script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>
  	<script th:src="@{/assets/libs/owl.carousel/dist/owl.carousel.min.js}"></script>
  	<script th:src="@{/assets/libs/apexcharts/dist/apexcharts.min.js}"></script>
  	<script th:src="@{/assets/js/dashboards/dashboard.js}"></script>
  	
  	<!-- Bootstrap Common JS Files End -->
  	
  	<!-- Custom JS Files -->
  	
  	<!-- Modal : 권한 생성 -->
	<div class="modal fade" id="roleAddModal" tabindex="-1" aria-labelledby="roleAddModalLabel" aria-hidden="true">
	  <div class="modal-dialog">
	    <div class="modal-content">
	      <div class="modal-header">
	        <h5 class="modal-title" id="roleAddModalLabel">권한 추가</h5>
	        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
	      </div>
	      	<form id="create_role_form" name="create_role_form" th:action="@{/admin/role/create}" method="post">
	        <!-- 폼 요소들 들어갈 자리 -->
	        	
	        	<!-- post 이므로 토큰 같이 실어보내줌 -->
	        	<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
	        	
	      		<div class="modal-body py-2 px-3">
			    	<div class="mb-3">
			        	<label for="role_nickname" class="form-label fw-normal">권한 이름 (예: 재무담당자, 인사담당자)</label>
			      		<input type="text" class="form-control" id="role_nickname" name="role_nickname" required>
			    	</div>
			    	<div class="mb-3">
			      		<label for="role_name" class="form-label fw-normal">권한 코드 (예: FINANCE, HUMANRESOURCE)</label>
			      		<input type="text" class="form-control" id="role_name" name="role_name" required>
			    	</div>
		    	<div class="modal-footer">
			        <button type="submit" class="btn btn-primary">추가</button>
			        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
			    </div>
	      	</div>
		  </form>
	    </div>
	  </div>
	</div>
	
	<!-- Modal : 권한 수정 -->
	<div class="modal fade" id="roleEditModal" tabindex="-1" aria-labelledby="roleEditModalLabel" aria-hidden="true">
	  <div class="modal-dialog">
	    <div class="modal-content">
	      <div class="modal-header">
	        <h5 class="modal-title" id="roleEditModalLabel">권한 수정</h5>
	        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
	      </div>
	      <form id="edit_role_form" name="edit_role_form" th:action="@{/admin/role/update}" method="post">
	        <!-- post 이므로 토큰 같이 실어보냄 -->
	        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
	        <input type="hidden" id="edit_role_no" name="role_no" />
			
	        <div class="modal-body py-2 px-3">
	          <div class="mb-3">
	            <label for="edit_role_nickname" class="form-label fw-normal">권한 이름 (예: 재무담당자, 인사담당자)</label>
	            <input type="text" class="form-control" id="edit_role_nickname" name="role_nickname" required>
	          </div>
	          <div class="mb-3">
	            <label for="edit_role_name" class="form-label fw-normal">권한 코드 (예: FINANCE, HUMANRESOURCE)</label>
	            <input type="text" class="form-control" id="edit_role_name" name="role_name" required>
	          </div>
	          <div class="modal-footer">
	            <button type="submit" class="btn btn-primary">수정</button>
	            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
	          </div>
	        </div>
	      </form>
	    </div>
	  </div>
	</div>
	
	<script>
		function openEditModal(button) {
		  // 수정 버튼을 클릭하는 시점에서 th:attr 의 값을 가져옴
		  const role_no = button.dataset.roleNo;
		  const role_nickname = button.dataset.roleNickname;
		  const role_name = button.dataset.roleName;
		  
		  // 수정 모달의 각 입력 필드에 값을 채움
		  document.getElementById('edit_role_no').value = role_no;
		  document.getElementById('edit_role_nickname').value = role_nickname;
		  document.getElementById('edit_role_name').value = role_name.substring(5);

		  // 모달을 띄워줌
		  const modal = new bootstrap.Modal(document.getElementById('roleEditModal'));
		  modal.show();
		}
	</script>
	
	<!-- Modal: 권한 삭제 -->
	<div class="modal fade" id="roleDeleteModal" tabindex="-1" aria-labelledby="roleDeleteModalLabel" aria-hidden="true">
	  <div class="modal-dialog">
	    <div class="modal-content">
	      <form id="delete_role_form" th:action="@{/admin/role/delete}" method="post">
	        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
	        <input type="hidden" id="delete_role_no" name="role_no" />
	
	        <div class="modal-header">
	          <h5 class="modal-title" id="roleDeleteModalLabel">
	          	<i class="fas fa-exclamation-triangle me-2"></i>권한 삭제
	          </h5>
	          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
	        </div>
	        <div class="modal-body py-2 px-3">
	          선택한 권한은 삭제되며,<br>
	          해당 권한을 가진 사원은 일반사원(USER) 권한으로 전환됩니다.<br>
			  정말 삭제하시겠습니까?
	        </div>
	        <div class="modal-footer">
	          <button type="submit" class="btn btn-danger">삭제</button>
	          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
	        </div>
	      </form>
	    </div>
	  </div>
	</div>
	
	<script>
		function openDeleteModal(button) {
			const roleNo = button.dataset.roleNo;
		  	document.getElementById('delete_role_no').value = roleNo;
		  	
		  	const modal = new bootstrap.Modal(document.getElementById('roleDeleteModal'));
		  	modal.show();
		}
	</script>
	
	<!-- Modal for alert : alert 형태로 메시지 출력 -->
	<div class="modal fade" id="alertModal" tabindex="-1" aria-labelledby="alertModalLabel" aria-hidden="true">
	  <div class="modal-dialog">
	    <div class="modal-content">
	      <div class="modal-header py-2 px-3">
	        <h5 class="modal-title m-0 d-flex align-items-center" id="alertModalLabel">
	        	<i class="fas fa-exclamation-triangle me-2"></i>처리 결과
	        </h5>
	        <button type="button" class="btn-close ms-2" data-bs-dismiss="modal" aria-label="닫기"></button>
	      </div>
	      <div class="modal-body">
	        <span th:text="${res_msg}">처리 메시지</span>
	      </div>
	      <div class="modal-footer">
	        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
	      </div>
	    </div>
	  </div>
	</div>
	
	<th:block th:if="${res_msg}">
	  <script>
	    var alertModal = new bootstrap.Modal(document.getElementById('alertModal'), {
	      keyboard: false
	    });
	    alertModal.show();
	  </script>
	</th:block>
  	
</th:block>
</html>