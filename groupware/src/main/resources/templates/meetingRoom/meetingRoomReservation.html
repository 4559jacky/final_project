<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{include/layout :: layout}">
<th:block layout:fragment="content">
	<link th:href="@{/css/ysw.css}" rel="stylesheet">
	<script th:src="@{/js/jquery-3.7.1.js}"></script>
	<link rel="stylesheet"
		href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css" />
	<script th:src="@{/js/ysw/jstree.js}"></script>
	<div class="col-lg-8 col-md-6 col-12 align-self-center">
		<nav aria-label="breadcrumb">
			<ol class="breadcrumb align-items-center">
				<li class="breadcrumb-item"><a
					class="text-muted text-decoration-none" th:href="@{/home}"> <i
						class="ti ti-home fs-5"></i>
				</a></li>
				<li class="breadcrumb-item" aria-current="page">íšŒì˜ì‹¤ ì˜ˆì•½</li>
			</ol>
		</nav>
		<br>
		<h2 class="mb-0 fw-bolder fs-8">íšŒì˜ì‹¤ ì˜ˆì•½</h2>
	</div>
	<br>

	<div class="card">
		<div class="card-body calender-sidebar app-calendar">
			<div id="calendar"></div>
		</div>
	</div>

	<!-- BEGIN MODAL -->
	<div class="modal fade" id="eventModal" tabindex="-1"
		aria-labelledby="eventModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-scrollable modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="eventModalLabel">Add / Edit Event
					</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<div class="row">
						<div class="col-md-12">
							<div>
								<label class="form-label">Event Title</label> <input
									id="event-title" type="text" class="form-control" />
							</div>
						</div>
						<div class="col-md-12 mt-6">
							<div>
								<label class="form-label">Event Color</label>
							</div>
							<div class="d-flex">
								<div class="n-chk">
									<div class="form-check form-check-primary form-check-inline">
										<input class="form-check-input" type="radio"
											name="event-level" value="Danger" id="modalDanger" /> <label
											class="form-check-label" for="modalDanger">Danger</label>
									</div>
								</div>
								<div class="n-chk">
									<div class="form-check form-check-warning form-check-inline">
										<input class="form-check-input" type="radio"
											name="event-level" value="Success" id="modalSuccess" /> <label
											class="form-check-label" for="modalSuccess">Success</label>
									</div>
								</div>
								<div class="n-chk">
									<div class="form-check form-check-success form-check-inline">
										<input class="form-check-input" type="radio"
											name="event-level" value="Primary" id="modalPrimary" /> <label
											class="form-check-label" for="modalPrimary">Primary</label>
									</div>
								</div>
								<div class="n-chk">
									<div class="form-check form-check-danger form-check-inline">
										<input class="form-check-input" type="radio"
											name="event-level" value="Warning" id="modalWarning" /> <label
											class="form-check-label" for="modalWarning">Warning</label>
									</div>
								</div>
							</div>
						</div>

						<div class="col-md-12 mt-6">
							<div>
								<label class="form-label">Enter Start Date</label> <input
									id="event-start-date" type="date" class="form-control" />
							</div>
						</div>

						<div class="col-md-12 mt-6">
							<div>
								<label class="form-label">Enter End Date</label> <input
									id="event-end-date" type="date" class="form-control" />
							</div>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn bg-danger-subtle text-danger"
						data-bs-dismiss="modal">Close</button>
					<button type="button" class="btn btn-success btn-update-event"
						data-fc-event-public-id="">Update changes</button>
					<button type="button" class="btn btn-primary btn-add-event">
						Add Event</button>
				</div>
			</div>
		</div>
	</div>

	<!-- íšŒì˜ì‹¤ ì˜ˆì•½ ëª¨ë‹¬ì°½ -->
	<div class="modal fade" id="dateInfoModal" tabindex="-1">
		<div class="modal-dialog modal-dialog-centered"
			style="max-width: 800px; width: auto; max-height: none;">
			<div class="modal-content p-3" style="max-height: none;">
				<div class="modal-header">
					<h5 class="modal-title" style="font-weight: bold; color: black;">
						íšŒì˜ì‹¤ ì˜ˆì•½ [<span id="selected-date-text"></span>]
					</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body" style="overflow-y: visible;">
					<form name="meetingRoom_title_form">
						<label for="createMeetingRoomTitle" class="form-label">ë“±ë¡í•  íšŒì˜ëª…</label> 
						<input type="text" class="form-control" id="meetingRoomTitle" name="new_meeting_room_name"
							style="color: black;" placeholder="ë“±ë¡í•˜ì‹¤ íšŒì˜ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."><br>

						<p style="color: gray;">ì˜ˆì•½í•˜ì‹¤ íšŒì˜ì‹¤ê³¼ ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”. (ì‹œê°„ì€ í•œì‹œê°„ ë‹¨ìœ„ë¡œì„ íƒë©ë‹ˆë‹¤.)</p>
						<input type="hidden" id="roomNo" name="roomNo">
						<input type="hidden" id="selectDate" name="selectDate">

						<!-- ë²„íŠ¼ì´ ë§ì•„ì§ˆ ê²½ìš° ì¤„ë°”ê¿ˆë˜ë©´ì„œ ìì—°ìŠ¤ëŸ½ê²Œ ì•„ë˜ë¡œ ëŠ˜ì–´ë‚©ë‹ˆë‹¤ -->
						<div id="meeting-room-buttons" class="d-flex flex-wrap gap-2 my-3"
							style="justify-content: start;"></div>

						<div id="meeting-time-buttons"
							class="d-flex flex-wrap gap-2 my-3"
							style="justify-content: start;"></div>

						<div class="text-end">
							<button type="submit" class="btn btn-primary">ë‹¤ìŒ</button>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>

	<!-- íšŒì˜ì‹¤ ì˜ˆì•½ ëª¨ë‹¬ ì°½ - ì¸ì›ì„ íƒ -->
	<div class="modal fade" id="selectMemberModal" tabindex="-1">
		<div class="modal-dialog modal-dialog-centered"
			style="max-width: 800px; width: auto; max-height: none;">
			<div class="modal-content p-3" style="max-height: none;">
				<div class="modal-header">
					<h5 class="modal-title fw-bold fs-4"> íšŒì˜ì‹¤ ì˜ˆì•½ </h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<!-- ìƒë‹¨: ì¡°ì§ë„ + ì‚¬ì› ëª©ë¡ -->
					<div class="row mb-4" style="height: 280px;">
						<p style="color: gray;">íšŒì˜ì— ì°¸ì„í•  ì¸ì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
						<!-- ì¡°ì§ë„ -->
						<div class="col-6 pe-3 border-end d-flex flex-column">
							<h6 class="fw-semibold mb-2">ì¡°ì§ë„</h6>
							<div id="ysw_create_jstree"
								class="ps-2 h-100 overflow-auto border rounded bg-light p-2">
								<!-- JSTree ì˜ì—­ -->
							</div>
						</div>

						<!-- ì‚¬ì› ëª©ë¡ -->
						<div class="col-6 ps-3 d-flex flex-column">
							<h6 class="fw-semibold mb-2">ì„ íƒí•œ ë¶€ì„œì˜ ì‚¬ì› ëª©ë¡</h6>
							<div id="memberListBox"
								class="h-100 overflow-auto border rounded bg-light p-2" style="max-height: 280px;">
								<!-- âœ… ìŠ¤í¬ë¡¤ ì˜ì—­ ê³ ì • ë†’ì´ ì„¤ì • -->
								<ul id="memberList" class="list-group fs-6 mb-0"></ul>
							</div>
						</div>
					</div><br><br>
		
					<!-- í•˜ë‹¨: ì„ íƒëœ ì¸ì›, ì²«ë²ˆì¨° ëª¨ë‹¬ì°½ì˜ ì •ë³´ -->
					<form name="meetingRoom_reservation_form">
						<input type="hidden" id="meetingTitle" name="meeting_title">
						<input type="hidden" id="meetingDate" name="meeting_date">
						<input type="hidden" id="meetingRoomNo" name="meeting_room_no">
						<input type="hidden" id="meetingRoomNo" name="meeting_room_no">
						<input type="hidden" id="reservationStatus" name="reservation_status" value="Y">
						<br><br>
						<div id="selectedUsersInputs"></div>
						<div class="row gx-3 text-center" style="height: 200px;">
							<div id="selectMemberListBox" class="h-100 overflow-auto border rounded bg-light p-2">
								<ul id="selectMemberList" class="list-group fs-6"></ul>	
							</div>
						</div>
						<div class="modal-footer justify-content-end">
							<button type="submit" class="btn btn-primary px-4">íšŒì˜ì‹¤ ì˜ˆì•½</button>
						</div><bR>
					</form>
				</div>
			</div>
		</div>
	</div>
	
	<div class="table-wrapper p-4 bg-white rounded-4 shadow-sm">
		<h5 class="card-title" style="font-weight: bold;">ë‚˜ì˜ íšŒì˜ì‹¤ ì˜ˆì•½ ë‚´ì—­</h5>
		<br>
		<div class="table-responsive">
			<div class="d-flex justify-content-end align-items-center mb-3 gap-5">
				<!-- íšŒì˜ì‹¤ë³„ ì¡°íšŒ -->
				<div class="d-flex align-items-center gap-2">
					<label for="roomSelect" class="form-label mb-0 fw-bold">íšŒì˜ì‹¤ ì„ íƒ</label> 
					<select id="roomSelect" class="form-select filter_btn" style="width: 200px; height: 36px;">
						<option value="">ì „ì²´</option>
						<th:block th:each="room:${meetingRoomList}">
							<th:block th:if="${room.meetingRoomStatus == 'Y'}">
								<option th:value="${room.meetingRoomNo}" th:text="${room.meetingRoomName}">íšŒì˜ì‹¤ëª…</option>
							</th:block>
							<th:block th:if="${room.meetingRoomStatus == 'N'}">
								<option th:value="${room.meetingRoomNo}" th:text="${room.meetingRoomName}">íšŒì˜ì‹¤ëª…</option>
							</th:block>
							<th:block th:if="${room.meetingRoomStatus == 'D'}">
								<option th:value="${room.meetingRoomNo}" th:text="${room.meetingRoomName}">íšŒì˜ì‹¤ëª…</option>
							</th:block>
						</th:block>
						<!-- í•„ìš”í•œ íšŒì˜ì‹¤ ì˜µì…˜ ì¶”ê°€ -->
					</select>
				</div>
				<!-- ë‚ ì§œë³„ ì¡°íšŒ -->
				<div class="d-flex align-items-center gap-2">
					<label for="dateSelect" class="form-label mb-0 fw-bold">ë‚ ì§œ ì„ íƒ</label> 
					<input type="date" id="dateSelect" class="form-control filter_btn" style="width: 200px; height: 36px;">
				</div>
			</div>
			<input type="hidden" id="loginMemberNo" th:value="${#authentication.principal.member.memberNo}">
			<table class="table align-middle text-center" id="myReservationTable">
				<thead class="bg-light">
					<tr>
						<th>íšŒì˜ì‹¤</th>
						<th>íšŒì˜ëª…</th>
						<th>ì‚¬ìš©ì</th>
						<th>ë‚ ì§œ</th>
						<th>ì‹œê°„</th> 
						<th>ì˜ˆì•½ ìƒíƒœ</th>
					</tr>
				</thead>
				<tbody id="reservation-body">
				    <tr th:each="list : ${reservationList}"
				        th:if="${#lists.contains(list.member_no, #authentication.principal.member.memberNo)}"
				        class="reservation-row">
				        <td th:text="${list.meeting_room_name}">íšŒì˜ì‹¤</td>
				        <td th:text="${list.meeting_title}">íšŒì˜ëª…</td>
				        <td th:text="${#strings.listJoin(list.member_name, ', ')}">íšŒì˜ì¸ì›</td>
				        <td th:text="${list.meeting_date}">ë‚ ì§œ</td>
				        <td th:text="${#strings.listJoin(list.meeting_start_time, ', ')}">íšŒì˜ì‹œì‘ ì‹œê°„</td>
				        <td>
				            <!-- ì·¨ì†Œ ê°€ëŠ¥: ìƒíƒœ Y + ì‹œê°„ì´ ì•ˆ ì§€ë‚¨ -->
					        <button type="button" class="btn bg-danger-subtle text-danger px-3 py-1 cancel_btn"
					            th:if="${list.reservation_status == 'Y' and 
					                    T(java.time.LocalDateTime).of(list.meeting_date, list.meeting_start_time[0])
					                        .isAfter(T(java.time.LocalDateTime).now())}"
					            th:attr="data-id=${list.reservation_no}">ì˜ˆì•½ ì·¨ì†Œ</button>
					
					        <!-- ì·¨ì†Œ ë¶ˆê°€: ìƒíƒœ Y + ì‹œê°„ì´ ì§€ë‚¨ -->
					        <button type="button" class="btn btn-rounded btn-light px-3 py-1"
					            th:if="${list.reservation_status == 'Y' and 
					                    T(java.time.LocalDateTime).of(list.meeting_date, list.meeting_start_time[0])
					                        .isBefore(T(java.time.LocalDateTime).now())}"
					            disabled>ì·¨ì†Œ ë¶ˆê°€</button>
					
					        <!-- ì·¨ì†Œ ì™„ë£Œ -->
					        <button type="button" class="btn bg-danger-subtle text-danger px-3 py-1"
					            th:if="${list.reservation_status == 'N'}"
					            disabled>ì·¨ì†Œ ì™„ë£Œ</button>
				        </td>
				    </tr>
				
				    <!-- ì•„ë¬´ íšŒì˜ë„ ì—†ì„ ê²½ìš° -->
				    <tr id="no-reservation-row">
				        <td colspan="6" class="text-center">íšŒì˜ì‹¤ ì˜ˆì•½ ëª©ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td>
				    </tr>
				</tbody>
			</table>
		</div>
	</div>
	
	<script>
		const form = document.meetingRoom_title_form;
		const input = document.getElementById("meetingRoomTitle");
		
		
		// ë‚ ì§œ í´ë¦­ì‹œ íšŒì˜ì‹¤ ì„ íƒ ëª¨ë‹¬ì°½ ë„ì›€
		var calendarSelect = function (info) {
			const selectedDateText = document.getElementById("selected-date-text");
			const selectedDateInput = document.getElementById("selectDate");
			// ëª¨ë‹¬ì°½ì— ë‚ ì§œ í‘œì‹œ 
			selectedDateText.innerText = info.startStr;
			// inputì— ë‚ ì§œ ì €ì¥ 
			selectedDateInput.value = info.startStr;
			
			
			// ì´ë¯¸ ì§€ë‚œ ë‚ ì§œë©´ ë¦¬í„´í•´ì„œ ëª¨ë‹¬ ì•ˆ ëœ¨ê²Œ
			const selectedDate = new Date(info.startStr);
			const today = new Date();
			today.setHours(0, 0, 0, 0); // ì˜¤ëŠ˜ ìì • ê¸°ì¤€
	
			if (selectedDate < today) {
				return;
			}
	
			// íšŒì˜ì‹¤ ì¡°íšŒ 
			const payload = new URLSearchParams();
			payload.append("date", info.startStr);
	
			fetch("/selectMeetingRoom", {
				method: "POST",
				headers: {
					'Content-Type': 'application/x-www-form-urlencoded',
					'header': document.querySelector('meta[name="_csrf_header"]').content,
					'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content
				},
				body: payload
			})
			.then(response => response.json())
			.then(data => {
				MeetingRoomButtons(data);
			});
			
			// íšŒì˜ì‹¤ ì˜ˆì•½ ì‹œê°„ ì¡°íšŒ 
		    
	
			// íšŒì˜ì‹¤ ì„ íƒ ëª¨ë‹¬ ë³´ì—¬ì¤Œ
			const dateInfoModal = new bootstrap.Modal(document.getElementById("dateInfoModal"));
			dateInfoModal.show();
		};
		
		// íšŒì˜ì‹¤ ë²„íŠ¼ ì¶”ê°€, íšŒì˜ì‹¤ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹œê°„ ë²„íŠ¼ ì¶”ê°€ 
		function MeetingRoomButtons(meetingRoom) {
			// btn ì¶”ê°€í•  ê³³
			const container = document.getElementById("meeting-room-buttons");
			const timeContainer = document.getElementById("meeting-time-buttons");
			
			container.innerHTML = ""; // ì´ˆê¸°í™”
			timeContainer.innerHTML = "";
			
			// íšŒì˜ì‹¤ ë²„íŠ¼ ì¶”ê°€ 
			meetingRoom.forEach(room => {
				
				if(room.meetingRoomStatus != 'D'){ // ì‚­ì œë˜ì§€ ì•Šì€ íšŒì˜ì‹¤
					const btn = document.createElement("button");
					btn.type = "button";
					btn.textContent = room.meetingRoomName;
					btn.setAttribute("data-room-id", room.meetingRoomNo);
					btn.setAttribute("data-room-status", room.meetingRoomStatus);
			
					if(room.meetingRoomStatus == 'Y'){ // ì‚¬ìš© ê°€ëŠ¥í•œ íšŒì˜ì‹¤
						btn.className = "btn bg-primary-subtle text-primary";
					}else if(room.meetingRoomStatus == 'N'){ // ì‚¬ìš© ë¶ˆê°€ëŠ¥í•œ íšŒì˜ì‹¤
						btn.className = "btn btn-rounded btn-light"; 
						btn.disabled = true;
					}
					
					// ë²„íŠ¼ ì¶”ê°€ 
					container.appendChild(btn);
					
					// íšŒì˜ì‹¤ ë²„íŠ¼ í´ë¦­ ì‹œ inputì— íšŒì˜ì‹¤ roomNo ë‹´ì•„ì¤Œ
					btn.addEventListener("click", function () {
						const selectRoomNo = this.dataset.roomId;

						document.getElementById("roomNo").value = selectRoomNo;
					});
					
					// íšŒì˜ì‹¤ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹œê°„ ë²„íŠ¼ ì¶”ê°€ 
					btn.addEventListener("click", () => {
						 // ëª¨ë“  íšŒì˜ì‹¤ ë²„íŠ¼ ì´ˆê¸°í™”
					    container.querySelectorAll("button[data-room-id]").forEach(b => {
							if (b.getAttribute("data-room-status") === 'Y') {
								b.className = "btn bg-primary-subtle text-primary";
								b.classList.add("selected");
							}
						}); 
					    // í´ë¦­ëœ ë²„íŠ¼ë§Œ primary ìŠ¤íƒ€ì¼ + ë¹„í™œì„±í™” ì²˜ë¦¬
					    btn.className = "btn btn-primary";
					    
					    // ê¸°ì¡´ ì‹œê°„ ë²„íŠ¼ ì´ˆê¸°í™”
					    timeContainer.innerHTML = "";
					    
					    // ë‚ ì§œë‘ íšŒì˜ì‹¤ ì •ë³´ ë¶ˆëŸ¬ì˜´
					    const selectedDate = document.getElementById("selectDate").value;
					    const meetingRoomNo = document.getElementById("roomNo").value;
					    
					    // í•´ë‹¹ íšŒì˜ì‹¤ ì˜ˆì•½ ë‚´ì—­ ì¡°íšŒ  
						fetch("/reservationInfo", {
						    	  method: 'POST',
						    	  headers: {
						    		  'Content-Type':'application/json',
						    	    [document.querySelector('meta[name="_csrf_header"]').content]:
						    	      document.querySelector('meta[name="_csrf"]').content
						    	  },
						    	  body: JSON.stringify({
								    		meetingRoomNo:meetingRoomNo,
								    		selectedDate:selectedDate
										})
						    	  })
						.then(response => response.json())
						.then(data => {
						    const timeList = [
						        "09:00", "10:00", "11:00", "12:00",
						        "13:00", "14:00", "15:00", "16:00", "17:00"
						    ];

						    const reservedTimeList = [];

						    // âœ… ì‹œê°„ë§Œ ë¹„êµ
						   for (let i = 0; i < data.length; i++) {
							    const item = data[i];
							
							    if (Array.isArray(item.meeting_start_time)) {
							        const times = item.meeting_start_time.map(time => time.substring(0, 5));
							        reservedTimeList.push(...times);
							    } else if (typeof item.meeting_start_time === "string") {
							        reservedTimeList.push(item.meeting_start_time.substring(0, 5));
							    }
							}

	    
						// í˜„ì¬ ë‚ ì§œì™€ ì‹œê°„ ì²´í¬
						   const now = new Date();
						   const todayStr = now.toISOString().slice(0, 10); // yyyy-MM-dd
						   const currentHour = now.getHours();

						   // ë²„íŠ¼ ë§Œë“¤ê¸° (ì˜ˆì•½ëœ ì‹œê°„ + í˜„ì¬ ì‹œê°„ ì´ì „ì´ë©´ ë¹„í™œì„±í™”)
						   let timeButtons = "";
						   for (let i = 0; i < timeList.length; i++) {
						       const time = timeList[i];
						       const hour = parseInt(time.split(":")[0]);

						       const isPastTime = selectedDate === todayStr && hour <= currentHour;
						       const isReserved = reservedTimeList.includes(time);

						       if (isPastTime || isReserved) {
						           timeButtons += `<button type="button" class="btn btn-rounded btn-light" disabled>${time}</button>`;
						       } else {
						           timeButtons += `<button type="button" class="btn bg-primary-subtle text-primary" data-time="${time}">${time}</button>`;
						       }
						   }


						    timeContainer.innerHTML = timeButtons;

						    // ì„ íƒ ë²„íŠ¼ ì´ë²¤íŠ¸
						    const clickableButtons = timeContainer.querySelectorAll("button[data-time]");
						    for (let i = 0; i < clickableButtons.length; i++) {
						        const timeBtn = clickableButtons[i];

						        timeBtn.addEventListener("click", () => {
						            timeBtn.classList.toggle("btn-primary");
						            timeBtn.classList.toggle("bg-primary-subtle");
						            timeBtn.classList.toggle("text-primary");
						            timeBtn.classList.toggle("selected");
						        });
						    }
						});


					});
				}		
			});
			
		}
		
		
		// ëª¨ë“  htmlì´ ìˆì„ ë•Œ ì‹¤í–‰
		// ì²«ë²ˆì¨° ëª¨ë‹¬ì°½ì˜ ì •ë³´ë¥¼ ê°€ì§€ê³  ë‘ë²ˆì¨° ëª¨ë‹¬ì°½ ë³´ì—¬ì¤Œ 
		document.addEventListener("DOMContentLoaded", () => {
			const input = document.getElementById("meetingRoomTitle");

			// form ì´ë²¤íŠ¸ëŠ” ì—¬ê¸° í•œ ë²ˆë§Œ ë“±ë¡
			form.addEventListener("submit", (e) => {
				e.preventDefault();

				// ì„ íƒëœ ë²„íŠ¼ ì°¾ìŒ 
				const selectRoomBtn = document.querySelector("#meeting-room-buttons button.selected");
				const selectTimeBtn = document.querySelectorAll("#meeting-time-buttons button.selected");

				//ìœ íš¨ì„± ê²€ì‚¬ 
				if (!form.meetingRoomTitle.value) {
					input.classList.add("is-invalid");
					setTimeout(() => input.classList.remove("is-invalid"), 2000);
					return;
				}
				if (!selectRoomBtn || selectTimeBtn.length === 0) {
					alert("íšŒì˜ì‹¤ê³¼ ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
					return;
				}

				
				const meetingtitle = form.meetingRoomTitle.value;
				const meetingRoomNo = form.roomNo.value;
				const meetingTimes = [...selectTimeBtn].map(btn => btn.getAttribute("data-time"));
				const meetingDate = form.selectDate.value;

				// ì •ë³´ë¥¼ form ì•ˆì— ì €ì¥
				document.querySelector("#meetingTitle").value = meetingtitle;
				document.querySelector("#meetingRoomNo").value = meetingRoomNo;
				document.querySelector("#meetingDate").value = meetingDate;
				
				// ì´ˆê¸°í™” ëª¨ë‹¬ ìƒˆë¡œ ì—´ë¦´ë•Œë¥¼ ë°©ì§€ 
				document.querySelectorAll("input[name='meetingTimes']").forEach(el => el.remove());
				
				meetingTimes.forEach(time => {
				    const input = document.createElement("input");
				    input.type = "hidden";
				    input.name = "meeting_start_time";
				    input.value = time;
				    document.forms["meetingRoom_reservation_form"].appendChild(input);
				});

				console.log(meetingtitle, meetingRoomNo, meetingTimes, meetingDate);

				
				// ìƒˆ ëª¨ë‹¬ ë³´ì—¬ì£¼ê¸°
				const nextModal = new bootstrap.Modal(document.getElementById("selectMemberModal"));
			    nextModal.show();
			    
			    const currentModal = bootstrap.Modal.getInstance(document.getElementById("dateInfoModal"));
			    currentModal.hide();

			});
		});
		
		// íšŒì˜ ì˜ˆì•½ ì¸ì› ì„ íƒ
		document.addEventListener("DOMContentLoaded",function(){
			const selectBtn = document.querySelectorAll(".selectBtn");
			const selectUserList = document.getElementById("selectMemberList");
			const selectedUsersInputs = document.getElementById("selectedUsersInputs");

			
			document.addEventListener("click", function (e) {
			    if (e.target.classList.contains("selectBtn")) {
			        const memberNo = e.target.getAttribute("data-id");
			        const memberName = e.target.getAttribute("data-name");
			        const memberPos = e.target.getAttribute("data-pos");
			        
			        // ì¤‘ë³µ ë°©ì§€ 
			        const result = Array.from(selectUserList.querySelectorAll("input[data-id]"))
		                .some(input => input.getAttribute("data-id") === memberNo);
	
		            if (result) {
		                return;
		            }
			        
			        const li = document.createElement("li");
			        li.className = "list-group-item";
			        li.innerHTML = `
					    <input 
					        type="button" 
					        value="-"  
					        data-id="${memberNo}" 
					        class="deleteBtn btn-sm btn btn-rounded btn-light">
					    ${memberName} (${memberPos})
					`;

					    
			     // í•¨ê»˜ ìˆ¨ì€ input ìƒì„±
			        const hiddenInput = document.createElement("input");
			        hiddenInput.type = "hidden";
			        hiddenInput.name = "member_no"; // ë°±ì—”ë“œì—ì„œ ì´ nameìœ¼ë¡œ ë°›ì•„ìš”!
			        hiddenInput.value = memberNo;
			        hiddenInput.setAttribute("data-id", memberNo);

			        // ë¦¬ìŠ¤íŠ¸ì™€ ìˆ¨ì€ input ì¶”ê°€
			        selectUserList.appendChild(li);
			        selectedUsersInputs.appendChild(hiddenInput);
			        
			    }
			});
			
		});
		

		// íšŒì˜ì‹¤ ì˜ˆì•½ ì¸ì› ì‚­ì œ 
		document.addEventListener("DOMContentLoaded",function(){
			document.addEventListener("click", function (e) {
			    if (e.target.classList.contains("deleteBtn")) {
			    	  const memberNo = e.target.getAttribute("data-id"); // ğŸ‘ˆ ì‚­ì œ ëŒ€ìƒ ID
			            const li = e.target.closest("li");
			            if (li) li.remove();

			            // í•´ë‹¹ memberNoë¥¼ ê°€ì§„ hidden input ì‚­ì œ
			            const hiddenInput = document.querySelector(`#selectedUsersInputs input[data-id='${memberNo}']`);
			            if (hiddenInput) hiddenInput.remove();
			    }
			});
			
		});
		
		
		
		// íšŒì˜ì‹¤ ì˜ˆì•½ ë²„íŠ¼ í´ë¦­ ì‹œ ì •ë³´ ì €ì¥ 
		const lastForm = document.meetingRoom_reservation_form;
		
		lastForm.addEventListener('submit',(e) => {
			e.preventDefault()
			
			const selectedInputs = document.querySelectorAll("#selectedUsersInputs input[name='member_no']");

			if (selectedInputs.length === 0) {
			    alert("íšŒì˜ì— ì°¸ì„í•  ì¸ì›ì„ 1ëª… ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.");
			    return;
			}
			
			const payload = new FormData(lastForm);
			fetch("/reservation",{
				method:'post',
				headers : {
					'header': document.querySelector('meta[name="_csrf_header"]').content,
	              	'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content
				},
				body:payload,
			})
			.then(response => response.json())
			.then(data => {
				alert(data.res_msg);
				if (data.res_code == "200") {
					location.reload();
				}
			});
			
		})
		
		
		// íšŒì˜ì‹¤ ë“±ë¡ ëª¨ë‹¬ì°½ ë¦¬ì…‹
		const modal = document.getElementById('dateInfoModal');
		modal.addEventListener('hidden.bs.modal', () => {
			form.reset();
		});
		
		// íšŒì˜ì‹¤ ì¸ì› ì„ íƒ ëª¨ë‹¬ì°½ ë¦¬ì…‹
		document.getElementById("selectMemberModal").addEventListener("hidden.bs.modal", () => {
			document.getElementById("selectMemberList").innerHTML = "";

		    // ìˆ¨ê²¨ì§„ input ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”
		    selectedUsersInputs.innerHTML = "";
		});
			
		
		// ë‚´ íšŒì˜ì‹¤ ì˜ˆì•½ ë‚´ì—­ ì¡°íšŒ í•„í„°
		document.addEventListener("DOMContentLoaded", function () {
		    const filters = document.getElementsByClassName("filter_btn");
	
		    for (let i = 0; i < filters.length; i++) {
		      filters[i].addEventListener("change", function () {
		    	const memberNo = document.getElementById("loginMemberNo").value;
		        const roomNo = document.getElementById("roomSelect").value;
		        const date = document.getElementById("dateSelect").value;
		        console.log(roomNo, date, memberNo);
		        
		        fetch("/selectFilter", {
		        	  method: 'POST',
		        	  headers: {
		        		  'Content-Type':'application/json',
		        	    [document.querySelector('meta[name="_csrf_header"]').content]:
		        	      document.querySelector('meta[name="_csrf"]').content
		        	  },
		        	  body: JSON.stringify({
							roomNo:roomNo,
							date:date,
							memberNo:memberNo
						})
		        	})
		        	  .then(response => response.json())
		        	  .then(data => {
		        		  const tbody = document.querySelector("#myReservationTable tbody");
		                  tbody.innerHTML = ""; // âœ… ì´ˆê¸°í™”ëŠ” ì—¬ê¸°ì„œ!

		                  if (data.length === 0) {
		                    const emptyRow = document.createElement("tr");
		                    emptyRow.innerHTML = `
		                      <td colspan="6" class="text-center">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
		                    `;
		                    tbody.appendChild(emptyRow);
		                    return;
		                  }

		                  data.forEach(list => {
		                    const tr = document.createElement("tr");

		                    tr.innerHTML = `
		                    	  <td>${list.meeting_room_name}</td>
		                    	  <td>${list.meeting_title}</td>
		                    	  <td>${Array.isArray(list.member_name) ? list.member_name.join(", ") : ''}</td>
		                    	  <td>${list.meeting_date}</td>
		                    	  <td>${Array.isArray(list.meeting_start_time) 
		                    	        ? list.meeting_start_time.map(time => time.slice(0, 5)).join(", ") 
		                    	        : ''}</td>
		                    	  <td>
		                    	    ${list.reservation_status === 'Y'
		                    	      ? isFuture(list.meeting_date, list.meeting_start_time[0])
		                    	        ? `<button type="button" class="btn bg-danger-subtle text-danger px-3 py-1 cancel_btn" data-id="${list.reservation_no}">ì˜ˆì•½ ì·¨ì†Œ</button>`
		                    	        : `<button type="button" class="btn btn-rounded btn-light px-3 py-1" disabled>ì·¨ì†Œ ë¶ˆê°€</button>`
		                    	      : `<button type="button" class="btn bg-danger-subtle text-danger px-3 py-1" disabled>ì·¨ì†Œ ì™„ë£Œ</button>`
		                    	    }
		                    	  </td>
		                    	`;


		                    tbody.appendChild(tr);
		        		  })
		        	  });
		      });
		    }
		  });
		
		// íšŒì˜ì‹¤ ì˜ˆì•½ ë‚´ì—­ ëª©ë¡ ê°œìˆ˜ 
		document.addEventListener("DOMContentLoaded", function () {
	        const reservationRows = document.querySelectorAll(".reservation-row");
	        const noDataRow = document.getElementById("no-reservation-row");
	
	        if (reservationRows.length > 0) {
	            noDataRow.style.display = "none";
	        } else {
	            noDataRow.style.display = "";
	        }
	    });
		
		// ì·¨ì†Œ ì‹œê°„ ë¹„êµ í•¨ìˆ˜
		function isFuture(dateStr, timeStr) {
		  const now = new Date();
		  const dateTime = new Date(`${dateStr}T${timeStr}`);
		  return dateTime > now;
		}

	
		// íšŒì˜ì‹¤ ì˜ˆì•½ ì·¨ì†Œ cancel_btn
		document.addEventListener("DOMContentLoaded", function () {
		    const tbody = document.querySelector("#myReservationTable tbody");
		
		    tbody.addEventListener("click", function (e) {
		        const btn = e.target.closest(".cancel_btn");
		        if (btn) {
		        	  const reservationNo = btn.getAttribute("data-id");

		        	  async function cancelReservation(reservationNo) {
		        	    const confirmed = await confirm("íšŒì˜ì‹¤ ì˜ˆì•½ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
		        	    if (!confirmed) return;

		        	    try {
		        	      const response = await fetch('/delete/' + reservationNo, {
		        	        method: 'POST',
		        	        headers: {
		        	          'header': document.querySelector('meta[name="_csrf_header"]').content,
		        	          'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content
		        	        },
		        	      });

		        	      const data = await response.json();
		        	      alert(data.res_msg); // âœ… ì»¤ìŠ¤í…€ alert ì‘ë™ë¨

		        	      if (data.res_code == 200) {
		        	        location.reload();
		        	      }
		        	    } catch (error) {
		        	      console.error("ì˜ˆì•½ ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜:", error);
		        	    }
		        	  }

		        	  cancelReservation(reservationNo); 
		        	}
		    });
		});



	
	</script>

	<!-- Bootstrap Common JS Files Start -->

	<!-- Import vendorJs Files -->
	<script th:src="@{/assets/js/vendor.min.js}"></script>

	<!-- Import Js Files -->
	<script
		th:src="@{/assets/libs/bootstrap/dist/js/bootstrap.bundle.min.js}"></script>
	<script th:src="@{/assets/libs/simplebar/dist/simplebar.min.js}"></script>
	<script th:src="@{/assets/js/theme/app.init.js}"></script>
	<script th:src="@{/assets/js/theme/theme.js}"></script>
	<script th:src="@{/assets/js/theme/app.min.js}"></script>
	<script th:src="@{/assets/js/theme/sidebarmenu.js}"></script>

	<!-- solar icons -->
	<script
		src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>
	<script th:src="@{/assets/libs/owl.carousel/dist/owl.carousel.min.js}"></script>
	<script th:src="@{/assets/libs/apexcharts/dist/apexcharts.min.js}"></script>
	<script th:src="@{/assets/js/dashboards/dashboard.js}"></script>

	<!-- Bootstrap Common JS Files End -->


	<script
		src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>
	<script src="../js/ysw/fullcalendar/index.global.min.js"></script>
	<script src="../js/ysw/meetingRoomCalendar.js"></script>
</th:block>
</html>